<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å­¸ç”Ÿèª²ç¨‹è¡Œäº‹æ›†ï½œæ¸…å¤§æ–‡ç†è£œç¿’ç­</title>
<style>
  :root{
    --brand:#1d4ed8;      /* ä¸»è‰² */
    --accent:#34c759;     /* ç¶ é» */
    --ink:#111827;        /* ä¸»å­—è‰² */
    --muted:#6b7280;      /* æ¬¡å­—è‰² */
    --bg:#f3f5f7;         /* èƒŒæ™¯ */
    --card:#ffffff;       /* å¡ç‰‡ */
    --soft:#f7fafc;       /* æ·ºå¡ */
    --line:#e5e7eb;       /* é‚Šæ¡† */
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;}
  a{color:var(--brand);text-decoration:none}
  a:hover{text-decoration:underline}

  /* Header */
  .site-header{background:#0f172a;color:#fff}
  .site-header .wrap{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.5px}
  .brand .sub{opacity:.85;font-weight:600}
  .who{font-weight:600;opacity:.9}

  /* App */
  .app{max-width:1100px;margin:26px auto;background:var(--card);border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.06);padding:22px 24px;position:relative;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .nav{display:flex;gap:10px;align-items:center}
  button.navbtn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  button.navbtn:hover{background:#f9fafb}
  .links{display:flex;gap:12px;align-items:center}
  .links .name{font-weight:700}

  .msg{padding:12px 14px;border-radius:10px;margin:8px 0;display:none}
  .msg.err{background:#fde2e0;color:#9b1c1c}

  /* Calendar */
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:8px;}
  .dow{font-weight:700;color:#5b6770;text-align:center;}
  .cell{background:var(--soft);min-height:86px;border-radius:12px;padding:10px;position:relative;border:1px solid var(--line)}
  .cell .day{font-weight:700;color:#3a4a5b;}

  /* å–®é»èˆŠè¦å‰‡ï¼šåªç®¡ä½ç½®èˆ‡å°ºå¯¸ï¼Œä¸ç®¡é¡è‰² */
  .cell.has .dot{ position:absolute; right:10px; top:10px; width:8px; height:8px; border-radius:50%; }

  /* å¤šé»ï¼šé è¨­ç¶ è‰² */
  .cell .dots{ position:absolute; right:10px; top:10px; display:flex; gap:4px; }
  .cell .dots .dot{ position:static; width:8px; height:8px; border-radius:50%; background:var(--accent); } /* ç¶  */

  /* å…¶ä»–é¡è‰²è¦†è“‹ */
  .cell .dots .dot-holiday{ background:#f59e0b; } /* æ©˜ */
  .cell .dots .dot-note   { background:#ec4899; } /* ç²‰ */

  /* Popover */
  .popover{position:absolute;z-index:50;min-width:300px;max-width:380px;background:#fff;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.18);padding:12px;display:none;border:1px solid var(--line)}
  .popover .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .card{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:8px 0;}

  /* Footer */
  .site-footer{margin:24px 0 40px;color:var(--muted)}
  .site-footer .wrap{max-width:1100px;margin:0 auto;padding:0 18px;display:flex;justify-content:space-between;align-items:center}
  .note{font-size:14px}
</style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap">
      <div class="brand">
        <div style="font-size:18px">å­¸ç”Ÿèª²ç¨‹è¡Œäº‹æ›†</div>
        <div class="sub">æ¸…å¤§æ–‡ç†è£œç¿’ç­</div>
      </div>
      <div class="who">
        <span id="studentName">å­¸ç”Ÿï¼š</span>
        <span id="adminLink" style="margin-left:12px"></span>
      </div>
    </div>
  </header>

  <!-- App -->
  <main class="app" id="app">
    <div class="topbar">
      <div class="nav">
        <button class="navbtn" id="btnPrev" aria-label="ä¸Šä¸€æœˆ">â—€</button>
        <div id="monthLabel" style="font-weight:700"></div>
        <button class="navbtn" id="btnNext" aria-label="ä¸‹ä¸€æœˆ">â–¶</button>
      </div>
      <div class="links">
        <!-- åªé¡¯ç¤ºå­¸ç”Ÿåå­—èˆ‡ï¼ˆæœ¬æ©Ÿï¼‰å¾Œå°ï¼›ä¸éœ²å‡ºè€å¸«ä¸»é  -->
      </div>
    </div>

    <div id="err" class="msg err"></div>
    <div id="calendar"></div>

    <!-- é»æœ‰è³‡æ–™çš„æ—¥æœŸæ‰æœƒé–‹ -->
    <div id="popover" class="popover" role="dialog" aria-modal="true">
      <div class="row">
        <label>èª²ç¨‹ï¼š</label><select id="pCourse"></select>
        <label>é¡å‹ï¼š</label><select id="pType"></select>
      </div>
      <div id="pList"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="wrap">
      <div class="note">Â© <span id="year"></span> æ¸…å¤§æ–‡ç†è£œç¿’ç­ | Jeff</div>
      <div class="note">æœ¬é åƒ…æä¾›å­¸ç¿’å…§å®¹æŸ¥é–±</div>
    </div>
  </footer>

<script>
/* ---------- åŸºæœ¬å·¥å…· ---------- */
const q=(s,e=document)=>e.querySelector(s);
const params=new URLSearchParams(location.search);
let currentStudent=params.get('student')||null;
let currentDate=params.get('date')||null;
let currentCourse=params.get('course')||null;
let currentType=params.get('type')||null;
const isLocal=()=>['127.0.0.1','localhost'].includes(location.hostname);

async function getJSON(path){
  // æœ¬æ©Ÿå„ªå…ˆæ‰“ APIï¼Œå¤±æ•—å°±å›é€€è®€éœæ…‹æª”ï¼ˆGitHub Pages å¯ç”¨ï¼‰
  if(isLocal()){
    try{ const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r2.ok) throw new Error('HTTP '+r2.status);
  return await r2.json();
}

let roster={students:[]}, manifest=null;
let view = (()=>{
  const d = currentDate ? new Date(currentDate) : new Date();
  return {y: d.getFullYear(), m: d.getMonth()};
})();
const fmtYMD=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const base=(p)=>p.split('/').pop();
function niceTitle(item){
  if(item.title && item.title.trim()) return item.title.trim();
  let name=base(item.path||'').replace(/\.[^.]+$/,'').replace(/^\d{4}-\d{2}-\d{2}_?/, '');
  return name || 'æ•™æ';
}
function setErr(m){const el=q('#err'); if(m){el.textContent=m; el.style.display='block';} else el.style.display='none';}
function closePopover(){ const p=q('#popover'); if(p) p.style.display='none'; }

// åˆ¤æ–·è©²æ—¥æ˜¯å¦æœ‰å…§å®¹æˆ–ç­†è¨˜
function dayFlags(dayObj){
  let hasContent=false, hasNote=false;
  if(!dayObj) return {hasContent, hasNote};
  Object.keys(dayObj).forEach(c=>{
    Object.keys(dayObj[c]||{}).forEach(t=>{
      const arr = dayObj[c][t]||[];
      if(Array.isArray(arr) && arr.length){
        if(t==='note') hasNote=true;
        else hasContent=true;
      }
    });
  });
  return {hasContent, hasNote};
}


/* ---------- æ¸²æŸ“æœˆæ›† ---------- */
function renderCalendar(){
  closePopover(); // é‡ç¹ªæ™‚æ”¶æ‰æ®˜ç•™çš„ popover
  const container=q('#calendar'); container.innerHTML='';
  const y=view.y, m=view.m;
  q('#monthLabel').textContent = `${y} / ${String(m+1).padStart(2,'0')}`;

  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0), days=last.getDate();
  const grid=document.createElement('div'); grid.className='calendar';

  ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; grid.appendChild(el);
  });
  for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));

  const daysMap=manifest?.days||{};
  for(let day=1; day<=days; day++){
    const d=new Date(y,m,day), k=fmtYMD(d), cell=document.createElement('div'); cell.className='cell';
    // åˆ¤æ–·è©²æ—¥æ˜¯å¦æœ‰å…§å®¹æˆ–ç­†è¨˜
    const {hasContent, hasNote} = dayFlags(daysMap[k]);
    // æ˜¯å¦æ”¾å‡ï¼ˆæ©˜é»ï¼‰â€” èˆŠ manifest æ²’ holidays æ™‚æœƒè‡ªå‹•è¦–ç‚º []
    const isOff = Array.isArray(manifest?.holidays) && manifest.holidays.includes(k);

    if (hasContent || hasNote || isOff) {
      // çµ±ä¸€çµ¦ .hasï¼ˆåªæ˜¯è¦–è¦ºç”¨ï¼Œä¸å½±éŸ¿è³‡æ–™ï¼‰
      cell.classList.add('has');

      // å³ä¸Šè§’å¯æ”¾ 1ï½3 é¡†é»ï¼ˆç¶ ï¼‹æ©˜ï¼‹ç²‰ï¼‰
      const dots = document.createElement('span');
      dots.className = 'dots';
      if (hasContent){ const g=document.createElement('span'); g.className='dot'; dots.appendChild(g); }
      if (hasNote)   { const n=document.createElement('span'); n.className='dot dot-note'; dots.appendChild(n); }
      if (isOff)     { const o=document.createElement('span'); o.className='dot dot-holiday'; dots.appendChild(o); }

      // é»æ“Šè¡Œç‚ºï¼šæœ‰æ•™æâ†’é–‹æ¸…å–®ï¼›åªæœ‰æ”¾å‡â†’è·³è¨Šæ¯
      cell.appendChild(dots);
      cell.style.cursor='pointer';
      cell.onclick = ()=>openPopover(k, cell, { has: hasContent||hasNote, isOff });
    }
    const todayStr=fmtYMD(new Date());
    if(k===todayStr) cell.classList.add('today');

    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.textContent=day; cell.appendChild(dayEl);
    grid.appendChild(cell);
  }
  container.appendChild(grid);

  // âŒ ä¸å†è‡ªå‹•é–‹å•Ÿ popoverï¼ˆå³ä½¿ URL å¸¶ ?date=ï¼‰
}

/* ---------- å°å¡ï¼ˆPopoverï¼‰ ---------- */
function combosFor(dateKey){
  const day=manifest?.days?.[dateKey]||{};
  const combos=[];
  Object.keys(day).forEach(c=>{
    Object.keys(day[c]||{}).forEach(t=>{
      const items=(day[c][t]||[]);
      if(items.length) combos.push({course:c,type:t,items});
    });
  });
  return combos;
}
function renderPopoverList(dateKey, courseKey, typeKey){
  const wrap = q('#pList'); 
  wrap.innerHTML = '';

  const arr = (((manifest.days?.[dateKey]||{})[courseKey]||{})[typeKey]) || [];

  // â˜… æé†’ noteï¼šé¡¯ç¤ºæ–‡å­—æ‘˜è¦ + é€£çµ
  if (typeKey === 'note') {
    if (!arr.length) {
      wrap.innerHTML = '<div class="card">ï¼ˆæœ¬æ—¥æ²’æœ‰æé†’ï¼‰</div>';
      return;
    }
    arr.forEach(it => {
      const card = document.createElement('div'); 
      card.className = 'card';

      // å…ˆæ”¾ä¸€å€‹ã€Œè¼‰å…¥ä¸­ã€ï¼Œç­‰æŠ“åˆ°æª”æ¡ˆå†æ›¿æ›
      const p = document.createElement('div'); 
      p.textContent = 'ğŸ“Œ è¼‰å…¥ä¸­â€¦';
      card.appendChild(p);

      if (it.path) {
        const a = document.createElement('a');
        a.href = it.path;
        a.style.display = 'inline-block';
        a.style.marginTop = '6px';
        a.textContent = 'æŸ¥çœ‹å®Œæ•´æé†’';
        card.appendChild(a);
      }

      wrap.appendChild(card);

      // å–æª”æ¡ˆæ–‡å­—ï¼ˆå®‰å…¨ï¼šåªç”¨ textContentï¼Œä¸å¡ innerHTMLï¼‰
      if (it.path) {
        fetch(it.path).then(r => r.text()).then(raw => {
          const doc = new DOMParser().parseFromString(raw, 'text/html');
          const cont = doc.querySelector('.note') || doc.querySelector('.container');
          let text = cont ? cont.textContent.trim() : (it.title || 'æé†’äº‹é …');
          // åšå€‹ç°¡çŸ­æ‘˜è¦ï¼ˆå¯è‡ªè¡Œèª¿æ•´é•·åº¦ï¼‰
          text = text.replace(/\s+/g, ' ').slice(0, 120);
          p.textContent = 'ğŸ“Œ ' + text;
        }).catch(() => {
          p.textContent = 'ğŸ“Œ ' + (it.title || 'æé†’äº‹é …');
        });
      } else {
        p.textContent = 'ğŸ“Œ ' + (it.title || 'æé†’äº‹é …');
      }
    });
    return; // note é¡å‹è™•ç†å®Œç•¢
  }

  // â˜… å…¶ä»–ï¼ˆæ•™æ/ä½œæ¥­â€¦ï¼‰ï¼šç¶­æŒåŸæœ¬åšæ³•ï¼Œé¡¯ç¤ºé€£çµ
  if (!arr.length) { 
    wrap.innerHTML = '<div class="card">é€™å€‹çµ„åˆç›®å‰æ²’æœ‰å…§å®¹</div>'; 
    return; 
  }
  arr.forEach(it => {
    const card = document.createElement('div'); 
    card.className = 'card';
    const a = document.createElement('a'); 
    a.href = it.path;      // ç›¸å°è·¯å¾‘ï¼Œéœæ…‹å¯ç”¨
    a.textContent = niceTitle(it);
    card.appendChild(a); 
    wrap.appendChild(card);
  });
}
function openPopover(dateKey, anchorCell, flags={}){
  const { has=false, isOff=false } = flags;
  currentDate=dateKey;
  // æœ¬æ©Ÿæ‰æœƒé¡¯ç¤ºå¾Œå°é€£çµï¼Œé€™è£¡è£œä¸Šæ›´æ–°ï¼ˆèˆ‡ loadAll ç›¸åŒé‚è¼¯ï¼‰
  if (isLocal()) {
    const qs = 'student=' + encodeURIComponent(currentStudent) + 
    (currentDate ? '&date=' + encodeURIComponent(currentDate) : '');
    q('#adminLink').innerHTML = `<a href="admin.html?${qs}" style="color:#a7f3d0">å¾Œå°</a>`;
  }
  const combos=combosFor(dateKey);
  // if(!combos.length) return; // æ²’æœ‰è³‡æ–™å°±ä¸é–‹ popover

  const pop=q('#popover'); const app=q('#app');
  const csel=q('#pCourse'), tsel=q('#pType');
  csel.innerHTML=''; tsel.innerHTML='';
  // æ–°å¢ï¼æ›´æ–°æ”¾å‡ bannerï¼ˆæ©˜è‰²ï¼‰
  let banner = pop.querySelector('.holiday-banner');
  if (isOff) {
    if (!banner) {
      banner = document.createElement('div');
      banner.className = 'card holiday-banner';
      banner.style.borderColor = '#f59e0b';
      banner.style.background = '#fff7e6';
      banner.textContent = 'ğŸ§¡ æ­¤æ—¥æ¨™è¨˜ç‚ºæ”¾å‡ï¼ˆä»å¯æ–°å¢æ•™æ/ä½œæ¥­ï¼‰';
      pop.insertBefore(banner, pop.firstChild);
      }
      } else if (banner) {
        banner.remove();
        }
  const courses=[...new Set(combos.map(x=>x.course))];
  const types=[...new Set(combos.map(x=>x.type))];
  const headerRow = pop.querySelector('.row');   // èª²ç¨‹/é¡å‹é‚£ä¸€æ’
  const listWrap  = q('#pList');
  if (combos.length === 0) {
    // æ²’æ•™æï¼šéš±è—ä¸‹æ‹‰ï¼Œåˆ—è¡¨é¡¯ç¤ºä¸€è¡Œèªªæ˜ï¼ˆä»å¯ç”±å¾Œå°æ–°å¢ï¼‰
    if (headerRow) headerRow.style.display = 'none';
    listWrap.innerHTML = '<div class="card">ï¼ˆæœ¬æ—¥ç„¡æ•™æ/ä½œæ¥­ï¼‰</div>';
  } else {
    if (headerRow) headerRow.style.display = '';
    courses.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=manifest.courses?.[c]?.label||c; csel.appendChild(o); });
    types.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=manifest.types?.[t]||t; tsel.appendChild(o); });
    const ck=(currentCourse&&courses.includes(currentCourse))?currentCourse:courses[0];
    const tk=(currentType&&types.includes(currentType))?currentType:types[0];
    csel.value=ck; tsel.value=tk;
    renderPopoverList(dateKey, ck, tk);
    csel.onchange=()=>{ currentCourse=csel.value; renderPopoverList(dateKey, csel.value, tsel.value); };
    tsel.onchange=()=>{ currentType=tsel.value; renderPopoverList(dateKey, csel.value, tsel.value); };
  }


  const ar = anchorCell.getBoundingClientRect();
  const pr = app.getBoundingClientRect();
  pop.style.display = 'block';

  // ä»¥ .app ç‚ºå®šä½å®¹å™¨ï¼Œä½¿ç”¨ cell ç›¸å° .app çš„ä½ç½®
  let left = ar.right - pr.left + 12;
  let top  = ar.top   - pr.top  - 6;   // â¶ ç§»é™¤å¤šé¤˜çš„ window.scrollY

  pop.style.left = left + 'px';
  pop.style.top  = top  + 'px';

  // é‚Šç•Œä¿è­·ï¼ç¿»è½‰ï¼šé¿å…è¶…å‡ºè¦–çª—
  const popRect = pop.getBoundingClientRect();
  if (popRect.right > window.innerWidth - 12) {
    left = ar.left - pr.left - popRect.width - 12;         // ç¿»åˆ°å·¦å´
    pop.style.left = Math.max(12, left) + 'px';
  }
  if (popRect.bottom > window.innerHeight - 12) {
    top = ar.bottom - pr.top - popRect.height - 6;         // ç¿»åˆ°ä¸Šæ–¹
    pop.style.top = Math.max(12, top) + 'px';
  }
  document.addEventListener('click', onDocClick);
  function onDocClick(e){ if(pop.contains(e.target)||anchorCell.contains(e.target)) return; pop.style.display='none'; document.removeEventListener('click', onDocClick); }
}

/* ---------- è¼‰å…¥ ---------- */
async function loadAll(){
  try{
    // å¹´ä»½åˆ° footer
    q('#year').textContent = new Date().getFullYear();

    roster=await getJSON('roster.json');

    // ç·šä¸Šä¸€å®šè¦ç”¨ ?student=ï¼Œé¿å…å­¸ç”Ÿçœ‹åˆ°å…¶ä»–åå–®
    if(!currentStudent){
      if(isLocal()){
        currentStudent = roster.students?.[0]?.id || null;
      }else{
        setErr('è«‹ä½¿ç”¨è€å¸«æä¾›çš„å°ˆå±¬é€£çµé–‹å•Ÿæœ¬é ã€‚');
        return;
      }
    }

    const stu = (roster.students||[]).find(s=>s.id===currentStudent);
    q('#studentName').textContent = `å­¸ç”Ÿï¼š${stu?.name || currentStudent}`;

    // æœ¬æ©Ÿé¡¯ç¤ºå¾Œå°å…¥å£ï¼ˆç·šä¸Šä¸é¡¯ç¤ºï¼ä¹Ÿä¸èƒ½ç”¨ï¼‰
    if (isLocal()) {
      const qs = 'student=' + encodeURIComponent(currentStudent)
                + (currentDate ? '&date=' + encodeURIComponent(currentDate) : '');
      q('#adminLink').innerHTML = `<a href="admin.html?${qs}" style="color:#a7f3d0">å¾Œå°</a>`;
    }

    manifest=await getJSON(`students/${currentStudent}/manifest.json`);
    renderCalendar();
  }catch(e){
    console.error(e);
    setErr('è®€å–è³‡æ–™å¤±æ•—ï¼šè«‹æª¢æŸ¥ docs/roster.json èˆ‡ docs/students/<id>/manifest.json è·¯å¾‘/æ ¼å¼ã€‚');
  }
}

/* ---------- æœˆåˆ‡æ› ---------- */
q('#btnPrev').onclick=()=>{ if(--view.m<0){view.m=11; view.y--;} renderCalendar(); };
q('#btnNext').onclick=()=>{ if(++view.m>11){view.m=0; view.y++;} renderCalendar(); };

loadAll();
</script>
</body>
</html>
