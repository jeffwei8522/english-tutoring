<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>課程日曆</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1024px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px 28px;position:relative;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .nav{display:flex;gap:10px;align-items:center}
  button.navbtn{border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .links a{margin-left:8px;color:#2563eb;text-decoration:none}
  .msg{padding:12px 14px;border-radius:8px;margin:8px 0;display:none}
  .msg.err{background:#fde2e0;color:#9b1c1c}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px;}
  .dow{font-weight:700;color:#5b6770;text-align:center;}
  .cell{background:#f7fafc;min-height:74px;border-radius:10px;padding:8px;position:relative}
  .cell .day{font-weight:700;color:#3a4a5b;}
  .cell.has .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;background:#34c759;border-radius:50%;}
  .cell.today{outline:2px solid #2f80ed;background:#eef6ff;}
  .popover{position:absolute;z-index:50;min-width:280px;max-width:360px;background:#fff;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px;display:none}
  .popover .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .card{background:#f7fafc;border-radius:10px;padding:10px 12px;margin:8px 0;}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="nav">
      <button class="navbtn" id="btnPrev">◀</button>
      <div id="monthLabel" style="font-weight:700"></div>
      <button class="navbtn" id="btnNext">▶</button>
    </div>
    <div class="links">
      <span id="studentName" style="font-weight:700;margin-right:8px"></span>
      <span id="adminLink"></span>
    </div>
  </div>

  <div id="err" class="msg err"></div>
  <div id="calendar"></div>

  <div id="popover" class="popover">
    <div class="row">
      <label>課程：</label><select id="pCourse"></select>
      <label>類型：</label><select id="pType"></select>
    </div>
    <div id="pList"></div>
  </div>
</div>

<script>
const q=(s,e=document)=>e.querySelector(s);
const params=new URLSearchParams(location.search);
let currentStudent=params.get('student')||null;
let currentDate=params.get('date')||null;
let currentCourse=params.get('course')||null;
let currentType=params.get('type')||null;

const isLocal=()=>['127.0.0.1','localhost'].includes(location.hostname);
async function getJSON(path){
  if(isLocal()){
    try{ const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r2.ok) throw new Error('HTTP '+r2.status);
  return await r2.json();
}

let roster={students:[]}, manifest=null;
let view = (()=>{
  const d = currentDate ? new Date(currentDate) : new Date();
  return {y: d.getFullYear(), m: d.getMonth()};
})();
const fmtYMD=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const base=(p)=>p.split('/').pop();
function niceTitle(item){
  if(item.title && item.title.trim()) return item.title.trim();
  let name=base(item.path||'').replace(/\.[^.]+$/,'').replace(/^\d{4}-\d{2}-\d{2}_?/, '');
  return name || '教材';
}
function setErr(m){const el=q('#err'); if(m){el.textContent=m; el.style.display='block';} else el.style.display='none';}

function dateHasAny(dayObj){
  if(!dayObj) return false;
  return Object.values(dayObj).some(courseObj=>{
    if(!courseObj) return false;
    return Object.values(courseObj).some(arr=>Array.isArray(arr)&&arr.length>0);
  });
}

function closePopover(){
  const pop = q('#popover');
  if (pop) pop.style.display = 'none';
}

function renderCalendar(){
  closePopover();  // 先把任何舊的 popover 收掉
  const container=q('#calendar'); container.innerHTML='';
  const y=view.y, m=view.m;
  q('#monthLabel').textContent = `${y} / ${String(m+1).padStart(2,'0')}`;

  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0), days=last.getDate();
  const grid=document.createElement('div'); grid.className='calendar';

  ["日","一","二","三","四","五","六"].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; grid.appendChild(el);
  });
  for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));

  const daysMap=manifest?.days||{};
  for(let day=1; day<=days; day++){
    const d=new Date(y,m,day), k=fmtYMD(d), cell=document.createElement('div'); cell.className='cell';
    const has = dateHasAny(daysMap[k]);
    if(has){
      cell.classList.add('has');
      const dot=document.createElement('span'); dot.className='dot'; cell.appendChild(dot);
      cell.style.cursor='pointer';
      cell.onclick=()=>openPopover(k, cell);
    }
    const todayStr=fmtYMD(new Date());
    if(k===todayStr) cell.classList.add('today');

    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.textContent=day; cell.appendChild(dayEl);
    grid.appendChild(cell);
  }
  container.appendChild(grid);
}

function combosFor(dateKey){
  const day=manifest?.days?.[dateKey]||{};
  const combos=[];
  Object.keys(day).forEach(c=>{
    Object.keys(day[c]||{}).forEach(t=>{
      const items=(day[c][t]||[]);
      if(items.length) combos.push({course:c,type:t,items});
    });
  });
  return combos;
}
function renderPopoverList(dateKey, courseKey, typeKey){
  const wrap=q('#pList'); wrap.innerHTML='';
  const arr=(((manifest.days?.[dateKey]||{})[courseKey]||{})[typeKey])||[];
  if(!arr.length){ wrap.innerHTML='<div class="card">這個組合目前沒有內容</div>'; return; }
  arr.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const a=document.createElement('a'); a.href=it.path;   /* 相對路徑，避免 / 造成 404 */
    a.textContent=niceTitle(it);
    card.appendChild(a); wrap.appendChild(card);
  });
}
function openPopover(dateKey, anchorCell){
  currentDate=dateKey;
  const u=new URL(location.href); u.searchParams.set('date',dateKey); history.replaceState({},'',u);

  const combos=combosFor(dateKey);
  if(!combos.length) return;

  const pop=q('#popover'); const app=q('#app');
  const csel=q('#pCourse'), tsel=q('#pType');
  csel.innerHTML=''; tsel.innerHTML='';
  const courses=[...new Set(combos.map(x=>x.course))];
  const types=[...new Set(combos.map(x=>x.type))];
  courses.forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=manifest.courses?.[c]?.label||c; csel.appendChild(o);});
  types.forEach(t=>{const o=document.createElement('option'); o.value=t; o.textContent=manifest.types?.[t]||t; tsel.appendChild(o);});
  const ck = (currentCourse && courses.includes(currentCourse)) ? currentCourse : courses[0];
  const tk = (currentType && types.includes(currentType)) ? currentType : types[0];
  csel.value=ck; tsel.value=tk;
  renderPopoverList(dateKey, ck, tk);
  csel.onchange=()=>{ currentCourse=csel.value; renderPopoverList(dateKey, csel.value, tsel.value); syncURL(); };
  tsel.onchange=()=>{ currentType=tsel.value; renderPopoverList(dateKey, csel.value, tsel.value); syncURL(); };

  const ar=anchorCell.getBoundingClientRect();
  const pr=app.getBoundingClientRect();
  pop.style.display='block';
  pop.style.left = (ar.right - pr.left + 10) + 'px';
  pop.style.top  = (ar.top - pr.top + window.scrollY - 6) + 'px';
  const popRect=pop.getBoundingClientRect();
  if(popRect.right > window.innerWidth - 12){
    pop.style.left = (ar.left - pr.left - popRect.width - 10) + 'px';
  }
  document.addEventListener('click', onDocClick);
  function onDocClick(e){ if(pop.contains(e.target)||anchorCell.contains(e.target)) return; pop.style.display='none'; document.removeEventListener('click', onDocClick); }
  function syncURL(){
    const u=new URL(location.href);
    u.searchParams.set('date', dateKey);
    u.searchParams.set('course', csel.value);
    u.searchParams.set('type',   tsel.value);
    history.replaceState({},'',u);
  }
}

async function loadAll(){
  try{
    roster = await getJSON('roster.json');

    if (!currentStudent) {
      if (isLocal()) {
        // 本機開發可用第一個學生當預設
        currentStudent = roster.students?.[0]?.id || null;
      } else {
        // 線上一定要用專屬連結（含 ?student=）
        setErr('請使用老師提供的專屬連結開啟本頁。');
        return; // 不載入任何資料
      }
    }

    const stu = (roster.students||[]).find(s=>s.id===currentStudent);
    q('#studentName').textContent = stu?.name ? `學生：${stu.name}` : `學生：${currentStudent||''}`;

    if (isLocal()) q('#adminLink').innerHTML = '<a href="admin.html">後台</a>';

    manifest = await getJSON(`students/${currentStudent}/manifest.json`);
    renderCalendar();
  } catch(e){
    console.error(e);
    setErr('讀取資料失敗：請檢查 docs/roster.json 與 docs/students/<id>/manifest.json 路徑/格式。');
  }
}

q('#btnPrev').onclick=()=>{ if(--view.m<0){view.m=11; view.y--;} renderCalendar(); };
q('#btnNext').onclick=()=>{ if(++view.m>11){view.m=0; view.y++;} renderCalendar(); };
loadAll();
</script>
</body>
</html>
