<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>學生課程行事曆｜清大文理補習班</title>
<style>
  :root{
    --brand:#1d4ed8;      /* 主色 */
    --accent:#34c759;     /* 綠點 */
    --ink:#111827;        /* 主字色 */
    --muted:#6b7280;      /* 次字色 */
    --bg:#f3f5f7;         /* 背景 */
    --card:#ffffff;       /* 卡片 */
    --soft:#f7fafc;       /* 淺卡 */
    --line:#e5e7eb;       /* 邊框 */
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;}
  a{color:var(--brand);text-decoration:none}
  a:hover{text-decoration:underline}

  /* Header */
  .site-header{background:#0f172a;color:#fff}
  .site-header .wrap{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.5px}
  .brand .sub{opacity:.85;font-weight:600}
  .who{font-weight:600;opacity:.9}

  /* App */
  .app{max-width:1100px;margin:26px auto;background:var(--card);border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.06);padding:22px 24px;position:relative;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .nav{display:flex;gap:10px;align-items:center}
  button.navbtn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  button.navbtn:hover{background:#f9fafb}
  .links{display:flex;gap:12px;align-items:center}
  .links .name{font-weight:700}

  .msg{padding:12px 14px;border-radius:10px;margin:8px 0;display:none}
  .msg.err{background:#fde2e0;color:#9b1c1c}

  /* Calendar */
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:8px;}
  .dow{font-weight:700;color:#5b6770;text-align:center;}
  .cell{background:var(--soft);min-height:86px;border-radius:12px;padding:10px;position:relative;border:1px solid var(--line)}
  .cell .day{font-weight:700;color:#3a4a5b;}

  /* 單點舊規則：只管位置與尺寸，不管顏色 */
  .cell.has .dot{ position:absolute; right:10px; top:10px; width:8px; height:8px; border-radius:50%; }

  /* 多點：預設綠色 */
  .cell .dots{ position:absolute; right:10px; top:10px; display:flex; gap:4px; }
  .cell .dots .dot{ position:static; width:8px; height:8px; border-radius:50%; background:var(--accent); } /* 綠 */

  /* 其他顏色覆蓋 */
  .cell .dots .dot-holiday{ background:#f59e0b; } /* 橘 */
  .cell .dots .dot-note   { background:#ec4899; } /* 粉 */

  /* Popover */
  .popover{position:absolute;z-index:50;min-width:300px;max-width:380px;background:#fff;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.18);padding:12px;display:none;border:1px solid var(--line)}
  .popover .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .card{background:var(--soft);border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:8px 0;}

  /* Footer */
  .site-footer{margin:24px 0 40px;color:var(--muted)}
  .site-footer .wrap{max-width:1100px;margin:0 auto;padding:0 18px;display:flex;justify-content:space-between;align-items:center}
  .note{font-size:14px}
</style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap">
      <div class="brand">
        <div style="font-size:18px">學生課程行事曆</div>
        <div class="sub">清大文理補習班</div>
      </div>
      <div class="who">
        <span id="studentName">學生：</span>
        <span id="adminLink" style="margin-left:12px"></span>
      </div>
    </div>
  </header>

  <!-- App -->
  <main class="app" id="app">
    <div class="topbar">
      <div class="nav">
        <button class="navbtn" id="btnPrev" aria-label="上一月">◀</button>
        <div id="monthLabel" style="font-weight:700"></div>
        <button class="navbtn" id="btnNext" aria-label="下一月">▶</button>
      </div>
      <div class="links">
        <!-- 只顯示學生名字與（本機）後台；不露出老師主頁 -->
      </div>
    </div>

    <div id="err" class="msg err"></div>
    <div id="calendar"></div>

    <!-- 點有資料的日期才會開 -->
    <div id="popover" class="popover" role="dialog" aria-modal="true">
      <div class="row">
        <label>課程：</label><select id="pCourse"></select>
        <label>類型：</label><select id="pType"></select>
      </div>
      <div id="pList"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="wrap">
      <div class="note">© <span id="year"></span> 清大文理補習班 | Jeff</div>
      <div class="note">本頁僅提供學習內容查閱</div>
    </div>
  </footer>

<script>
/* ---------- 基本工具 ---------- */
const q=(s,e=document)=>e.querySelector(s);
const params=new URLSearchParams(location.search);
let currentStudent=params.get('student')||null;
let currentDate=params.get('date')||null;
let currentCourse=params.get('course')||null;
let currentType=params.get('type')||null;
const isLocal=()=>['127.0.0.1','localhost'].includes(location.hostname);

async function getJSON(path){
  // 本機優先打 API，失敗就回退讀靜態檔（GitHub Pages 可用）
  if(isLocal()){
    try{ const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r2.ok) throw new Error('HTTP '+r2.status);
  return await r2.json();
}

let roster={students:[]}, manifest=null;
let view = (()=>{
  const d = currentDate ? new Date(currentDate) : new Date();
  return {y: d.getFullYear(), m: d.getMonth()};
})();
const fmtYMD=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const base=(p)=>p.split('/').pop();
function niceTitle(item){
  if(item.title && item.title.trim()) return item.title.trim();
  let name=base(item.path||'').replace(/\.[^.]+$/,'').replace(/^\d{4}-\d{2}-\d{2}_?/, '');
  return name || '教材';
}
function setErr(m){const el=q('#err'); if(m){el.textContent=m; el.style.display='block';} else el.style.display='none';}
function closePopover(){ const p=q('#popover'); if(p) p.style.display='none'; }

// 判斷該日是否有內容或筆記
function dayFlags(dayObj){
  let hasContent=false, hasNote=false;
  if(!dayObj) return {hasContent, hasNote};
  Object.keys(dayObj).forEach(c=>{
    Object.keys(dayObj[c]||{}).forEach(t=>{
      const arr = dayObj[c][t]||[];
      if(Array.isArray(arr) && arr.length){
        if(t==='note') hasNote=true;
        else hasContent=true;
      }
    });
  });
  return {hasContent, hasNote};
}


/* ---------- 渲染月曆 ---------- */
function renderCalendar(){
  closePopover(); // 重繪時收掉殘留的 popover
  const container=q('#calendar'); container.innerHTML='';
  const y=view.y, m=view.m;
  q('#monthLabel').textContent = `${y} / ${String(m+1).padStart(2,'0')}`;

  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0), days=last.getDate();
  const grid=document.createElement('div'); grid.className='calendar';

  ["日","一","二","三","四","五","六"].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; grid.appendChild(el);
  });
  for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));

  const daysMap=manifest?.days||{};
  for(let day=1; day<=days; day++){
    const d=new Date(y,m,day), k=fmtYMD(d), cell=document.createElement('div'); cell.className='cell';
    // 判斷該日是否有內容或筆記
    const {hasContent, hasNote} = dayFlags(daysMap[k]);
    // 是否放假（橘點）— 舊 manifest 沒 holidays 時會自動視為 []
    const isOff = Array.isArray(manifest?.holidays) && manifest.holidays.includes(k);

    if (hasContent || hasNote || isOff) {
      // 統一給 .has（只是視覺用，不影響資料）
      cell.classList.add('has');

      // 右上角可放 1～3 顆點（綠＋橘＋粉）
      const dots = document.createElement('span');
      dots.className = 'dots';
      if (hasContent){ const g=document.createElement('span'); g.className='dot'; dots.appendChild(g); }
      if (hasNote)   { const n=document.createElement('span'); n.className='dot dot-note'; dots.appendChild(n); }
      if (isOff)     { const o=document.createElement('span'); o.className='dot dot-holiday'; dots.appendChild(o); }

      // 點擊行為：有教材→開清單；只有放假→跳訊息
      cell.appendChild(dots);
      cell.style.cursor='pointer';
      cell.onclick = ()=>openPopover(k, cell, { has: hasContent||hasNote, isOff });
    }
    const todayStr=fmtYMD(new Date());
    if(k===todayStr) cell.classList.add('today');

    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.textContent=day; cell.appendChild(dayEl);
    grid.appendChild(cell);
  }
  container.appendChild(grid);

  // ❌ 不再自動開啟 popover（即使 URL 帶 ?date=）
}

/* ---------- 小卡（Popover） ---------- */
function combosFor(dateKey){
  const day=manifest?.days?.[dateKey]||{};
  const combos=[];
  Object.keys(day).forEach(c=>{
    Object.keys(day[c]||{}).forEach(t=>{
      const items=(day[c][t]||[]);
      if(items.length) combos.push({course:c,type:t,items});
    });
  });
  return combos;
}
function renderPopoverList(dateKey, courseKey, typeKey){
  const wrap = q('#pList'); 
  wrap.innerHTML = '';

  const arr = (((manifest.days?.[dateKey]||{})[courseKey]||{})[typeKey]) || [];

  // ★ 提醒 note：顯示文字摘要 + 連結
  if (typeKey === 'note') {
    if (!arr.length) {
      wrap.innerHTML = '<div class="card">（本日沒有提醒）</div>';
      return;
    }
    arr.forEach(it => {
      const card = document.createElement('div'); 
      card.className = 'card';

      // 先放一個「載入中」，等抓到檔案再替換
      const p = document.createElement('div'); 
      p.textContent = '📌 載入中…';
      card.appendChild(p);

      if (it.path) {
        const a = document.createElement('a');
        a.href = it.path;
        a.style.display = 'inline-block';
        a.style.marginTop = '6px';
        a.textContent = '查看完整提醒';
        card.appendChild(a);
      }

      wrap.appendChild(card);

      // 取檔案文字（安全：只用 textContent，不塞 innerHTML）
      if (it.path) {
        fetch(it.path).then(r => r.text()).then(raw => {
          const doc = new DOMParser().parseFromString(raw, 'text/html');
          const cont = doc.querySelector('.note') || doc.querySelector('.container');
          let text = cont ? cont.textContent.trim() : (it.title || '提醒事項');
          // 做個簡短摘要（可自行調整長度）
          text = text.replace(/\s+/g, ' ').slice(0, 120);
          p.textContent = '📌 ' + text;
        }).catch(() => {
          p.textContent = '📌 ' + (it.title || '提醒事項');
        });
      } else {
        p.textContent = '📌 ' + (it.title || '提醒事項');
      }
    });
    return; // note 類型處理完畢
  }

  // ★ 其他（教材/作業…）：維持原本做法，顯示連結
  if (!arr.length) { 
    wrap.innerHTML = '<div class="card">這個組合目前沒有內容</div>'; 
    return; 
  }
  arr.forEach(it => {
    const card = document.createElement('div'); 
    card.className = 'card';
    const a = document.createElement('a'); 
    a.href = it.path;      // 相對路徑，靜態可用
    a.textContent = niceTitle(it);
    card.appendChild(a); 
    wrap.appendChild(card);
  });
}
function openPopover(dateKey, anchorCell, flags={}){
  const { has=false, isOff=false } = flags;
  currentDate=dateKey;
  // 本機才會顯示後台連結，這裡補上更新（與 loadAll 相同邏輯）
  if (isLocal()) {
    const qs = 'student=' + encodeURIComponent(currentStudent) + 
    (currentDate ? '&date=' + encodeURIComponent(currentDate) : '');
    q('#adminLink').innerHTML = `<a href="admin.html?${qs}" style="color:#a7f3d0">後台</a>`;
  }
  const combos=combosFor(dateKey);
  // if(!combos.length) return; // 沒有資料就不開 popover

  const pop=q('#popover'); const app=q('#app');
  const csel=q('#pCourse'), tsel=q('#pType');
  csel.innerHTML=''; tsel.innerHTML='';
  // 新增／更新放假 banner（橘色）
  let banner = pop.querySelector('.holiday-banner');
  if (isOff) {
    if (!banner) {
      banner = document.createElement('div');
      banner.className = 'card holiday-banner';
      banner.style.borderColor = '#f59e0b';
      banner.style.background = '#fff7e6';
      banner.textContent = '🧡 此日標記為放假（仍可新增教材/作業）';
      pop.insertBefore(banner, pop.firstChild);
      }
      } else if (banner) {
        banner.remove();
        }
  const courses=[...new Set(combos.map(x=>x.course))];
  const types=[...new Set(combos.map(x=>x.type))];
  const headerRow = pop.querySelector('.row');   // 課程/類型那一排
  const listWrap  = q('#pList');
  if (combos.length === 0) {
    // 沒教材：隱藏下拉，列表顯示一行說明（仍可由後台新增）
    if (headerRow) headerRow.style.display = 'none';
    listWrap.innerHTML = '<div class="card">（本日無教材/作業）</div>';
  } else {
    if (headerRow) headerRow.style.display = '';
    courses.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=manifest.courses?.[c]?.label||c; csel.appendChild(o); });
    types.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=manifest.types?.[t]||t; tsel.appendChild(o); });
    const ck=(currentCourse&&courses.includes(currentCourse))?currentCourse:courses[0];
    const tk=(currentType&&types.includes(currentType))?currentType:types[0];
    csel.value=ck; tsel.value=tk;
    renderPopoverList(dateKey, ck, tk);
    csel.onchange=()=>{ currentCourse=csel.value; renderPopoverList(dateKey, csel.value, tsel.value); };
    tsel.onchange=()=>{ currentType=tsel.value; renderPopoverList(dateKey, csel.value, tsel.value); };
  }


  const ar = anchorCell.getBoundingClientRect();
  const pr = app.getBoundingClientRect();
  pop.style.display = 'block';

  // 以 .app 為定位容器，使用 cell 相對 .app 的位置
  let left = ar.right - pr.left + 12;
  let top  = ar.top   - pr.top  - 6;   // ❶ 移除多餘的 window.scrollY

  pop.style.left = left + 'px';
  pop.style.top  = top  + 'px';

  // 邊界保護／翻轉：避免超出視窗
  const popRect = pop.getBoundingClientRect();
  if (popRect.right > window.innerWidth - 12) {
    left = ar.left - pr.left - popRect.width - 12;         // 翻到左側
    pop.style.left = Math.max(12, left) + 'px';
  }
  if (popRect.bottom > window.innerHeight - 12) {
    top = ar.bottom - pr.top - popRect.height - 6;         // 翻到上方
    pop.style.top = Math.max(12, top) + 'px';
  }
  document.addEventListener('click', onDocClick);
  function onDocClick(e){ if(pop.contains(e.target)||anchorCell.contains(e.target)) return; pop.style.display='none'; document.removeEventListener('click', onDocClick); }
}

/* ---------- 載入 ---------- */
async function loadAll(){
  try{
    // 年份到 footer
    q('#year').textContent = new Date().getFullYear();

    roster=await getJSON('roster.json');

    // 線上一定要用 ?student=，避免學生看到其他名單
    if(!currentStudent){
      if(isLocal()){
        currentStudent = roster.students?.[0]?.id || null;
      }else{
        setErr('請使用老師提供的專屬連結開啟本頁。');
        return;
      }
    }

    const stu = (roster.students||[]).find(s=>s.id===currentStudent);
    q('#studentName').textContent = `學生：${stu?.name || currentStudent}`;

    // 本機顯示後台入口（線上不顯示／也不能用）
    if (isLocal()) {
      const qs = 'student=' + encodeURIComponent(currentStudent)
                + (currentDate ? '&date=' + encodeURIComponent(currentDate) : '');
      q('#adminLink').innerHTML = `<a href="admin.html?${qs}" style="color:#a7f3d0">後台</a>`;
    }

    manifest=await getJSON(`students/${currentStudent}/manifest.json`);
    renderCalendar();
  }catch(e){
    console.error(e);
    setErr('讀取資料失敗：請檢查 docs/roster.json 與 docs/students/<id>/manifest.json 路徑/格式。');
  }
}

/* ---------- 月切換 ---------- */
q('#btnPrev').onclick=()=>{ if(--view.m<0){view.m=11; view.y--;} renderCalendar(); };
q('#btnNext').onclick=()=>{ if(++view.m>11){view.m=0; view.y++;} renderCalendar(); };

loadAll();
</script>
</body>
</html>
