<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \'../index.html?student=\'+student+\'&date=\'+meta+\'#calendar-widget\' : \'../index.html?student=\'+student+\'#calendar-widget\';document.getElementById('breadcrumb').innerHTML = '<a href="'+back+'" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
