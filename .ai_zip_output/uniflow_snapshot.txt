### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
# server.py
from __future__ import annotations
import json, mimetypes
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory, Response, abort
from werkzeug.utils import safe_join

app = Flask(__name__, static_folder=None)

BASE_DIR = Path(__file__).resolve().parent
DOCS_DIR = BASE_DIR / "docs"
DOCS_DIR.mkdir(exist_ok=True)

def _json_ok(data):
    return Response(json.dumps(data, ensure_ascii=False, indent=2),
                    mimetype="application/json; charset=utf-8")

def _default_manifest(student_id: str) -> dict:
    return {
        "version": 3,
        "student": student_id,
        "displayName": student_id,
        "courses": {"english": {"label": "è‹±æ–‡"}, "math": {"label": "æ•¸å­¸"}},
        "types": {"material": "æ•™æ", "homework": "ä½œæ¥­"},
        "days": {}
    }

def _default_roster() -> dict:
    return {"students": []}

def _path_under_docs(relpath: str) -> Path:
    p = DOCS_DIR / Path(relpath.strip("/"))
    p.parent.mkdir(parents=True, exist_ok=True)
    return p

def _guess_mime(p: Path) -> str:
    t, _ = mimetypes.guess_type(str(p))
    return t or "text/plain; charset=utf-8"

@app.get("/api/data/<path:req_path>")
def api_data(req_path: str):
    dst = safe_join(str(DOCS_DIR), req_path)
    if not dst: abort(400)
    fp = Path(dst)
    lower = req_path.lower()

    if not fp.exists():
        if lower.endswith("manifest.json"):
            parts = Path(req_path).parts
            sid = parts[-2] if len(parts) >= 2 else "unknown"
            return _json_ok(_default_manifest(sid))
        if lower == "roster.json":
            return _json_ok(_default_roster())
        return jsonify({"error": "Not Found", "path": req_path}), 404

    if lower.endswith(".json"):
        return _json_ok(json.loads(fp.read_text(encoding="utf-8")))

    mime = _guess_mime(fp)
    if mime.startswith("text/") or mime.endswith(("xml", "javascript")):
        return Response(fp.read_text(encoding="utf-8"), mimetype=mime)
    return Response(fp.read_bytes(), mimetype=mime)

@app.post("/api/save")
def api_save():
    data = request.get_json(silent=True) or {}
    relpath, content = data.get("path"), data.get("content")
    if not relpath:
        return jsonify({"status":"error","message":"missing path"}), 400

    target = _path_under_docs(relpath)
    if str(target).lower().endswith(".json"):
        if isinstance(content, str):
            try: content = json.loads(content)
            except Exception: return jsonify({"status":"error","message":"content is not valid JSON"}), 400
        target.write_text(json.dumps(content, ensure_ascii=False, indent=2), encoding="utf-8")
    else:
        if not isinstance(content, str):
            return jsonify({"status":"error","message":"content must be string for non-JSON files"}), 400
        target.write_text(content, encoding="utf-8")

    return jsonify({"status":"success","path": str(target.relative_to(DOCS_DIR))})

@app.post("/api/delete")
def api_delete():
    data = request.get_json(silent=True) or {}
    relpath = (data.get("path") or "").strip("/")
    if not relpath:
        return jsonify({"status":"error","message":"missing path"}), 400
    target = Path(safe_join(str(DOCS_DIR), relpath))
    if not target or not target.exists():
        return jsonify({"status":"success","deleted": False, "path": relpath})
    if target.is_dir():
        return jsonify({"status":"error","message":"refuse to delete directory"}), 400
    try:
        target.unlink()
        return jsonify({"status":"success","deleted": True, "path": relpath})
    except Exception as e:
        return jsonify({"status":"error","message":str(e)}), 500

# éœæ…‹é 
@app.get("/")
def _root(): return send_from_directory(DOCS_DIR, "teacher.html")
@app.get("/teacher")
def _teacher(): return send_from_directory(DOCS_DIR, "teacher.html")
@app.get("/<path:filename>")
def _static(filename: str):
    full = safe_join(str(DOCS_DIR), filename)
    if not full or not Path(full).exists(): abort(404)
    return send_from_directory(DOCS_DIR, filename)

if __name__ == "__main__":
    print("Serving at http://127.0.0.1:5000")
    app.run(host="127.0.0.1", port=5000, debug=True)


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
# server.py
from __future__ import annotations
import json, mimetypes
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory, Response, abort
from werkzeug.utils import safe_join

app = Flask(__name__, static_folder=None)

BASE_DIR = Path(__file__).resolve().parent
DOCS_DIR = BASE_DIR / "docs"
DOCS_DIR.mkdir(exist_ok=True)

def _json_ok(data):
    return Response(json.dumps(data, ensure_ascii=False, indent=2),
                    mimetype="application/json; charset=utf-8")

def _default_manifest(student_id: str) -> dict:
    return {
        "version": 3,
        "student": student_id,
        "displayName": student_id,
        "courses": {"english": {"label": "è‹±æ–‡"}, "math": {"label": "æ•¸å­¸"}},
        "types": {"material": "æ•™æ", "homework": "ä½œæ¥­"},
        "days": {}
    }

def _default_roster() -> dict:
    return {"students": []}

def _path_under_docs(relpath: str) -> Path:
    p = DOCS_DIR / Path(relpath.strip("/"))
    p.parent.mkdir(parents=True, exist_ok=True)
    return p

def _guess_mime(p: Path) -> str:
    t, _ = mimetypes.guess_type(str(p))
    return t or "text/plain; charset=utf-8"

@app.get("/api/data/<path:req_path>")
def api_data(req_path: str):
    dst = safe_join(str(DOCS_DIR), req_path)
    if not dst: abort(400)
    fp = Path(dst)
    lower = req_path.lower()

    if not fp.exists():
        if lower.endswith("manifest.json"):
            sid = Path(req_path).parts[-2] if len(Path(req_path).parts) >= 2 else "unknown"
            return _json_ok(_default_manifest(sid))
        if lower == "roster.json":
            return _json_ok(_default_roster())
        return jsonify({"error": "Not Found", "path": req_path}), 404

    if lower.endswith(".json"):
        return _json_ok(json.loads(fp.read_text(encoding="utf-8")))

    mime = _guess_mime(fp)
    if mime.startswith("text/") or mime.endswith(("xml", "javascript")):
        return Response(fp.read_text(encoding="utf-8"), mimetype=mime)
    return Response(fp.read_bytes(), mimetype=mime)

@app.post("/api/save")
def api_save():
    data = request.get_json(silent=True) or {}
    relpath, content = data.get("path"), data.get("content")
    if not relpath:
        return jsonify({"status":"error","message":"missing path"}), 400

    target = _path_under_docs(relpath)
    if str(target).lower().endswith(".json"):
        if isinstance(content, str):
            try: content = json.loads(content)
            except Exception: return jsonify({"status":"error","message":"content is not valid JSON"}), 400
        target.write_text(json.dumps(content, ensure_ascii=False, indent=2), encoding="utf-8")
    else:
        if not isinstance(content, str):
            return jsonify({"status":"error","message":"content must be string for non-JSON files"}), 400
        target.write_text(content, encoding="utf-8")

    return jsonify({"status":"success","path": str(target.relative_to(DOCS_DIR))})

@app.post("/api/delete")
def api_delete():
    data = request.get_json(silent=True) or {}
    relpath = (data.get("path") or "").strip("/")
    if not relpath:
        return jsonify({"status":"error","message":"missing path"}), 400
    target = Path(safe_join(str(DOCS_DIR), relpath))
    if not target or not target.exists():
        return jsonify({"status":"success","deleted": False, "path": relpath})
    if target.is_dir():
        return jsonify({"status":"error","message":"refuse to delete directory"}), 400
    try:
        target.unlink()
        return jsonify({"status":"success","deleted": True, "path": relpath})
    except Exception as e:
        return jsonify({"status":"error","message":str(e)}), 500

# ---- éœæ…‹é  ----
@app.get("/")
def _root(): return send_from_directory(DOCS_DIR, "teacher.html")  # è€å¸«ä¸»é 
@app.get("/teacher")
def _teacher(): return send_from_directory(DOCS_DIR, "teacher.html")
@app.get("/<path:filename>")
def _static(filename: str):
    full = safe_join(str(DOCS_DIR), filename)
    if not full or not Path(full).exists(): abort(404)
    return send_from_directory(DOCS_DIR, filename)

if __name__ == "__main__":
    print("Serving at http://127.0.0.1:5000")
    app.run(host="127.0.0.1", port=5000, debug=True)


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
# server.py
from __future__ import annotations
import json, mimetypes
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory, Response, abort
from werkzeug.utils import safe_join

app = Flask(__name__, static_folder=None)

BASE_DIR = Path(__file__).resolve().parent
DOCS_DIR = BASE_DIR / "docs"
DOCS_DIR.mkdir(exist_ok=True)

def _json_ok(data):  # pretty json
    return Response(json.dumps(data, ensure_ascii=False, indent=2),
                    mimetype="application/json; charset=utf-8")

def _default_manifest(student_id: str) -> dict:
    return {"student": student_id, "entries": {}, "meta": {
        "course_options": ["english", "math"],
        "type_options": ["material", "homework"]
    }}

def _default_roster() -> dict:
    return {"students": []}

def _path_under_docs(relpath: str) -> Path:
    p = DOCS_DIR / Path(relpath.strip("/"))
    p.parent.mkdir(parents=True, exist_ok=True)
    return p

def _guess_mime(p: Path) -> str:
    t, _ = mimetypes.guess_type(str(p))
    return t or "text/plain; charset=utf-8"

@app.get("/api/data/<path:req_path>")
def api_data(req_path: str):
    dst = safe_join(str(DOCS_DIR), req_path)
    if not dst: abort(400)
    fp = Path(dst)
    lower = req_path.lower()

    if not fp.exists():
        if lower.endswith("manifest.json"):
            sid = Path(req_path).parts[-2] if len(Path(req_path).parts) >= 2 else "unknown"
            return _json_ok(_default_manifest(sid))
        if lower == "roster.json":
            return _json_ok(_default_roster())
        return jsonify({"error": "Not Found", "path": req_path}), 404

    if lower.endswith(".json"):
        return _json_ok(json.loads(fp.read_text(encoding="utf-8")))

    mime = _guess_mime(fp)
    if mime.startswith("text/") or mime.endswith(("xml", "javascript")):
        return Response(fp.read_text(encoding="utf-8"), mimetype=mime)
    return Response(fp.read_bytes(), mimetype=mime)

@app.post("/api/save")
def api_save():
    data = request.get_json(silent=True) or {}
    relpath, content = data.get("path"), data.get("content")
    if not relpath: return jsonify({"status":"error","message":"missing path"}), 400

    target = _path_under_docs(relpath)
    if str(target).lower().endswith(".json"):
        if isinstance(content, str):
            try: content = json.loads(content)
            except Exception: return jsonify({"status":"error","message":"content is not valid JSON"}), 400
        target.write_text(json.dumps(content, ensure_ascii=False, indent=2), encoding="utf-8")
    else:
        if not isinstance(content, str):
            return jsonify({"status":"error","message":"content must be string for non-JSON files"}), 400
        target.write_text(content, encoding="utf-8")

    return jsonify({"status":"success","path": str(target.relative_to(DOCS_DIR))})

@app.get("/")
def _root(): return send_from_directory(DOCS_DIR, "index.html")

@app.get("/<path:filename>")
def _static(filename: str):
    full = safe_join(str(DOCS_DIR), filename)
    if not full or not Path(full).exists(): abort(404)
    return send_from_directory(DOCS_DIR, filename)

if __name__ == "__main__":
    print("Serving at http://127.0.0.1:5000")
    app.run(host="127.0.0.1", port=5000, debug=True)


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
# server.py
from __future__ import annotations
import json, mimetypes
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory, Response, abort
from werkzeug.utils import safe_join

app = Flask(__name__, static_folder=None)

BASE_DIR = Path(__file__).resolve().parent
DOCS_DIR = BASE_DIR / "docs"
DOCS_DIR.mkdir(exist_ok=True)

# ---------- helpers ----------
def _jsonify_ok(data):
    return Response(json.dumps(data, ensure_ascii=False, indent=2), mimetype="application/json; charset=utf-8")

def _default_manifest(student_id: str) -> dict:
    # ç©º manifestï¼Œæ”¯æ´æ—¥æ›†ï¼ˆä»¥ YYYY-MM-DD ç‚º keyï¼‰
    return {
        "student": student_id,
        "entries": {
            # "2025-02-14": [
            #   {"title": "ç¬¬ä¸€æ¬¡ä¸Šèª²", "path": "materials/sally/english/2025-02-14_intro.html"}
            # ]
        }
    }

def _default_roster() -> dict:
    # åˆæ¬¡å•Ÿå‹•è‹¥æ²’æœ‰ roster.json å°±å›ç©ºåå–®
    return {"students": []}

def _path_under_docs(relpath: str) -> Path:
    # åƒ…å…è¨±åœ¨ docs ç›®éŒ„å…§
    clean = Path(relpath.strip("/"))
    full = DOCS_DIR / clean
    full.parent.mkdir(parents=True, exist_ok=True)
    return full

def _guess_mime(p: Path) -> str:
    typ, _ = mimetypes.guess_type(str(p))
    return typ or "text/plain; charset=utf-8"

# ---------- APIs ----------
@app.get("/api/data/<path:req_path>")
def api_data(req_path: str):
    """
    è®€æª” APIï¼šå„ªå…ˆå› JSONï¼›è‹¥æ˜¯ manifest / roster ç¼ºæª”ï¼Œå›é è¨­æ¨¡æ¿ï¼ˆ200ï¼‰
    """
    # æ­£è¦åŒ–è·¯å¾‘
    dst = safe_join(str(DOCS_DIR), req_path)
    if not dst:
        abort(400)
    file_path = Path(dst)

    # ç¼ºæª”æ™‚ï¼šmanifest èˆ‡ roster çµ¦é è¨­æ¨¡æ¿ï¼ˆ200ï¼‰
    lower = req_path.lower()
    if not file_path.exists():
        if lower.endswith("manifest.json"):
            sid = Path(req_path).parts[-2] if len(Path(req_path).parts) >= 2 else "unknown"
            return _jsonify_ok(_default_manifest(sid))
        if lower == "roster.json":
            return _jsonify_ok(_default_roster())
        return jsonify({"error": "Not Found", "path": req_path}), 404

    # å­˜åœ¨å‰‡å›æª”æ¡ˆå…§å®¹
    if lower.endswith(".json"):
        with open(file_path, "r", encoding="utf-8") as f:
            data = json.load(f)
        return _jsonify_ok(data)

    # å…¶ä»–æ–‡å­— / äºŒé€²ä½
    mime = _guess_mime(file_path)
    if mime.startswith("text/") or mime.endswith("xml") or mime.endswith("javascript"):
        with open(file_path, "r", encoding="utf-8") as f:
            return Response(f.read(), mimetype=mime)
    else:
        with open(file_path, "rb") as f:
            return Response(f.read(), mimetype=mime)

@app.post("/api/save")
def api_save():
    """
    å¯«æª” APIï¼š{path, content}
    path ç‚º docs/ ä¸‹çš„ç›¸å°è·¯å¾‘ï¼ˆä¾‹å¦‚ students/sally/manifest.json æˆ– materials/sally/english/2025-02-14_intro.htmlï¼‰
    content å¯ç‚º JSONï¼ˆdict/listï¼‰æˆ–ç´”æ–‡å­—ï¼ˆHTMLï¼‰
    """
    data = request.get_json(silent=True) or {}
    relpath = data.get("path")
    content = data.get("content")
    if not relpath:
        return jsonify({"status": "error", "message": "missing path"}), 400

    target = _path_under_docs(relpath)
    # JSON æª”ç¾åŒ–è¼¸å‡º
    if str(target).lower().endswith(".json"):
        try:
            # è‹¥å‰ç«¯å‚³å­—ä¸²ä¹Ÿå˜—è©¦ parse
            if isinstance(content, str):
                content = json.loads(content)
        except Exception:
            return jsonify({"status": "error", "message": "content is not valid JSON"}), 400
        with open(target, "w", encoding="utf-8") as f:
            json.dump(content, f, ensure_ascii=False, indent=2)
    else:
        # ç´”æ–‡å­—å¯«å…¥ï¼ˆHTMLã€CSSã€JSâ€¦ï¼‰
        if not isinstance(content, str):
            return jsonify({"status": "error", "message": "content must be string for non-JSON files"}), 400
        with open(target, "w", encoding="utf-8") as f:
            f.write(content)

    return jsonify({"status": "success", "path": str(target.relative_to(DOCS_DIR))})

# ---------- static files ----------
@app.get("/")
def _root():
    return send_from_directory(DOCS_DIR, "index.html")

@app.get("/<path:filename>")
def _docs_static(filename: str):
    # åƒ…ä¾› docs ç›®éŒ„ï¼ˆå« materials/...ï¼‰
    full = safe_join(str(DOCS_DIR), filename)
    if not full:
        abort(404)
    p = Path(full)
    if not p.exists():
        abort(404)
    return send_from_directory(DOCS_DIR, filename)

if __name__ == "__main__":
    print("Serving at http://127.0.0.1:5000")
    app.run(host="127.0.0.1", port=5000, debug=True)


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
import json
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory
from werkzeug.utils import safe_join # <-- ä¿®æ­£ä¹‹è™•

# -- é…ç½® --
ROOT_DIR = Path(__file__).resolve().parent
DOCS_DIR = ROOT_DIR / "docs"
app = Flask(__name__)

print(f"Flask å°ˆæ¡ˆæ ¹ç›®éŒ„: {ROOT_DIR}")
print(f"éœæ…‹æ–‡ä»¶ç›®éŒ„: {DOCS_DIR}")

# -- è¼”åŠ©å‡½æ•¸ --
def get_safe_path(file_path_str: str) -> Path | None:
    """ç¢ºä¿æª”æ¡ˆè·¯å¾‘åœ¨ docs ç›®éŒ„å…§ï¼Œé˜²æ­¢ä»»æ„è·¯å¾‘å­˜å–"""
    if not file_path_str: return None
    try:
        abs_path = Path(safe_join(str(DOCS_DIR), file_path_str)).resolve()
        if DOCS_DIR in abs_path.parents or DOCS_DIR == abs_path:
            return abs_path
    except Exception:
        return None
    return None

# -- API ç«¯é» --
@app.route('/api/data/<path:file_path>', methods=['GET'])
def get_data(file_path):
    """é€šç”¨è®€å– API"""
    safe_path = get_safe_path(file_path)
    if not safe_path or not safe_path.exists():
        if 'manifest.json' in file_path: # è‹¥ manifest ä¸å­˜åœ¨ï¼Œå›å‚³ä¸€å€‹æ–°å­¸ç”Ÿçš„ç¯„æœ¬
            student_id = Path(file_path).parent.name
            return jsonify({
                "version": 2, "student": student_id, "displayName": student_id.capitalize(),
                "courses": {"english": {"label": "è‹±æ–‡", "color": "#1d4ed8"}}, "days": {}
            }), 200
        # å°æ–¼ HTML æ•™æï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå›å‚³ç©ºå­—ä¸²è€Œä¸æ˜¯éŒ¯èª¤
        if file_path.endswith('.html'):
            return "", 200
        return jsonify({"error": f"æª”æ¡ˆæ‰¾ä¸åˆ°: {file_path}"}), 404
    
    try:
        content = safe_path.read_text(encoding='utf-8')
        return content # ç›´æ¥å›å‚³æª”æ¡ˆå…§å®¹ (JSON æˆ– HTML)
    except Exception as e:
        return jsonify({"error": f"è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}"}), 500

@app.route('/api/save', methods=['POST'])
def save_data():
    """é€šç”¨å„²å­˜ API"""
    data = request.get_json()
    if not data or 'path' not in data or 'content' not in data:
        return jsonify({"status": "error", "message": "è«‹æ±‚æ ¼å¼éŒ¯èª¤"}), 400

    safe_path = get_safe_path(data['path'])
    if not safe_path:
        return jsonify({"status": "error", "message": "ç„¡æ•ˆçš„å„²å­˜è·¯å¾‘"}), 403

    try:
        safe_path.parent.mkdir(parents=True, exist_ok=True)
        content = data['content']
        if isinstance(content, (dict, list)):
            safe_path.write_text(json.dumps(content, ensure_ascii=False, indent=2), encoding='utf-8')
        else:
            safe_path.write_text(str(content), encoding='utf-8')
        return jsonify({"status": "success", "path": data['path']})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

# -- éœæ…‹æª”æ¡ˆä¼ºæœ --
@app.route('/')
def serve_root():
    return send_from_directory(str(DOCS_DIR), 'index.html')

@app.route('/<path:filename>')
def serve_docs_files(filename):
    return send_from_directory(str(DOCS_DIR), filename)

if __name__ == '__main__':
    print("="*50)
    print("Flask ä¼ºæœå™¨å·²å•Ÿå‹•ï¼")
    print("è«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿä»¥ä¸‹ç¶²å€ï¼š")
    print(f"  - å¾Œå°ç®¡ç†: http://127.0.0.1:5000/admin.html")
    print(f"  - å…¬é–‹æ—¥æ›†: http://127.0.0.1:5000/")
    print("="*50)
    app.run(debug=True, port=5000)

=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
import json
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory
from werkzeug.utils import safe_join

# -- é…ç½® --
ROOT_DIR = Path(__file__).resolve().parent
DOCS_DIR = ROOT_DIR / "docs"
app = Flask(__name__)

# -- è¼”åŠ©å‡½æ•¸ --
def get_safe_path(file_path_str: str) -> Path | None:
    """ç¢ºä¿æª”æ¡ˆè·¯å¾‘åœ¨ docs ç›®éŒ„å…§ï¼Œé˜²æ­¢ä»»æ„è·¯å¾‘å­˜å–"""
    if not file_path_str: return None
    try:
        # safe_join æœƒè™•ç† '..' ç­‰ä¸å®‰å…¨çš„è·¯å¾‘
        abs_path = Path(safe_join(str(DOCS_DIR), file_path_str)).resolve()
        # ç¢ºä¿è§£æå¾Œçš„è·¯å¾‘ä»ç„¶åœ¨ DOCS_DIR çš„ç¯„åœå…§
        if DOCS_DIR in abs_path.parents or DOCS_DIR == abs_path:
            return abs_path
    except Exception:
        return None
    return None

# -- API ç«¯é» --
@app.route('/api/data/<path:file_path>', methods=['GET'])
def get_data(file_path):
    """é€šç”¨è®€å– APIï¼Œè™•ç† roster, manifest, html ç­‰æª”æ¡ˆ"""
    safe_path = get_safe_path(file_path)
    if not safe_path or not safe_path.exists():
        if 'manifest.json' in file_path: # å°æ–¼ manifest.jsonï¼Œå›å‚³ä¸€å€‹ç©ºç¯„æœ¬ï¼Œè®“å‰ç«¯å¯ä»¥ç›´æ¥ç·¨è¼¯æ–°å­¸ç”Ÿ
            student_id = Path(file_path).parent.name
            return jsonify({
                "version": 2, "student": student_id, "displayName": student_id.capitalize(),
                "courses": {"english": {"label": "è‹±æ–‡", "color": "#1d4ed8"}}, "days": {}
            }), 200
        return jsonify({"error": f"æª”æ¡ˆæ‰¾ä¸åˆ°: {file_path}"}), 404
    
    try:
        content = safe_path.read_text(encoding='utf-8')
        return jsonify(json.loads(content)) if safe_path.suffix == '.json' else content
    except Exception as e:
        return jsonify({"error": f"è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}"}), 500

@app.route('/api/save', methods=['POST'])
def save_data():
    """é€šç”¨å„²å­˜ APIï¼Œè² è²¬å¯«å…¥æ‰€æœ‰æª”æ¡ˆ"""
    data = request.get_json()
    if not data or 'path' not in data or 'content' not in data:
        return jsonify({"status": "error", "message": "è«‹æ±‚æ ¼å¼éŒ¯èª¤"}), 400

    safe_path = get_safe_path(data['path'])
    if not safe_path:
        return jsonify({"status": "error", "message": "ç„¡æ•ˆçš„å„²å­˜è·¯å¾‘"}), 403

    try:
        safe_path.parent.mkdir(parents=True, exist_ok=True)
        content = data['content']
        if isinstance(content, (dict, list)):
            safe_path.write_text(json.dumps(content, ensure_ascii=False, indent=2), encoding='utf-8')
        else:
            safe_path.write_text(str(content), encoding='utf-8')
        return jsonify({"status": "success", "path": data['path']})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

# -- éœæ…‹æª”æ¡ˆä¼ºæœ --
@app.route('/')
def serve_root():
    return send_from_directory(str(DOCS_DIR), 'index.html')

@app.route('/<path:filename>')
def serve_docs_files(filename):
    return send_from_directory(str(DOCS_DIR), filename)

if __name__ == '__main__':
    print("="*50)
    print("Flask ä¼ºæœå™¨å·²å•Ÿå‹•ï¼")
    print("è«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿä»¥ä¸‹ç¶²å€ï¼š")
    print(f"  - å¾Œå°ç®¡ç†: http://127.0.0.1:5000/admin.html")
    print(f"  - å…¬é–‹æ—¥æ›†: http://127.0.0.1:5000/")
    print("="*50)
    app.run(debug=True, port=5000)

=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: server.py ===
import json
import os
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory, abort

# -- é…ç½® --
# é€™æœƒå°‡ server.py æ‰€åœ¨çš„ç›®éŒ„è¨­ç‚ºå°ˆæ¡ˆæ ¹ç›®éŒ„
ROOT_DIR = Path(__file__).resolve().parent
DOCS_DIR = ROOT_DIR / "docs"

app = Flask(__name__)

# -- è¼”åŠ©å‡½æ•¸ --
def get_safe_path(file_path):
    """ç¢ºä¿æª”æ¡ˆè·¯å¾‘åœ¨ docs ç›®éŒ„å…§ï¼Œé˜²æ­¢ä»»æ„è·¯å¾‘å­˜å–"""
    # å¾ä½¿ç”¨è€…æä¾›çš„ç›¸å°è·¯å¾‘ï¼ˆä¾‹å¦‚ students/ray/manifest.jsonï¼‰å»ºç«‹çµ•å°è·¯å¾‘
    abs_path = (DOCS_DIR / file_path).resolve()
    # æª¢æŸ¥è§£æå¾Œçš„è·¯å¾‘æ˜¯å¦ä»ç„¶åœ¨ DOCS_DIR çš„ç¯„åœå…§
    if not abs_path.is_relative_to(DOCS_DIR):
        return None
    return abs_path

# -- API ç«¯é» (Endpoints) --

@app.route('/api/data/<path:file_path>', methods=['GET'])
def get_data(file_path):
    """æä¾›è®€å– docs è³‡æ–™å¤¾å…§ä»»ä½•æª”æ¡ˆçš„é€šç”¨ API"""
    safe_path = get_safe_path(file_path)
    if not safe_path or not safe_path.exists():
        # å¦‚æœæª”æ¡ˆä¸å­˜åœ¨ï¼Œç‰¹åˆ¥è™•ç† roster.json çš„æƒ…æ³ä»¥æä¾›å‹å–„æç¤º
        if file_path == 'students/roster.json':
             return jsonify({"error": "æ‰¾ä¸åˆ° roster.jsonï¼Œè«‹ç¢ºèª `docs/students/roster.json` æª”æ¡ˆå·²å»ºç«‹ã€‚"}), 404
        # å°æ–¼ manifest.jsonï¼Œå›å‚³ä¸€å€‹ç©ºç¯„æœ¬ï¼Œè®“å‰ç«¯å¯ä»¥ç›´æ¥ç·¨è¼¯æ–°å­¸ç”Ÿ
        if 'manifest.json' in file_path:
            student_id = Path(file_path).parent.name
            student_name = student_id.capitalize() # ç°¡å–®çš„åå­—å¤§å¯«
            # é€™è£¡å¯ä»¥å¾ roster æ‰¾åˆ°æ›´ç²¾ç¢ºçš„åå­—ï¼Œä½†ç‚ºç°¡åŒ–ï¼Œç›´æ¥ç”¨ID
            return jsonify({
                "version": 2, "student": student_id, "displayName": student_name,
                "courses": {
                    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
                    "math": { "label": "æ•¸å­¸", "color": "#059669" }
                },
                "days": {}
            }), 200 # å›å‚³ 200 OKï¼Œè®“å‰ç«¯çŸ¥é“é€™æ˜¯å€‹å¯ç”¨çš„æ–°ç¯„æœ¬
        return abort(404, description="File not found")
        
    content = safe_path.read_text(encoding='utf-8')
    if safe_path.suffix == '.json':
        return jsonify(json.loads(content))
    return content

@app.route('/api/save', methods=['POST'])
def save_data():
    """æä¾›å„²å­˜å–®ä¸€æª”æ¡ˆçš„ API"""
    data = request.get_json()
    if not data or 'path' not in data or 'content' not in data:
        return jsonify({"status": "error", "message": "è«‹æ±‚æ ¼å¼éŒ¯èª¤"}), 400

    file_path = data['path']
    content = data['content']
    
    safe_path = get_safe_path(file_path)
    if not safe_path:
        return jsonify({"status": "error", "message": "ç„¡æ•ˆçš„å„²å­˜è·¯å¾‘"}), 403

    try:
        # ç¢ºä¿ç›®æ¨™è³‡æ–™å¤¾å­˜åœ¨
        safe_path.parent.mkdir(parents=True, exist_ok=True)
        # å¦‚æœ content æ˜¯ç‰©ä»¶/é™£åˆ— (JSON)ï¼Œå°‡å…¶æ ¼å¼åŒ–å¾Œå¯«å…¥
        if isinstance(content, (dict, list)):
            safe_path.write_text(json.dumps(content, ensure_ascii=False, indent=2), encoding='utf-8')
        else: # å¦å‰‡è¦–ç‚ºç´”æ–‡å­— (HTML) å¯«å…¥
            safe_path.write_text(str(content), encoding='utf-8')
        return jsonify({"status": "success", "path": file_path})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500


# -- éœæ…‹æª”æ¡ˆä¼ºæœ --

@app.route('/')
def serve_root():
    """è¨ªå•æ ¹ç›®éŒ„æ™‚ï¼Œè‡ªå‹•å°å‘å…¬é–‹æ—¥æ›†"""
    return send_from_directory(DOCS_DIR, 'index.html')

@app.route('/<path:path>')
def serve_static_files(path):
    """æä¾› docs è³‡æ–™å¤¾ä¸‹çš„æ‰€æœ‰éœæ…‹æª”æ¡ˆ (index, admin, jsons, etc.)"""
    return send_from_directory(DOCS_DIR, path)


if __name__ == '__main__':
    print("="*50)
    print("Flask ä¼ºæœå™¨å·²å•Ÿå‹•ï¼")
    print(f"å°ˆæ¡ˆç›®éŒ„: {ROOT_DIR}")
    print("è«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿä»¥ä¸‹ç¶²å€ï¼š")
    print(f"  - å¾Œå°ç®¡ç†: http://127.0.0.1:5000/admin.html")
    print(f"  - å…¬é–‹æ—¥æ›†: http://127.0.0.1:5000/index.html")
    print("="*50)
    app.run(debug=True, port=5000)

=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: .ai_zip_output\uniflow_snapshot.txt ===
### Project root: C:\Users\User\Desktop\english-tutoring

=== FILE: build.py ===
# -*- coding: utf-8 -*-
"""
en_class scaffolder & content manager
Spec: /docs å°ˆæ¡ˆï¼Œå­¸ç”Ÿç«¯é¦–é  + å¾Œå° GUI + per-student manifest
Commands:
  init --student <id>
  new-student --student <id>
  add --student <id> --course <key> --date YYYY-MM-DD --type material|homework --format html|pdf|image|link [--src PATH] [--external-url URL] [--title "æ–‡å­—"] [--dry-run]
  batch-add --student <id> --course <key> --from-dir PATH [--dry-run]
"""
import argparse, datetime as dt, json, os, re, shutil, sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
DOCS = ROOT / "docs"

# ------------------------ helpers ------------------------
def p(*a): print(*a)
def ensure_dir(path: Path): path.mkdir(parents=True, exist_ok=True)
def write_text(path: Path, text: str, *, dry=False):
    ensure_dir(path.parent)
    if dry: p("  [dry] write", path); return
    path.write_text(text, encoding="utf-8"); p("  [+] write", path)
def copy_file(src: Path, dst: Path, *, dry=False):
    ensure_dir(dst.parent)
    if dry: p("  [dry] copy", src, "->", dst); return
    shutil.copy2(src, dst); p("  [+] copy", src, "->", dst)

def load_json(path: Path, default=None):
    if path.exists():
        return json.loads(path.read_text(encoding="utf-8"))
    return default if default is not None else {}

def backup_manifest(path: Path, *, dry=False):
    if not path.exists(): return
    ts = dt.datetime.now().strftime("%Y%m%d-%H%M%S")
    b = path.with_name(f"{path.stem}.backup-{ts}.json")
    if dry: p("  [dry] backup", path, "->", b); return
    shutil.copy2(path, b); p("  [*] backup", b)

def yymmdd(dtobj: dt.date): return dtobj.strftime("%y%m%d")

def yyyy_mm_dd_from_yymmdd(s: str):
    # '250810' -> '2025-08-10'ï¼ˆå‡è¨­ 20xxï¼‰
    return f"20{s[0:2]}-{s[2:4]}-{s[4:6]}"

def guess_format_from_ext(ext: str):
    e = ext.lower()
    if e in (".html", ".htm"): return "html"
    if e in (".pdf",): return "pdf"
    if e in (".png", ".jpg", ".jpeg", ".webp", ".gif"): return "image"
    return "link"

# ------------------------ templates ------------------------
INDEX_HTML = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
"""

ADMIN_HTML = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \\'../index.html?student=\\'+student+\\'&date=\\'+meta+\\'#calendar-widget\\' : \\'../index.html?student=\\'+student+\\'#calendar-widget\\';document.getElementById('breadcrumb').innerHTML = '<a href=\"'+back+'\" class=\"text-blue-600 hover:underline\">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>
"""

MATERIAL_TEMPLATE = """<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="{iso_date}">
<title>{title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){{
  const p = new URLSearchParams(location.search);
  const student = p.get('student') || 'ray';
  const meta = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
  const back = meta
    ? '../index.html?student=' + student + '&date=' + meta + '#calendar-widget'
    : '../index.html?student=' + student + '#calendar-widget';
  document.getElementById('breadcrumb').innerHTML =
    '<a href="' + back + '" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';
}})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">{title}</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>
"""

README = """# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`
"""

GITIGNORE = """__pycache__/
*.backup-*.json
"""

# ------------------------ core ops ------------------------
def init_cmd(student: str, *, dry=False):
    p(">>> init scaffold to /docs")
    ensure_dir(DOCS)
    write_text(DOCS/".nojekyll", "", dry=dry)
    write_text(ROOT/".gitignore", GITIGNORE, dry=dry)
    write_text(DOCS/"index.html", INDEX_HTML, dry=dry)
    write_text(DOCS/"admin.html", ADMIN_HTML, dry=dry)
    write_text(ROOT/"README.md", README, dry=dry)

    # seed student
    new_student_cmd(student, create_samples=True, dry=dry)

def new_student_cmd(student: str, create_samples=False, *, dry=False):
    manifest_path = DOCS / f"students/{student}/manifest.json"
    if manifest_path.exists() and not dry:
        p("  [=] already exists:", manifest_path)
        return
    today = dt.date.today()
    d0 = today.strftime("%Y-%m-%d")
    d1 = (today - dt.timedelta(days=7)).strftime("%Y-%m-%d")
    data = {
        "version": 1,
        "student": student,
        "displayName": student.capitalize(),
        "courses": {
            "english": {"label": "è‹±æ–‡", "color": "#1d4ed8"},
            "math": {"label": "æ•¸å­¸", "color": "#059669"}
        },
        "days": {
            d0: {},
            d1: {}
        }
    }
    write_text(manifest_path, json.dumps(data, ensure_ascii=False, indent=2), dry=dry)

    if create_samples:
        # create sample HTMLs for today
        for course in ("english", "math"):
            add_cmd(student=student, course=course, date=d0, typ="material", fmt="html",
                    src=None, title=f"{data['courses'][course]['label']}æ•™æï¼ˆæ¨£æ¿ï¼‰", dry=dry)

def add_cmd(*, student: str, course: str, date: str, typ: str, fmt: str,
            src: str|None, title: str|None=None, external_url: str|None=None, dry=False):
    assert typ in ("material","homework")
    assert fmt in ("html","pdf","image","link")
    # paths
    rel_dir = Path(f"materials/{student}/{course}")
    abs_dir = DOCS / rel_dir
    ensure_dir(abs_dir)

    # load & backup manifest
    manifest_path = DOCS / f"students/{student}/manifest.json"
    manifest = load_json(manifest_path, default={"version":1,"student":student,"courses":{course:{"label":course,"color":"#333"}}, "days":{}})
    backup_manifest(manifest_path, dry=dry)

    # decide target URL
    if fmt == "link":
        if not external_url:
            raise SystemExit("--external-url ç‚ºå¿…å¡«ï¼ˆformat=linkï¼‰")
        url = external_url
        dst_path = None
    else:
        # decide filename
        ymd = date.replace("-","")
        yyMMdd = ymd[2:]
        suffix = "_hw" if typ=="homework" and fmt=="html" else ""
        if src:
            ext = Path(src).suffix.lower()
            if not ext:
                # default extension per format
                ext = ".html" if fmt=="html" else (".pdf" if fmt=="pdf" else ".png")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' and fmt!='html' else ''}{ext}" if fmt!="html" else f"{yyMMdd}{suffix}.html"
            dst_path = abs_dir / fname
            copy_file(Path(src), dst_path, dry=dry)
        else:
            # no src: only allowed for html -> create template
            if fmt != "html":
                raise SystemExit("æœªæä¾› --srcï¼Œåƒ…æ”¯æ´ format=html è‡ªå‹•ç”¢ç”Ÿæ¨¡æ¿")
            fname = f"{yyMMdd}{'_hw' if typ=='homework' else ''}.html"
            dst_path = abs_dir / fname
            html = MATERIAL_TEMPLATE.format(iso_date=date, title=title or "æ•™æï¼ˆæ¨£æ¿ï¼‰")
            write_text(dst_path, html, dry=dry)
        url = f"{rel_dir.as_posix()}/{dst_path.name}"

    # update manifest
    manifest.setdefault("courses", {}).setdefault(course, {"label":course, "color":"#333"})
    manifest.setdefault("days", {}).setdefault(date, {}).setdefault(course, {})
    node = manifest["days"][date][course]
    if title: node["title"] = title
    node.setdefault(typ, {})
    node[typ]["format"] = fmt
    node[typ]["url"] = url

    # write manifest
    write_text(manifest_path, json.dumps(manifest, ensure_ascii=False, indent=2), dry=dry)
    p("  ==> updated", manifest_path)

def batch_add_cmd(*, student: str, course: str, from_dir: str, dry=False):
    base = Path(from_dir)
    if not base.exists(): raise SystemExit(f"ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{base}")
    files = [p for p in base.iterdir() if p.is_file()]
    if not files: p("ï¼ˆä¾†æºè³‡æ–™å¤¾æ²’æœ‰æª”æ¡ˆï¼‰"); return
    for f in sorted(files):
        m = re.match(r"^(\d{6})(?:_hw)?", f.stem, re.IGNORECASE)
        if not m:
            p("  [skip] æª”åæœªå«æ—¥æœŸ YYMMDDï¼š", f.name); continue
        date = yyyy_mm_dd_from_yymmdd(m.group(1))
        is_hw = "_hw" in f.stem.lower()
        ext = f.suffix.lower()
        fmt = guess_format_from_ext(ext)
        typ = "homework" if is_hw else "material"
        p(f"  -> {f.name}  date={date} type={typ} fmt={fmt}")
        add_cmd(student=student, course=course, date=date, typ=typ, fmt=fmt, src=str(f), dry=dry, title=None)

# ------------------------ CLI ------------------------
def main():
    ap = argparse.ArgumentParser(description="en_class scaffolder & manager")
    sub = ap.add_subparsers(dest="cmd", required=True)

    ap_init = sub.add_parser("init", help="åˆå§‹åŒ– /docs éª¨æ¶")
    ap_init.add_argument("--student", default="ray")
    ap_init.add_argument("--dry-run", action="store_true")

    ap_ns = sub.add_parser("new-student", help="æ–°å¢å­¸ç”Ÿï¼ˆç©º manifestï¼‰")
    ap_ns.add_argument("--student", required=True)
    ap_ns.add_argument("--dry-run", action="store_true")

    ap_add = sub.add_parser("add", help="æ–°å¢/æ›´æ–°ä¸€ç­†æ•™ææˆ–ä½œæ¥­")
    ap_add.add_argument("--student", required=True)
    ap_add.add_argument("--course", required=True)
    ap_add.add_argument("--date", required=True, help="YYYY-MM-DD")
    ap_add.add_argument("--type", dest="typ", choices=["material","homework"], required=True)
    ap_add.add_argument("--format", dest="fmt", choices=["html","pdf","image","link"], required=True)
    ap_add.add_argument("--src")
    ap_add.add_argument("--external-url")
    ap_add.add_argument("--title")
    ap_add.add_argument("--dry-run", action="store_true")

    ap_b = sub.add_parser("batch-add", help="æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™å¤¾ï¼ˆæª”åè¦æœ‰ YYMMDDï¼›å« _hw è¦–ç‚ºä½œæ¥­ï¼‰")
    ap_b.add_argument("--student", required=True)
    ap_b.add_argument("--course", required=True)
    ap_b.add_argument("--from-dir", required=True)
    ap_b.add_argument("--dry-run", action="store_true")

    args = ap.parse_args()

    if args.cmd == "init":
        init_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "new-student":
        new_student_cmd(args.student, dry=args.dry_run)
    elif args.cmd == "add":
        add_cmd(student=args.student, course=args.course, date=args.date, typ=args.typ, fmt=args.fmt,
                src=args.src, title=args.title, external_url=args.external_url, dry=args.dry_run)
    elif args.cmd == "batch-add":
        batch_add_cmd(student=args.student, course=args.course, from_dir=args.from_dir, dry=args.dry_run)

if __name__ == "__main__":
    main()


=== FILE: README.md ===
# en_class (Project Pages)

- GitHub Pages â†’ Source = `main` / `docs`
- å­¸ç”Ÿé¦–é ï¼š`docs/index.html?student=<id>`
- å¾Œå°ï¼š`docs/admin.html`ï¼ˆé›¢ç·šåŒ¯å‡ºç‰ˆï¼‰
- æ¯ä½å­¸ç”Ÿè¨­å®šï¼š`docs/students/<id>/manifest.json`
- æ•™æ/ä½œæ¥­æª”ï¼š`docs/materials/<student>/<course>/...`


=== FILE: docs\admin.html ===
<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \'../index.html?student=\'+student+\'&date=\'+meta+\'#calendar-widget\' : \'../index.html?student=\'+student+\'#calendar-widget\';document.getElementById('breadcrumb').innerHTML = '<a href="'+back+'" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>


=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 1,
  "student": "ray",
  "displayName": "Ray",
  "courses": {
    "english": {
      "label": "è‹±æ–‡",
      "color": "#1d4ed8"
    },
    "math": {
      "label": "æ•¸å­¸",
      "color": "#059669"
    }
  },
  "days": {
    "2025-08-08": {},
    "2025-08-01": {}
  }
}


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        input[type="color"] { padding: 0; height: 2.5rem; width: 2.5rem; border: none; }
        .card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); padding: 1rem; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="admin-app" class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">å¾Œå°ç®¡ç†</h1>

        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">è¼‰å…¥ & åŒ¯å‡º</h2>
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-grow">
                    <label for="load-student-id" class="block text-sm font-medium text-gray-700">å¾ä¼ºæœå™¨è¼‰å…¥å­¸ç”Ÿ ID</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="load-student-id" placeholder="e.g., ray" class="block w-full rounded-none rounded-l-md border-gray-300 px-3 py-2 focus:border-indigo-500 focus:ring-indigo-500">
                        <button id="load-from-server-btn" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">è¼‰å…¥</button>
                    </div>
                </div>
                 <div class="text-gray-500">æˆ–</div>
                <div>
                    <label for="load-local-file" class="block text-sm font-medium text-gray-700">å¾æœ¬åœ°æª”æ¡ˆè¼‰å…¥</label>
                    <input type="file" id="load-local-file" accept=".json" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="w-full md:w-auto pt-4 md:pt-0">
                     <button id="export-btn" class="w-full bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 font-semibold">ä¸‹è¼‰ manifest.json</button>
                </div>
            </div>
        </div>
        
        <div id="editor-panel" class="hidden">
            <div class="card mb-6">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">å­¸ç”Ÿè³‡è¨Š</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-id" class="block text-sm font-medium text-gray-700">Student ID</label>
                        <input type="text" id="student-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly>
                    </div>
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">DisplayName</label>
                        <input type="text" id="student-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
            </div>

            <div class="card mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold">èª²ç¨‹è¨­å®š</h2>
                    <button id="add-course-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 text-sm font-semibold">+ æ–°å¢èª²ç¨‹</button>
                </div>
                <div id="courses-container" class="space-y-3"></div>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold">æ—¥æœŸèˆ‡å…§å®¹</h2>
                    <div class="flex gap-2">
                         <button id="download-template-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 text-sm font-semibold">ä¸‹è¼‰HTMLç¯„æœ¬</button>
                         <input type="date" id="new-date-input" class="rounded-md border-gray-300 shadow-sm">
                         <button id="add-date-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 text-sm font-semibold">+ æ–°å¢æ—¥æœŸ</button>
                    </div>
                </div>
                <div id="days-container" class="space-y-4"></div>
            </div>
        </div>

    </div>

    <script>
    // In a real app, this would be more robust with a framework, but for this self-contained file:
    document.addEventListener('DOMContentLoaded', () => {
        let manifest = null;

        const el = (id) => document.getElementById(id);

        const render = () => {
            if (!manifest) {
                el('editor-panel').classList.add('hidden');
                return;
            }
            el('editor-panel').classList.remove('hidden');
            
            // Student Info
            el('student-id').value = manifest.student;
            el('student-name').value = manifest.displayName;

            // Courses
            const coursesContainer = el('courses-container');
            coursesContainer.innerHTML = '';
            for (const key in manifest.courses) {
                const course = manifest.courses[key];
                const courseEl = document.createElement('div');
                courseEl.className = 'grid grid-cols-1 md:grid-cols-5 gap-2 items-center p-2 border rounded';
                courseEl.innerHTML = `
                    <input type="text" value="${key}" placeholder="key (e.g., english)" class="md:col-span-1 rounded-md border-gray-300" data-key="${key}" onchange="updateCourseKey(event)">
                    <input type="text" value="${course.label}" placeholder="Label (e.g., è‹±æ–‡)" class="md:col-span-2 rounded-md border-gray-300" data-key="${key}" onchange="updateCourseProp(event, 'label')">
                    <input type="color" value="${course.color}" class="md:col-span-1" data-key="${key}" onchange="updateCourseProp(event, 'color')">
                    <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm" data-key="${key}" onclick="deleteCourse(event)">åˆªé™¤</button>
                `;
                coursesContainer.appendChild(courseEl);
            }

            // Days
            const daysContainer = el('days-container');
            daysContainer.innerHTML = '';
            // Sort dates descending
            const sortedDays = Object.keys(manifest.days).sort((a, b) => new Date(b) - new Date(a));

            for (const date of sortedDays) {
                const dayData = manifest.days[date];
                const dayEl = document.createElement('div');
                dayEl.className = 'card';
                dayEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg">${date}</h3>
                        <button class="text-red-500 hover:text-red-700 text-sm" data-date="${date}" onclick="deleteDate(event)">åˆªé™¤æ­¤æ—¥æœŸ</button>
                    </div>
                    <div class="space-y-3" id="day-content-${date}"></div>
                    <div class="mt-3 pt-3 border-t">
                        <select class="add-course-to-date-select rounded-md border-gray-300 text-sm">
                           <option value="">--é¸æ“‡èª²ç¨‹æ–°å¢è‡³æ­¤æ—¥æœŸ--</option>
                           ${Object.keys(manifest.courses).map(k => `<option value="${k}">${manifest.courses[k].label}</option>`).join('')}
                        </select>
                        <button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm" data-date="${date}" onclick="addCourseToDate(event)">æ–°å¢</button>
                    </div>
                `;
                daysContainer.appendChild(dayEl);

                const dayContentContainer = el(`day-content-${date}`);
                for (const courseKey in dayData) {
                    const entry = dayData[courseKey];
                    const courseCard = createCourseCard(date, courseKey, entry);
                    dayContentContainer.appendChild(courseCard);
                }
            }
        };

        const createCourseCard = (date, courseKey, entry) => {
            const course = manifest.courses[courseKey];
            const card = document.createElement('div');
            card.className = 'p-3 border rounded-md relative';
            card.style.borderColor = course.color;
            const material = entry.material || {};
            const homework = entry.homework || {};

            card.innerHTML = `
                <button class="absolute top-1 right-1 text-xs text-red-400 hover:text-red-600" data-date="${date}" data-course="${courseKey}" onclick="deleteCourseFromDate(event)">ç§»é™¤èª²ç¨‹</button>
                <h4 class="font-semibold" style="color: ${course.color}">${course.label}</h4>
                <div class="mt-1">
                    <label class="text-xs">æ¨™é¡Œ</label>
                    <input type="text" value="${entry.title || ''}" onchange="updateEntryProp(event, '${date}', '${courseKey}', 'title')" class="w-full text-sm rounded-md border-gray-200">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div class="p-2 bg-gray-50 rounded">
                        <label class="font-medium text-sm">ğŸ“˜ æ•™æ</label>
                        <div class="mt-1 space-y-1">
                            <select onchange="updateEntrySubProp(event, '${date}', '${courseKey}', 'material', 'format')" class="w-full text-sm rounded-md border-gray-200">
                                <option value="" ${!material.format ? 'selected' : ''}>-- ç„¡ --</option>
                                <option value="html" ${material.format === 'html' ? 'selected' : ''}>HTML</option>
                                <option value="pdf" ${material.format === 'pdf' ? 'selected' : ''}>PDF</option>
                                <option value="image" ${material.format === 'image' ? 'selected' : ''}>Image</option>
                                <option value="link" ${material.format === 'link' ? 'selected' : ''}>Link</option>
                            </select>
                            <input type="text" value="${material.url || ''}" onchange="updateEntrySubProp(event, '${date}', '${courseKey}', 'material', 'url')" placeholder="URL (ç›¸å°æˆ– http)" class="w-full text-sm rounded-md border-gray-200 ${!material.format ? 'hidden' : ''}">
                        </div>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <label class="font-medium text-sm">ğŸ“ ä½œæ¥­</label>
                        <div class="mt-1 space-y-1">
                            <select onchange="updateEntrySubProp(event, '${date}', '${courseKey}', 'homework', 'format')" class="w-full text-sm rounded-md border-gray-200">
                                <option value="" ${!homework.format ? 'selected' : ''}>-- ç„¡ --</option>
                                <option value="html" ${homework.format === 'html' ? 'selected' : ''}>HTML</option>
                                <option value="pdf" ${homework.format === 'pdf' ? 'selected' : ''}>PDF</option>
                                <option value="image" ${homework.format === 'image' ? 'selected' : ''}>Image</option>
                                <option value="link" ${homework.format === 'link' ? 'selected' : ''}>Link</option>
                            </select>
                            <input type="text" value="${homework.url || ''}" onchange="updateEntrySubProp(event, '${date}', '${courseKey}', 'homework', 'url')" placeholder="URL (ç›¸å°æˆ– http)" class="w-full text-sm rounded-md border-gray-200 ${!homework.format ? 'hidden' : ''}">
                        </div>
                    </div>
                </div>
            `;
            return card;
        };

        // --- Event Handlers (bound globally for simplicity) ---
        window.updateCourseKey = (e) => {
            const oldKey = e.target.dataset.key;
            const newKey = e.target.value.trim();
            if (!newKey || newKey === oldKey || manifest.courses[newKey]) {
                e.target.value = oldKey; // revert if invalid
                return;
            }
            // This is complex: need to update all references in 'days'
            alert("æ›´æ”¹èª²ç¨‹ Key æ˜¯è¤‡é›œæ“ä½œï¼Œæš«ä¸æ”¯æ´ã€‚è«‹åˆªé™¤å¾Œé‡å»ºã€‚");
            e.target.value = oldKey;
        };
        window.updateCourseProp = (e, prop) => { manifest.courses[e.target.dataset.key][prop] = e.target.value; render(); };
        window.deleteCourse = (e) => { 
            const key = e.target.dataset.key;
            if (confirm(`ç¢ºå®šè¦åˆªé™¤èª²ç¨‹ "${key}"ï¼Ÿæ‰€æœ‰æ—¥æœŸä¸‹é—œè¯æ­¤èª²ç¨‹çš„é …ç›®ä¹Ÿæœƒè¢«ç§»é™¤ã€‚`)) {
                delete manifest.courses[key];
                for(const date in manifest.days) {
                    if (manifest.days[date][key]) {
                        delete manifest.days[date][key];
                    }
                }
                render();
            }
        };
        window.deleteDate = (e) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ—¥æœŸï¼Ÿ')) { delete manifest.days[e.target.dataset.date]; render(); }};
        window.updateEntryProp = (e, date, course, prop) => { manifest.days[date][course][prop] = e.target.value; };
        window.updateEntrySubProp = (e, date, course, type, prop) => {
            if (!manifest.days[date][course][type]) manifest.days[date][course][type] = {};
            manifest.days[date][course][type][prop] = e.target.value;
            if (prop === 'format' && !e.target.value) delete manifest.days[date][course][type]; // remove if format is empty
            render();
        };
        window.addCourseToDate = (e) => {
            const date = e.target.dataset.date;
            const select = e.target.previousElementSibling;
            const courseKey = select.value;
            if (courseKey && !manifest.days[date][courseKey]) {
                manifest.days[date][courseKey] = { title: "" };
                render();
            }
        };
        window.deleteCourseFromDate = (e) => {
            if(confirm('ç¢ºå®šç§»é™¤æ­¤èª²ç¨‹ï¼Ÿ')){
                delete manifest.days[e.target.dataset.date][e.target.dataset.course];
                render();
            }
        };


        // --- Top Level Buttons ---
        el('load-from-server-btn').addEventListener('click', async () => {
            const studentId = el('load-student-id').value.trim();
            if (!studentId) { alert('è«‹è¼¸å…¥å­¸ç”Ÿ ID'); return; }
            try {
                const res = await fetch(`students/${studentId}/manifest.json?ts=${Date.now()}`, {cache: 'no-store'});
                if (!res.ok) throw new Error(`æ‰¾ä¸åˆ° ${studentId} çš„è³‡æ–™`);
                manifest = await res.json();
                render();
            } catch (err) {
                alert(`è¼‰å…¥å¤±æ•—: ${err.message}`);
            }
        });

        el('load-local-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        manifest = JSON.parse(ev.target.result);
                        el('load-student-id').value = manifest.student || '';
                        render();
                    } catch (err) {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œä¸æ˜¯æœ‰æ•ˆçš„ JSONã€‚');
                    }
                };
                reader.readAsText(file);
            }
        });
        
        el('student-name').addEventListener('change', (e) => { if(manifest) manifest.displayName = e.target.value; });
        
        el('add-course-btn').addEventListener('click', () => {
            const newKey = `new_course_${Date.now()}`;
            manifest.courses[newKey] = { label: 'æ–°èª²ç¨‹', color: '#cccccc' };
            render();
        });
        
        el('add-date-btn').addEventListener('click', () => {
            const newDate = el('new-date-input').value;
            if (newDate && !manifest.days[newDate]) {
                manifest.days[newDate] = {};
                render();
            } else if (manifest.days[newDate]) {
                alert('è©²æ—¥æœŸå·²å­˜åœ¨');
            }
        });

        el('export-btn').addEventListener('click', () => {
            if (!manifest) { alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™'); return; }
            const dataStr = JSON.stringify(manifest, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'manifest.json';
            a.click();
            URL.revokeObjectURL(url);
        });
        
        el('download-template-btn').addEventListener('click', () => {
             const template = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™æ</title>
    <meta name="lesson-date" content="YYYY-MM-DD">
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>body{font-family: sans-serif;}</style>
</head>
<body>
    <div style="padding: 2rem;">
        <header>
            <a href="../../index.html?student=REPLACE_STUDENT_ID&date=YYYY-MM-DD#calendar-widget">&larr; è¿”å›</a>
        </header>
        <main><h1>æ•™æå…§å®¹</h1><p>è«‹åœ¨æ­¤ç·¨è¼¯...</p></main>
    </div>
</body>
</html>`;
            const blob = new Blob([template], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template.html';
            a.click();
            URL.revokeObjectURL(url);
        });

    });
    </script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹æœˆæ›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day-cell { aspect-ratio: 1 / 1; }
        .has-data-dot {
            position: absolute;
            bottom: 8px; left: 50%;
            transform: translateX(-50%);
            width: 6px; height: 6px;
            background-color: #10b981; /* a shade of green */
            border-radius: 50%;
        }
        .today { background-color: #eff6ff; } /* blue-50 */
        .selected-date { box-shadow: 0 0 0 2px #3b82f6; } /* blue-500 */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="app" class="container mx-auto p-4 max-w-3xl">
        
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">éŒ¯èª¤ï¼š</strong>
            <span class="block sm:inline">æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™ã€‚è«‹ç¢ºèªç¶²å€ä¸­çš„ `?student=` åƒæ•¸æ˜¯å¦æ­£ç¢ºã€‚</span>
        </div>

        <div id="calendar-container" class="bg-white rounded-lg shadow-lg p-4 md:p-6">
            <header class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                <h2 id="current-month-year" class="text-xl md:text-2xl font-bold"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
            </header>
            
            <div id="calendar-widget">
                <div class="calendar-grid text-xs md:text-sm font-semibold text-center text-gray-600 mb-2">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div id="calendar-days" class="calendar-grid"></div>
            </div>

            <footer class="mt-4 text-center text-gray-500 text-sm">
                å­¸ç”Ÿï¼š<span id="student-name" class="font-semibold"></span>
            </footer>
        </div>
    </div>

    <div id="course-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">é¸æ“‡èª²ç¨‹</h3>
                <div class="mt-4 px-2 py-3 space-y-3" id="modal-body">
                    </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const studentId = params.get('student');
            const urlDate = params.get('date');

            if (!studentId) {
                document.getElementById('calendar-container').classList.add('hidden');
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

            const appState = {
                studentId,
                manifest: null,
                currentDate: urlDate ? new Date(urlDate + 'T00:00:00') : new Date(),
                today: new Date(),
            };
            
            // Set initial month to display
            if (urlDate) {
               const [year, month, day] = urlDate.split('-').map(Number);
               appState.currentDate = new Date(year, month - 1, day);
            }

            const fetchManifest = async () => {
                try {
                    const response = await fetch(`students/${studentId}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
                    if (!response.ok) throw new Error('Manifest not found');
                    appState.manifest = await response.json();
                    document.getElementById('student-name').textContent = appState.manifest.displayName || appState.studentId;
                    renderCalendar();
                } catch (error) {
                    console.error('Failed to load manifest:', error);
                    document.getElementById('calendar-container').classList.add('hidden');
                    document.getElementById('error-message').classList.remove('hidden');
                }
            };

            const renderCalendar = () => {
                const year = appState.currentDate.getFullYear();
                const month = appState.currentDate.getMonth(); // 0-11
                
                document.getElementById('current-month-year').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const calendarDays = document.getElementById('calendar-days');
                calendarDays.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon...
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Add empty cells for days before the 1st of the month
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarDays.innerHTML += `<div class="day-cell"></div>`;
                }

                const todayStr = `${appState.today.getFullYear()}-${String(appState.today.getMonth() + 1).padStart(2, '0')}-${String(appState.today.getDate()).padStart(2, '0')}`;
                const selectedDateStr = urlDate;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = appState.manifest.days[dateStr];
                    
                    const cell = document.createElement('div');
                    cell.className = 'day-cell relative flex items-center justify-center border border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors';
                    if (dateStr === todayStr) cell.classList.add('today');
                    if (dateStr === selectedDateStr) cell.classList.add('selected-date');
                    
                    cell.innerHTML = `<span>${day}</span>`;
                    
                    if (dayData) {
                        cell.innerHTML += `<div class="has-data-dot"></div>`;
                        cell.dataset.date = dateStr;
                        cell.addEventListener('click', onDayClick);
                    }
                    
                    calendarDays.appendChild(cell);
                }
            };

            const onDayClick = (e) => {
                const cell = e.currentTarget;
                const date = cell.dataset.date;
                const dayData = appState.manifest.days[date];
                const courses = Object.keys(dayData);

                if (courses.length === 1) {
                    const courseKey = courses[0];
                    const courseData = dayData[courseKey];
                    const target = courseData.material || courseData.homework;
                    if (target) {
                        openLink(target.url, target.format);
                    } else {
                        alert('æ­¤æ—¥ç„¡å¯ç”¨è³‡æ–™');
                    }
                } else if (courses.length > 1) {
                    showCourseModal(date, dayData);
                }
            };

            const showCourseModal = (date, dayData) => {
                const modal = document.getElementById('course-modal');
                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = '';

                document.getElementById('modal-title').textContent = `é¸æ“‡èª²ç¨‹ - ${date}`;

                for (const courseKey in dayData) {
                    const courseInfo = appState.manifest.courses[courseKey];
                    const courseData = dayData[courseKey];
                    
                    const courseDiv = document.createElement('div');
                    courseDiv.className = 'p-3 rounded-lg border';
                    courseDiv.style.borderColor = courseInfo.color || '#e5e7eb';
                    
                    const title = document.createElement('h4');
                    title.className = 'font-semibold mb-2';
                    title.textContent = courseInfo.label || courseKey;
                    if (courseData.title) {
                        title.textContent += `ï¼š${courseData.title}`;
                    }
                    courseDiv.appendChild(title);
                    
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'flex gap-2 justify-center';

                    if (courseData.material) {
                        const btn = createModalButton('ğŸ“˜ æ•™æ', courseData.material.url, courseData.material.format, courseInfo.color);
                        buttonsDiv.appendChild(btn);
                    }
                    if (courseData.homework) {
                        const btn = createModalButton('ğŸ“ ä½œæ¥­', courseData.homework.url, courseData.homework.format, courseInfo.color);
                        buttonsDiv.appendChild(btn);
                    }
                    courseDiv.appendChild(buttonsDiv);
                    modalBody.appendChild(courseDiv);
                }

                modal.classList.remove('hidden');
            };
            
            const createModalButton = (text, url, format, color) => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 text-white rounded-md text-sm font-medium focus:outline-none';
                btn.textContent = text;
                btn.style.backgroundColor = color;
                btn.onclick = () => openLink(url, format);
                return btn;
            };

            const openLink = (url, format) => {
                const isExternal = url.startsWith('http');
                const targetUrl = isExternal ? url : `./${url}`;
                
                if (format === 'link' || format === 'pdf' || format === 'image') {
                    window.open(targetUrl, '_blank');
                } else {
                    window.location.href = targetUrl;
                }
            };
            
            document.getElementById('prev-month').addEventListener('click', () => {
                appState.currentDate.setMonth(appState.currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                appState.currentDate.setMonth(appState.currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            document.getElementById('modal-close').addEventListener('click', () => {
                 document.getElementById('course-modal').classList.add('hidden');
            });

            // Initial Load
            fetchManifest();
        });
    </script>
</body>
</html>

=== FILE: docs\students\ray\manifest.json ===
{
  "version": 1,
  "student": "ray",
  "displayName": "Ray",
  "courses": {
    "english": {
      "label": "è‹±æ–‡",
      "color": "#1d4ed8"
    },
    "math": {
      "label": "æ•¸å­¸",
      "color": "#059669"
    }
  },
  "days": {
    "2025-08-10": {
      "english": {
        "title": "åŸºç¤æ–‡æ³• (Sample)",
        "material": {
          "format": "html",
          "url": "materials/ray/english/250810.html"
        }
      }
    }
  }
}

=== FILE: docs\students\ray\english\250810.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡æ•™æ - 2025-08-10</title>
    <meta name="lesson-date" content="2025-08-10">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6">
            <a href="#" onclick="goBack(event)" class="text-blue-600 hover:text-blue-800 hover:underline">&larr; è¿”å›æ—¥æ›†</a>
        </header>
        <main>
            <article class="prose lg:prose-xl bg-white p-6 rounded-lg shadow">
                <h1>åŸºç¤æ–‡æ³• (Sample)</h1>
                <p class="text-gray-500">æ—¥æœŸï¼š2025-08-10</p>
                
                <h2>æ•™æå…§å®¹</h2>
                <p>è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„æ•™æå…§å®¹ã€‚</p>
                <ul>
                    <li>é‡é»ä¸€</li>
                    <li>é‡é»äºŒ</li>
                    <li>é‡é»ä¸‰</li>
                </ul>

            </article>
        </main>
    </div>

    <script>
        function goBack(event) {
            event.preventDefault();
            const studentId = new URLSearchParams(window.location.search).get('student') || 'ray'; // Fallback for direct access
            const lessonDateMeta = document.querySelector('meta[name="lesson-date"]');
            if (lessonDateMeta) {
                const lessonDate = lessonDateMeta.getAttribute('content');
                // Path must be relative to the current location in the /materials/ directory
                const calendarUrl = `../../index.html?student=${studentId}&date=${lessonDate}#calendar-widget`;
                window.location.href = calendarUrl;
            } else {
                // Fallback if meta tag is missing
                const calendarUrl = `../../index.html?student=${studentId}#calendar-widget`;
                window.location.href = calendarUrl;
            }
        }
    </script>
</body>
</html>


=== FILE: docs\admin.html ===
<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Â· Manifest ç·¨è¼¯å™¨</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-3">Manifest ç·¨è¼¯å™¨ï¼ˆé›¢ç·šåŒ¯å‡ºï¼‰</h1>
  <p class="text-gray-600 mb-4">è¼‰å…¥ <code>students/&lt;student&gt;/manifest.json</code>ï¼Œåœ–å½¢åŒ–ç·¨è¼¯æ—¥æœŸ/èª²ç¨‹/æ•™æèˆ‡ä½œæ¥­ï¼ˆå« formatï¼‰ï¼Œæœ€å¾ŒåŒ¯å‡ºæª”æ¡ˆè¦†è“‹å³å¯ã€‚</p>

  <div class="flex flex-wrap items-center gap-2 mb-4">
    <input id="studentId" class="border px-2 py-1 rounded" placeholder="studentï¼ˆé è¨­ rayï¼‰">
    <button id="loadBtn" class="px-3 py-1 bg-blue-600 text-white rounded">è¼‰å…¥</button>
    <input type="file" id="filePicker" class="hidden" accept="application/json">
    <button id="loadFile" class="px-3 py-1 bg-gray-200 rounded">å¾æª”æ¡ˆè¼‰å…¥</button>
    <button id="saveFile" class="px-3 py-1 bg-emerald-600 text-white rounded">åŒ¯å‡º manifest.json</button>
    <span class="text-gray-400">|</span>
    <button id="downloadTpl" class="px-3 py-1 bg-gray-200 rounded">ä¸‹è¼‰ HTML ç¯„æœ¬</button>
  </div>

  <div id="editor" class="space-y-4"></div>
</div>
<script>
const $ = s => document.querySelector(s);
let manifest = null;

async function fetchManifest(student){
  const url = `students/${student}/manifest.json?ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return await res.json();
}
function render(){
  const el = $('#editor');
  if(!manifest){ el.innerHTML = '<p class="text-gray-500">å°šæœªè¼‰å…¥ manifestã€‚</p>'; return; }

  const days = manifest.days || {};
  const courses = manifest.courses || {};
  const dayKeys = Object.keys(days).sort();

  const courseRow = `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">å­¸ç”Ÿï¼š${manifest.displayName||manifest.student}ï¼ˆ${manifest.student}ï¼‰</div>
      <div class="mb-2">èª²ç¨‹æ¸…å–®ï¼š
        ${Object.entries(courses).map(([k,v])=>`<span class="px-2 py-0.5 rounded bg-gray-100 border mr-1">${k}ï¼ˆ${v.label||k}ï¼‰</span>`).join('') || '<span class="text-gray-400">å°šç„¡</span>'}
      </div>
      <div class="flex gap-2 mb-2">
        <input id="newCourseKey" class="border px-2 py-1 rounded" placeholder="course keyï¼ˆå¦‚ englishï¼‰">
        <input id="newCourseLabel" class="border px-2 py-1 rounded" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¦‚ è‹±æ–‡ï¼‰">
        <input id="newCourseColor" class="border px-2 py-1 rounded" placeholder="é¡è‰²ï¼ˆå¦‚ #1d4ed8ï¼‰">
        <button id="addCourse" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢èª²ç¨‹</button>
      </div>
    </div>`;

  const dayRows = dayKeys.map(d=>{
    const map = days[d];
    const items = Object.entries(map).map(([ck, obj])=>{
      const mat = obj.material || {};
      const hw  = obj.homework || {};
      const opt = (sel, v) => sel===v ? 'selected' : '';
      return `
      <div class="p-3 border rounded mb-3">
        <div class="font-medium mb-1">${ck} Â· ${(courses[ck]&&courses[ck].label)||ck}</div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
          <div class="font-semibold text-blue-700">ğŸ“˜ æ•™æ</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="material" data-field="format">
            <option ${opt(mat.format,'html')} value="html">html</option>
            <option ${opt(mat.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(mat.format,'image')} value="image">image</option>
            <option ${opt(mat.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${mat.url||''}" data-date="${d}" data-course="${ck}" data-slot="material" data-field="url">
          <input class="border px-2 py-1 rounded md:col-span-3" placeholder="titleï¼ˆå¯ç©ºï¼‰" value="${obj.title||''}" data-date="${d}" data-course="${ck}" data-field="title">

          <div class="font-semibold text-amber-700 mt-2">ğŸ“ ä½œæ¥­</div>
          <select class="border px-2 py-1 rounded" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="format">
            <option ${opt(hw.format,'html')} value="html">html</option>
            <option ${opt(hw.format,'pdf')} value="pdf">pdf</option>
            <option ${opt(hw.format,'image')} value="image">image</option>
            <option ${opt(hw.format,'link')} value="link">link</option>
          </select>
          <input class="border px-2 py-1 rounded" placeholder="URLï¼ˆç›¸å°æˆ– httpï¼‰" value="${hw.url||''}" data-date="${d}" data-course="${ck}" data-slot="homework" data-field="url">
        </div>
      </div>`;
    }).join('');

    return `
    <details class="mb-3">
      <summary class="cursor-pointer select-none p-2 bg-gray-50 rounded border">${d} Â· ${Object.keys(map).length} é–€èª²</summary>
      <div class="p-2">
        ${items || '<div class="text-gray-500">é€™å¤©å°šç„¡èª²ç¨‹</div>'}
        <div class="flex gap-2 mt-2">
          <select id="addCourseSel_${d}" class="border px-2 py-1 rounded">
            <option value="">é¸æ“‡è¦æ–°å¢çš„èª²ç¨‹</option>
            ${Object.keys(courses).map(k=>`<option value="${k}">${k}ï¼ˆ${courses[k].label||k}ï¼‰</option>`).join('')}
          </select>
          <button data-add="${d}" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢åˆ°æ­¤æ—¥</button>
        </div>
      </div>
    </details>`;
  }).join('');

  el.innerHTML = courseRow + `
    <div class="p-3 rounded border">
      <div class="font-semibold mb-2">æ—¥æœŸæ¸…å–®</div>
      ${dayRows}
      <div class="flex gap-2 mt-4">
        <input id="newDate" class="border px-2 py-1 rounded" placeholder="YYYY-MM-DD">
        <button id="addDate" class="px-3 py-1 bg-gray-200 rounded">æ–°å¢æ—¥æœŸ</button>
      </div>
    </div>`;

  $('#addCourse')?.addEventListener('click', ()=>{
    const key = $('#newCourseKey').value.trim(); if(!key) return alert('course key å¿…å¡«');
    const label = $('#newCourseLabel').value.trim() || key;
    const color = $('#newCourseColor').value.trim() || '#333';
    manifest.courses = manifest.courses || {};
    if(manifest.courses[key]) return alert('å·²å­˜åœ¨ç›¸åŒ key');
    manifest.courses[key] = { label, color };
    render();
  });

  document.querySelectorAll('select[data-field],input[data-field]')?.forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const d = inp.dataset.date, c = inp.dataset.course, slot = inp.dataset.slot, f = inp.dataset.field;
      if (slot) {
        manifest.days[d][c][slot] = manifest.days[d][c][slot] || {};
        manifest.days[d][c][slot][f] = inp.value;
      } else {
        manifest.days[d][c][f] = inp.value;
      }
    });
  });

  document.querySelectorAll('button[data-add]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const d = btn.dataset.add;
      const sel = document.getElementById('addCourseSel_'+d);
      const key = sel.value; if(!key) return;
      manifest.days[d] = manifest.days[d] || {};
      if (!manifest.days[d][key]) manifest.days[d][key] = { title:'', material:{format:'html',url:''}, homework:{format:'html',url:''} };
      render();
    });
  });

  $('#addDate')?.addEventListener('click', ()=>{
    const d = $('#newDate').value.trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert('æ—¥æœŸæ ¼å¼ YYYY-MM-DD');
    manifest.days = manifest.days || {};
    if(manifest.days[d]) return alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
    manifest.days[d] = {};
    render();
  });
}

$('#loadBtn').addEventListener('click', async ()=>{
  const student = ($('#studentId').value || 'ray').trim();
  try { manifest = await fetchManifest(student); render(); }
  catch(e){ alert('è®€å–å¤±æ•—ï¼š'+e.message); }
});

$('#loadFile').addEventListener('click', ()=> $('#filePicker').click());
$('#filePicker').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try { manifest = JSON.parse(txt); render(); }
  catch(e){ alert('JSON è§£æå¤±æ•—'); }
});

$('#saveFile').addEventListener('click', ()=>{
  if(!manifest) return alert('å°šæœªè¼‰å…¥è³‡æ–™');
  const blob = new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'manifest.json';
  a.click(); URL.revokeObjectURL(url);
});

$('#downloadTpl').addEventListener('click', ()=>{
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  const html = `<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="lesson-date" content="${iso}">
<title>æ•™ææ¨£æ¿</title>
<script src="https://cdn.tailwindcss.com"></script>
<body class="bg-gray-100 p-4 sm:p-8">
<div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
<script>(function(){const p=new URLSearchParams(location.search);const student=p.get('student')||'ray';const meta=document.querySelector('meta[name="lesson-date"]')?.content?.trim();const back=meta? \'../index.html?student=\'+student+\'&date=\'+meta+\'#calendar-widget\' : \'../index.html?student=\'+student+\'#calendar-widget\';document.getElementById('breadcrumb').innerHTML = '<a href="'+back+'" class="text-blue-600 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>';})();</script>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-2">æ•™ææ¨™é¡Œ</h1>
  <p class="text-gray-600 mb-6">æŠŠ AI ç”¢çš„å…§å®¹è²¼åˆ°é€™è£¡ã€‚</p>
</div>
</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lesson_template.html';
  a.click(); URL.revokeObjectURL(url);
});
</script>
</body></html>


=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 1,
  "student": "ray",
  "displayName": "Ray",
  "courses": {
    "english": {
      "label": "è‹±æ–‡",
      "color": "#1d4ed8"
    },
    "math": {
      "label": "æ•¸å­¸",
      "color": "#059669"
    }
  },
  "days": {
    "2025-08-08": {},
    "2025-08-01": {}
  }
}

=== FILE: docs\students\ray\english\250810.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡æ•™æ - 2025-08-10</title>
    <meta name="lesson-date" content="2025-08-10">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6">
            <a href="#" onclick="goBack(event)" class="text-blue-600 hover:text-blue-800 hover:underline">&larr; è¿”å›æ—¥æ›†</a>
        </header>
        <main>
            <article class="prose lg:prose-xl bg-white p-6 rounded-lg shadow">
                <h1>åŸºç¤æ–‡æ³• (Sample)</h1>
                <p class="text-gray-500">æ—¥æœŸï¼š2025-08-10</p>
                
                <h2>æ•™æå…§å®¹</h2>
                <p>è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„æ•™æå…§å®¹ã€‚</p>
                <ul>
                    <li>é‡é»ä¸€</li>
                    <li>é‡é»äºŒ</li>
                    <li>é‡é»ä¸‰</li>
                </ul>

            </article>
        </main>
    </div>

    <script>
        function goBack(event) {
            event.preventDefault();
            const studentId = new URLSearchParams(window.location.search).get('student') || 'ray'; // Fallback for direct access
            const lessonDateMeta = document.querySelector('meta[name="lesson-date"]');
            if (lessonDateMeta) {
                const lessonDate = lessonDateMeta.getAttribute('content');
                // Path must be relative to the current location in the /materials/ directory
                const calendarUrl = `../../index.html?student=${studentId}&date=${lessonDate}#calendar-widget`;
                window.location.href = calendarUrl;
            } else {
                // Fallback if meta tag is missing
                const calendarUrl = `../../index.html?student=${studentId}#calendar-widget`;
                window.location.href = calendarUrl;
            }
        }
    </script>
</body>
</html>


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto p-4 md:p-6 max-w-5xl space-y-6">
    <header>
        <h1 class="text-3xl font-bold text-gray-800">å¾Œå°ç®¡ç†ä»‹é¢</h1>
        <p class="text-gray-500">åœ¨æ­¤ç·¨è¼¯ manifest.jsonï¼Œå®Œæˆå¾Œè«‹é»æ“Šã€ŒåŒ¯å‡ºã€ä¸¦æ‰‹å‹•è¦†è“‹æª”æ¡ˆã€‚</p>
    </header>

    <div class="card p-4">
        <div class="flex flex-wrap items-end gap-4">
            <div>
                <label for="student-id-input" class="text-sm font-medium text-gray-700">å­¸ç”Ÿ ID</label>
                <input type="text" id="student-id-input" value="ray" class="mt-1 w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <button id="load-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700">è¼‰å…¥</button>
            <button id="load-file-btn" class="bg-gray-700 text-white font-semibold px-4 py-2 rounded-md hover:bg-gray-800">å¾æª”æ¡ˆè¼‰å…¥</button>
            <div class="flex-grow"></div>
            <button id="export-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-green-700">åŒ¯å‡º manifest.json</button>
        </div>
    </div>

    <div id="editor-panel" class="hidden space-y-6">
        <div id="courses-section" class="card p-4"></div>
        <div id="days-section" class="card p-4"></div>
    </div>
</div>
<input type="file" id="file-picker" class="hidden" accept=".json">

<script>
document.addEventListener('DOMContentLoaded', () => {
    let manifest = null;
    const dom = {
        studentIdInput: document.getElementById('student-id-input'),
        loadBtn: document.getElementById('load-btn'),
        loadFileBtn: document.getElementById('load-file-btn'),
        filePicker: document.getElementById('file-picker'),
        exportBtn: document.getElementById('export-btn'),
        editorPanel: document.getElementById('editor-panel'),
        coursesSection: document.getElementById('courses-section'),
        daysSection: document.getElementById('days-section'),
    };

    const render = () => {
        if (!manifest) {
            dom.editorPanel.classList.add('hidden');
            return;
        }
        renderCourses();
        renderDays();
        attachGeneralListeners();
        dom.editorPanel.classList.remove('hidden');
    };

    const renderCourses = () => {
        const courseItems = Object.entries(manifest.courses).map(([key, { label, color }]) => `
            <div class="flex items-center gap-2 p-2 border-b">
                <input class="p-1 border rounded bg-gray-100 w-28 font-mono text-sm" value="${key}" readonly>
                <input class="p-1 border rounded w-full" value="${label}" data-action="update-course" data-key="${key}" data-prop="label">
                <input type="color" class="h-8 w-10 p-0 border-0" value="${color}" data-action="update-course" data-key="${key}" data-prop="color">
                <button class="text-red-500 hover:text-red-700 font-bold p-1" data-action="delete-course" data-key="${key}">&times;</button>
            </div>`).join('');
        
        dom.coursesSection.innerHTML = `
            <h2 class="text-xl font-bold mb-4">èª²ç¨‹è¨­å®š</h2>
            <div id="course-list">${courseItems}</div>
            <div class="flex items-center gap-2 mt-4 pt-4 border-t">
                <input id="new-course-key" class="p-1 border rounded w-28 font-mono text-sm" placeholder="course_key">
                <input id="new-course-label" class="p-1 border rounded w-full" placeholder="èª²ç¨‹åç¨±">
                <input id="new-course-color" type="color" class="h-8 w-10 p-0" value="#cccccc">
                <button id="add-course-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">æ–°å¢</button>
            </div>`;
    };

    const renderDays = () => {
        const sortedDays = Object.keys(manifest.days).sort((a, b) => b.localeCompare(a));
        const dayItems = sortedDays.map(date => `
            <details class="border rounded-lg" open>
                <summary class="p-3 font-semibold cursor-pointer flex justify-between">
                    <span>${date}</span>
                    <button class="text-red-500 hover:text-red-700 font-bold text-sm" data-action="delete-date" data-date="${date}">åˆªé™¤æ­¤æ—¥</button>
                </summary>
                <div class="p-3 border-t bg-gray-50 space-y-3" data-date-container="${date}">
                    ${Object.entries(manifest.days[date]).map(([courseKey, entry]) => renderDayEntry(date, courseKey, entry)).join('')}
                    <div class="pt-2 border-t flex items-center gap-2">
                        <select class="w-full p-1 border rounded" data-action="select-course-for-date" data-date="${date}">
                            <option value="">-- æ–°å¢èª²ç¨‹è‡³æ­¤æ—¥æœŸ --</option>
                            ${Object.keys(manifest.courses).map(key => `<option value="${key}">${manifest.courses[key].label}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </details>`).join('');

        dom.daysSection.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">æ—¥æœŸç®¡ç†</h2>
                <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="p-1 border rounded">
                    <button id="add-date-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">æ–°å¢æ—¥æœŸ</button>
                </div>
            </div>
            <div class="space-y-4">${dayItems}</div>`;
    };

    const renderDayEntry = (date, courseKey, entry) => {
        const course = manifest.courses[courseKey] || { label: courseKey, color: '#9ca3af' };
        const formats = ["html", "pdf", "image", "link"];
        const renderSlot = (type) => {
            const data = entry[type] || {};
            return `
                <div class="p-2 rounded-md bg-white border">
                    <label class="font-semibold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <select class="w-full p-1 border rounded" data-action="update-entry-sub" data-date="${date}" data-course="${courseKey}" data-type="${type}" data-prop="format">
                            <option value="">-- ç„¡ --</option>
                            ${formats.map(f => `<option value="${f}" ${data.format === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                        <input class="w-full p-1 border rounded ${!data.format ? 'hidden' : ''}" value="${data.url || ''}" placeholder="URL" data-action="update-entry-sub" data-date="${date}" data-course="${courseKey}" data-type="${type}" data-prop="url">
                    </div>
                </div>`;
        };
        return `
            <div class="p-3 border rounded-lg bg-white" style="border-left: 4px solid ${course.color}">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold" style="color: ${course.color}">${course.label}</h4>
                        <input class="w-full p-1 mt-1 border rounded text-sm" value="${entry.title || ''}" placeholder="é¡¯ç¤ºæ¨™é¡Œ..." data-action="update-entry" data-date="${date}" data-course="${courseKey}" data-prop="title">
                    </div>
                    <button class="text-xs text-gray-400 hover:text-red-500" data-action="delete-entry" data-date="${date}" data-course="${courseKey}">ç§»é™¤</button>
                </div>
                <div class="grid md:grid-cols-2 gap-2 mt-2">${renderSlot('material')}${renderSlot('homework')}</div>
            </div>`;
    };

    const attachGeneralListeners = () => {
        // Use event delegation on the editor panel
        dom.editorPanel.addEventListener('change', e => {
            const target = e.target;
            const action = target.dataset.action;

            if (action === 'update-course') {
                const { key, prop } = target.dataset;
                manifest.courses[key][prop] = target.value;
                render(); // Re-render to reflect color changes everywhere
            }
            if (action === 'update-entry') {
                const { date, course, prop } = target.dataset;
                manifest.days[date][course][prop] = target.value;
            }
            if (action === 'update-entry-sub') {
                const { date, course, type, prop } = target.dataset;
                manifest.days[date][course][type] = manifest.days[date][course][type] || {};
                if(target.value) {
                    manifest.days[date][course][type][prop] = target.value;
                } else {
                    delete manifest.days[date][course][type];
                }
                render();
            }
            if (action === 'select-course-for-date') {
                const { date } = target.dataset;
                const courseKey = target.value;
                if (!courseKey || manifest.days[date][courseKey]) {
                    target.value = ""; return;
                }
                manifest.days[date][courseKey] = { title: "" };
                target.value = "";
                render();
            }
        });

        dom.editorPanel.addEventListener('click', e => {
            const target = e.target;
            const action = target.dataset.action;
            if (action === 'delete-course') {
                const { key } = target.dataset;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤èª²ç¨‹ "${key}"ï¼Ÿæ‰€æœ‰æ—¥æœŸä¸‹çš„ç›¸é—œè³‡æ–™å°‡ä¸€ä½µç§»é™¤ï¼`)) return;
                delete manifest.courses[key];
                Object.values(manifest.days).forEach(day => delete day[key]);
                render();
            }
            if (action === 'delete-date') {
                const { date } = target.dataset;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ—¥æœŸ "${date}"ï¼Ÿ`)) return;
                delete manifest.days[date];
                render();
            }
            if (action === 'delete-entry') {
                const { date, course } = target.dataset;
                if (!confirm(`ç¢ºå®šè¦å¾ ${date} ç§»é™¤ ${course} èª²ç¨‹ï¼Ÿ`)) return;
                delete manifest.days[date][course];
                render();
            }
        });
        
        document.getElementById('add-course-btn')?.addEventListener('click', () => {
            const key = document.getElementById('new-course-key').value.trim();
            const label = document.getElementById('new-course-label').value.trim();
            if (!key || !label) { alert('èª²ç¨‹ Key å’Œåç¨±ç‚ºå¿…å¡«'); return; }
            if (manifest.courses[key]) { alert(`èª²ç¨‹ Key "${key}" å·²å­˜åœ¨`); return; }
            manifest.courses[key] = { label, color: document.getElementById('new-course-color').value };
            render();
        });

        document.getElementById('add-date-btn')?.addEventListener('click', () => {
            const date = document.getElementById('new-date-input').value;
            if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
            if (manifest.days[date]) { alert(`æ—¥æœŸ "${date}" å·²å­˜åœ¨`); return; }
            manifest.days[date] = {};
            render();
        });
    };

    dom.loadBtn.onclick = async () => {
        try {
            const student = dom.studentIdInput.value.trim();
            if (!student) { alert('è«‹è¼¸å…¥å­¸ç”ŸID'); return; }
            const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`);
            if (!res.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${student} çš„è³‡æ–™`);
            manifest = await res.json();
            render();
        } catch (e) { alert(`è¼‰å…¥å¤±æ•—: ${e.message}`); }
    };
    
    dom.loadFileBtn.onclick = () => dom.filePicker.click();
    dom.filePicker.onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                manifest = JSON.parse(ev.target.result);
                dom.studentIdInput.value = manifest.student || '';
                render();
            } catch (err) { alert('JSON è§£æå¤±æ•—'); }
        };
        reader.readAsText(e.target.files[0]);
    };

    dom.exportBtn.onclick = () => {
        if (!manifest) return alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
        const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'manifest.json';
        a.click();
        URL.revokeObjectURL(a.href);
    };
});
</script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 1,
  "student": "ray",
  "displayName": "Ray",
  "courses": {
    "english": {
      "label": "è‹±æ–‡",
      "color": "#1d4ed8"
    },
    "math": {
      "label": "æ•¸å­¸",
      "color": "#059669"
    }
  },
  "days": {
    "2025-08-08": {
      "english": {
        "title": "ç¾åœ¨å®Œæˆå¼",
        "material": {
          "format": "html",
          "url": "materials/ray/english/250808.html"
        },
        "homework": {
          "format": "link",
          "url": "https://www.google.com/search?q=present+perfect+exercises"
        }
      },
      "math": {
        "title": "ä¸‰è§’å‡½æ•¸",
        "material": {
          "format": "html",
          "url": "materials/ray/math/250808.html"
        }
      }
    },
    "2025-08-06": {
      "english": {
        "title": "å–®å­—è¤‡ç¿’",
        "homework": {
          "format": "pdf",
          "url": "materials/ray/english/250806_hw.pdf"
        }
      }
    },
    "2025-07-29": {
        "math": {
            "title": "å¹¾ä½•å­¸",
            "material": {
                "format": "html",
                "url": "materials/ray/math/250729.html"
            }
        }
    }
  }
}


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Noto Sans TC', sans-serif; } </style>
</head>
<body class="bg-gray-100">

<div class="container mx-auto p-4 max-w-6xl space-y-4">
    <header class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">ç®¡ç†ç³»çµ±</h1>
        <button id="export-zip-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400">
            åŒ¯å‡ºä½‡åˆ— (ZIP) <span id="queue-count" class="bg-green-800 text-xs rounded-full px-2 py-1 ml-1">0</span>
        </button>
    </header>

    <main>
        <div id="dashboard-view"></div>
        <div id="student-view" class="hidden"></div>
    </main>
</div>

<script type="module">
    // --- State Management ---
    const state = {
        roster: [],
        manifests: {},
        queue: new Map(), // Use Map to handle overwrites easily: path -> {content, type}
        currentStudentId: null,
        currentView: 'dashboard',
    };

    // --- DOM Elements ---
    const dom = {
        dashboardView: document.getElementById('dashboard-view'),
        studentView: document.getElementById('student-view'),
        exportZipBtn: document.getElementById('export-zip-btn'),
        queueCount: document.getElementById('queue-count'),
    };

    // --- View Router ---
    const showView = (viewName, studentId = null) => {
        state.currentView = viewName;
        state.currentStudentId = studentId;
        dom.dashboardView.classList.toggle('hidden', viewName !== 'dashboard');
        dom.studentView.classList.toggle('hidden', viewName !== 'student-view');

        if (viewName === 'dashboard') renderDashboard();
        if (viewName === 'student-view') renderStudentView();
    };
    
    // --- Render Functions ---
    const renderDashboard = () => {
        const studentCards = state.roster.map(s => `
            <div class="bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-lg transition-shadow" data-action="select-student" data-id="${s.id}">
                <h3 class="font-bold text-lg text-blue-700">${s.name}</h3>
                <p class="text-sm text-gray-500">${s.id}</p>
            </div>`).join('');
        dom.dashboardView.innerHTML = `
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">å­¸ç”Ÿåå†Š</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">${studentCards}</div>
                <div class="mt-6 pt-4 border-t">
                    <h3 class="font-semibold">æ–°å¢å­¸ç”Ÿ</h3>
                    <div class="flex gap-2 mt-2">
                        <input id="new-student-id" class="border rounded px-2 py-1 w-1/3" placeholder="ID (è‹±æ–‡, ä¸å¯æ”¹)">
                        <input id="new-student-name" class="border rounded px-2 py-1 w-2/3" placeholder="å§“å">
                        <button data-action="add-student" class="bg-blue-500 text-white px-4 rounded hover:bg-blue-600">åŠ å…¥ä½‡åˆ—</button>
                    </div>
                </div>
            </div>`;
    };

    const renderStudentView = () => {
        const student = state.roster.find(s => s.id === state.currentStudentId);
        const manifest = state.manifests[state.currentStudentId];
        if (!student || !manifest) return;

        const sortedDays = Object.keys(manifest.days).sort().reverse();
        const daySections = sortedDays.map(date => {
            const entries = Object.entries(manifest.courses).map(([courseKey, courseMeta]) => {
                const dayEntry = manifest.days[date]?.[courseKey] || {};
                const materialPath = `docs/materials/${student.id}/${courseKey}/${date.replace(/-/g,'').slice(2)}.html`;
                const homeworkPath = `docs/materials/${student.id}/${courseKey}/${date.replace(/-/g,'').slice(2)}_hw.html`;
                const hasMaterialInQueue = state.queue.has(materialPath);
                const hasHomeworkInQueue = state.queue.has(homeworkPath);
                
                return `
                <div class="p-3 bg-white rounded-lg border" style="border-left: 4px solid ${courseMeta.color};">
                    <h4 class="font-semibold" style="color: ${courseMeta.color}">${courseMeta.label}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        ${renderContentCard(date, student.id, courseKey, 'material', dayEntry.material, hasMaterialInQueue)}
                        ${renderContentCard(date, student.id, courseKey, 'homework', dayEntry.homework, hasHomeworkInQueue)}
                    </div>
                </div>`;
            }).join('');
            return `<details class="bg-gray-50 border rounded-lg" open>
                <summary class="p-3 font-semibold cursor-pointer">${date}</summary>
                <div class="p-3 border-t grid gap-4">${entries}</div>
            </details>`;
        }).join('');

        dom.studentView.innerHTML = `
            <button data-action="back-to-dashboard" class="mb-4 bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">&larr; è¿”å›å„€è¡¨æ¿</button>
            <h2 class="text-2xl font-bold mb-1">æ­£åœ¨ç·¨è¼¯ï¼š${student.name}</h2>
            <p class="text-gray-600 mb-4">æ‰€æœ‰è®Šæ›´éƒ½æœƒå…ˆåŠ å…¥ä½‡åˆ—ï¼Œæœ€å¾Œçµ±ä¸€åŒ¯å‡ºæˆ ZIP æª”ã€‚</p>
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="border rounded p-2">
                    <button data-action="add-date" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md">æ–°å¢æ—¥æœŸ</button>
                </div>
                ${daySections}
            </div>`;
    };

    const renderContentCard = (date, studentId, courseKey, type, existingData, inQueue) => {
        const path = `docs/materials/${studentId}/${courseKey}/${date.replace(/-/g,'').slice(2)}${type === 'homework' ? '_hw' : ''}.html`;
        const queuedContent = state.queue.get(path)?.content;
        return `
        <div class="p-3 rounded-md ${inQueue ? 'bg-yellow-50' : 'bg-gray-50'}">
            <label class="font-bold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
            <textarea class="w-full h-24 border rounded mt-1 p-1 text-xs" placeholder="åœ¨æ­¤è²¼ä¸Š HTML å…§å®¹...">${queuedContent || ''}</textarea>
            <div class="flex items-center justify-between mt-1">
                <button class="text-xs text-blue-600 hover:underline" data-action="preview" data-path="${path}">é è¦½</button>
                <button class="text-xs bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600" data-action="add-to-queue" data-path="${path}" data-date="${date}" data-course="${courseKey}" data-type="${type}" ${inQueue ? 'disabled' : ''}>${inQueue ? 'å·²åœ¨ä½‡åˆ—' : 'åŠ å…¥ä½‡åˆ—'}</button>
            </div>
            ${(existingData && !inQueue) ? '<p class="text-xs text-red-500 mt-1">æ³¨æ„ï¼šæ­¤æ§½ä½å·²æœ‰è³‡æ–™ï¼ŒåŠ å…¥å°‡æœƒè¦†è“‹ã€‚</p>' : ''}
        </div>`;
    };

    // --- Actions & Event Handlers ---
    const handleAction = async (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const { action, id, path, date, course, type } = target.dataset;

        switch (action) {
            case 'select-student':
                if (!state.manifests[id]) {
                    try {
                        const res = await fetch(`students/${id}/manifest.json?ts=${Date.now()}`);
                        if (!res.ok) throw new Error(`æ‰¾ä¸åˆ° ${id} çš„ manifest`);
                        state.manifests[id] = await res.json();
                    } catch (err) { alert(err.message); return; }
                }
                showView('student-view', id);
                break;
            case 'back-to-dashboard':
                showView('dashboard');
                break;
            case 'add-student':
                const newId = document.getElementById('new-student-id').value.trim();
                const newName = document.getElementById('new-student-name').value.trim();
                if (!newId || !newName) { alert('ID å’Œå§“åç‚ºå¿…å¡«'); return; }
                if (state.roster.some(s => s.id === newId)) { alert('è©²å­¸ç”ŸIDå·²å­˜åœ¨'); return; }
                
                state.roster.push({ id: newId, name: newName });
                state.manifests[newId] = createEmptyManifest(newId, newName);
                
                addToQueue(`docs/students/${newId}/manifest.json`, JSON.stringify(state.manifests[newId], null, 2));
                addToQueue(`docs/students/roster.json`, JSON.stringify(state.roster, null, 2), true); // Always overwrite roster
                renderDashboard();
                break;
            case 'add-date':
                const newDate = document.getElementById('new-date-input').value;
                if (!newDate) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
                const manifest = state.manifests[state.currentStudentId];
                if (!manifest.days[newDate]) {
                    manifest.days[newDate] = {};
                    renderStudentView();
                }
                break;
            case 'preview':
                const textarea = target.closest('div').querySelector('textarea');
                const content = textarea.value;
                if (!content) { alert('æ²’æœ‰å…§å®¹å¯é è¦½'); return; }
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(content);
                previewWindow.document.close();
                break;
            case 'add-to-queue':
                const text = target.closest('div').querySelector('textarea').value;
                if (!text) { alert('HTML å…§å®¹ä¸å¯ç‚ºç©º'); return; }
                
                const existingManifestEntry = state.manifests[state.currentStudentId]?.days[date]?.[course]?.[type];
                if (existingManifestEntry && !confirm(`æ­¤æ§½ä½å·²æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;

                addToQueue(path, text);
                updateManifestInState(state.currentStudentId, date, course, type, path);
                renderStudentView();
                break;
        }
    };

    // --- Helper & Core Logic ---
    const addToQueue = (path, content, overwrite = false) => {
        if (!overwrite && state.queue.has(path)) {
            if (!confirm(`ä½‡åˆ—ä¸­å·²æœ‰åŒè·¯å¾‘æª”æ¡ˆ (${path})ï¼Œè¦è¦†è“‹å—ï¼Ÿ`)) return;
        }
        state.queue.set(path, { content });
        updateQueueCount();
    };
    
    const updateManifestInState = (studentId, date, course, type, url) => {
        const manifest = state.manifests[studentId];
        manifest.days[date] = manifest.days[date] || {};
        manifest.days[date][course] = manifest.days[date][course] || {};
        manifest.days[date][course][type] = { format: "html", url: url.replace('docs/', '') };
        addToQueue(`docs/students/${studentId}/manifest.json`, JSON.stringify(manifest, null, 2), true);
    };

    const updateQueueCount = () => {
        dom.queueCount.textContent = state.queue.size;
        dom.exportZipBtn.disabled = state.queue.size === 0;
    };
    
    const createEmptyManifest = (id, name) => ({
        version: 2, student: id, displayName: name,
        courses: { english: { label: "è‹±æ–‡", color: "#1d4ed8" } },
        days: {},
    });

    const exportZip = () => {
        if (state.queue.size === 0) return;
        const zip = new JSZip();
        for (const [path, { content }] of state.queue.entries()) {
            zip.file(path, content);
        }
        zip.generateAsync({ type: "blob" })
            .then(blob => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `update_${new Date().toISOString().slice(0,10)}.zip`;
                a.click();
                URL.revokeObjectURL(a.href);
            });
    };

    // --- Initializer ---
    const init = async () => {
        try {
            const res = await fetch('students/roster.json?ts=' + Date.now());
            if (!res.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š roster.jsonï¼Œè«‹å…ˆå»ºç«‹è©²æª”æ¡ˆã€‚");
            state.roster = await res.json();
            showView('dashboard');
        } catch (err) {
            dom.dashboardView.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">${err.message}</div>`;
        }
        document.addEventListener('click', handleAction);
        dom.exportZipBtn.addEventListener('click', exportZip);
    };

    init();
</script>

</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .day-cell { aspect-ratio: 1 / 1; }
    .today-highlight { background-color: #3b82f6; color: white; }
    .selected-highlight { box-shadow: 0 0 0 2px #2563eb; }
    .dot {
      height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
      position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-2xl mx-auto p-4 sm:p-6">
    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <div class="mt-2 flex justify-center items-center gap-2">
        <p class="text-gray-500" id="student-display"></p>
        <select id="student-switcher" class="rounded-md border-gray-300 shadow-sm"></select>
      </div>
    </header>

    <main class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
      <div id="error-display" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4"></div>
      <div id="calendar-widget">
        <div class="flex items-center justify-between mb-4">
          <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">&lt;</button>
          <h2 id="month-year" class="text-xl font-bold text-gray-700 w-32 text-center"></h2>
          <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">&gt;</button>
        </div>
        <div class="grid grid-cols-7 text-center text-sm font-semibold text-gray-500 mb-2">
          <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
        </div>
        <div id="calendar-grid" class="grid grid-cols-7"></div>
      </div>
    </main>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
    <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-sm"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const state = { studentId: '', roster: [], manifest: null, currentDate: new Date(), today: new Date() };
      const dom = {
        studentDisplay: document.getElementById('student-display'),
        studentSwitcher: document.getElementById('student-switcher'),
        errorDisplay: document.getElementById('error-display'),
        calendarWidget: document.getElementById('calendar-widget'),
        calendarGrid: document.getElementById('calendar-grid'),
        monthYear: document.getElementById('month-year'),
        modal: document.getElementById('modal'),
        modalContent: document.getElementById('modal-content'),
      };

      function showError(message) {
        dom.errorDisplay.textContent = message;
        dom.errorDisplay.classList.remove('hidden');
        dom.calendarWidget.classList.add('hidden');
      }
      
      function renderCalendar() { /* ... (Same as previous correct version) ... */ }
      function handleDayClick(dateStr, dayData) { /* ... (Same as previous correct version) ... */ }
      function showModal(dateStr, dayData) { /* ... (Same as previous correct version, but simplified for HTML only) ... */ }

      function renderCalendar() {
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        dom.monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        dom.calendarGrid.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
          dom.calendarGrid.insertAdjacentHTML('beforeend', '<div class="day-cell"></div>');
        }

        const todayStr = state.today.toISOString().slice(0, 10);
        const selectedDateStr = new URLSearchParams(window.location.search).get('date');

        for (let i = 1; i <= daysInMonth; i++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          const dayData = state.manifest.days[dateStr];
          const cell = document.createElement('div');
          cell.className = 'day-cell relative flex justify-center items-center rounded-lg';
          
          const content = document.createElement('span');
          content.textContent = i;
          content.className = 'w-8 h-8 flex items-center justify-center rounded-full transition-colors';
          
          if (dateStr === todayStr) content.classList.add('today-highlight');
          if (dateStr === selectedDateStr) cell.classList.add('selected-highlight');
          
          if (dayData && Object.keys(dayData).length > 0) {
            cell.classList.add('cursor-pointer');
            content.classList.add('hover:bg-gray-200');
            cell.innerHTML += '<div class="dot"></div>';
            cell.addEventListener('click', () => handleDayClick(dateStr, dayData));
          }
          
          cell.appendChild(content);
          dom.calendarGrid.appendChild(cell);
        }
      }

      function handleDayClick(dateStr, dayData) {
        const courses = Object.keys(dayData);
        if (courses.length === 1) {
          const entry = dayData[courses[0]];
          const target = entry.material || entry.homework;
          if (target && target.url) window.location.href = target.url;
        } else {
          showModal(dateStr, dayData);
        }
      }

      function showModal(dateStr, dayData) {
        let itemsHtml = '';
        for (const [courseKey, entry] of Object.entries(dayData)) {
          const courseMeta = state.manifest.courses[courseKey] || { label: courseKey, color: '#6b7280' };
          const title = entry.title ? `: ${entry.title}` : '';
          let links = '';
          if (entry.material && entry.material.url) links += `<a href="${entry.material.url}" class="block text-center w-full px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-800 rounded-md">ğŸ“˜ æ•™æ</a>`;
          if (entry.homework && entry.homework.url) links += `<a href="${entry.homework.url}" class="block text-center w-full px-4 py-2 bg-green-50 hover:bg-green-100 text-green-800 rounded-md">ğŸ“ ä½œæ¥­</a>`;
          
          if(links) {
              itemsHtml += `<div class="p-3 border-t">
                  <h4 class="font-semibold mb-2" style="color:${courseMeta.color}">${courseMeta.label}${title}</h4>
                  <div class="flex flex-col space-y-2">${links}</div>
              </div>`;
          }
        }
        dom.modalContent.innerHTML = `
          <div class="flex justify-between items-center p-4">
            <h3 class="font-bold text-lg">${dateStr}</h3>
            <button id="close-modal" class="text-gray-400 hover:text-gray-800">&times;</button>
          </div>
          <div class="max-h-[60vh] overflow-y-auto">${itemsHtml}</div>`;
        dom.modal.classList.remove('hidden');
        dom.modal.querySelector('#close-modal').onclick = () => dom.modal.classList.add('hidden');
      }

      async function init() {
        try {
            const rosterRes = await fetch('students/roster.json?ts=' + Date.now());
            if(!rosterRes.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š roster.json");
            state.roster = await rosterRes.json();
            
            const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
            state.studentId = studentIdFromUrl || (state.roster[0] ? state.roster[0].id : null);
            
            if (!state.studentId) throw new Error("åå†Šç‚ºç©ºï¼Œä¸”ç¶²å€æœªæŒ‡å®šå­¸ç”Ÿ");
            
            dom.studentSwitcher.innerHTML = state.roster.map(s => `<option value="${s.id}" ${s.id === state.studentId ? 'selected' : ''}>${s.name}</option>`).join('');
            dom.studentSwitcher.onchange = () => {
                window.location.search = `?student=${dom.studentSwitcher.value}`;
            };
            
            const manifestRes = await fetch(`students/${state.studentId}/manifest.json?ts=${Date.now()}`);
            if (!manifestRes.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${state.studentId} çš„è³‡æ–™`);
            state.manifest = await manifestRes.json();
            
            dom.studentDisplay.textContent = `å­¸ç”Ÿï¼š${state.manifest.displayName || state.studentId}`;
            renderCalendar();
        } catch (e) {
            showError(e.message);
        }
      }

      document.getElementById('prev-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); };
      document.getElementById('next-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); };
      dom.modal.onclick = (e) => { if (e.target === dom.modal) dom.modal.classList.add('hidden'); };

      init();
    });
  </script>
</body>
</html>

=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": {
      "label": "è‹±æ–‡",
      "color": "#1d4ed8"
    },
    "math": {
      "label": "æ•¸å­¸",
      "color": "#059669"
    }
  },
  "days": {}
}

=== FILE: docs\students\ray\roster.json ===
[
  {
    "id": "ray",
    "name": "Ray Chen"
  },
  {
    "id": "sally",
    "name": "Sally Lin"
  }
]


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto p-4 md:p-6 max-w-5xl space-y-6">
    <header>
        <h1 class="text-3xl font-bold text-gray-800">å¾Œå°ç®¡ç†ä»‹é¢</h1>
        <p class="text-gray-500">åœ¨æ­¤ç·¨è¼¯ manifest.jsonï¼Œå®Œæˆå¾Œè«‹é»æ“Šã€ŒåŒ¯å‡ºã€ä¸¦æ‰‹å‹•è¦†è“‹æª”æ¡ˆã€‚</p>
    </header>

    <div class="card p-4">
        <div class="flex flex-wrap items-end gap-4">
            <div>
                <label for="student-id-input" class="text-sm font-medium text-gray-700">å­¸ç”Ÿ ID</label>
                <input type="text" id="student-id-input" value="ray" class="mt-1 w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <button id="load-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700">è¼‰å…¥</button>
            <button id="load-file-btn" class="bg-gray-700 text-white font-semibold px-4 py-2 rounded-md hover:bg-gray-800">å¾æª”æ¡ˆè¼‰å…¥</button>
            <div class="flex-grow"></div>
            <button id="export-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-green-700">åŒ¯å‡º manifest.json</button>
        </div>
    </div>

    <div id="editor-panel" class="hidden space-y-6">
        <div id="courses-section" class="card p-4"></div>
        <div id="days-section" class="card p-4"></div>
    </div>
</div>
<input type="file" id="file-picker" class="hidden" accept=".json">

<script>
document.addEventListener('DOMContentLoaded', () => {
    let manifest = null;
    const dom = {
        studentIdInput: document.getElementById('student-id-input'),
        loadBtn: document.getElementById('load-btn'),
        loadFileBtn: document.getElementById('load-file-btn'),
        filePicker: document.getElementById('file-picker'),
        exportBtn: document.getElementById('export-btn'),
        editorPanel: document.getElementById('editor-panel'),
        coursesSection: document.getElementById('courses-section'),
        daysSection: document.getElementById('days-section'),
    };

    const render = () => {
        if (!manifest) {
            dom.editorPanel.classList.add('hidden');
            return;
        }
        renderCourses();
        renderDays();
        attachGeneralListeners();
        dom.editorPanel.classList.remove('hidden');
    };

    const renderCourses = () => {
        const courseItems = Object.entries(manifest.courses).map(([key, { label, color }]) => `
            <div class="flex items-center gap-2 p-2 border-b">
                <input class="p-1 border rounded bg-gray-100 w-28 font-mono text-sm" value="${key}" readonly>
                <input class="p-1 border rounded w-full" value="${label}" data-action="update-course" data-key="${key}" data-prop="label">
                <input type="color" class="h-8 w-10 p-0 border-0" value="${color}" data-action="update-course" data-key="${key}" data-prop="color">
                <button class="text-red-500 hover:text-red-700 font-bold p-1" data-action="delete-course" data-key="${key}">&times;</button>
            </div>`).join('');
        
        dom.coursesSection.innerHTML = `
            <h2 class="text-xl font-bold mb-4">èª²ç¨‹è¨­å®š</h2>
            <div id="course-list">${courseItems}</div>
            <div class="flex items-center gap-2 mt-4 pt-4 border-t">
                <input id="new-course-key" class="p-1 border rounded w-28 font-mono text-sm" placeholder="course_key">
                <input id="new-course-label" class="p-1 border rounded w-full" placeholder="èª²ç¨‹åç¨±">
                <input id="new-course-color" type="color" class="h-8 w-10 p-0" value="#cccccc">
                <button id="add-course-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">æ–°å¢</button>
            </div>`;
    };

    const renderDays = () => {
        const sortedDays = Object.keys(manifest.days).sort((a, b) => b.localeCompare(a));
        const dayItems = sortedDays.map(date => `
            <details class="border rounded-lg" open>
                <summary class="p-3 font-semibold cursor-pointer flex justify-between">
                    <span>${date}</span>
                    <button class="text-red-500 hover:text-red-700 font-bold text-sm" data-action="delete-date" data-date="${date}">åˆªé™¤æ­¤æ—¥</button>
                </summary>
                <div class="p-3 border-t bg-gray-50 space-y-3" data-date-container="${date}">
                    ${Object.entries(manifest.days[date]).map(([courseKey, entry]) => renderDayEntry(date, courseKey, entry)).join('')}
                    <div class="pt-2 border-t flex items-center gap-2">
                        <select class="w-full p-1 border rounded" data-action="select-course-for-date" data-date="${date}">
                            <option value="">-- æ–°å¢èª²ç¨‹è‡³æ­¤æ—¥æœŸ --</option>
                            ${Object.keys(manifest.courses).map(key => `<option value="${key}">${manifest.courses[key].label}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </details>`).join('');

        dom.daysSection.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">æ—¥æœŸç®¡ç†</h2>
                <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="p-1 border rounded">
                    <button id="add-date-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm">æ–°å¢æ—¥æœŸ</button>
                </div>
            </div>
            <div class="space-y-4">${dayItems}</div>`;
    };

    const renderDayEntry = (date, courseKey, entry) => {
        const course = manifest.courses[courseKey] || { label: courseKey, color: '#9ca3af' };
        const formats = ["html", "pdf", "image", "link"];
        const renderSlot = (type) => {
            const data = entry[type] || {};
            return `
                <div class="p-2 rounded-md bg-white border">
                    <label class="font-semibold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <select class="w-full p-1 border rounded" data-action="update-entry-sub" data-date="${date}" data-course="${courseKey}" data-type="${type}" data-prop="format">
                            <option value="">-- ç„¡ --</option>
                            ${formats.map(f => `<option value="${f}" ${data.format === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                        <input class="w-full p-1 border rounded ${!data.format ? 'hidden' : ''}" value="${data.url || ''}" placeholder="URL" data-action="update-entry-sub" data-date="${date}" data-course="${courseKey}" data-type="${type}" data-prop="url">
                    </div>
                </div>`;
        };
        return `
            <div class="p-3 border rounded-lg bg-white" style="border-left: 4px solid ${course.color}">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold" style="color: ${course.color}">${course.label}</h4>
                        <input class="w-full p-1 mt-1 border rounded text-sm" value="${entry.title || ''}" placeholder="é¡¯ç¤ºæ¨™é¡Œ..." data-action="update-entry" data-date="${date}" data-course="${courseKey}" data-prop="title">
                    </div>
                    <button class="text-xs text-gray-400 hover:text-red-500" data-action="delete-entry" data-date="${date}" data-course="${courseKey}">ç§»é™¤</button>
                </div>
                <div class="grid md:grid-cols-2 gap-2 mt-2">${renderSlot('material')}${renderSlot('homework')}</div>
            </div>`;
    };

    const attachGeneralListeners = () => {
        // Use event delegation on the editor panel
        dom.editorPanel.addEventListener('change', e => {
            const target = e.target;
            const action = target.dataset.action;

            if (action === 'update-course') {
                const { key, prop } = target.dataset;
                manifest.courses[key][prop] = target.value;
                render(); // Re-render to reflect color changes everywhere
            }
            if (action === 'update-entry') {
                const { date, course, prop } = target.dataset;
                manifest.days[date][course][prop] = target.value;
            }
            if (action === 'update-entry-sub') {
                const { date, course, type, prop } = target.dataset;
                manifest.days[date][course][type] = manifest.days[date][course][type] || {};
                if(target.value) {
                    manifest.days[date][course][type][prop] = target.value;
                } else {
                    delete manifest.days[date][course][type];
                }
                render();
            }
            if (action === 'select-course-for-date') {
                const { date } = target.dataset;
                const courseKey = target.value;
                if (!courseKey || manifest.days[date][courseKey]) {
                    target.value = ""; return;
                }
                manifest.days[date][courseKey] = { title: "" };
                target.value = "";
                render();
            }
        });

        dom.editorPanel.addEventListener('click', e => {
            const target = e.target;
            const action = target.dataset.action;
            if (action === 'delete-course') {
                const { key } = target.dataset;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤èª²ç¨‹ "${key}"ï¼Ÿæ‰€æœ‰æ—¥æœŸä¸‹çš„ç›¸é—œè³‡æ–™å°‡ä¸€ä½µç§»é™¤ï¼`)) return;
                delete manifest.courses[key];
                Object.values(manifest.days).forEach(day => delete day[key]);
                render();
            }
            if (action === 'delete-date') {
                const { date } = target.dataset;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ—¥æœŸ "${date}"ï¼Ÿ`)) return;
                delete manifest.days[date];
                render();
            }
            if (action === 'delete-entry') {
                const { date, course } = target.dataset;
                if (!confirm(`ç¢ºå®šè¦å¾ ${date} ç§»é™¤ ${course} èª²ç¨‹ï¼Ÿ`)) return;
                delete manifest.days[date][course];
                render();
            }
        });
        
        document.getElementById('add-course-btn')?.addEventListener('click', () => {
            const key = document.getElementById('new-course-key').value.trim();
            const label = document.getElementById('new-course-label').value.trim();
            if (!key || !label) { alert('èª²ç¨‹ Key å’Œåç¨±ç‚ºå¿…å¡«'); return; }
            if (manifest.courses[key]) { alert(`èª²ç¨‹ Key "${key}" å·²å­˜åœ¨`); return; }
            manifest.courses[key] = { label, color: document.getElementById('new-course-color').value };
            render();
        });

        document.getElementById('add-date-btn')?.addEventListener('click', () => {
            const date = document.getElementById('new-date-input').value;
            if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
            if (manifest.days[date]) { alert(`æ—¥æœŸ "${date}" å·²å­˜åœ¨`); return; }
            manifest.days[date] = {};
            render();
        });
    };

    dom.loadBtn.onclick = async () => {
        try {
            const student = dom.studentIdInput.value.trim();
            if (!student) { alert('è«‹è¼¸å…¥å­¸ç”ŸID'); return; }
            const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`);
            if (!res.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${student} çš„è³‡æ–™`);
            manifest = await res.json();
            render();
        } catch (e) { alert(`è¼‰å…¥å¤±æ•—: ${e.message}`); }
    };
    
    dom.loadFileBtn.onclick = () => dom.filePicker.click();
    dom.filePicker.onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                manifest = JSON.parse(ev.target.result);
                dom.studentIdInput.value = manifest.student || '';
                render();
            } catch (err) { alert('JSON è§£æå¤±æ•—'); }
        };
        reader.readAsText(e.target.files[0]);
    };

    dom.exportBtn.onclick = () => {
        if (!manifest) return alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
        const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'manifest.json';
        a.click();
        URL.revokeObjectURL(a.href);
    };
});
</script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹æ—¥æ›†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
    .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
    .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%;
           position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
      <p class="text-lg text-gray-600">ä½¿ç”¨ ?student=ray æŒ‡å®šå­¸ç”Ÿï¼›æœ‰è³‡æ–™çš„æ—¥æœŸæœƒæœ‰ç¶ é»</p>
    </header>

    <main>
      <section id="calendar-widget">
        <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">èª²ç¨‹æ—¥æ›†</h2>
        <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-inner">
          <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
            <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
            <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
          </div>

          <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </section>
    </main>

    <footer class="text-center mt-16 pt-8 border-t border-gray-200">
      <p class="text-gray-500">Powered by GitHub Pages Â· Adminï¼š<a href="admin.html" class="text-blue-600 underline">admin.html</a></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarGrid = document.getElementById('calendar-grid');
      const monthYearDisplay = document.getElementById('month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');

      const params = new URLSearchParams(location.search);
      const student = params.get('student') || 'ray';
      const qDate = params.get('date');
      let currentDate = qDate && !isNaN(Date.parse(qDate)) ? new Date(qDate) : new Date();
      let selectedDate = qDate || null;

      let manifest = { days: {}, courses: {} };
      try {
        const res = await fetch(`students/${student}/manifest.json?ts=${Date.now()}`, { cache: 'no-store' });
        if (res.ok) manifest = await res.json();
        else console.warn('è®€ manifest å¤±æ•—ï¼š', res.status);
      } catch (e) { console.warn('è®€ manifest éŒ¯èª¤ï¼š', e); }

      function hasAnyCourse(dateStr){ return Boolean(manifest.days && manifest.days[dateStr]); }

      function openCoursePicker(dateStr, coursesMap, courseMeta) {
        const items = Object.entries(coursesMap).map(([key, obj])=>{
          const label = (courseMeta[key] && courseMeta[key].label) || key;
          const m = obj.material ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.material.url}">ğŸ“˜ ${label}ï¼šæ•™æ</a>` : '';
          const h = obj.homework ? `<a class="block px-4 py-2 hover:bg-gray-100 rounded" href="${obj.homework.url}" target="${obj.homework.format==='link'?'_blank':'_self'}">ğŸ“ ${label}ï¼šä½œæ¥­</a>` : '';
          return m + h;
        }).join('');
        const wrap = document.createElement('div');
        wrap.className = 'fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50';
        wrap.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3>
              <button class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded" id="close-picker">âœ•</button>
            </div>
            <div class="space-y-2">${items || '<div class="text-gray-500">æ²’æœ‰å¯ç”¨è³‡æ–™</div>'}</div>
          </div>`;
        document.body.appendChild(wrap);
        wrap.querySelector('#close-picker').onclick = () => wrap.remove();
        wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        const today = new Date();

        monthYearDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGrid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=é€±æ—¥
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
        const lastDateOfPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDayOfMonth; i > 0; i--) {
          const day = lastDateOfPrevMonth - i + 1;
          calendarGrid.innerHTML += `<div class="p-2 text-gray-300">${day}</div>`;
        }

        for (let i = 1; i <= lastDateOfMonth; i++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'p-2 relative flex justify-center items-center cursor-pointer';

          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

          let content;
          if (hasAnyCourse(dateStr)) {
            dayCell.classList.add('has-material');
            content = document.createElement('a');
            content.innerHTML = `${i}<span class="dot"></span>`;
            content.className = 'w-full h-full flex justify-center items-center';
            content.addEventListener('click', (ev)=>{
              ev.preventDefault();
              const courses = manifest.days[dateStr];
              const keys = Object.keys(courses||{});
              if (keys.length===1) {
                const c = courses[keys[0]];
                const target = c.material ? c.material.url : (c.homework ? c.homework.url : null);
                if (target) location.href = target;
              } else {
                openCoursePicker(dateStr, courses, manifest.courses||{});
              }
            });
          } else {
            content = document.createElement('span');
            content.textContent = i;
          }

          const todayY = today.getFullYear(), todayM = today.getMonth(), todayD = today.getDate();
          if (year === todayY && month === todayM && i === todayD) (content.tagName === 'A' ? content : dayCell).classList.add('today');

          if (selectedDate && dateStr === selectedDate) dayCell.classList.add('ring-2','ring-blue-500','rounded-full');

          dayCell.appendChild(content);
          calendarGrid.appendChild(dayCell);
        }
      }

      prevMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });

      renderCalendar();
    });
  </script>
</body>
</html>


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": {
      "label": "è‹±æ–‡",
      "color": "#1d4ed8"
    },
    "math": {
      "label": "æ•¸å­¸",
      "color": "#059669"
    }
  },
  "days": {}
}

=== FILE: docs\students\ray\roster.json ===
[
  {
    "id": "ray",
    "name": "Ray Chen"
  },
  {
    "id": "sally",
    "name": "Sally Lin"
  }
]


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; } 
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4 md:p-6 max-w-6xl space-y-6">
    <header class="flex flex-wrap justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">å¾Œå°ç®¡ç†ä»‹é¢</h1>
            <p class="text-gray-500">æ‰€æœ‰è®Šæ›´å°‡åŠ å…¥ä½‡åˆ—ï¼Œæœ€å¾Œçµ±ä¸€åŒ¯å‡ºç‚º ZIP æª”ã€‚</p>
        </div>
        <button id="export-zip-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400" disabled>
            åŒ¯å‡ºä½‡åˆ— (ZIP) <span id="queue-count" class="bg-green-800 text-xs rounded-full px-2 py-1 ml-1">0</span>
        </button>
    </header>

    <div id="editor-container" class="space-y-6">
        </div>
</div>

<script type="module">
    const state = { roster: [], manifests: {}, queue: new Map(), currentStudentId: null };
    const dom = { container: document.getElementById('editor-container'), queueCount: document.getElementById('queue-count'), exportBtn: document.getElementById('export-zip-btn') };

    const render = () => {
        const student = state.roster.find(s => s.id === state.currentStudentId);
        const manifest = state.manifests[state.currentStudentId];
        dom.container.innerHTML = `
            ${renderTopBar()}
            ${student && manifest ? renderStudentEditor(student, manifest) : ''}
        `;
        attachListeners();
    };

    const renderTopBar = () => {
        const studentOptions = state.roster.map(s => `<option value="${s.id}" ${s.id === state.currentStudentId ? 'selected' : ''}>${s.name}</option>`).join('');
        return `
        <div class="card p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é¸æ“‡å­¸ç”Ÿ</label>
                    <select id="student-switcher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${studentOptions}</select>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700">æ–°å¢å­¸ç”Ÿ</h3>
                    <div class="flex gap-2 mt-1">
                        <input id="new-student-id" class="border rounded px-2 py-1 w-1/2" placeholder="ID (è‹±æ–‡)">
                        <input id="new-student-name" class="border rounded px-2 py-1 w-1/2" placeholder="å§“å">
                        <button data-action="add-student" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600 text-sm">åŠ å…¥ä½‡åˆ—</button>
                    </div>
                </div>
            </div>
        </div>`;
    };

    const renderStudentEditor = (student, manifest) => {
        const sortedDays = Object.keys(manifest.days).sort((a,b) => b.localeCompare(a));
        const daySections = sortedDays.map(date => {
            const entries = Object.entries(manifest.courses).map(([courseKey, courseMeta]) => {
                const dayEntry = manifest.days[date]?.[courseKey] || {};
                return `<div class="p-3 bg-white rounded-lg border" style="border-left: 4px solid ${courseMeta.color};">
                    <h4 class="font-semibold" style="color: ${courseMeta.color}">${courseMeta.label}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        ${renderContentCard(date, student.id, courseKey, 'material', dayEntry.material)}
                        ${renderContentCard(date, student.id, courseKey, 'homework', dayEntry.homework)}
                    </div>
                </div>`;
            }).join('');
            return `<details class="bg-gray-50 border rounded-lg" open>
                <summary class="p-3 font-semibold cursor-pointer">${date}</summary>
                <div class="p-3 border-t grid gap-4">${entries}</div>
            </details>`;
        }).join('');
        
        return `
        <div class="card p-4 space-y-4">
            <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold">æ—¥æœŸç®¡ç† for ${student.name}</h2>
                 <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="border rounded p-2">
                    <button data-action="add-date" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md text-sm">æ–°å¢æ—¥æœŸ</button>
                 </div>
            </div>
            <div class="space-y-4">${daySections}</div>
        </div>`;
    };
    
    const renderContentCard = (date, studentId, courseKey, type, existingData) => {
        const fileName = `${date.replace(/-/g, '').slice(2)}${type === 'homework' ? '_hw' : ''}.html`;
        const path = `docs/materials/${studentId}/${courseKey}/${fileName}`;
        const queueItem = state.queue.get(path);
        const inQueue = !!queueItem;
        const hasExistingData = !!existingData && !inQueue;

        return `
        <div class="p-3 rounded-md ${inQueue ? 'bg-yellow-100 border-yellow-300' : 'bg-white'} border">
            <label class="font-bold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
            <textarea class="w-full h-24 border rounded mt-1 p-1 text-xs font-mono" placeholder="è²¼ä¸Š HTML...">${queueItem?.content || ''}</textarea>
            <div class="flex items-center justify-between mt-1">
                <button class="text-xs text-blue-600 hover:underline" data-action="preview">é è¦½</button>
                <button class="text-xs bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600 disabled:bg-gray-400" data-action="add-to-queue" data-path="${path}" data-date="${date}" data-course="${courseKey}" data-type="${type}" data-is-overwrite="${hasExistingData}" ${inQueue ? 'disabled' : ''}>${inQueue ? 'å·²åœ¨ä½‡åˆ—' : 'åŠ å…¥ä½‡åˆ—'}</button>
            </div>
            ${hasExistingData ? '<p class="text-xs text-red-500 mt-1">æ³¨æ„ï¼šæ­¤è™•å·²æœ‰è³‡æ–™ï¼ŒåŠ å…¥å°‡è¦†è“‹ã€‚</p>' : ''}
        </div>`;
    };

    const handleAction = async (e) => {
        const target = e.target;
        const action = target.closest('[data-action]')?.dataset.action;
        if (!action) return;

        const { id, path, date, course, type, isOverwrite } = target.closest('[data-action]').dataset;

        switch (action) {
            case 'add-student':
                const newId = document.getElementById('new-student-id').value.trim();
                const newName = document.getElementById('new-student-name').value.trim();
                if (!newId || !newName || !/^[a-zA-Z0-9_-]+$/.test(newId)) { alert('ID å’Œå§“åç‚ºå¿…å¡«ï¼Œä¸” ID åªèƒ½æ˜¯è‹±æ–‡/æ•¸å­—'); return; }
                if (state.roster.some(s => s.id === newId)) { alert('è©²å­¸ç”ŸIDå·²å­˜åœ¨'); return; }
                
                const updatedRoster = [...state.roster, { id: newId, name: newName }];
                const newManifest = createEmptyManifest(newId, newName);
                addToQueue(`docs/students/roster.json`, JSON.stringify(updatedRoster, null, 2));
                addToQueue(`docs/students/${newId}/manifest.json`, JSON.stringify(newManifest, null, 2));
                
                state.roster = updatedRoster;
                state.manifests[newId] = newManifest;
                render();
                break;
            case 'add-date':
                const newDate = document.getElementById('new-date-input').value;
                if (!newDate) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
                if (state.manifests[state.currentStudentId].days[newDate]) { alert(`æ—¥æœŸ "${newDate}" å·²å­˜åœ¨`); return; }
                state.manifests[state.currentStudentId].days[newDate] = {};
                render();
                break;
            case 'preview':
                const content = target.closest('div.p-3').querySelector('textarea').value;
                if (content) window.open('', '_blank').document.write(content);
                else alert('æ²’æœ‰å…§å®¹å¯é è¦½');
                break;
            case 'add-to-queue':
                const text = target.closest('div.p-3').querySelector('textarea').value;
                if (!text) { alert('HTML å…§å®¹ä¸å¯ç‚ºç©º'); return; }
                if (isOverwrite === 'true' && !confirm(`æ­¤æ§½ä½å·²æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
                addToQueue(path, text);
                updateManifestInState(state.currentStudentId, date, course, type, path);
                render();
                break;
        }
    };

    const loadStudent = async (studentId) => {
        if (!studentId) return;
        state.currentStudentId = studentId;
        if (!state.manifests[studentId]) {
             try {
                const res = await fetch(`students/${studentId}/manifest.json?ts=${Date.now()}`);
                state.manifests[studentId] = res.ok ? await res.json() : createEmptyManifest(studentId, state.roster.find(s=>s.id===studentId).name);
            } catch { state.manifests[studentId] = createEmptyManifest(studentId, state.roster.find(s=>s.id===studentId).name); }
        }
        render();
    };

    const addToQueue = (path, content) => {
        state.queue.set(path, { content });
        updateQueueCount();
    };
    
    const updateManifestInState = (studentId, date, course, type, url) => {
        const manifest = state.manifests[studentId];
        manifest.days[date][course] = manifest.days[date][course] || {};
        manifest.days[date][course][type] = { format: "html", url: url.replace('docs/', '') };
        addToQueue(`docs/students/${studentId}/manifest.json`, JSON.stringify(manifest, null, 2));
    };

    const updateQueueCount = () => {
        dom.queueCount.textContent = state.queue.size;
        dom.exportBtn.disabled = state.queue.size === 0;
    };
    
    const createEmptyManifest = (id, name) => ({
        version: 2, student: id, displayName: name,
        courses: { english: { label: "è‹±æ–‡", color: "#1d4ed8" }, math: { label: "æ•¸å­¸", color: "#059669" } },
        days: {},
    });

    const exportZip = () => {
        if (state.queue.size === 0) return alert("ä½‡åˆ—æ˜¯ç©ºçš„ï¼");
        const zip = new JSZip();
        for (const [path, { content }] of state.queue.entries()) {
            zip.file(path, content);
        }
        zip.generateAsync({ type: "blob" }).then(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `update_${new Date().toISOString().slice(0,10)}.zip`;
            a.click();
            URL.revokeObjectURL(a.href);
        });
    };
    
    const attachListeners = () => {
        document.querySelectorAll('[data-action]').forEach(el => el.onclick = handleAction);
        const studentSwitcher = document.getElementById('student-switcher');
        if (studentSwitcher) {
            studentSwitcher.onchange = () => loadStudent(studentSwitcher.value);
        }
    };

    const init = async () => {
        try {
            const res = await fetch('students/roster.json?ts=' + Date.now());
            if (!res.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š docs/students/roster.json");
            state.roster = await res.json();
            await loadStudent(state.roster[0]?.id);
        } catch (err) {
            dom.container.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">${err.message}</div>`;
        }
        dom.exportBtn.addEventListener('click', exportZip);
    };

    init();
});
</script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>èª²ç¨‹æ—¥æ›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .day-cell { aspect-ratio: 1 / 1; }
        .today-highlight { background-color: #3b82f6; color: white; }
        .selected-highlight { box-shadow: 0 0 0 2px #2563eb; }
        .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
    </style>
</head>
<body class="bg-gray-100">
<div class="max-w-2xl mx-auto p-4 sm:p-6">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
        <div class="mt-2 flex justify-center items-center gap-2">
            <select id="student-switcher" class="rounded-md border-gray-300 shadow-sm"></select>
        </div>
    </header>

    <main class="bg-white rounded-xl shadow-lg p-4 sm:p-6 min-h-[400px]">
        <div id="error-display" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4"></div>
        <div id="calendar-widget">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">&lt;</button>
                <h2 id="month-year" class="text-xl font-bold text-gray-700 w-32 text-center"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">&gt;</button>
            </div>
            <div class="grid grid-cols-7 text-center text-sm font-semibold text-gray-500 mb-2">
                <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7"></div>
        </div>
    </main>
</div>

<div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
    <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-sm"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { studentId: '', roster: [], manifest: null, currentDate: new Date() };
        const dom = {
            studentSwitcher: document.getElementById('student-switcher'),
            errorDisplay: document.getElementById('error-display'),
            calendarWidget: document.getElementById('calendar-widget'),
            calendarGrid: document.getElementById('calendar-grid'),
            monthYear: document.getElementById('month-year'),
            modal: document.getElementById('modal'),
            modalContent: document.getElementById('modal-content'),
        };

        const showError = (message) => {
            dom.errorDisplay.textContent = `éŒ¯èª¤: ${message}`;
            dom.errorDisplay.classList.remove('hidden');
            dom.calendarWidget.classList.add('hidden');
        };

        const renderCalendar = () => {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            dom.monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            dom.calendarGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) dom.calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');

            const todayStr = new Date().toISOString().slice(0, 10);
            const selectedDateStr = new URLSearchParams(window.location.search).get('date');

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayData = state.manifest.days[dateStr];
                const hasContent = dayData && Object.values(dayData).some(c => c.material || c.homework);

                const cell = document.createElement('div');
                cell.className = 'day-cell relative flex justify-center items-center rounded-lg';
                const content = document.createElement('span');
                content.textContent = i;
                content.className = 'w-8 h-8 flex items-center justify-center rounded-full transition-colors';
                if (dateStr === todayStr) content.classList.add('today-highlight');
                if (dateStr === selectedDateStr) cell.classList.add('selected-highlight');
                
                if (hasContent) {
                    cell.classList.add('cursor-pointer');
                    content.classList.add('hover:bg-gray-200');
                    cell.insertAdjacentHTML('beforeend', '<div class="dot"></div>');
                    cell.addEventListener('click', () => handleDayClick(dateStr, dayData));
                }
                cell.appendChild(content);
                dom.calendarGrid.appendChild(cell);
            }
        };

        const handleDayClick = (dateStr, dayData) => {
            const entries = Object.values(dayData).filter(c => c.material || c.homework);
            if (entries.length === 1) {
                const target = entries[0].material || entries[0].homework;
                if (target.url) window.location.href = target.url;
            } else {
                showModal(dateStr, dayData);
            }
        };

        const showModal = (dateStr, dayData) => {
            let itemsHtml = '';
            for (const [courseKey, entry] of Object.entries(dayData)) {
                const courseMeta = state.manifest.courses[courseKey] || { label: courseKey, color: '#6b7280' };
                let links = '';
                if (entry.material?.url) links += `<a href="${entry.material.url}" class="block text-center w-full px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-800 rounded-md">ğŸ“˜ æ•™æ</a>`;
                if (entry.homework?.url) links += `<a href="${entry.homework.url}" class="block text-center w-full px-4 py-2 bg-green-50 hover:bg-green-100 text-green-800 rounded-md">ğŸ“ ä½œæ¥­</a>`;
                if (links) {
                    itemsHtml += `<div class="p-3 border-t"><h4 class="font-semibold mb-2" style="color:${courseMeta.color}">${courseMeta.label}</h4><div class="flex flex-col space-y-2">${links}</div></div>`;
                }
            }
            dom.modalContent.innerHTML = `
                <div class="flex justify-between items-center p-4"><h3 class="font-bold text-lg">${dateStr}</h3><button id="close-modal" class="text-gray-400 hover:text-gray-800">&times;</button></div>
                <div class="max-h-[60vh] overflow-y-auto">${itemsHtml}</div>`;
            dom.modal.classList.remove('hidden');
        };

        const init = async () => {
            try {
                const rosterRes = await fetch('students/roster.json?ts=' + Date.now());
                if (!rosterRes.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š roster.json");
                state.roster = await rosterRes.json();

                const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
                state.studentId = studentIdFromUrl || state.roster[0]?.id;
                if (!state.studentId) throw new Error("åå†Šç‚ºç©ºï¼Œç„¡æ³•é¡¯ç¤ºæ—¥æ›†");

                dom.studentSwitcher.innerHTML = state.roster.map(s => `<option value="${s.id}" ${s.id === state.studentId ? 'selected' : ''}>${s.name}</option>`).join('');
                dom.studentSwitcher.onchange = () => { window.location.search = `?student=${dom.studentSwitcher.value}`; };
                
                const manifestRes = await fetch(`students/${state.studentId}/manifest.json?ts=${Date.now()}`);
                if (!manifestRes.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${state.studentId} çš„è³‡æ–™`);
                state.manifest = await manifestRes.json();
                
                const urlDate = new URLSearchParams(window.location.search).get('date');
                if (urlDate) state.currentDate = new Date(urlDate + 'T00:00:00');
                
                renderCalendar();
            } catch (e) { showError(e.message); }
        };

        dom.modal.onclick = (e) => { if (e.target === dom.modal || e.target.id === 'close-modal') dom.modal.classList.add('hidden'); };
        document.getElementById('prev-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); };
        init();
    });
</script>
</body>
</html>

=== FILE: docs\students\roster.json ===
[
  {
    "id": "ray",
    "name": "Ray Chen"
  },
  {
    "id": "sally",
    "name": "Sally Lin"
  }
]

=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {
    "2025-08-10": {
      "english": {
        "title": "ç¾åœ¨å®Œæˆå¼",
        "material": { "format": "html", "url": "materials/ray/english/250810.html" },
        "homework": { "format": "html", "url": "materials/ray/english/250810_hw.html" }
      },
      "math": {
        "title": "ä¸‰è§’å‡½æ•¸",
        "material": { "format": "html", "url": "materials/ray/math/250810.html" }
      }
    },
    "2025-08-08": {
      "english": {
        "title": "å–®å­—è¤‡ç¿’",
        "homework": { "format": "html", "url": "materials/ray/english/250808_hw.html" }
      }
    }
  }
}


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 50; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto p-4 md:p-6 max-w-6xl space-y-6">
    <header>
        <h1 class="text-3xl font-bold text-gray-800">å¾Œå°ç®¡ç†ä»‹é¢</h1>
        <p class="text-gray-500">æ‰€æœ‰è®Šæ›´å°‡ç›´æ¥å„²å­˜è‡³æ‚¨æœ¬åœ°çš„å°ˆæ¡ˆæª”æ¡ˆã€‚</p>
    </header>
    <div id="app-body"></div>
</div>
<div id="toast-container"></div>

<script type="module">
    const state = { roster: [], manifest: null, currentStudentId: null };
    const dom = { appBody: document.getElementById('app-body'), toast: document.getElementById('toast-container') };

    const showToast = (message, isError = false) => {
        const toast = document.createElement('div');
        toast.className = `toast ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.textContent = message;
        dom.toast.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    const api = {
        get: async (endpoint) => {
            const res = await fetch(`/api/data/${endpoint}?ts=${Date.now()}`);
            if (!res.ok) throw new Error(`è®€å–å¤±æ•—: ${res.statusText}`);
            return res.json();
        },
        save: async (path, content) => {
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, content }),
            });
            if (!res.ok) throw new Error(`å„²å­˜å¤±æ•—: ${res.statusText}`);
            return res.json();
        }
    };

    const render = () => {
        dom.appBody.innerHTML = `
            ${renderTopBar()}
            ${state.manifest ? renderStudentEditor() : '<div class="card p-4 text-gray-500">è«‹é¸æ“‡ä¸€ä½å­¸ç”Ÿä»¥é–‹å§‹ç·¨è¼¯ã€‚</div>'}`;
    };

    const renderTopBar = () => {
        const studentOptions = state.roster.map(s => `<option value="${s.id}" ${s.id === state.currentStudentId ? 'selected' : ''}>${s.name}</option>`).join('');
        return `<div class="card p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é¸æ“‡æˆ–åˆ‡æ›å­¸ç”Ÿ</label>
                    <select id="student-switcher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${studentOptions}</select>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700">æ–°å¢å­¸ç”Ÿ</h3>
                    <div class="flex gap-2 mt-1">
                        <input id="new-student-id" class="border rounded px-2 py-1 w-1/2" placeholder="ID (è‹±æ–‡)">
                        <input id="new-student-name" class="border rounded px-2 py-1 w-1/2" placeholder="å§“å">
                        <button data-action="add-student" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600 text-sm">æ–°å¢ä¸¦å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>`;
    };

    const renderStudentEditor = () => { /* ... */ };
    const renderContentCard = (date, studentId, courseKey, type, existingData) => { /* ... */ };

    const handleAction = async (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const { action, id, path, date, course, type } = target.dataset;
        
        try {
            switch (action) {
                case 'add-student':
                    const newId = document.getElementById('new-student-id').value.trim();
                    const newName = document.getElementById('new-student-name').value.trim();
                    if (!newId || !newName || !/^[a-zA-Z0-9_-]+$/.test(newId)) { alert('IDå’Œå§“åç‚ºå¿…å¡«ï¼Œä¸”IDåªèƒ½æ˜¯è‹±æ–‡/æ•¸å­—'); return; }
                    if (state.roster.some(s => s.id === newId)) { alert('è©²å­¸ç”ŸIDå·²å­˜åœ¨'); return; }
                    
                    const updatedRoster = [...state.roster, { id: newId, name: newName }];
                    await api.save('students/roster.json', updatedRoster);
                    const newManifest = createEmptyManifest(newId, newName);
                    await api.save(`students/${newId}/manifest.json`, newManifest);

                    state.roster = updatedRoster;
                    state.manifests[newId] = newManifest;
                    await loadStudent(newId);
                    showToast(`å­¸ç”Ÿ ${newName} å·²æ–°å¢ï¼`);
                    break;
                case 'add-date':
                    const newDate = document.getElementById('new-date-input').value;
                    if (!newDate) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
                    if (state.manifest.days[newDate]) { alert(`æ—¥æœŸ "${newDate}" å·²å­˜åœ¨`); return; }
                    state.manifest.days[newDate] = {};
                    await api.save(`students/${state.currentStudentId}/manifest.json`, state.manifest);
                    showToast(`æ—¥æœŸ ${newDate} å·²æ–°å¢ï¼`);
                    render();
                    break;
                case 'save-html':
                    const content = target.closest('div.p-3').querySelector('textarea').value;
                    if (!content) { alert('HTML å…§å®¹ä¸å¯ç‚ºç©º'); return; }
                    await api.save(path, content);
                    state.manifest.days[date][course][type] = { format: "html", url: path };
                    await api.save(`students/${state.currentStudentId}/manifest.json`, state.manifest);
                    showToast(`å·²å„²å­˜ ${course} ${type}ï¼`);
                    render();
                    break;
            }
        } catch(err) {
            showToast(`æ“ä½œå¤±æ•—: ${err.message}`, true);
        }
    };

    const loadStudent = async (studentId) => {
        if (!studentId) return;
        try {
            state.currentStudentId = studentId;
            // Update URL for state persistence on refresh
            const url = new URL(window.location);
            url.searchParams.set('student', studentId);
            history.pushState({}, '', url);
            
            state.manifest = await api.get(`students/${studentId}/manifest.json`);
            render();
        } catch(err) {
            showToast(err.message, true);
        }
    };
    
    const createEmptyManifest = (id, name) => ({ version: 2, student: id, displayName: name, courses: { english: { label: "è‹±æ–‡", color: "#1d4ed8" }}, days: {} });

    const init = async () => {
        dom.appBody.addEventListener('click', handleAction);
        dom.appBody.addEventListener('change', e => {
             if (e.target.id === 'student-switcher') loadStudent(e.target.value);
        });
        
        try {
            state.roster = await api.get('students/roster.json');
            const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
            const initialStudentId = studentIdFromUrl && state.roster.some(s => s.id === studentIdFromUrl) ? studentIdFromUrl : state.roster[0]?.id;
            await loadStudent(initialStudentId);
        } catch (err) {
            dom.appBody.innerHTML = `<div class="card p-4 bg-red-100 text-red-700">${err.message}</div>`;
        }
    };
    
    // --- Inner rendering functions ---
    renderStudentEditor = () => { /* ... */ };
    renderStudentEditor = () => {
        const student = state.roster.find(s => s.id === state.currentStudentId);
        const manifest = state.manifests[state.currentStudentId];
        const sortedDays = Object.keys(manifest.days).sort((a, b) => b.localeCompare(a));
        const daySections = sortedDays.map(date => {
            const entries = Object.entries(manifest.courses).map(([courseKey, courseMeta]) => {
                const dayEntry = manifest.days[date]?.[courseKey] || {};
                return `<div class="p-3 bg-white rounded-lg border" style="border-left: 4px solid ${courseMeta.color};">
                    <h4 class="font-semibold" style="color: ${courseMeta.color}">${courseMeta.label}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        ${renderContentCard(date, student.id, courseKey, 'material', dayEntry.material)}
                        ${renderContentCard(date, student.id, courseKey, 'homework', dayEntry.homework)}
                    </div></div>`;
            }).join('');
            return `<details class="bg-gray-50 border rounded-lg" open><summary class="p-3 font-semibold cursor-pointer">${date}</summary><div class="p-3 border-t grid gap-4">${entries}</div></details>`;
        }).join('');
        return `<div class="card p-4 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">æ—¥æœŸç®¡ç† for ${student.name}</h2>
                <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="border rounded p-2"><button data-action="add-date" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md text-sm">æ–°å¢æ—¥æœŸ</button>
                </div>
            </div><div class="space-y-4">${daySections}</div></div>`;
    };
    renderContentCard = (date, studentId, courseKey, type, existingData) => {
        const fileName = `${date.replace(/-/g, '').slice(2)}${type === 'homework' ? '_hw' : ''}.html`;
        const path = `docs/materials/${studentId}/${courseKey}/${fileName}`;
        return `<div class="p-3 rounded-md bg-gray-50 border">
            <label class="font-bold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
            <textarea class="w-full h-24 border rounded mt-1 p-1 text-xs font-mono" placeholder="è²¼ä¸Š HTML...">${existingData ? `` : ''}</textarea>
            <div class="flex items-center justify-end mt-1">
                <button class="text-xs bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" data-action="save-html" data-path="${path}" data-date="${date}" data-course="${courseKey}" data-type="${type}">å„²å­˜</button>
            </div>
        </div>`;
    };

    init();
</script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>èª²ç¨‹æ—¥æ›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
        .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
        .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
        .ring-2 { box-shadow: 0 0 0 2px #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
        <div class="inline-block relative">
            <select id="student-switcher" class="text-lg text-gray-600 rounded-md p-1 border-gray-300 shadow-sm"></select>
        </div>
    </header>
    <main>
        <div id="error-display" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4"></div>
        <section id="calendar-widget" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â—€</button>
                <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
                <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </section>
    </main>
</div>
<div id="modal" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50 hidden"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { studentId: '', roster: [], manifest: null, currentDate: new Date() };
        const dom = {
            studentSwitcher: document.getElementById('student-switcher'),
            errorDisplay: document.getElementById('error-display'),
            calendarWidget: document.getElementById('calendar-widget'),
            calendarGrid: document.getElementById('calendar-grid'),
            monthYear: document.getElementById('month-year'),
            modal: document.getElementById('modal'),
        };

        const showError = (message) => {
            dom.errorDisplay.textContent = `éŒ¯èª¤: ${message}`;
            dom.errorDisplay.classList.remove('hidden');
            dom.calendarWidget.classList.add('hidden');
        };

        const renderCalendar = () => {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            dom.monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            dom.calendarGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) dom.calendarGrid.insertAdjacentHTML('beforeend', '<div class="p-2"></div>');
            const todayStr = new Date().toISOString().slice(0, 10);
            const selectedDateStr = new URLSearchParams(window.location.search).get('date');

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayData = state.manifest.days[dateStr];
                const hasContent = dayData && Object.values(dayData).some(c => c.material || c.homework);
                const dayCell = document.createElement('div');
                dayCell.className = 'p-2 relative flex justify-center items-center';
                let content = document.createElement('span');
                content.textContent = i;
                if (hasContent) {
                    dayCell.classList.add('has-material', 'cursor-pointer');
                    content.innerHTML = `${i}<span class="dot"></span>`;
                    content = document.createElement('a');
                    content.href = '#';
                    content.innerHTML = `${i}<span class="dot"></span>`;
                    content.className = 'w-full h-full flex justify-center items-center';
                    content.onclick = (e) => { e.preventDefault(); handleDayClick(dateStr, dayData); };
                }
                if (dateStr === todayStr) (content.tagName === 'A' ? content : dayCell).classList.add('today');
                if (dateStr === selectedDateStr) dayCell.classList.add('ring-2', 'rounded-full');
                dayCell.appendChild(content);
                dom.calendarGrid.appendChild(dayCell);
            }
        };

        const handleDayClick = (dateStr, dayData) => {
            const entries = Object.values(dayData).filter(c => c.material || c.homework);
            if (entries.length === 1) {
                const target = entries[0].material || entries[0].homework;
                if (target.url) window.location.href = target.url;
            } else { showModal(dateStr, dayData); }
        };

        const showModal = (dateStr, dayData) => {
            let itemsHtml = '';
            for (const [courseKey, entry] of Object.entries(dayData)) {
                const courseMeta = state.manifest.courses[courseKey] || { label: courseKey, color: '#6b7280' };
                let links = '';
                if (entry.material?.url) links += `<a href="${entry.material.url}" class="block px-4 py-2 hover:bg-gray-100 rounded">ğŸ“˜ ${courseMeta.label}ï¼šæ•™æ</a>`;
                if (entry.homework?.url) links += `<a href="${entry.homework.url}" class="block px-4 py-2 hover:bg-gray-100 rounded">ğŸ“ ${courseMeta.label}ï¼šä½œæ¥­</a>`;
                if(links) itemsHtml += links;
            }
            dom.modal.innerHTML = `<div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
                <div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3><button data-action="close-modal" class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded">&times;</button></div>
                <div class="space-y-2">${itemsHtml || '<p>ç„¡å¯ç”¨è³‡æ–™</p>'}</div>
            </div>`;
            dom.modal.classList.remove('hidden');
        };

        const init = async () => {
            try {
                const rosterRes = await fetch('students/roster.json?ts=' + Date.now());
                if (!rosterRes.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š docs/students/roster.json");
                state.roster = await rosterRes.json();
                const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
                state.studentId = studentIdFromUrl || state.roster[0]?.id;
                if (!state.studentId) throw new Error("åå†Šç‚ºç©ºï¼Œç„¡æ³•é¡¯ç¤ºæ—¥æ›†");

                dom.studentSwitcher.innerHTML = state.roster.map(s => `<option value="${s.id}" ${s.id === state.studentId ? 'selected' : ''}>${s.name}</option>`).join('');
                dom.studentSwitcher.onchange = () => { window.location.search = `?student=${dom.studentSwitcher.value}`; };
                
                const manifestRes = await fetch(`students/${state.studentId}/manifest.json?ts=${Date.now()}`);
                if (!manifestRes.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${state.studentId} çš„è³‡æ–™`);
                state.manifest = await manifestRes.json();
                
                const urlDate = new URLSearchParams(window.location.search).get('date');
                if (urlDate) state.currentDate = new Date(urlDate + 'T00:00:00');
                
                dom.calendarWidget.classList.remove('hidden');
                renderCalendar();
            } catch (e) { showError(e.message); }
        };

        dom.modal.onclick = (e) => { if (e.target.dataset.action === 'close-modal' || e.target === dom.modal) dom.modal.classList.add('hidden'); };
        document.getElementById('prev-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); };
        init();
    });
</script>
</body>
</html>

=== FILE: docs\students\roster.json ===
[
  {
    "id": "ray",
    "name": "Ray Chen"
  },
  {
    "id": "sally",
    "name": "Sally Lin"
  }
]

=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {
    "2025-08-10": {
      "english": {
        "title": "ç¯„ä¾‹æ•™æ",
        "material": {
          "format": "html",
          "url": "materials/ray/english/250810.html"
        }
      }
    }
  }
}


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; } 
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 50; opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto p-4 md:p-6 max-w-6xl space-y-6">
    <header>
        <h1 class="text-3xl font-bold text-gray-800">å¾Œå°ç®¡ç†ä»‹é¢</h1>
        <p class="text-gray-500">æ‰€æœ‰è®Šæ›´å°‡ç›´æ¥å„²å­˜è‡³æ‚¨æœ¬åœ°çš„å°ˆæ¡ˆæª”æ¡ˆã€‚</p>
    </header>
    <div id="app-body"></div>
</div>
<div id="toast-container"></div>

<script type="module">
    const state = { roster: [], manifest: null, currentStudentId: null };
    const dom = { appBody: document.getElementById('app-body'), toast: document.getElementById('toast-container') };

    const showToast = (message, isError = false) => { /* ... (Same as previous correct version) ... */ };
    const api = { /* ... (Same as previous correct version) ... */ };
    const render = () => { /* ... (Same as previous correct version) ... */ };
    const renderTopBar = () => { /* ... (Same as previous correct version) ... */ };
    const renderStudentEditor = () => { /* ... (Same as previous correct version) ... */ };
    const renderContentCard = (date, studentId, courseKey, type) => { /* ... (Same as previous correct version) ... */ };
    const handleAction = async (e) => { /* ... (Same as previous correct version) ... */ };
    const loadStudent = async (studentId) => { /* ... (Same as previous correct version) ... */ };
    const createEmptyManifest = (id, name) => ({ version: 2, student: id, displayName: name, courses: { english: { label: "è‹±æ–‡", color: "#1d4ed8" }}, days: {} });
    const init = async () => { /* ... (Same as previous correct version) ... */ };
    
    // --- Full function definitions ---
    showToast = (message, isError = false) => {
        const toast = document.createElement('div');
        toast.className = `toast ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.textContent = message;
        dom.toast.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    api.get = async (endpoint) => {
        const res = await fetch(`/api/data/${endpoint}?ts=${Date.now()}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `è®€å–å¤±æ•—: ${res.status}`);
        return data;
    };
    api.save = async (path, content) => {
        const res = await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path, content }),
        });
        const resData = await res.json();
        if (!res.ok || resData.status !== 'success') throw new Error(resData.message || `å„²å­˜å¤±æ•—: ${res.status}`);
        return resData;
    };

    render = () => {
        const student = state.roster.find(s => s.id === state.currentStudentId);
        const manifest = state.manifests[state.currentStudentId];
        dom.appBody.innerHTML = `
            ${renderTopBar()}
            ${student && manifest ? renderStudentEditor(student, manifest) : '<div class="card p-4 text-gray-500">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€ä½å­¸ç”Ÿä»¥é–‹å§‹ç·¨è¼¯ï¼Œæˆ–æ–°å¢ä¸€ä½å­¸ç”Ÿã€‚</div>'}
        `;
    };
    
    renderTopBar = () => {
        const studentOptions = state.roster.map(s => `<option value="${s.id}" ${s.id === state.currentStudentId ? 'selected' : ''}>${s.name}</option>`).join('');
        return `<div class="card p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é¸æ“‡æˆ–åˆ‡æ›å­¸ç”Ÿ</label>
                    <select id="student-switcher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">-- è«‹é¸æ“‡ --</option>${studentOptions}</select>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700">æ–°å¢å­¸ç”Ÿ</h3>
                    <div class="flex gap-2 mt-1">
                        <input id="new-student-id" class="border rounded px-2 py-1 w-1/2" placeholder="ID (è‹±æ–‡)">
                        <input id="new-student-name" class="border rounded px-2 py-1 w-1/2" placeholder="å§“å">
                        <button data-action="add-student" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600 text-sm">æ–°å¢ä¸¦å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>`;
    };

    renderStudentEditor = () => {
        const student = state.roster.find(s => s.id === state.currentStudentId);
        const manifest = state.manifests[state.currentStudentId];
        const sortedDays = Object.keys(manifest.days).sort((a,b) => b.localeCompare(a));
        const daySections = sortedDays.map(date => {
            const entries = Object.entries(manifest.courses).map(([courseKey, courseMeta]) => {
                const dayEntry = manifest.days[date]?.[courseKey] || {};
                return `<div class="p-3 bg-white rounded-lg border" style="border-left: 4px solid ${courseMeta.color};">
                    <h4 class="font-semibold" style="color: ${courseMeta.color}">${courseMeta.label}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        ${renderContentCard(date, student.id, courseKey, 'material', dayEntry.material)}
                        ${renderContentCard(date, student.id, courseKey, 'homework', dayEntry.homework)}
                    </div></div>`;
            }).join('');
            return `<details class="bg-gray-50 border rounded-lg" open><summary class="p-3 font-semibold cursor-pointer">${date}</summary><div class="p-3 border-t grid gap-4">${entries}</div></details>`;
        }).join('');
        return `<div class="card p-4 space-y-4">
            <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold">æ—¥æœŸç®¡ç† for ${student.name}</h2>
                 <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="border rounded p-2"><button data-action="add-date" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md text-sm">æ–°å¢æ—¥æœŸ</button>
                 </div>
            </div><div class="space-y-4">${daySections}</div></div>`;
    };

    renderContentCard = (date, studentId, courseKey, type, existingData) => {
        const fileName = `${date.replace(/-/g, '').slice(2)}${type === 'homework' ? '_hw' : ''}.html`;
        const path = `materials/${studentId}/${courseKey}/${fileName}`;
        const hasExistingData = !!existingData;
        return `<div class="p-3 rounded-md bg-gray-50 border">
            <label class="font-bold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
            <textarea class="w-full h-24 border rounded mt-1 p-1 text-xs font-mono" placeholder="è²¼ä¸Š HTML..."></textarea>
            <div class="flex items-center justify-between mt-1">
                <button class="text-xs text-blue-600 hover:underline" data-action="load-and-preview" data-path="${path}">è¼‰å…¥ & é è¦½</button>
                <button class="text-xs bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" data-action="save-html" data-path="${path}" data-date="${date}" data-course="${courseKey}" data-type="${type}">å„²å­˜</button>
            </div>
            ${hasExistingData ? `<p class="text-xs text-green-600 mt-1">âœ“ å·²æœ‰æª”æ¡ˆï¼Œå†æ¬¡å„²å­˜å°‡è¦†è“‹ã€‚</p>` : ''}
        </div>`;
    };
    
    loadStudent = async (studentId) => {
        if (!studentId) { state.currentStudentId = null; state.manifest = null; render(); return; }
        try {
            state.currentStudentId = studentId;
            const url = new URL(window.location);
            url.searchParams.set('student', studentId);
            history.pushState({}, '', url);
            state.manifest = await api.get(`students/${studentId}/manifest.json`);
            state.manifests[studentId] = state.manifest;
            render();
        } catch(err) { showToast(err.message, true); }
    };
    
    handleAction = async (e) => {
        const target = e.target.closest('[data-action]');
        if (!target || target.disabled) return;
        target.disabled = true;

        const { action, path, date, course, type } = target.dataset;
        
        try {
            switch (action) {
                case 'add-student':
                    const newId = document.getElementById('new-student-id').value.trim();
                    const newName = document.getElementById('new-student-name').value.trim();
                    if (!newId || !newName || !/^[a-zA-Z0-9_-]+$/.test(newId)) throw new Error('IDå’Œå§“åç‚ºå¿…å¡«ï¼Œä¸”IDåªèƒ½æ˜¯è‹±æ–‡/æ•¸å­—');
                    if (state.roster.some(s => s.id === newId)) throw new Error('è©²å­¸ç”ŸIDå·²å­˜åœ¨');
                    const updatedRoster = [...state.roster, { id: newId, name: newName }];
                    await api.save('students/roster.json', updatedRoster);
                    const newManifest = createEmptyManifest(newId, newName);
                    await api.save(`students/${newId}/manifest.json`, newManifest);
                    state.roster = updatedRoster;
                    state.manifests[newId] = newManifest;
                    await loadStudent(newId);
                    showToast(`å­¸ç”Ÿ ${newName} å·²æ–°å¢ï¼`);
                    break;
                case 'add-date':
                    const newDate = document.getElementById('new-date-input').value;
                    if (!newDate) throw new Error('è«‹é¸æ“‡æ—¥æœŸ');
                    if (state.manifest.days[newDate]) throw new Error(`æ—¥æœŸ "${newDate}" å·²å­˜åœ¨`);
                    state.manifest.days[newDate] = {};
                    await api.save(`students/${state.currentStudentId}/manifest.json`, state.manifest);
                    showToast(`æ—¥æœŸ ${newDate} å·²æ–°å¢ï¼`);
                    render();
                    break;
                case 'load-and-preview':
                    const textareaToLoad = target.closest('.p-3').querySelector('textarea');
                    try {
                        const content = await api.get(path);
                        textareaToLoad.value = content;
                        if (confirm('å·²è¼‰å…¥ç¾æœ‰å…§å®¹ï¼Œè¦åœ¨æ–°åˆ†é é è¦½å—ï¼Ÿ')) {
                           window.open('', '_blank').document.write(content);
                        }
                    } catch (err) { showToast('å°šç„¡ç¾æœ‰å…§å®¹å¯è¼‰å…¥ã€‚', true); }
                    break;
                case 'save-html':
                    const contentToSave = target.closest('.p-3').querySelector('textarea').value;
                    if (!contentToSave) throw new Error('HTML å…§å®¹ä¸å¯ç‚ºç©º');
                    await api.save(path, contentToSave);
                    const manifestToUpdate = state.manifests[state.currentStudentId];
                    manifestToUpdate.days[date][course] = manifestToUpdate.days[date][course] || {};
                    manifestToUpdate.days[date][course][type] = { format: "html", url: path };
                    await api.save(`students/${state.currentStudentId}/manifest.json`, manifestToUpdate);
                    showToast(`å·²å„²å­˜ ${path.split('/').pop()}ï¼`);
                    render();
                    break;
            }
        } catch(err) {
            showToast(`æ“ä½œå¤±æ•—: ${err.message}`, true);
        } finally {
            target.disabled = false;
        }
    };

    init = async () => {
        dom.appBody.addEventListener('click', handleAction);
        dom.appBody.addEventListener('change', e => { if (e.target.id === 'student-switcher') loadStudent(e.target.value); });
        try {
            state.roster = await api.get('students/roster.json');
            const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
            const initialStudentId = studentIdFromUrl && state.roster.some(s => s.id === studentIdFromUrl) ? studentIdFromUrl : state.roster[0]?.id;
            await loadStudent(initialStudentId);
        } catch (err) {
            dom.appBody.innerHTML = `<div class="card p-4 bg-red-100 text-red-700">${err.message}</div>`;
        }
    };

    init();
</script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>èª²ç¨‹æ—¥æ›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
        .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
        .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
        .ring-2 { box-shadow: 0 0 0 2px #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
        <div class="inline-block relative">
            <select id="student-switcher" class="text-lg text-gray-600 rounded-md p-1 border-gray-300 shadow-sm"></select>
        </div>
    </header>
    <main>
        <div id="error-display" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4"></div>
        <section id="calendar-widget" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700">â—€</button>
                <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
                <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </section>
    </main>
</div>
<div id="modal" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50 hidden"></div>
<script>
    // ... (JavaScript from previous correct version, no changes needed)
    document.addEventListener('DOMContentLoaded', () => {
        const state = { studentId: '', roster: [], manifest: null, currentDate: new Date() };
        const dom = { studentSwitcher: document.getElementById('student-switcher'), errorDisplay: document.getElementById('error-display'), calendarWidget: document.getElementById('calendar-widget'), calendarGrid: document.getElementById('calendar-grid'), monthYear: document.getElementById('month-year'), modal: document.getElementById('modal') };
        const showError = (message) => { dom.errorDisplay.textContent = `éŒ¯èª¤: ${message}`; dom.errorDisplay.classList.remove('hidden'); dom.calendarWidget.classList.add('hidden'); };
        const renderCalendar = () => {
            const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth();
            dom.monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`; dom.calendarGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) dom.calendarGrid.insertAdjacentHTML('beforeend', '<div class="p-2"></div>');
            const todayStr = new Date().toISOString().slice(0, 10); const selectedDateStr = new URLSearchParams(window.location.search).get('date');
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayData = state.manifest.days[dateStr];
                const hasContent = dayData && Object.values(dayData).some(c => c.material || c.homework);
                const dayCell = document.createElement('div'); dayCell.className = 'p-2 relative flex justify-center items-center';
                let content = document.createElement('span'); content.textContent = i;
                if (hasContent) {
                    dayCell.classList.add('has-material', 'cursor-pointer');
                    content = document.createElement('a'); content.href = '#'; content.innerHTML = `${i}<span class="dot"></span>`;
                    content.className = 'w-full h-full flex justify-center items-center';
                    content.onclick = (e) => { e.preventDefault(); handleDayClick(dateStr, dayData); };
                }
                if (dateStr === todayStr) (content.tagName === 'A' ? content : dayCell).classList.add('today');
                if (dateStr === selectedDateStr) dayCell.classList.add('ring-2', 'rounded-full');
                dayCell.appendChild(content); dom.calendarGrid.appendChild(dayCell);
            }
        };
        const handleDayClick = (dateStr, dayData) => {
            const entries = Object.values(dayData).filter(c => c.material || c.homework);
            if (entries.length === 1) { const target = entries[0].material || entries[0].homework; if (target.url) window.location.href = target.url; } 
            else { showModal(dateStr, dayData); }
        };
        const showModal = (dateStr, dayData) => {
            let itemsHtml = '';
            for (const [courseKey, entry] of Object.entries(dayData)) {
                const courseMeta = state.manifest.courses[courseKey] || { label: courseKey };
                let links = '';
                if (entry.material?.url) links += `<a href="${entry.material.url}" class="block px-4 py-2 hover:bg-gray-100 rounded">ğŸ“˜ ${courseMeta.label}ï¼šæ•™æ</a>`;
                if (entry.homework?.url) links += `<a href="${entry.homework.url}" class="block px-4 py-2 hover:bg-gray-100 rounded">ğŸ“ ${courseMeta.label}ï¼šä½œæ¥­</a>`;
                if(links) itemsHtml += links;
            }
            dom.modal.innerHTML = `<div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
                <div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3><button data-action="close-modal" class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded">&times;</button></div>
                <div class="space-y-2">${itemsHtml || '<p>ç„¡å¯ç”¨è³‡æ–™</p>'}</div></div>`;
            dom.modal.classList.remove('hidden');
        };
        const init = async () => {
            try {
                const rosterRes = await fetch('students/roster.json?ts=' + Date.now());
                if (!rosterRes.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š docs/students/roster.json");
                state.roster = await rosterRes.json();
                const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
                state.studentId = studentIdFromUrl || state.roster[0]?.id;
                if (!state.studentId) throw new Error("åå†Šç‚ºç©º");
                dom.studentSwitcher.innerHTML = state.roster.map(s => `<option value="${s.id}" ${s.id === state.studentId ? 'selected' : ''}>${s.name}</option>`).join('');
                dom.studentSwitcher.onchange = () => { window.location.search = `?student=${dom.studentSwitcher.value}`; };
                const manifestRes = await fetch(`students/${state.studentId}/manifest.json?ts=${Date.now()}`);
                if (!manifestRes.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${state.studentId} çš„è³‡æ–™`);
                state.manifest = await manifestRes.json();
                const urlDate = new URLSearchParams(window.location.search).get('date');
                if (urlDate) state.currentDate = new Date(urlDate + 'T00:00:00');
                dom.calendarWidget.classList.remove('hidden');
                renderCalendar();
            } catch (e) { showError(e.message); }
        };
        dom.modal.onclick = (e) => { if (e.target.closest('[data-action="close-modal"]') || e.target === dom.modal) dom.modal.classList.add('hidden'); };
        document.getElementById('prev-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); };
        init();
    });
</script>
</body>
</html>

=== FILE: docs\students\roster.json ===
[
  {
    "id": "ray",
    "name": "Ray Chen"
  },
  {
    "id": "sally",
    "name": "Sally Lin"
  }
]

=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {}
}


=== FILE: docs\admin.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Noto Sans TC', sans-serif; } 
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 50; opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto p-4 md:p-6 max-w-6xl space-y-6">
    <header>
        <h1 class="text-3xl font-bold text-gray-800">å¾Œå°ç®¡ç†ä»‹é¢</h1>
        <p class="text-gray-500">æ‰€æœ‰è®Šæ›´å°‡ç›´æ¥å„²å­˜è‡³æ‚¨æœ¬åœ°çš„å°ˆæ¡ˆæª”æ¡ˆã€‚</p>
    </header>
    <div id="app-body"></div>
</div>
<div id="toast-container"></div>

<script type="module">
    const state = { roster: [], manifests: {}, manifest: null, currentStudentId: null };
    const dom = { appBody: document.getElementById('app-body'), toast: document.getElementById('toast-container') };

    const showToast = (message, isError = false) => {
        const toast = document.createElement('div');
        toast.className = `toast ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.textContent = message;
        dom.toast.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    const api = {
        get: async (endpoint) => {
            const res = await fetch(`/api/data/${endpoint}?ts=${Date.now()}`);
            const contentType = res.headers.get("content-type");
            if (!res.ok) {
                const errText = await res.text();
                try {
                    const errJson = JSON.parse(errText);
                    throw new Error(errJson.error || `è®€å–å¤±æ•—: ${res.status}`);
                } catch {
                    throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ (éJSON): ${res.status} ${res.statusText}`);
                }
            }
            if (contentType && contentType.includes("application/json")) {
                return res.json();
            }
            return res.text();
        },
        save: async (path, content) => {
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path, content }),
            });
            const resData = await res.json();
            if (!res.ok || resData.status !== 'success') {
                throw new Error(resData.message || `å„²å­˜å¤±æ•—: ${res.status}`);
            }
            return resData;
        }
    };

    const render = () => {
        const student = state.roster.find(s => s.id === state.currentStudentId);
        const manifest = state.manifest;
        dom.appBody.innerHTML = `
            ${renderTopBar()}
            ${student && manifest ? renderStudentEditor(student, manifest) : '<div class="card p-4 text-gray-500">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€ä½å­¸ç”Ÿä»¥é–‹å§‹ç·¨è¼¯ï¼Œæˆ–æ–°å¢ä¸€ä½å­¸ç”Ÿã€‚</div>'}
        `;
    };

    const renderTopBar = () => {
        const studentOptions = state.roster.map(s => `<option value="${s.id}" ${s.id === state.currentStudentId ? 'selected' : ''}>${s.name}</option>`).join('');
        return `<div class="card p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é¸æ“‡æˆ–åˆ‡æ›å­¸ç”Ÿ</label>
                    <select id="student-switcher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">-- è«‹é¸æ“‡ --</option>${studentOptions}</select>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700">æ–°å¢å­¸ç”Ÿ</h3>
                    <div class="flex gap-2 mt-1">
                        <input id="new-student-id" class="border rounded px-2 py-1 w-1/2" placeholder="ID (è‹±æ–‡)">
                        <input id="new-student-name" class="border rounded px-2 py-1 w-1/2" placeholder="å§“å">
                        <button data-action="add-student" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600 text-sm">æ–°å¢ä¸¦å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>`;
    };

    const renderStudentEditor = (student, manifest) => {
        const sortedDays = Object.keys(manifest.days).sort((a,b) => b.localeCompare(a));
        const daySections = sortedDays.map(date => {
            const entries = Object.entries(manifest.courses).map(([courseKey, courseMeta]) => {
                const dayEntry = manifest.days[date]?.[courseKey] || {};
                return `<div class="p-3 bg-white rounded-lg border" style="border-left: 4px solid ${courseMeta.color};">
                    <h4 class="font-semibold" style="color: ${courseMeta.color}">${courseMeta.label}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        ${renderContentCard(date, student.id, courseKey, 'material', dayEntry.material)}
                        ${renderContentCard(date, student.id, courseKey, 'homework', dayEntry.homework)}
                    </div></div>`;
            }).join('');
            return `<details class="bg-gray-50 border rounded-lg" open><summary class="p-3 font-semibold cursor-pointer">${date}</summary><div class="p-3 border-t grid gap-4">${entries}</div></details>`;
        });
        return `<div class="card p-4 space-y-4">
            <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold">æ—¥æœŸç®¡ç† for ${student.name}</h2>
                 <div class="flex items-center gap-2">
                    <input type="date" id="new-date-input" class="border rounded p-2"><button data-action="add-date" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md text-sm">æ–°å¢æ—¥æœŸ</button>
                 </div>
            </div><div class="space-y-4">${daySections.join('')}</div></div>`;
    };

    const renderContentCard = (date, studentId, courseKey, type, existingData) => {
        const fileName = `${date.replace(/-/g, '').slice(2)}${type === 'homework' ? '_hw' : ''}.html`;
        const path = `materials/${studentId}/${courseKey}/${fileName}`;
        return `<div class="p-3 rounded-md bg-gray-50 border">
            <label class="font-bold text-sm">${type === 'material' ? 'ğŸ“˜ æ•™æ' : 'ğŸ“ ä½œæ¥­'}</label>
            <textarea class="w-full h-24 border rounded mt-1 p-1 text-xs font-mono" placeholder="è²¼ä¸Š HTML..."></textarea>
            <div class="flex items-center justify-between mt-1">
                <button class="text-xs text-blue-600 hover:underline" data-action="load-and-preview" data-path="${path}">è¼‰å…¥ & é è¦½</button>
                <button class="text-xs bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" data-action="save-html" data-path="${path}" data-date="${date}" data-course="${courseKey}" data-type="${type}">å„²å­˜</button>
            </div>
            ${existingData ? `<p class="text-xs text-green-600 mt-1">âœ“ å·²æœ‰æª”æ¡ˆï¼Œå†æ¬¡å„²å­˜å°‡è¦†è“‹ã€‚</p>` : ''}
        </div>`;
    };
    
    const loadStudent = async (studentId) => {
        if (!studentId) {
            state.currentStudentId = null;
            state.manifest = null;
            const url = new URL(window.location);
            url.searchParams.delete('student');
            history.pushState({}, '', url);
            render();
            return;
        }
        try {
            state.currentStudentId = studentId;
            const url = new URL(window.location);
            url.searchParams.set('student', studentId);
            history.pushState({}, '', url);
            const manifestData = await api.get(`students/${studentId}/manifest.json`);
            state.manifest = manifestData;
            state.manifests[studentId] = manifestData;
            render();
        } catch(err) {
            showToast(err.message, true);
            state.currentStudentId = null;
            state.manifest = null;
            render();
        }
    };
    
    const handleAction = async (e) => {
        const target = e.target.closest('[data-action]');
        if (!target || target.disabled) return;
        
        const { action, path, date, course, type } = target.dataset;
        
        const actionWrapper = async (promise) => {
            target.disabled = true;
            try {
                await promise;
            } catch(err) {
                showToast(`æ“ä½œå¤±æ•—: ${err.message}`, true);
            } finally {
                target.disabled = false;
            }
        };

        if (action === 'add-student') {
            actionWrapper((async () => {
                const newId = document.getElementById('new-student-id').value.trim();
                const newName = document.getElementById('new-student-name').value.trim();
                if (!newId || !newName || !/^[a-zA-Z0-9_-]+$/.test(newId)) throw new Error('IDå’Œå§“åç‚ºå¿…å¡«ï¼Œä¸”IDåªèƒ½æ˜¯è‹±æ–‡/æ•¸å­—');
                if (state.roster.some(s => s.id === newId)) throw new Error('è©²å­¸ç”ŸIDå·²å­˜åœ¨');
                
                const updatedRoster = [...state.roster, { id: newId, name: newName }];
                await api.save('students/roster.json', updatedRoster);
                const newManifest = { version: 2, student: newId, displayName: newName, courses: { english: { label: "è‹±æ–‡", color: "#1d4ed8" }}, days: {} };
                await api.save(`students/${newId}/manifest.json`, newManifest);

                state.roster = updatedRoster;
                state.manifests[newId] = newManifest;
                await loadStudent(newId);
                showToast(`å­¸ç”Ÿ ${newName} å·²æ–°å¢ï¼`);
            })());
        } else if (action === 'add-date') {
            actionWrapper((async () => {
                const newDate = document.getElementById('new-date-input').value;
                if (!newDate) throw new Error('è«‹é¸æ“‡æ—¥æœŸ');
                if (state.manifest.days[newDate]) throw new Error(`æ—¥æœŸ "${newDate}" å·²å­˜åœ¨`);
                state.manifest.days[newDate] = {};
                await api.save(`students/${state.currentStudentId}/manifest.json`, state.manifest);
                showToast(`æ—¥æœŸ ${newDate} å·²æ–°å¢ï¼`);
                render();
            })());
        } else if (action === 'load-and-preview') {
             actionWrapper((async () => {
                const textareaToLoad = target.closest('.p-3').querySelector('textarea');
                try {
                    const content = await api.get(path);
                    textareaToLoad.value = content;
                    if (content && confirm('å·²è¼‰å…¥ç¾æœ‰å…§å®¹ï¼Œè¦åœ¨æ–°åˆ†é é è¦½å—ï¼Ÿ')) {
                       window.open('', '_blank').document.write(content);
                    } else if (!content) {
                       showToast('å°šç„¡ç¾æœ‰å…§å®¹å¯è¼‰å…¥ã€‚');
                    }
                } catch (err) { showToast('å°šç„¡ç¾æœ‰å…§å®¹æˆ–è®€å–å¤±æ•—ã€‚', true); }
            })());
        } else if (action === 'save-html') {
            actionWrapper((async () => {
                const contentToSave = target.closest('.p-3').querySelector('textarea').value;
                if (!contentToSave) throw new Error('HTML å…§å®¹ä¸å¯ç‚ºç©º');
                await api.save(`docs/${path}`, contentToSave);
                
                const manifestToUpdate = state.manifest;
                manifestToUpdate.days[date][course] = manifestToUpdate.days[date][course] || {};
                manifestToUpdate.days[date][course][type] = { format: "html", url: path };
                await api.save(`students/${state.currentStudentId}/manifest.json`, manifestToUpdate);
                
                showToast(`å·²å„²å­˜ ${path.split('/').pop()}ï¼`);
                render();
            })());
        }
    };

    const init = async () => {
        document.addEventListener('click', handleAction);
        document.addEventListener('change', e => { if (e.target.id === 'student-switcher') loadStudent(e.target.value); });
        try {
            state.roster = await api.get('students/roster.json');
            const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
            const initialStudentId = studentIdFromUrl && state.roster.some(s => s.id === studentIdFromUrl) ? studentIdFromUrl : state.roster[0]?.id;
            await loadStudent(initialStudentId);
        } catch (err) {
            dom.appBody.innerHTML = `<div class="card p-4 bg-red-100 text-red-700">${err.message}</div>`;
        }
    };

    init();
</script>
</body>
</html>

=== FILE: docs\index.html ===
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>èª²ç¨‹æ—¥æ›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .today { background-color: #3b82f6; color: white; border-radius: 9999px; }
        .has-material:hover { background-color: #dbeafe; border-radius: 9999px; }
        .dot { height: 6px; width: 6px; background-color: #16a34a; border-radius: 50%; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); }
        .ring-2 { box-shadow: 0 0 0 2px #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
    <header class="text-center mb-12">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">èª²ç¨‹æ—¥æ›† ğŸ“…</h1>
        <div class="inline-block relative">
            <select id="student-switcher" class="text-lg text-gray-600 rounded-md p-1 border-gray-300 shadow-sm"></select>
        </div>
    </header>
    <main>
        <div id="error-display" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4"></div>
        <section id="calendar-widget" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700">â—€</button>
                <h3 id="month-year" class="text-xl font-bold text-gray-800 w-40 text-center"></h3>
                <button id="next-month" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600 mb-2">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </section>
    </main>
</div>
<div id="modal" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50 hidden"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { studentId: '', roster: [], manifest: null, currentDate: new Date() };
        const dom = { studentSwitcher: document.getElementById('student-switcher'), errorDisplay: document.getElementById('error-display'), calendarWidget: document.getElementById('calendar-widget'), calendarGrid: document.getElementById('calendar-grid'), monthYear: document.getElementById('month-year'), modal: document.getElementById('modal') };

        const showError = (message) => {
            dom.errorDisplay.textContent = `éŒ¯èª¤: ${message}`;
            dom.errorDisplay.classList.remove('hidden');
            dom.calendarWidget.classList.add('hidden');
        };

        const renderCalendar = () => {
            const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth();
            dom.monthYear.textContent = `${year}å¹´ ${month + 1}æœˆ`; dom.calendarGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) dom.calendarGrid.insertAdjacentHTML('beforeend', '<div class="p-2"></div>');
            const todayStr = new Date().toISOString().slice(0, 10); const selectedDateStr = new URLSearchParams(window.location.search).get('date');

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayData = state.manifest.days[dateStr];
                const hasContent = dayData && Object.values(dayData).some(c => c.material || c.homework);
                const dayCell = document.createElement('div'); dayCell.className = 'p-2 relative flex justify-center items-center';
                let content = document.createElement('span'); content.textContent = i;
                if (hasContent) {
                    dayCell.classList.add('has-material', 'cursor-pointer');
                    content = document.createElement('a'); content.href = '#'; content.innerHTML = `${i}<span class="dot"></span>`;
                    content.className = 'w-full h-full flex justify-center items-center';
                    content.onclick = (e) => { e.preventDefault(); handleDayClick(dateStr, dayData); };
                }
                if (dateStr === todayStr) (content.tagName === 'A' ? content : dayCell).classList.add('today');
                if (dateStr === selectedDateStr) dayCell.classList.add('ring-2', 'rounded-full');
                dayCell.appendChild(content); dom.calendarGrid.appendChild(dayCell);
            }
        };

        const handleDayClick = (dateStr, dayData) => {
            const entries = Object.values(dayData).filter(c => c.material || c.homework);
            if (entries.length === 1) { const target = entries[0].material || entries[0].homework; if (target.url) window.location.href = target.url; } 
            else { showModal(dateStr, dayData); }
        };

        const showModal = (dateStr, dayData) => {
            let itemsHtml = '';
            for (const [courseKey, entry] of Object.entries(dayData)) {
                const courseMeta = state.manifest.courses[courseKey] || { label: courseKey, color: '#6b7280' };
                let links = '';
                if (entry.material?.url) links += `<a href="${entry.material.url}" class="block px-4 py-2 hover:bg-gray-100 rounded">ğŸ“˜ ${courseMeta.label}ï¼šæ•™æ</a>`;
                if (entry.homework?.url) links += `<a href="${entry.homework.url}" class="block px-4 py-2 hover:bg-gray-100 rounded">ğŸ“ ${courseMeta.label}ï¼šä½œæ¥­</a>`;
                if(links) itemsHtml += `<div class="p-3 border-t"><h4 class="font-semibold mb-2" style="color:${courseMeta.color}">${courseMeta.label}</h4><div class="flex flex-col space-y-2">${links}</div></div>`;
            }
            dom.modal.innerHTML = `<div class="bg-white rounded-xl shadow-xl max-w-md w-full p-4">
                <div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold">é¸æ“‡èª²ç¨‹ï½œ${dateStr}</h3><button data-action="close-modal" class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded">&times;</button></div>
                <div class="space-y-2">${itemsHtml || '<p>ç„¡å¯ç”¨è³‡æ–™</p>'}</div></div>`;
            dom.modal.classList.remove('hidden');
        };

        const init = async () => {
            try {
                const rosterRes = await fetch('students/roster.json?ts=' + Date.now());
                if (!rosterRes.ok) throw new Error("æ‰¾ä¸åˆ°å­¸ç”Ÿåå†Š docs/students/roster.json");
                state.roster = await rosterRes.json();
                const studentIdFromUrl = new URLSearchParams(window.location.search).get('student');
                state.studentId = studentIdFromUrl || state.roster[0]?.id;
                if (!state.studentId) throw new Error("åå†Šç‚ºç©º");

                dom.studentSwitcher.innerHTML = state.roster.map(s => `<option value="${s.id}" ${s.id === state.studentId ? 'selected' : ''}>${s.name}</option>`).join('');
                dom.studentSwitcher.onchange = () => { window.location.search = `?student=${dom.studentSwitcher.value}`; };
                
                const manifestRes = await fetch(`students/${state.studentId}/manifest.json?ts=${Date.now()}`);
                if (!manifestRes.ok) throw new Error(`æ‰¾ä¸åˆ°å­¸ç”Ÿ ${state.studentId} çš„è³‡æ–™`);
                state.manifest = await manifestRes.json();
                
                const urlDate = new URLSearchParams(window.location.search).get('date');
                if (urlDate) state.currentDate = new Date(urlDate + 'T00:00:00');
                
                dom.calendarWidget.classList.remove('hidden');
                renderCalendar();
            } catch (e) { showError(e.message); }
        };

        dom.modal.onclick = (e) => { if (e.target.closest('[data-action="close-modal"]') || e.target === dom.modal) dom.modal.classList.add('hidden'); };
        document.getElementById('prev-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); };
        init();
    });
</script>
</body>
</html>

=== FILE: docs\students\roster.json ===
[
  { "id": "ray", "name": "Ray Chen" },
  { "id": "sally", "name": "Sally Lin" }
]

=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {}
}


=== FILE: docs\admin.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å¾Œå°ç®¡ç†ä»‹é¢</title>
  <style>
    body{font-family: system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif; background:#f3f5f7; margin:0;}
    .app{max-width:1100px; margin:36px auto; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:22px 24px;}
    h1{margin:0 0 16px; display:flex; gap:10px; align-items:center;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0;}
    input[type="text"], input[type="date"], select, textarea{
      border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; font-size:15px;
    }
    textarea{width:100%; min-height:180px;}
    .btn{padding:8px 12px; border-radius:8px; border:0; background:#2563eb; color:#fff; cursor:pointer}
    .btn.gray{background:#6b7280}
    .btn.green{background:#059669}
    .btn.red{background:#dc2626}
    .msg{padding:10px 12px; border-radius:8px; margin:8px 0; display:none}
    .msg.ok{display:block; background:#e6f9ed; color:#065f46}
    .msg.err{display:block; background:#fde2e0; color:#9b1c1c}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:12px;}
    .box{background:#f8fafc; border-radius:10px; padding:12px;}
    .list .item{background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; margin:6px 0;}
    code{background:#f3f4f6; padding:2px 6px; border-radius:6px;}
  </style>
</head>
<body>
<div class="app">
  <h1>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</h1>

  <div id="msg" class="msg"></div>

  <div class="row">
    <label>å­¸ç”Ÿï¼š</label>
    <select id="studentSel"></select>
    <button class="btn" id="btnReloadManifest">è¼‰å…¥</button>
    <span style="flex:1"></span>
    <input type="text" id="newId" placeholder="æ–°å­¸ç”Ÿ idï¼ˆå°å¯«/ç„¡ç©ºç™½ï¼‰"/>
    <input type="text" id="newName" placeholder="æ–°å­¸ç”Ÿå§“åï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯ç©ºï¼‰"/>
    <button class="btn green" id="btnAddStudent">æ–°å¢å­¸ç”Ÿ</button>
  </div>

  <div class="grid">
    <div class="box">
      <h3>æ•™æé …ç›®ï¼ˆå¯«å…¥ manifest.jsonï¼‰</h3>
      <div class="row">
        <input type="date" id="lessonDate"/>
        <input type="text" id="lessonTitle" placeholder="æ¨™é¡Œ"/>
        <input type="text" id="lessonCourse" placeholder="èª²ç¨‹/åˆ†é¡ï¼ˆè‹±æ–‡æˆ–æ‹¼éŸ³ï¼Œåšç‚ºè³‡æ–™å¤¾åï¼‰"/>
      </div>
      <div class="row">
        <input style="flex:1" type="text" id="lessonFile" placeholder="æ•™ææª”åï¼ˆå¯ç•™ç©ºï¼Œè‡ªå‹•ç”¨æ—¥æœŸèˆ‡æ¨™é¡Œç”Ÿæˆï¼‰"/>
        <button class="btn" id="btnAddToManifest">åŠ å…¥æ¸…å–®ï¼ˆåƒ…è¨˜éŒ„è·¯å¾‘ï¼‰</button>
        <button class="btn" id="btnSaveManifest">å„²å­˜ manifest.json åˆ°ç¡¬ç¢Ÿ</button>
      </div>

      <div class="list" id="manifestList"></div>
    </div>

    <div class="box">
      <h3>å»ºç«‹ / è¦†è“‹æ•™æ HTML æª”</h3>
      <p>è²¼ä¸Šæ•™æå…§å®¹ï¼ˆ<code>&lt;body&gt;</code> å…§çš„ HTML ç‰‡æ®µå³å¯ï¼‰ã€‚ç³»çµ±æœƒè‡ªå‹•åŒ…ä¸Šé é¦–ï¼Œå«ã€Œè¿”å›æ—¥æ›†ã€éºµåŒ…å±‘ã€‚</p>
      <textarea id="htmlContent" placeholder="åœ¨é€™è£¡è²¼ä¸Šæ•™æ HTML å…§å®¹"></textarea>
      <div class="row">
        <button class="btn green" id="btnWriteHtml">å¯«å…¥ HTML åˆ°ç¡¬ç¢Ÿ</button>
      </div>
      <div>å¯¦éš›è·¯å¾‘é è¦½ï¼š<code id="previewPath">ï¼ˆå…ˆå¡«æ—¥æœŸ/èª²ç¨‹/æª”åï¼‰</code></div>
    </div>
  </div>
</div>

<script>
const q = (s, el=document)=>el.querySelector(s);
const msg = q("#msg");

function toast(ok, text){
  msg.className = "msg " + (ok ? "ok" : "err");
  msg.textContent = text;
  msg.style.display = "block";
  clearTimeout(window.__msgTimer);
  window.__msgTimer = setTimeout(()=> msg.style.display="none", 3200);
}

async function apiGet(path){
  const r = await fetch(`/api/data/${path}?ts=${Date.now()}`, {cache:'no-store'});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}
async function apiSave(path, content){
  const r = await fetch("/api/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ path, content })
  });
  const j = await r.json();
  if (!r.ok || j.status!=="success") throw new Error(j.message || ("HTTP "+r.status));
  return j;
}

let roster = {students:[]};
let manifest = null;
let currentStudent = null;

function updatePreviewPath(){
  const date = q("#lessonDate").value;
  const course = (q("#lessonCourse").value || "general").trim();
  let file = (q("#lessonFile").value || "").trim();
  if(!date){ q("#previewPath").textContent="ï¼ˆå…ˆå¡«æ—¥æœŸï¼‰"; return; }
  if(!file){
    const title = (q("#lessonTitle").value || "lesson").trim().replace(/\s+/g,"_").toLowerCase();
    file = `${date}_${title}.html`;
  }
  const path = `materials/${currentStudent}/${course}/${file}`;
  q("#previewPath").textContent = path;
  return path;
}

function renderManifestList(){
  const wrap = q("#manifestList");
  wrap.innerHTML = "";
  const entries = manifest?.entries || {};
  Object.keys(entries).sort().forEach(d=>{
    const arr = entries[d];
    arr.forEach((it, idx)=>{
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = `${d}ï¼š${it.title}  â†’  ${it.path}`;
      wrap.appendChild(div);
    });
  });
}

async function loadRoster(){
  roster = await apiGet("roster.json");
  const sel = q("#studentSel");
  sel.innerHTML = "";
  roster.students.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name || s.id;
    sel.appendChild(opt);
  });
  if(!currentStudent){
    currentStudent = roster.students?.[0]?.id || null;
  }
  if(currentStudent) sel.value = currentStudent;
  sel.onchange = async ()=>{
    currentStudent = sel.value;
    await loadManifest();
  }
}

async function saveRoster(){
  await apiSave("roster.json", roster);
}

async function addStudent(){
  const id = (q("#newId").value || "").trim();
  const name = (q("#newName").value || "").trim();
  if(!id || !/^[a-z0-9_-]+$/.test(id)){
    toast(false, "è«‹è¼¸å…¥åˆæ³• idï¼ˆå°å¯«è‹±æ•¸èˆ‡ _-ï¼‰");
    return;
  }
  if (roster.students.some(s=>s.id===id)){
    toast(false, "æ­¤ id å·²å­˜åœ¨");
    return;
  }
  roster.students.push({id, name});
  await saveRoster();
  toast(true, `å·²æ–°å¢å­¸ç”Ÿï¼š${name||id}`);
  q("#newId").value = ""; q("#newName").value = "";
  await loadRoster();
  currentStudent = id;
  q("#studentSel").value = id;
  await loadManifest(); // è‡ªå‹•ç”¢å‡ºç©º manifestï¼ˆå¾Œç«¯æœƒçµ¦é è¨­ï¼‰
}

async function loadManifest(){
  if(!currentStudent){ toast(false, "å°šæœªå»ºç«‹å­¸ç”Ÿ"); return; }
  try{
    manifest = await apiGet(`students/${currentStudent}/manifest.json`);
    toast(true, `å·²è¼‰å…¥ ${currentStudent} çš„ manifest`);
  }catch(e){
    console.error(e);
    manifest = {student: currentStudent, entries:{}};
    toast(false, "è¼‰å…¥ manifest å¤±æ•—ï¼Œå·²ä½¿ç”¨ç©ºæ¨¡æ¿");
  }
  renderManifestList();
  updatePreviewPath();
}

function ensureArray(obj, key){
  if(!obj[key]) obj[key] = [];
  if(!Array.isArray(obj[key])) obj[key] = [];
  return obj[key];
}

function wrapHtml(student, date, title, bodyHtml){
  // æ³¨æ„éºµåŒ…å±‘å›åˆ° ../../../index.htmlï¼ˆmaterials/<id>/<course>/<file>.html â†’ å›åˆ° docs/index.htmlï¼‰
  const back = `../../../index.html?student=${encodeURIComponent(student)}&date=${encodeURIComponent(date)}#calendar-widget`;
  return `<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title||""}</title>
<style>
body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
</style>
</head>
<body>
  <div class="header">â† <a href="${back}">è¿”å›æ—¥æ›†</a></div>
  <div class="container">
    <h1>${title||""}</h1>
    ${bodyHtml||""}
  </div>
</body>
</html>`;
}

async function addToManifestOnly(){
  const date = q("#lessonDate").value;
  const title = (q("#lessonTitle").value || "").trim();
  const course = (q("#lessonCourse").value || "general").trim();
  let file = (q("#lessonFile").value || "").trim();
  if(!currentStudent) return toast(false, "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
  if(!date) return toast(false, "è«‹å…ˆé¸æ—¥æœŸ");

  if(!file){
    const safeTitle = (title||"lesson").replace(/\s+/g,"_").toLowerCase();
    file = `${date}_${safeTitle}.html`;
  }
  const rel = `materials/${currentStudent}/${course}/${file}`;

  const arr = ensureArray(manifest, "entries");
  manifest.entries[date] = manifest.entries[date] || [];
  manifest.entries[date].push({title, path: rel});
  renderManifestList();
  updatePreviewPath();
  toast(true, "å·²åŠ å…¥æ¸…å–®ï¼ˆå°šæœªå¯«æª”ï¼‰");
}

async function saveManifestToDisk(){
  if(!currentStudent) return toast(false, "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
  const path = `students/${currentStudent}/manifest.json`;
  await apiSave(path, manifest);
  toast(true, `manifest å·²å¯«å…¥ï¼š${path}`);
}

async function writeHtmlFile(){
  const date = q("#lessonDate").value;
  const title = (q("#lessonTitle").value || "").trim();
  const course = (q("#lessonCourse").value || "general").trim();
  let file = (q("#lessonFile").value || "").trim();
  const body = q("#htmlContent").value || "";
  if(!currentStudent) return toast(false, "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
  if(!date) return toast(false, "è«‹å…ˆé¸æ—¥æœŸ");

  if(!file){
    const safeTitle = (title||"lesson").replace(/\s+/g,"_").toLowerCase();
    file = `${date}_${safeTitle}.html`;
  }
  const rel = `materials/${currentStudent}/${course}/${file}`;
  const html = wrapHtml(currentStudent, date, title, body);
  await apiSave(rel, html);
  // é †ä¾¿åŠ å…¥ manifestï¼ˆè‹¥é‚„æ²’ï¼‰
  manifest.entries[date] = manifest.entries[date] || [];
  if (!manifest.entries[date].some(x=>x.path===rel)){
    manifest.entries[date].push({title, path: rel});
  }
  renderManifestList();
  updatePreviewPath();
  toast(true, `æ•™æå·²å¯«å…¥ï¼š${rel}`);
}

async function init(){
  await loadRoster();
  if(!currentStudent){
    toast(false, "ç›®å‰æ²’æœ‰å­¸ç”Ÿï¼Œè«‹å…ˆæ–°å¢å­¸ç”Ÿ");
  }else{
    await loadManifest();
  }

  q("#studentSel").addEventListener("change", ()=>updatePreviewPath());
  ["lessonDate","lessonTitle","lessonCourse","lessonFile"].forEach(id=>{
    q("#"+id).addEventListener("input", updatePreviewPath);
  });

  q("#btnReloadManifest").onclick = loadManifest;
  q("#btnAddStudent").onclick = addStudent;
  q("#btnAddToManifest").onclick = addToManifestOnly;
  q("#btnSaveManifest").onclick = saveManifestToDisk;
  q("#btnWriteHtml").onclick = writeHtmlFile;
}
init();
</script>
</body>
</html>


=== FILE: docs\index.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>èª²ç¨‹æ—¥æ›† ğŸ“…</title>
  <style>
    body{font-family: system-ui, -apple-system, "Noto Sans TC", Arial, sans-serif; background:#f3f5f7; margin:0;}
    .app{max-width:1024px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:24px 28px;}
    h1{display:flex; gap:12px; align-items:center; margin:0 0 12px;}
    h1 .icon{font-size:28px;}
    .toolbar{display:flex; gap:12px; align-items:center; margin:12px 0 20px;}
    select{padding:8px 10px; font-size:16px;}
    .msg{padding:12px 14px; border-radius:8px; margin:8px 0; display:none}
    .msg.err{display:block; background:#fde2e0; color:#9b1c1c}
    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:10px;}
    .dow{font-weight:700; color:#5b6770; text-align:center;}
    .cell{background:#f7fafc; min-height:74px; border-radius:10px; padding:8px; position:relative}
    .cell .day{font-weight:700; color:#3a4a5b;}
    .cell.has .dot{position:absolute; right:10px; top:10px; width:8px; height:8px; background:#34c759; border-radius:50%;}
    .cell.today{outline:2px solid #2f80ed; background:#eef6ff;}
    .list{margin-top:18px;}
    .card{background:#f7fafc; border-radius:10px; padding:10px 12px; margin:8px 0;}
    a{color:#2563eb; text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="app">
    <h1><span class="icon">ğŸ“…</span>èª²ç¨‹æ—¥æ›†</h1>
    <div class="toolbar">
      <label>å­¸ç”Ÿï¼š</label>
      <select id="studentSel"></select>
    </div>
    <div id="err" class="msg err"></div>

    <div id="calendar"></div>
    <div class="list" id="items"></div>
  </div>

<script>
const q = (s, el=document)=>el.querySelector(s);

const params = new URLSearchParams(location.search);
const queryStudent = params.get('student');
const queryDate = params.get('date');

let roster = {students:[]};
let manifest = null;
let currentStudent = null;

async function apiGet(path){
  const r = await fetch(`/api/data/${path}?ts=${Date.now()}`, {cache:'no-store'});
  if(!r.ok){ throw new Error("HTTP "+r.status); }
  const ct = r.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await r.json();
  return await r.text();
}

function setErr(msg){ const box = q("#err"); if(msg){ box.textContent=msg; box.style.display='block'; }else{ box.style.display='none'; } }

function ymd(d){
  const y = d.getFullYear();
  const m = (d.getMonth()+1+"").padStart(2,"0");
  const dd = (d.getDate()+"").padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

function renderRoster(){
  const sel = q("#studentSel");
  sel.innerHTML = "";
  roster.students.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id; opt.textContent = s.name || s.id;
    sel.appendChild(opt);
  });
  if(currentStudent){
    sel.value = currentStudent;
  }else if(roster.students.length){
    currentStudent = roster.students[0].id;
    sel.value = currentStudent;
  }
  sel.onchange = ()=>{
    currentStudent = sel.value;
    const u = new URL(location.href);
    u.searchParams.set("student", currentStudent);
    history.replaceState({}, "", u.toString());
    loadManifest(currentStudent);
  }
}

function renderCalendar(){
  const container = q("#calendar");
  container.innerHTML = "";

  const today = new Date();
  const y = today.getFullYear();
  const m = today.getMonth(); // 0-based

  const first = new Date(y, m, 1);
  const startDow = first.getDay(); // 0 Sun
  const last = new Date(y, m+1, 0);
  const days = last.getDate();

  const grid = document.createElement("div");
  grid.className = "calendar";

  // header dow
  const DOW = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  DOW.forEach(d=>{
    const el = document.createElement("div");
    el.className = "dow";
    el.textContent = d;
    grid.appendChild(el);
  });

  for(let i=0;i<startDow;i++){
    const pad = document.createElement("div");
    grid.appendChild(pad);
  }

  const entries = manifest?.entries || {};
  for(let day=1; day<=days; day++){
    const d = new Date(y, m, day);
    const k = ymd(d);
    const cell = document.createElement("div");
    cell.className = "cell";
    if (k in entries) cell.classList.add("has");
    if (k === ymd(new Date())) cell.classList.add("today");

    const dayEl = document.createElement("div");
    dayEl.className = "day";
    dayEl.textContent = day;
    cell.appendChild(dayEl);

    if (k in entries){
      const dot = document.createElement("span");
      dot.className = "dot";
      cell.appendChild(dot);
      cell.style.cursor = "pointer";
      cell.onclick = ()=>{
        renderList(k);
        const u = new URL(location.href);
        u.searchParams.set("date", k);
        history.replaceState({}, "", u.toString());
      };
    }
    grid.appendChild(cell);
  }
  container.appendChild(grid);

  if (queryDate && (queryDate in entries)) {
    renderList(queryDate);
  }else{
    q("#items").innerHTML = "";
  }
}

function renderList(dateKey){
  const wrap = q("#items");
  wrap.innerHTML = `<h3>${dateKey} çš„æ•™æ</h3>`;
  const arr = manifest.entries[dateKey] || [];
  if(!arr.length){
    wrap.innerHTML += `<div class="card">é€™å¤©æ²’æœ‰æ•™æ</div>`;
    return;
  }
  arr.forEach(item=>{
    const card = document.createElement("div");
    card.className = "card";
    const a = document.createElement("a");
    a.href = "/" + item.path; // ç›´æ¥é–‹æ•™æ
    a.textContent = item.title || item.path;
    card.appendChild(a);
    wrap.appendChild(card);
  });
}

async function loadManifest(studentId){
  setErr("");
  try{
    manifest = await apiGet(`students/${studentId}/manifest.json`);
    renderCalendar();
  }catch(e){
    console.error(e);
    setErr(`éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å­¸ç”Ÿ ${studentId} çš„è³‡æ–™`);
    manifest = {"student": studentId, "entries": {}};
    renderCalendar();
  }
}

async function init(){
  // roster
  roster = await apiGet("roster.json");
  currentStudent = queryStudent || roster.students?.[0]?.id || null;
  renderRoster();

  if(!currentStudent){
    setErr("å°šæœªå»ºç«‹ä»»ä½•å­¸ç”Ÿï¼Œè«‹å…ˆåˆ°å¾Œå°æ–°å¢ï¼ˆadmin.htmlï¼‰");
    return;
  }
  await loadManifest(currentStudent);
}
init();
</script>
</body>
</html>


=== FILE: docs\students\roster.json ===
{
  "students": [
    { "id": "sally", "name": "Sally Lin" },
    { "id": "ray",   "name": "Ray" }
  ]
}


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {}
}


=== FILE: docs\admin.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1100px;margin:36px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:22px 24px;}
  h1{margin:0 0 16px;display:flex;gap:10px;align-items:center;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0;}
  input[type="text"], input[type="date"], select, textarea{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;font-size:15px;}
  textarea{width:100%;min-height:180px;}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
  .btn.gray{background:#6b7280}.btn.green{background:#059669}
  .msg{padding:10px 12px;border-radius:8px;margin:8px 0;display:none}
  .msg.ok{display:block;background:#e6f9ed;color:#065f46}.msg.err{display:block;background:#fde2e0;color:#9b1c1c}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;}
  .box{background:#f8fafc;border-radius:10px;padding:12px;}
  .list .item{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;margin:6px 0;}
  code{background:#f3f4f6;padding:2px 6px;border-radius:6px;}
</style>
</head>
<body>
<div class="app">
  <h1>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</h1>

  <div id="msg" class="msg"></div>

  <div class="row">
    <label>å­¸ç”Ÿï¼š</label>
    <select id="studentSel"></select>
    <button class="btn" id="btnReloadManifest">è¼‰å…¥</button>
    <span style="flex:1"></span>
    <input type="text" id="newId" placeholder="æ–°å­¸ç”Ÿ idï¼ˆå°å¯«/ç„¡ç©ºç™½ï¼‰"/>
    <input type="text" id="newName" placeholder="æ–°å­¸ç”Ÿå§“åï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯ç©ºï¼‰"/>
    <button class="btn green" id="btnAddStudent">æ–°å¢å­¸ç”Ÿ</button>
  </div>

  <div class="grid">
    <div class="box">
      <h3>æ•™æé …ç›®ï¼ˆå¯«å…¥ manifest.jsonï¼‰</h3>
      <div class="row">
        <input type="date" id="lessonDate"/>
        <input type="text" id="lessonTitle" placeholder="æ¨™é¡Œ"/>
      </div>

      <div class="row">
        <label>èª²ç¨‹ï¼š</label>
        <select id="lessonCourseSel"></select>
        <input type="text" id="newCourseKey" placeholder="æ–°å¢èª²ç¨‹ keyï¼ˆå¦‚ englishï¼‰"/>
        <button class="btn gray" id="btnAddCourse">åŠ å…¥èª²ç¨‹é¸å–®</button>
      </div>

      <div class="row">
        <label>é¡å‹ï¼š</label>
        <select id="lessonTypeSel"></select>
        <input type="text" id="newTypeKey" placeholder="æ–°å¢é¡å‹ keyï¼ˆå¦‚ homeworkï¼‰"/>
        <button class="btn gray" id="btnAddType">åŠ å…¥é¡å‹é¸å–®</button>
      </div>

      <div class="row">
        <input style="flex:1" type="text" id="lessonFile" placeholder="æ•™ææª”åï¼ˆå¯ç•™ç©ºï¼Œè‡ªå‹•ç”¨æ—¥æœŸèˆ‡æ¨™é¡Œç”Ÿæˆï¼‰"/>
        <button class="btn" id="btnAddToManifest">åŠ å…¥æ¸…å–®ï¼ˆåƒ…è¨˜éŒ„è·¯å¾‘ï¼‰</button>
        <button class="btn" id="btnSaveManifest">å„²å­˜ manifest.json åˆ°ç¡¬ç¢Ÿ</button>
      </div>

      <div class="list" id="manifestList"></div>
    </div>

    <div class="box">
      <h3>å»ºç«‹ / è¦†è“‹æ•™æ HTML æª”</h3>
      <p>è²¼ä¸Šæ•™æå…§å®¹ï¼ˆ<code>&lt;body&gt;</code> å…§çš„ HTML ç‰‡æ®µå³å¯ï¼‰ã€‚ç³»çµ±æœƒè‡ªå‹•åŒ…ä¸Šé é¦–èˆ‡ã€Œè¿”å›æ—¥æ›†ã€é€£çµã€‚</p>
      <textarea id="htmlContent" placeholder="åœ¨é€™è£¡è²¼ä¸Šæ•™æ HTML å…§å®¹"></textarea>
      <div class="row"><button class="btn green" id="btnWriteHtml">å¯«å…¥ HTML åˆ°ç¡¬ç¢Ÿ</button></div>
      <div>å¯¦éš›è·¯å¾‘é è¦½ï¼š<code id="previewPath">ï¼ˆå…ˆé¸å­¸ç”Ÿï¼æ—¥æœŸï¼èª²ç¨‹ï¼‰</code></div>
    </div>
  </div>
</div>

<!-- é‡è¦ï¼šå¤–éƒ¨ JSï¼Œé¿å…å…§åµŒ <script> è¢«æˆªæ–· -->
<script src="admin.js"></script>
</body>
</html>


=== FILE: docs\admin.js ===
const q = (s, el=document)=>el.querySelector(s);
const msg = q("#msg");

function toast(ok, text){
  msg.className = "msg " + (ok ? "ok" : "err");
  msg.textContent = text;
  msg.style.display = "block";
  clearTimeout(window.__msgTimer);
  window.__msgTimer = setTimeout(()=> msg.style.display="none", 3000);
}

async function apiGet(path){
  const r = await fetch(`/api/data/${path}?ts=${Date.now()}`, {cache:'no-store'});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}
async function apiSave(path, content){
  const r = await fetch("/api/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ path, content })
  });
  const j = await r.json();
  if (!r.ok || j.status!=="success") throw new Error(j.message || ("HTTP "+r.status));
  return j;
}

let roster = {students:[]};
let manifest = null;
let currentStudent = null;

function ensureMeta(){
  manifest.meta = manifest.meta || {};
  if(!Array.isArray(manifest.meta.course_options)) manifest.meta.course_options = ["english","math"];
  if(!Array.isArray(manifest.meta.type_options))   manifest.meta.type_options   = ["material","homework"];
}
function renderCourseOptions(){
  const sel = q("#lessonCourseSel"); sel.innerHTML = "";
  ensureMeta();
  manifest.meta.course_options.forEach(k=>{
    const opt = document.createElement("option"); opt.value = k; opt.textContent = k; sel.appendChild(opt);
  });
}
function renderTypeOptions(){
  const sel = q("#lessonTypeSel"); sel.innerHTML = "";
  ensureMeta();
  manifest.meta.type_options.forEach(k=>{
    const opt = document.createElement("option"); opt.value = k; opt.textContent = k; sel.appendChild(opt);
  });
}

function updatePreviewPath(){
  if(!currentStudent){ q("#previewPath").textContent="ï¼ˆå…ˆé¸å­¸ç”Ÿï¼‰"; return; }
  const date = q("#lessonDate").value;
  const title = (q("#lessonTitle").value || "").trim();
  const course = (q("#lessonCourseSel").value || "general").trim();
  let file = (q("#lessonFile").value || "").trim();
  if(!date){ q("#previewPath").textContent="ï¼ˆå…ˆé¸æ—¥æœŸï¼‰"; return; }
  if(!file){
    const safeTitle = (title||"lesson").replace(/\s+/g,"_").toLowerCase();
    file = `${date}_${safeTitle}.html`;
  }
  const rel = `materials/${currentStudent}/${course}/${file}`;
  q("#previewPath").textContent = rel;
  return rel;
}

function renderManifestList(){
  const wrap = q("#manifestList"); wrap.innerHTML = "";
  const entries = manifest?.entries || {};
  Object.keys(entries).sort().forEach(d=>{
    (entries[d]||[]).forEach(it=>{
      const div = document.createElement("div"); div.className = "item";
      div.textContent = `${d}ï¼š[${it.type||'material'}][${it.course||'general'}] ${(it.title||'') || it.path}  â†’  ${it.path}`;
      wrap.appendChild(div);
    });
  });
}

async function loadRoster(){
  roster = await apiGet("roster.json");
  const sel = q("#studentSel"); sel.innerHTML = "";
  (roster.students||[]).forEach(s=>{
    const opt = document.createElement("option"); opt.value = s.id; opt.textContent = s.name || s.id; sel.appendChild(opt);
  });
  if(!currentStudent) currentStudent = roster.students?.[0]?.id || null;
  if(currentStudent) sel.value = currentStudent;
  sel.onchange = async ()=>{ currentStudent = sel.value; await loadManifest(); };
}
async function saveRoster(){ await apiSave("roster.json", roster); }

async function addStudent(){
  const id = (q("#newId").value || "").trim();
  const name = (q("#newName").value || "").trim();
  if(!id || !/^[a-z0-9_-]+$/.test(id)) return toast(false,"è«‹è¼¸å…¥åˆæ³• idï¼ˆå°å¯«è‹±æ•¸èˆ‡ _-ï¼‰");
  if (roster.students.some(s=>s.id===id)) return toast(false,"æ­¤ id å·²å­˜åœ¨");
  roster.students.push({id, name});
  await saveRoster();
  toast(true, `å·²æ–°å¢å­¸ç”Ÿï¼š${name||id}`);
  q("#newId").value = ""; q("#newName").value = "";
  await loadRoster();
  currentStudent = id; q("#studentSel").value = id;
  await loadManifest(); // å¾Œç«¯æœƒå›ç©ºæ¨¡æ¿
}

async function loadManifest(){
  if(!currentStudent){ toast(false, "å°šæœªå»ºç«‹å­¸ç”Ÿ"); return; }
  try{
    manifest = await apiGet(`students/${currentStudent}/manifest.json`);
    ensureMeta();
    toast(true, `å·²è¼‰å…¥ ${currentStudent} çš„ manifest`);
  }catch(e){
    console.error(e);
    manifest = {student: currentStudent, entries:{}, meta:{course_options:["english","math"], type_options:["material","homework"]}};
    toast(false, "è¼‰å…¥ manifest å¤±æ•—ï¼Œå·²ä½¿ç”¨ç©ºæ¨¡æ¿");
  }
  renderCourseOptions(); renderTypeOptions();
  renderManifestList(); updatePreviewPath();
}

function ensureEntries(date){
  manifest.entries = manifest.entries || {};
  manifest.entries[date] = manifest.entries[date] || [];
  return manifest.entries[date];
}

function makeLessonHtml(student, date, title, bodyHtml, relIndexHref){
  return `<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title||""}</title>
<style>
body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
</style>
</head>
<body>
  <div class="header">â† <a href="${relIndexHref}">è¿”å›æ—¥æ›†</a></div>
  <div class="container">
    <h1>${title||""}</h1>
    ${bodyHtml||""}
  </div>
</body>
</html>`;
}

async function addToManifestOnly(){
  if(!currentStudent) return toast(false, "è«‹å…ˆé¸å­¸ç”Ÿ");
  const date = q("#lessonDate").value; if(!date) return toast(false, "è«‹å…ˆé¸æ—¥æœŸ");
  const title = (q("#lessonTitle").value || "").trim();
  const course = (q("#lessonCourseSel").value || "general").trim();
  const type   = (q("#lessonTypeSel").value   || "material").trim();
  let file = (q("#lessonFile").value || "").trim();
  if(!file){ const safeTitle = (title||"lesson").replace(/\s+/g,"_").toLowerCase(); file = `${date}_${safeTitle}.html`; }
  const rel = `materials/${currentStudent}/${course}/${file}`;
  const arr = ensureEntries(date); arr.push({title, path: rel, course, type});
  renderManifestList(); updatePreviewPath();
  toast(true, "å·²åŠ å…¥æ¸…å–®ï¼ˆå°šæœªå¯«æª”ï¼‰");
}

async function saveManifestToDisk(){
  if(!currentStudent) return toast(false, "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
  const path = `students/${currentStudent}/manifest.json`;
  await apiSave(path, manifest);
  toast(true, `manifest å·²å¯«å…¥ï¼š${path}`);
}

async function writeHtmlFile(){
  if(!currentStudent) return toast(false, "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
  const date = q("#lessonDate").value; if(!date) return toast(false, "è«‹å…ˆé¸æ—¥æœŸ");
  const title = (q("#lessonTitle").value || "").trim();
  const course = (q("#lessonCourseSel").value || "general").trim();
  const type   = (q("#lessonTypeSel").value   || "material").trim();
  const body = q("#htmlContent").value || "";
  let file = (q("#lessonFile").value || "").trim();
  if(!file){ const safeTitle = (title||"lesson").replace(/\s+/g,"_").toLowerCase(); file = `${date}_${safeTitle}.html`; }
  const rel = `materials/${currentStudent}/${course}/${file}`;
  const back = `../../../index.html?student=${encodeURIComponent(currentStudent)}&date=${encodeURIComponent(date)}#calendar-widget`;
  const html = makeLessonHtml(currentStudent, date, title, body, back);
  await apiSave(rel, html);

  const arr = ensureEntries(date);
  if (!arr.some(x=>x.path===rel)){ arr.push({title, path: rel, course, type}); }
  renderManifestList(); updatePreviewPath();
  toast(true, `æ•™æå·²å¯«å…¥ï¼š${rel}`);
}

async function init(){
  await loadRoster();
  if(!currentStudent){ toast(false, "ç›®å‰æ²’æœ‰å­¸ç”Ÿï¼Œè«‹å…ˆæ–°å¢å­¸ç”Ÿ"); }
  else { await loadManifest(); }

  ["lessonDate","lessonTitle","lessonCourseSel","lessonTypeSel","lessonFile","htmlContent"]
    .forEach(id=> q("#"+id).addEventListener("input", updatePreviewPath));

  q("#btnReloadManifest").onclick = loadManifest;
  q("#btnAddStudent").onclick = addStudent;
  q("#btnAddToManifest").onclick = addToManifestOnly;
  q("#btnSaveManifest").onclick = saveManifestToDisk;
  q("#btnWriteHtml").onclick = writeHtmlFile;

  q("#btnAddCourse").onclick = ()=>{
    const key = (q("#newCourseKey").value||"").trim();
    if(!key) return toast(false,"è«‹è¼¸å…¥èª²ç¨‹ key");
    ensureMeta();
    if(!manifest.meta.course_options.includes(key)){
      manifest.meta.course_options.push(key); renderCourseOptions();
      toast(true, `å·²åŠ å…¥èª²ç¨‹ï¼š${key}ï¼ˆè¨˜å¾—å„²å­˜ manifestï¼‰`);
    }else toast(false, "æ­¤èª²ç¨‹å·²å­˜åœ¨");
    q("#newCourseKey").value = "";
  };

  q("#btnAddType").onclick = ()=>{
    const key = (q("#newTypeKey").value||"").trim();
    if(!key) return toast(false,"è«‹è¼¸å…¥é¡å‹ key");
    ensureMeta();
    if(!manifest.meta.type_options.includes(key)){
      manifest.meta.type_options.push(key); renderTypeOptions();
      toast(true, `å·²åŠ å…¥é¡å‹ï¼š${key}ï¼ˆè¨˜å¾—å„²å­˜ manifestï¼‰`);
    }else toast(false, "æ­¤é¡å‹å·²å­˜åœ¨");
    q("#newTypeKey").value = "";
  };
}
init();


=== FILE: docs\index.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èª²ç¨‹æ—¥æ›† ğŸ“…</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1024px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px 28px;}
  h1{display:flex;gap:12px;align-items:center;margin:0 0 12px;}
  .toolbar{display:flex;gap:12px;align-items:center;margin:12px 0 20px;}
  select{padding:8px 10px;font-size:16px;}
  .msg{padding:12px 14px;border-radius:8px;margin:8px 0;display:none}
  .msg.err{display:block;background:#fde2e0;color:#9b1c1c}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
  .dow{font-weight:700;color:#5b6770;text-align:center;}
  .cell{background:#f7fafc;min-height:74px;border-radius:10px;padding:8px;position:relative}
  .cell .day{font-weight:700;color:#3a4a5b;}
  .cell.has .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;background:#34c759;border-radius:50%;}
  .cell.today{outline:2px solid #2f80ed;background:#eef6ff;}
  .list{margin-top:18px;}
  .card{background:#f7fafc;border-radius:10px;padding:10px 12px;margin:8px 0;}
  .tag{display:inline-block;font-size:12px;padding:2px 6px;border-radius:6px;background:#eef2ff;color:#334155;margin-right:6px}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="app">
  <h1>ğŸ“… èª²ç¨‹æ—¥æ›†</h1>
  <div class="toolbar">
    <label>å­¸ç”Ÿï¼š</label>
    <select id="studentSel"></select>
  </div>
  <div id="err" class="msg err"></div>
  <div id="calendar"></div>
  <div class="list" id="items"></div>
</div>

<script>
const q=(s,e=document)=>e.querySelector(s);
const params=new URLSearchParams(location.search);
const queryStudent=params.get('student'); const queryDate=params.get('date');
let roster={students:[]}, manifest=null, currentStudent=null;

async function apiGet(path){
  const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
function setErr(m){const el=q('#err'); if(m){el.textContent=m; el.style.display='block';} else el.style.display='none';}
function ymd(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`;}

function renderRoster(){
  const sel=q('#studentSel'); sel.innerHTML='';
  (roster.students||[]).forEach(s=>{const o=document.createElement('option'); o.value=s.id; o.textContent=s.name||s.id; sel.appendChild(o);});
  if(currentStudent) sel.value=currentStudent; else if(roster.students?.length){currentStudent=roster.students[0].id; sel.value=currentStudent;}
  sel.onchange=()=>{currentStudent=sel.value; const u=new URL(location.href); u.searchParams.set('student',currentStudent); history.replaceState({},'',u); loadManifest(currentStudent);};
}

function renderCalendar(){
  const container=q('#calendar'); container.innerHTML='';
  const today=new Date(), y=today.getFullYear(), m=today.getMonth(), first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0), days=last.getDate();
  const grid=document.createElement('div'); grid.className='calendar';
  ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(d=>{const el=document.createElement('div'); el.className='dow'; el.textContent=d; grid.appendChild(el);});
  for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));

  const entries=manifest?.entries||{};
  for(let day=1; day<=days; day++){
    const d=new Date(y,m,day), k=ymd(d), cell=document.createElement('div'); cell.className='cell';
    if(k in entries) cell.classList.add('has'); if(k===ymd(new Date())) cell.classList.add('today');
    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.textContent=day; cell.appendChild(dayEl);
    if(k in entries){ const dot=document.createElement('span'); dot.className='dot'; cell.appendChild(dot); cell.style.cursor='pointer';
      cell.onclick=()=>{renderList(k); const u=new URL(location.href); u.searchParams.set('date',k); history.replaceState({},'',u);}; }
    grid.appendChild(cell);
  }
  container.appendChild(grid);
  if(queryDate && (queryDate in entries)) renderList(queryDate); else q('#items').innerHTML='';
}

function renderList(dateKey){
  const wrap=q('#items'); wrap.innerHTML=`<h3>${dateKey} çš„æ•™æ</h3>`;
  const arr=manifest.entries[dateKey]||[];
  if(!arr.length){ wrap.innerHTML+=`<div class="card">é€™å¤©æ²’æœ‰æ•™æ</div>`; return; }
  arr.forEach(item=>{
    const card=document.createElement('div'); card.className='card';
    const tag1=document.createElement('span'); tag1.className='tag'; tag1.textContent = item.type || 'material';
    const tag2=document.createElement('span'); tag2.className='tag'; tag2.textContent = item.course || 'general';
    const a=document.createElement('a'); a.href='/'+item.path; a.textContent=item.title||item.path;
    card.appendChild(tag1); card.appendChild(tag2); card.appendChild(a); wrap.appendChild(card);
  });
}

async function loadManifest(studentId){
  setErr('');
  try{ manifest=await apiGet(`students/${studentId}/manifest.json`); renderCalendar(); }
  catch(e){ console.error(e); setErr(`éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å­¸ç”Ÿ ${studentId} çš„è³‡æ–™`); manifest={"student":studentId,"entries":{}}; renderCalendar(); }
}

async function init(){
  roster=await apiGet('roster.json');
  currentStudent=queryStudent || roster.students?.[0]?.id || null;
  renderRoster();
  if(!currentStudent){ setErr('å°šæœªå»ºç«‹ä»»ä½•å­¸ç”Ÿï¼Œè«‹å…ˆåˆ°å¾Œå°æ–°å¢ï¼ˆadmin.htmlï¼‰'); return; }
  await loadManifest(currentStudent);
}
init();
</script>
</body>
</html>


=== FILE: docs\students\roster.json ===
{
  "students": [
    { "id": "sally", "name": "Sally Lin" },
    { "id": "ray",   "name": "Ray" }
  ]
}


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {}
}


=== FILE: docs\admin.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1100px;margin:36px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:22px 24px;}
  h1{margin:0 0 16px;display:flex;gap:10px;align-items:center;justify-content:space-between;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0;}
  input[type="text"], input[type="date"], select, textarea{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;font-size:15px;}
  textarea{width:100%;min-height:200px;}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
  .btn.gray{background:#6b7280}.btn.green{background:#059669}.btn.red{background:#dc2626}
  .msg{padding:10px 12px;border-radius:8px;margin:8px 0;display:none}
  .msg.ok{display:block;background:#e6f9ed;color:#065f46}.msg.err{display:block;background:#fde2e0;color:#9b1c1c}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:12px;}
  .box{background:#f8fafc;border-radius:10px;padding:12px;}
  .list .item{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;margin:6px 0;display:flex;justify-content:space-between;align-items:center;}
  .muted{opacity:.65}
</style>
</head>
<body>
<div class="app">
  <h1>
    <span>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</span>
    <div class="row" style="margin:0">
      <input type="text" id="newCourseKey" placeholder="èª²ç¨‹ keyï¼ˆenglishï¼‰"/>
      <input type="text" id="newCourseLabel" placeholder="é¡¯ç¤ºåï¼ˆè‹±æ–‡ï¼‰"/>
      <button class="btn gray" id="btnAddCourse">æ–°å¢èª²ç¨‹</button>
      <input type="text" id="newTypeKey" placeholder="é¡å‹ keyï¼ˆhomeworkï¼‰"/>
      <input type="text" id="newTypeLabel" placeholder="é¡¯ç¤ºåï¼ˆä½œæ¥­ï¼‰"/>
      <button class="btn gray" id="btnAddType">æ–°å¢é¡å‹</button>
    </div>
  </h1>

  <div id="msg" class="msg"></div>

  <div class="row">
    <label>å­¸ç”Ÿï¼š</label>
    <select id="studentSel"></select>
    <button class="btn" id="btnReload">è¼‰å…¥</button>
    <span style="flex:1"></span>
    <input type="text" id="newId" placeholder="æ–°å­¸ç”Ÿ idï¼ˆå°å¯«/ç„¡ç©ºç™½ï¼‰"/>
    <input type="text" id="newName" placeholder="æ–°å­¸ç”Ÿå§“åï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯ç©ºï¼‰"/>
    <button class="btn green" id="btnAddStudent">æ–°å¢å­¸ç”Ÿ</button>
  </div>

  <div class="grid">
    <div class="box">
      <h3>å»ºç«‹ / ç·¨è¼¯ï¼ˆå–®éµå„²å­˜ï¼‰</h3>
      <div class="row">
        <input type="date" id="date"/>
        <select id="course"></select>
        <select id="type"></select>
      </div>
      <div class="row">
        <input style="flex:1" type="text" id="title" placeholder="æ¨™é¡Œ"/>
        <input style="flex:1" type="text" id="filename" placeholder="æª”åï¼ˆå¯ç•™ç©ºï¼Œæœƒç”¨ æ—¥æœŸ_æ¨™é¡Œ.htmlï¼‰"/>
      </div>
      <textarea id="html" placeholder="æ•™æ HTMLï¼ˆå¯ç•™ç©ºï¼šåªè¨˜éŒ„è·¯å¾‘ï¼›æŒ‰ã€å„²å­˜ã€æœƒç›´æ¥å¯«å…¥/è¦†è“‹ï¼‰"></textarea>
      <div class="row">
        <button class="btn green" id="btnSave">å„²å­˜</button>
        <span class="muted">å„²å­˜æœƒï¼šå¯« HTMLï¼ˆè‹¥æœ‰å…§å®¹ï¼‰â†’ æ›´æ–°/æ–°å¢æ¢ç›® â†’ å¯«å…¥ manifest.json</span>
      </div>
    </div>

    <div class="box">
      <h3>ç¾æœ‰æ¢ç›®</h3>
      <div class="row">
        <label>ç¯©é¸æ—¥æœŸï¼š</label>
        <input type="date" id="filterDate"/>
        <span class="muted">ï¼ˆåˆªé™¤å°‡**åŒæ™‚**åˆªé™¤ HTML æª”ï¼‰</span>
      </div>
      <div class="list" id="list"></div>
    </div>
  </div>
</div>

<script src="admin.js"></script>
</body>
</html>


=== FILE: docs\admin.js ===
// ------- helpers -------
const q=(s,e=document)=>e.querySelector(s);
const msg=q('#msg');
const base=(p)=>p.split('/').pop();
const ymd=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

function toast(ok, text){
  msg.className='msg ' + (ok?'ok':'err');
  msg.textContent=text; msg.style.display='block';
  clearTimeout(window.__t); window.__t=setTimeout(()=>msg.style.display='none',3000);
}
async function apiGet(path){
  const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status); return await r.json();
}
async function apiGetText(path){
  const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status); return await r.text();
}
async function apiSave(path, content){
  const r=await fetch('/api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,content})});
  const j=await r.json(); if(!r.ok||j.status!=='success') throw new Error(j.message||('HTTP '+r.status)); return j;
}
async function apiDelete(path){
  const r=await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path})});
  const j=await r.json(); if(!r.ok||j.status!=='success') throw new Error(j.message||('HTTP '+r.status)); return j;
}

// ------- state -------
let roster={students:[]}, manifest=null, stu=null;

// ------- manifest helpers -------
function ensureBase(){
  if(!manifest.version) manifest.version=3;
  manifest.courses=manifest.courses||{english:{label:'è‹±æ–‡'}, math:{label:'æ•¸å­¸'}};
  manifest.types  =manifest.types  ||{material:'æ•™æ', homework:'ä½œæ¥­'};
  manifest.days   =manifest.days   ||{};
}
function ensureArr(date,course,type){
  manifest.days[date]=manifest.days[date]||{};
  manifest.days[date][course]=manifest.days[date][course]||{};
  manifest.days[date][course][type]=manifest.days[date][course][type]||[];
  return manifest.days[date][course][type];
}
function removeEmpty(date,course,type){
  const d=manifest.days[date]||{};
  const c=d[course]||{};
  if((c[type]||[]).length===0) delete c[type];
  if(Object.keys(c).length===0) delete d[course];
  if(Object.keys(d).length===0) delete manifest.days[date];
}

// ------- UI render -------
function renderStu(){
  const sel=q('#studentSel'); sel.innerHTML='';
  (roster.students||[]).forEach(s=>{const o=document.createElement('option'); o.value=s.id; o.textContent=s.name||s.id; sel.appendChild(o);});
  if(!stu) stu=roster.students?.[0]?.id||null;
  if(stu) sel.value=stu;
  sel.onchange=async()=>{stu=sel.value; await loadManifest();}
}
function renderCourseType(){
  const c=q('#course'), t=q('#type'); c.innerHTML=''; t.innerHTML='';
  Object.entries(manifest.courses).forEach(([k,v])=>{const o=document.createElement('option'); o.value=k; o.textContent=v.label||k; c.appendChild(o);});
  Object.entries(manifest.types).forEach(([k,v])=>{const o=document.createElement('option'); o.value=k; o.textContent=v||k; t.appendChild(o);});
}

// é è¨­å¸¶å…¥ï¼šæœ€æ–°æ—¥æœŸï¼ˆ>=ä»Šå¤©å‰‡ç”¨æœ€æ–°ï¼›è‹¥æœ€æ–°åœ¨ä»Šå¤©ä»¥å‰ï¼Œå°±ç”¨ä»Šå¤©ï¼‰
function setDefaultDateFocus(){
  const today=ymd(new Date());
  const dates=Object.keys(manifest.days||{}).sort();
  const latest = dates.length ? dates[dates.length-1] : null;
  const pick = (!latest || latest < today) ? today : latest;
  q('#filterDate').value = pick;
  q('#date').value = pick;
}

function renderList(){
  const wrap=q('#list'); wrap.innerHTML='';
  const fd=q('#filterDate').value || null;
  const days=manifest.days||{};
  const dates=Object.keys(days).sort().filter(d=>!fd||d===fd);
  if(!dates.length){ wrap.innerHTML='<div class="item" style="opacity:.7">ç›®å‰æ²’æœ‰æ¢ç›®</div>'; return; }

  dates.forEach(d=>{
    const perDate=days[d];
    Object.keys(perDate).forEach(course=>{
      Object.keys(perDate[course]).forEach(type=>{
        perDate[course][type].forEach((it,idx)=>{
          const row=document.createElement('div'); row.className='item';
          row.innerHTML=`
            <div>${d}ï½œ${manifest.courses[course]?.label||course}ï½œ${manifest.types[type]||type} â†’ <strong>${it.title||base(it.path)}</strong></div>
            <div style="display:flex;gap:8px">
              <button class="btn gray">ç·¨è¼¯</button>
              <button class="btn red">åˆªé™¤</button>
            </div>`;
          // ç·¨è¼¯ï¼šå¸¶å›è¡¨å–® + è®€å› HTML
          row.children[1].children[0].onclick=async()=>{
            q('#date').value=d; q('#course').value=course; q('#type').value=type;
            q('#title').value=it.title||''; q('#filename').value=base(it.path||'');
            try{
              const raw = await apiGetText(it.path);
              let bodySnippet = '';
              try{
                const doc = new DOMParser().parseFromString(raw, 'text/html');
                const cont = doc.querySelector('.container');
                if(cont){
                  const clone = cont.cloneNode(true);
                  const h1 = clone.querySelector('h1'); if(h1) h1.remove();
                  bodySnippet = clone.innerHTML.trim();
                }else{
                  bodySnippet = (doc.querySelector('body')?.innerHTML||'').trim();
                }
              }catch(_){}
              q('#html').value = bodySnippet;
            }catch(e){
              q('#html').value='';
              toast(false,'è®€å–æ—¢æœ‰ HTML å¤±æ•—ï¼Œåƒ…å¸¶å…¥æ¨™é¡Œ/æª”å');
            }
            toast(true,'å·²å¸¶å…¥è¡¨å–®ï¼Œå¯ç›´æ¥ä¿®æ”¹å¾ŒæŒ‰ã€Œå„²å­˜ã€');
          };
          // åˆªé™¤ï¼šä¸€å¾‹åŒæ­¥åˆª HTML
          row.children[1].children[1].onclick=async()=>{
            const arr=manifest.days[d][course][type];
            const [removed]=arr.splice(idx,1);
            removeEmpty(d,course,type);
            if(removed?.path){
              try{ await apiDelete(removed.path); }catch(e){ toast(false,'åˆªæª”å¤±æ•—ï¼š'+(e.message||e)); }
            }
            await apiSave(`students/${stu}/manifest.json`, manifest);
            renderList(); toast(true,'å·²åˆªé™¤ï¼ˆå« HTML æª”ï¼‰');
          };
          wrap.appendChild(row);
        });
      });
    });
  });
}

// ------- actions -------
async function loadRoster(){
  roster=await apiGet('roster.json'); renderStu();
}
async function loadManifest(){
  manifest=await apiGet(`students/${stu}/manifest.json`); ensureBase();
  renderCourseType(); setDefaultDateFocus(); renderList();
}
function buildFilename(date,title){
  const safe=(title||'lesson').trim().replace(/\s+/g,'_').toLowerCase();
  return `${date}_${safe}.html`;
}
async function doSave(){
  if(!stu) return toast(false,'è«‹å…ˆå»ºç«‹å­¸ç”Ÿ');
  const date=q('#date').value||''; if(!date) return toast(false,'è«‹é¸æ—¥æœŸ');
  const course=q('#course').value; const type=q('#type').value;
  const title=(q('#title').value||'').trim();
  let filename=(q('#filename').value||'').trim(); if(!filename) filename = buildFilename(date,title);
  const rel=`materials/${stu}/${course}/${filename}`;
  const html=(q('#html').value||'').trim();

  if(html){
    const wrap=`<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title||''}</title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=${encodeURIComponent(stu)}&date=${encodeURIComponent(date)}">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1>${title||''}</h1>${html}</div>
</body></html>`;
    await apiSave(rel, wrap);
  }

  const arr=ensureArr(date,course,type);
  const exists=arr.find(x=>x.path===rel);
  if(exists){ exists.title=title; } else { arr.push({title, path: rel}); }

  await apiSave(`students/${stu}/manifest.json`, manifest);

  // å„²å­˜å¾Œæ˜¯å¦æ¸…ç©ºè¡¨å–®ï¼Ÿ
  if(!q('#keepForm').checked){
    q('#title').value=''; q('#filename').value=''; q('#html').value='';
  }
  setDefaultDateFocus(); renderList();
  toast(true,'å·²å„²å­˜');
}

// é¡å¤–ï¼šæ¸…ç©ºèˆ‡é‡è¼‰
function clearForm(){ q('#title').value=''; q('#filename').value=''; q('#html').value=''; }
async function reloadCurrentHtml(){
  const date=q('#date').value, course=q('#course').value, type=q('#type').value;
  const file=q('#filename').value;
  if(!file){ toast(false,'ç›®å‰æ²’æœ‰æª”åå¯é‡è¼‰'); return; }
  const rel=`materials/${stu}/${course}/${file}`;
  try{
    const raw=await apiGetText(rel);
    const doc=new DOMParser().parseFromString(raw,'text/html');
    const cont=doc.querySelector('.container'); let body='';
    if(cont){ const c=cont.cloneNode(true); const h=c.querySelector('h1'); if(h) h.remove(); body=c.innerHTML.trim(); }
    else{ body=(doc.querySelector('body')?.innerHTML||'').trim(); }
    q('#html').value=body; toast(true,'å·²é‡è¼‰ç›®å‰æ•™æ');
  }catch(e){ toast(false,'é‡è¼‰å¤±æ•—ï¼š'+(e.message||e)); }
}

// ------- boot -------
async function init(){
  await loadRoster(); await loadManifest();
  q('#btnReload').onclick=loadManifest;
  q('#btnSave').onclick=doSave;
  q('#btnClear').onclick=clearForm;
  q('#btnReloadHtml').onclick=reloadCurrentHtml;
  q('#filterDate').oninput=renderList;

  // èª²ç¨‹/é¡å‹ï¼ˆå³ä¸Šï¼‰æ–°å¢
  q('#btnAddCourse')?.addEventListener('click', ()=>{
    const k=(q('#newCourseKey').value||'').trim(); const label=(q('#newCourseLabel').value||'').trim()||k;
    if(!k) return toast(false,'è«‹è¼¸å…¥èª²ç¨‹ key'); if(manifest.courses[k]) return toast(false,'èª²ç¨‹å·²å­˜åœ¨');
    manifest.courses[k]={label}; renderCourseType();
    q('#newCourseKey').value=q('#newCourseLabel').value='';
    toast(true,'å·²æ–°å¢èª²ç¨‹ï¼ˆä»»ä½•å„²å­˜éƒ½æœƒä¸€ä½µå¯«å› manifestï¼‰');
  });
  q('#btnAddType')?.addEventListener('click', ()=>{
    const k=(q('#newTypeKey').value||'').trim(); const label=(q('#newTypeLabel').value||'').trim()||k;
    if(!k) return toast(false,'è«‹è¼¸å…¥é¡å‹ key'); if(manifest.types[k]) return toast(false,'é¡å‹å·²å­˜åœ¨');
    manifest.types[k]=label; renderCourseType();
    q('#newTypeKey').value=q('#newTypeLabel').value='';
    toast(true,'å·²æ–°å¢é¡å‹ï¼ˆä»»ä½•å„²å­˜éƒ½æœƒä¸€ä½µå¯«å› manifestï¼‰');
  });

  // æ–°å¢å­¸ç”Ÿ
  q('#btnAddStudent').onclick=async()=>{
    const id=(q('#newId').value||'').trim(); const name=(q('#newName').value||'').trim();
    if(!/^[a-z0-9_-]+$/.test(id)) return toast(false,'id éœ€ç‚ºå°å¯«è‹±æ•¸èˆ‡ _-');
    roster.students.push({id, name: name||id}); await apiSave('roster.json', roster);
    q('#newId').value=''; q('#newName').value='';
    await loadRoster(); stu=id; await loadManifest(); toast(true,'å·²æ–°å¢å­¸ç”Ÿ');
  };
}
init();


=== FILE: docs\index.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èª²ç¨‹æ—¥æ›†</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1024px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px 28px;position:relative;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .nav{display:flex;gap:10px;align-items:center}
  button.navbtn{border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .links a{margin-left:8px;color:#2563eb;text-decoration:none}
  .msg{padding:12px 14px;border-radius:8px;margin:8px 0;display:none}
  .msg.err{background:#fde2e0;color:#9b1c1c}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px;}
  .dow{font-weight:700;color:#5b6770;text-align:center;}
  .cell{background:#f7fafc;min-height:74px;border-radius:10px;padding:8px;position:relative}
  .cell .day{font-weight:700;color:#3a4a5b;}
  .cell.has .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;background:#34c759;border-radius:50%;}
  .cell.today{outline:2px solid #2f80ed;background:#eef6ff;}
  .popover{position:absolute;z-index:50;min-width:280px;max-width:360px;background:#fff;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px;display:none}
  .popover .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .card{background:#f7fafc;border-radius:10px;padding:10px 12px;margin:8px 0;}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="nav">
      <button class="navbtn" id="btnPrev">â—€</button>
      <div id="monthLabel" style="font-weight:700"></div>
      <button class="navbtn" id="btnNext">â–¶</button>
    </div>
    <div class="links">
      <span id="studentName" style="font-weight:700;margin-right:8px"></span>
      <a href="/teacher.html">è€å¸«ä¸»é </a>
      <a href="/admin.html">å¾Œå°</a>
    </div>
  </div>

  <div id="err" class="msg err"></div>
  <div id="calendar"></div>

  <div id="popover" class="popover">
    <div class="row">
      <label>èª²ç¨‹ï¼š</label><select id="pCourse"></select>
      <label>é¡å‹ï¼š</label><select id="pType"></select>
    </div>
    <div id="pList"></div>
  </div>
</div>

<script>
const q=(s,e=document)=>e.querySelector(s);
const params=new URLSearchParams(location.search);
let currentStudent=params.get('student')||null;
let currentDate=params.get('date')||null;
let currentCourse=params.get('course')||null;
let currentType=params.get('type')||null;

let roster={students:[]}, manifest=null;
let view = (()=>{
  const d = currentDate ? new Date(currentDate) : new Date();
  return {y: d.getFullYear(), m: d.getMonth()};
})();
const fmtYMD=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const base=(p)=>p.split('/').pop();
function niceTitle(item){
  if(item.title && item.title.trim()) return item.title.trim();
  let name=base(item.path||'').replace(/\.[^.]+$/,'').replace(/^\d{4}-\d{2}-\d{2}_?/, '');
  return name || 'æ•™æ';
}
async function apiGet(path){
  const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
function setErr(m){const el=q('#err'); if(m){el.textContent=m; el.style.display='block';} else el.style.display='none';}

function dateHasAny(dayObj){
  if(!dayObj) return false;
  return Object.values(dayObj).some(courseObj=>{
    if(!courseObj) return false;
    return Object.values(courseObj).some(arr=>Array.isArray(arr)&&arr.length>0);
  });
}

function renderCalendar(){
  const container=q('#calendar'); container.innerHTML='';
  const y=view.y, m=view.m;
  q('#monthLabel').textContent = `${y} / ${String(m+1).padStart(2,'0')}`;

  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0), days=last.getDate();
  const grid=document.createElement('div'); grid.className='calendar';

  ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; grid.appendChild(el);
  });
  for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));

  const daysMap=manifest?.days||{};
  for(let day=1; day<=days; day++){
    const d=new Date(y,m,day), k=fmtYMD(d), cell=document.createElement('div'); cell.className='cell';
    const has = dateHasAny(daysMap[k]);
    if(has){
      cell.classList.add('has');
      const dot=document.createElement('span'); dot.className='dot'; cell.appendChild(dot);
      cell.style.cursor='pointer';
      cell.onclick=()=>openPopover(k, cell);
    }
    const todayStr=fmtYMD(new Date());
    if(k===todayStr) cell.classList.add('today');

    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.textContent=day; cell.appendChild(dayEl);
    grid.appendChild(cell);
  }
  container.appendChild(grid);

  if(currentDate){
    const d=new Date(currentDate);
    if(d.getFullYear()===y && d.getMonth()===m){
      const cell = container.querySelectorAll('.cell')[d.getDate()+start] || null;
      if(cell) openPopover(currentDate, cell);
    }
  }
}

function combosFor(dateKey){
  const day=manifest?.days?.[dateKey]||{};
  const combos=[];
  Object.keys(day).forEach(c=>{
    Object.keys(day[c]||{}).forEach(t=>{
      const items=(day[c][t]||[]);
      if(items.length) combos.push({course:c,type:t,items});
    });
  });
  return combos;
}
function renderPopoverList(dateKey, courseKey, typeKey){
  const wrap=q('#pList'); wrap.innerHTML='';
  const arr=(((manifest.days?.[dateKey]||{})[courseKey]||{})[typeKey])||[];
  if(!arr.length){ wrap.innerHTML='<div class="card">é€™å€‹çµ„åˆç›®å‰æ²’æœ‰å…§å®¹</div>'; return; }
  arr.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const a=document.createElement('a'); a.href='/'+it.path; a.textContent=niceTitle(it);
    card.appendChild(a); wrap.appendChild(card);
  });
}
function openPopover(dateKey, anchorCell){
  currentDate=dateKey;
  const u=new URL(location.href); u.searchParams.set('date',dateKey); history.replaceState({},'',u);

  const combos=combosFor(dateKey);
  if(!combos.length) return;

  const pop=q('#popover'); const app=q('#app');
  const csel=q('#pCourse'), tsel=q('#pType');
  csel.innerHTML=''; tsel.innerHTML='';
  const courses=[...new Set(combos.map(x=>x.course))];
  const types=[...new Set(combos.map(x=>x.type))];
  courses.forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=manifest.courses?.[c]?.label||c; csel.appendChild(o);});
  types.forEach(t=>{const o=document.createElement('option'); o.value=t; o.textContent=manifest.types?.[t]||t; tsel.appendChild(o);});
  const ck = (currentCourse && courses.includes(currentCourse)) ? currentCourse : courses[0];
  const tk = (currentType && types.includes(currentType)) ? currentType : types[0];
  csel.value=ck; tsel.value=tk;
  renderPopoverList(dateKey, ck, tk);
  csel.onchange=()=>{ currentCourse=csel.value; renderPopoverList(dateKey, csel.value, tsel.value); syncURL(); };
  tsel.onchange=()=>{ currentType=tsel.value; renderPopoverList(dateKey, csel.value, tsel.value); syncURL(); };

  const ar=anchorCell.getBoundingClientRect();
  const pr=app.getBoundingClientRect();
  pop.style.display='block';
  pop.style.left = (ar.right - pr.left + 10) + 'px';
  pop.style.top  = (ar.top - pr.top + window.scrollY - 6) + 'px';
  const popRect=pop.getBoundingClientRect();
  if(popRect.right > window.innerWidth - 12){
    pop.style.left = (ar.left - pr.left - popRect.width - 10) + 'px';
  }
  document.addEventListener('click', onDocClick);
  function onDocClick(e){ if(pop.contains(e.target)||anchorCell.contains(e.target)) return; pop.style.display='none'; document.removeEventListener('click', onDocClick); }
  function syncURL(){
    const u=new URL(location.href);
    u.searchParams.set('date', dateKey);
    u.searchParams.set('course', csel.value);
    u.searchParams.set('type',   tsel.value);
    history.replaceState({},'',u);
  }
}

async function loadManifest(){
  // é¡¯ç¤ºå­¸ç”Ÿåï¼ˆå„ªå…ˆ rosterï¼Œå…¶æ¬¡ manifest.displayNameï¼‰
  const stu = (roster.students||[]).find(s=>s.id===currentStudent);
  q('#studentName').textContent = (stu?.name) ? `å­¸ç”Ÿï¼š${stu.name}` : `å­¸ç”Ÿï¼š${currentStudent||''}`;
  try{ manifest=await apiGet(`students/${currentStudent}/manifest.json`); renderCalendar(); }
  catch(e){ console.error(e); setErr('ç„¡æ³•è®€å–å­¸ç”Ÿè³‡æ–™ï¼Œè«‹ç¢ºèªç”¨ python server.py é–‹å•Ÿï¼Œæˆ–å…ˆåˆ°å¾Œå°å»ºç«‹ã€‚'); }
}

async function init(){
  try{ roster=await apiGet('roster.json'); }
  catch(e){ setErr('è®€å– roster.json å¤±æ•—ï¼›è«‹ç”¨ http://127.0.0.1:5000/ å­˜å–'); return; }

  // æœˆä»½åˆ‡æ›
  q('#btnPrev').onclick=()=>{ if(--view.m<0){view.m=11; view.y--;} renderCalendar(); };
  q('#btnNext').onclick=()=>{ if(++view.m>11){view.m=0; view.y++;} renderCalendar(); };

  if(!currentStudent) currentStudent = roster.students?.[0]?.id || null;
  await loadManifest();
}
init();
</script>
</body>
</html>


=== FILE: docs\roster.json ===
{
  "students": [
    { "id": "åº­å¦¤", "name": "åº­å¦¤" },
    { "id": "ray",   "name": "Ray" }
  ]
}


=== FILE: docs\teacher.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è€å¸«ä¸»é </title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1024px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px 28px;}
  .header{display:flex;justify-content:space-between;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:14px;}
  .card{background:#f7fafc;border-radius:12px;padding:14px;border:1px solid #e5e7eb}
  .card h3{margin:0 0 6px}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none}
  .link{color:#2563eb;text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>è€å¸«ä¸»é </h1>
    <a class="btn" href="/admin.html">é€²å¾Œå°</a>
  </div>
  <div id="list" class="grid"></div>
</div>
<script>
const q=(s,e=document)=>e.querySelector(s);
async function apiGet(path){
  const r=await fetch(`/api/data/${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status); return await r.json();
}
async function init(){
  const roster=await apiGet('roster.json');
  const wrap=q('#list'); wrap.innerHTML='';
  (roster.students||[]).forEach(s=>{
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<h3>${s.name||s.id}</h3>
      <div style="opacity:.7">idï¼š${s.id}</div>
      <div style="margin-top:8px"><a class="btn" href="/index.html?student=${encodeURIComponent(s.id)}">æ‰“é–‹æ—¥æ›†</a></div>`;
    wrap.appendChild(el);
  });
}
init();
</script>
</body>
</html>


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {}
}

=== FILE: docs\students\sally\manifest.json ===
{
  "version": 3,
  "student": "sally",
  "displayName": "sally",
  "courses": {
    "english": {
      "label": "è‹±æ–‡"
    },
    "math": {
      "label": "æ•¸å­¸"
    }
  },
  "types": {
    "material": "æ•™æ",
    "homework": "ä½œæ¥­"
  },
  "days": {
    "2025-08-09": {
      "english": {
        "material": [
          {
            "title": "ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)",
            "path": "materials/sally/english/2025-08-09_ä¸»é¡Œï¼šåª’é«”ç´ é¤Š_(media_literacy).html"
          }
        ]
      }
    }
  }
}

=== FILE: docs\materials\sally\english\2025-08-09_ä¸»é¡Œï¼šåª’é«”ç´ é¤Š_(media_literacy).html ===
<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)</title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=sally&date=2025-08-09">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1>ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)</h1><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- è®“éºµåŒ…å±‘èƒ½æ­£ç¢ºè§£ææ—¥æœŸ -->
    <meta name="lesson-date" content="2025-08-10">
    <title>é«˜ä¸‰å­¸æ¸¬è‹±æ–‡ - ä¸»é¡Œæ¢è¨ï¼šåª’é«”ç´ é¤Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        summary {
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary::before {
            content: 'â–¶';
            margin-right: 8px;
            font-size: 0.8em;
            display: inline-block;
            transition: transform 0.2s ease-in-out;
        }
        details[open] summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <!-- è‡ªå‹•ç”¢ç”Ÿè¿”å›ä¸»é çš„éºµåŒ…å±‘ -->
    <div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
    <script>
    (function () {
      // 1) å…ˆç”¨ <meta name="lesson-date">ï¼›è‹¥æ²’æœ‰ï¼Œå†å˜—è©¦å¾æª”åæ¨ YYMMDD
      const metaDate = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
      let dateStr = metaDate && !isNaN(Date.parse(metaDate)) ? metaDate : null;
      if (!dateStr) {
        const m = location.pathname.match(/(\d{2})(\d{2})(\d{2})\.html$/);
        if (m) dateStr = `20${m[1]}-${m[2]}-${m[3]}`;
      }
      const backUrl = dateStr ? `../index.html?date=${dateStr}#calendar-widget` : `../index.html#calendar-widget`;
      document.getElementById('breadcrumb').innerHTML = `
        <a href="${backUrl}" class="text-blue-600 hover:text-blue-800 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>
      `;
    })();
    </script>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
        <header class="text-center mb-12">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">é«˜ä¸‰å­¸æ¸¬è‹±æ–‡ - ä¸»é¡Œæ¢è¨ ğŸŒ</h1>
            <p class="text-lg text-gray-600">ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)</p>
        </header>

        <main class="space-y-12">

            <!-- 1. é‡é»å–®å­— -->
            <section id="vocabulary">
                <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">1. é‡é»å–®å­— (Key Vocabulary)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">literacy (n.)</h3>
                        <p class="text-gray-700">ç´ é¤Šï¼›è®€å¯«èƒ½åŠ›</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., Financial <strong>literacy</strong> is essential for managing personal finances.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">critically (adv.)</h3>
                        <p class="text-gray-700">æ‰¹åˆ¤æ€§åœ°</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., We should think <strong>critically</strong> about the news we read online.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">evaluate (v.)</h3>
                        <p class="text-gray-700">è©•ä¼°ï¼›è©•åƒ¹</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., It's important to <strong>evaluate</strong> the credibility of a website before trusting its content.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">verify (v.)</h3>
                        <p class="text-gray-700">æŸ¥è­‰ï¼›æ ¸å¯¦</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., Always try to <strong>verify</strong> facts from multiple sources.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">mislead (v.)</h3>
                        <p class="text-gray-700">èª¤å° (ä¸‰æ…‹: mislead, misled, misled)</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., The advertisement was designed to <strong>mislead</strong> customers.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">cultivate (v.)</h3>
                        <p class="text-gray-700">åŸ¹é¤Š</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., Parents play a key role in <strong>cultivating</strong> good habits in their children.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">prevalence (n.)</h3>
                        <p class="text-gray-700">æ™®åŠï¼›ç››è¡Œ</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., The <strong>prevalence</strong> of smartphones has changed how we communicate.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">disseminator (n.)</h3>
                        <p class="text-gray-700">å‚³æ’­è€…</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., With social media, anyone can be a content <strong>disseminator</strong>.</p>
                    </div>
                </div>
            </section>

            <!-- 2. æ ¸å¿ƒå¥å‹ -->
            <section id="patterns">
                <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">2. æ ¸å¿ƒå¥å‹ (Core Sentence Patterns)</h2>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 1: <code class="text-pink-600">The term A refers to B, which/where...</code> (A ä¸€è©æŒ‡çš„æ˜¯ Bï¼Œè€Œ B...)</p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šç”¨ä¾†æä¾›ä¸€å€‹æ­£å¼çš„å®šç¾©ï¼Œä¸¦å¯æ¥çºŒä¸€å€‹é—œä¿‚å­å¥ä¾†è£œå……èªªæ˜ã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼šThe term "media literacy" <strong>refers to</strong> a set of skills, <strong>which</strong> empower individuals to critically analyze media messages.</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 2: <code class="text-pink-600">In an era flooded with..., it is important/vital/crucial to + Vr...</code></p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šå¼·èª¿åœ¨æŸå€‹ç‰¹å®šæ™‚ä»£èƒŒæ™¯ä¸‹ï¼ŒåšæŸä»¶äº‹çš„é‡è¦æ€§ã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼š<strong>In an era flooded with</strong> fake news, <strong>it is crucial to verify</strong> information sources.</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 3: <code class="text-pink-600">Cultivating... can help sb. (to) avoid being + p.p.</code> (åŸ¹é¤Š...èƒ½å¹«åŠ©æŸäººé¿å…è¢«...)</p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šè¡¨é”æ¡å–æŸè¡Œå‹•å¯ä»¥å¹«åŠ©é¿å…æŸç¨®è¢«å‹•çš„è² é¢çµæœã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼š<strong>Cultivating</strong> good media literacy <strong>can help us avoid being misled</strong> by false information.</p>
                    </div>
                     <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 4: <code class="text-pink-600">...come(s) with + N.</code> (...ä¼´éš¨è‘—...è€Œä¾†)</p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šè¡¨ç¤ºæŸäº‹ç‰©å‡ºç¾æ™‚ï¼Œæœƒé€£å¸¶ç”¢ç”Ÿå¦ä¸€ç¨®æƒ…æ³æˆ–è²¬ä»»ã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼šBecoming a content creator <strong>comes with</strong> great responsibility.</p>
                    </div>
                </div>
            </section>

            <!-- 3. å¯«ä½œæ”»ç•¥ -->
            <section id="writing-strategy">
                <h2 class="text-2xl font-bold text-purple-700 border-b-2 border-purple-200 pb-2 mb-6">3. å¯«ä½œæ”»ç•¥ (Writing Strategy)</h2>
                
                <div class="bg-purple-50 border-l-4 border-purple-400 p-6 rounded-r-lg space-y-6">
                    <div>
                        <h3 class="text-lg font-bold text-purple-900">ç¬¬ä¸€æ­¥ï¼šè¾¨åˆ¥æ–‡é«”</h3>
                        <p class="mt-1 text-gray-800">çœ‹åˆ°ã€Œæ¢è¨é‡è¦æ€§ã€ã€ã€Œåˆ†æå½±éŸ¿ã€é€™é¡é¡Œç›®ï¼Œå°±è¦çŸ¥é“é€™æ˜¯ä¸€ç¯‡<strong class="font-semibold">ã€Œè«–èªªæ–‡ã€(Argumentative/Expository Essay)</strong>ã€‚ä½ çš„ç›®æ¨™æ˜¯æå‡ºæ¸…æ™°çš„è«–é»ï¼Œä¸¦ç”¨ç†ç”±å’Œä¾‹å­ä¾†æ”¯æŒå®ƒã€‚</p>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-purple-900">ç¬¬äºŒæ­¥ï¼šè¦åŠƒæ–‡ç« æ¶æ§‹ (Structure)</h3>
                        <p class="mt-1 text-gray-800 mb-4">ä¸€ç¯‡å¥½çš„è«–èªªæ–‡ï¼Œå°±åƒè“‹æˆ¿å­ï¼Œéœ€è¦ç©©å›ºçš„æ¶æ§‹ã€‚ä½ å¯ä»¥éµå¾ªã€Œç¸½-åˆ†-ç¸½ã€çš„åŸå‰‡ï¼š</p>
                        
                        <div class="space-y-3">
                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p><strong>A. ä¸»æ—¨æ®µ (Introduction): é»å‡ºæ ¸å¿ƒè«–é»</strong></p>
                                <ul class="list-disc list-inside mt-2 text-gray-700 text-sm space-y-1">
                                    <li><strong>é–‹é ­ (Hook):</strong> ç”¨ä¸€å€‹å•é¡Œæˆ–ä¸€å¥è©±å¸å¼•è®€è€…æ³¨æ„ã€‚ (e.g., "In a world saturated with information, how can we tell truth from fiction?")</li>
                                    <li><strong>å®šç¾©èˆ‡èƒŒæ™¯:</strong> ç°¡å–®è§£é‡‹ã€Œåª’é«”ç´ é¤Šã€æ˜¯ä»€éº¼ï¼Œä»¥åŠç‚ºä»€éº¼åœ¨ã€Œæ•¸ä½æ™‚ä»£ã€å¾ˆé‡è¦ã€‚</li>
                                    <li><strong>ä¸»æ—¨å¥ (Thesis Statement):</strong> ä¸€å¥è©±æ¸…æ¥šè¡¨æ˜ä½ çš„æ ¸å¿ƒè«–é»ã€‚ (e.g., "Therefore, developing media literacy is a critical skill for navigating the modern world and fostering a responsible digital citizenship.")</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p><strong>B. æ”¯æ’æ®µ (Body Paragraph): æå‡ºç†ç”±èˆ‡è­‰æ“š</strong></p>
                                <ul class="list-disc list-inside mt-2 text-gray-700 text-sm space-y-1">
                                    <li><strong>ä¸»é¡Œå¥ (Topic Sentence):</strong> æ¯æ®µé–‹é ­ç”¨ä¸€å¥è©±é»å‡ºè©²æ®µçš„é‡é»ã€‚ä¾‹å¦‚ï¼Œå…ˆè«‡ã€Œç¼ºä¹åª’é«”ç´ é¤Šçš„å£è™•ã€ã€‚</li>
                                    <li><strong>è§£é‡‹èˆ‡èˆ‰ä¾‹ (Explanation & Example):</strong> é—¡è¿°ä¸»é¡Œå¥ï¼Œä¸¦èˆ‰å‡ºå…·é«”ä¾‹å­ï¼Œå¦‚å‡æ–°è (fake news)ã€ç¶²è·¯éœ¸å‡Œ (cyberbullying) ç­‰ã€‚</li>
                                    <li><strong>ç™¼å±•è«–é»:</strong> æ¥è‘—å¯ä»¥å¯«ä¸‹ä¸€æ®µï¼Œä¸»é¡Œå¥æ˜¯ã€Œå¦‚ä½•åŸ¹é¤Šåª’é«”ç´ é¤Šã€ï¼Œä¸¦æå‡ºå…·é«”æ–¹æ³•ï¼Œå¦‚æŸ¥è­‰ä¾†æº (verifying sources)ã€æ‰¹åˆ¤æ€§æ€è€ƒ (thinking critically) ç­‰ã€‚</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p><strong>C. çµè«–æ®µ (Conclusion): ç¸½çµä¸¦æ˜‡è¯</strong></p>
                                <ul class="list-disc list-inside mt-2 text-gray-700 text-sm space-y-1">
                                    <li><strong>é‡ç”³ä¸»æ—¨:</strong> ç”¨ä¸åŒçš„è©±å†æ¬¡å¼·èª¿ä½ çš„æ ¸å¿ƒè«–é»ã€‚</li>
                                    <li><strong>ç¸½çµè¦é»:</strong> å¿«é€Ÿç¸½çµä½ åœ¨æ”¯æ’æ®µæå‡ºçš„ä¸»è¦ç†ç”±ã€‚</li>
                                    <li><strong>æå‡ºå±•æœ› (Concluding thought):</strong> çµ¦å‡ºä¸€å€‹æœ‰åŠ›çš„çµå°¾ï¼Œä¾‹å¦‚å°æœªä¾†çš„æœŸè¨±æˆ–çµ¦è®€è€…çš„å»ºè­°ã€‚ (e.g., "Ultimately, being media literate is not just about personal protection; it is about contributing to a more informed and democratic society.")</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
        
        <footer class="text-center mt-16 pt-8 border-t border-gray-200">
            <p class="text-gray-500">æ¯å¤©é€²æ­¥ä¸€é»é»ï¼Œç´¯ç©èµ·ä¾†å°±æ˜¯å·¨å¤§çš„é£›èºï¼ğŸš€</p>
            <p class="text-sm text-gray-400 mt-2">æ¸…å¤§æ–‡ç†è£œç¿’ç­ãƒ»Jeff</p>
        </footer>
    </div>

</body>
</html></div>
</body></html>

=== FILE: docs\materials\ray\english\2025-08-10_lesson.html ===
<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç‘ç‘ç¬¬ä¸€èª²</title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=ray&date=2025-08-10">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1>ç‘ç‘ç¬¬ä¸€èª²</h1><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸€è‹±æ–‡ Lesson 1 å­¸ç¿’é‡é» - For ç‘ç‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;family=Noto+Sans+TC:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .hero-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>



    <header class="hero-bg text-white py-12 sm:py-20 px-4 text-center rounded-b-3xl shadow-lg">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4">æ­¡è¿ä¾†åˆ°åœ‹ä¸€è‹±æ–‡ç¬¬ä¸€èª²ï¼</h1>
            <p class="text-lg sm:text-xl opacity-90">é€™æ˜¯ä¸€å€‹å°ˆç‚ºç‘ç‘è¨­è¨ˆçš„å­¸ç¿’é é¢ï¼ŒæŠŠç¬¬ä¸€èª²çš„é‡é»ä¸€ç¶²æ‰“ç›¡ï¼</p>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 max-w-5xl">
        
        <!-- Vocabulary Section -->
        <section id="vocabulary" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md mb-8">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">æ ¸å¿ƒå–®å­— (Core Vocabulary)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <div class="bg-indigo-50 p-5 rounded-xl">
                    <h3 class="text-xl font-semibold text-indigo-800 mb-3">å®¶åº­èˆ‡ç¨±è¬‚ (Family &amp; Titles)</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>family: å®¶äººï¼›å®¶åº­</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>father (dad): çˆ¶è¦ª</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>mother (mom): æ¯è¦ª</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>brother: å…„å¼Ÿ</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>sister: å§å¦¹</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>son: å…’å­</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>daughter: å¥³å…’</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>uncle: å”(ä¼¯)çˆ¶ï¼›å§‘(å§¨)ä¸ˆï¼›èˆ…èˆ…</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>aunt: å¬¸å¬¸ï¼›ä¼¯æ¯ï¼›å§‘(å§¨)åª½ï¼›èˆ…åª½</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>cousin: å ‚(è¡¨)å…„å¼Ÿå§å¦¹</li>
                    </ul>
                </div>
                
                <div class="bg-purple-50 p-5 rounded-xl">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3">è·æ¥­ (Occupation)</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>student: å­¸ç”Ÿ</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>teacher: è€å¸«</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>doctor: é†«ç”Ÿ</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>nurse: è­·ç†å¸«ï¼›è­·å£«</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>farmer: è¾²å¤«</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>cook: å»šå¸«</li>
                    </ul>
                </div>
                
                <div class="bg-pink-50 p-5 rounded-xl">
                    <h3 class="text-xl font-semibold text-pink-800 mb-3">å½¢å®¹è© (Adjectives)</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>young: å¹´è¼•çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>old: å¹´è€çš„ï¼›èˆŠçš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>tall: é«˜çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>handsome: è‹±ä¿Šçš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>beautiful: æ¼‚äº®çš„ï¼›ç¾éº—çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>cute: å¯æ„›çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>strict: åš´æ ¼çš„</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Grammar Section -->
        <section id="grammar" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md mb-8">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">é‡é»æ–‡æ³•èˆ‡å¥å‹ (Key Grammar &amp; Patterns)</h2>
            
            <div class="space-y-6">
                <div>
                    <h4 class="text-xl font-semibold mb-2">1. be å‹•è©ï¼šam, is, are (æ˜¯)</h4>
                    <p class="text-gray-600 mb-3">be å‹•è©ç”¨ä¾†è¡¨ç¤ºç‹€æ…‹æˆ–èº«ä»½ï¼Œæœƒæ ¹æ“šä¸»è©äººç¨±åšè®ŠåŒ–ã€‚</p>
                    <ul class="list-disc list-inside bg-gray-100 p-4 rounded-lg">
                        <li>ç¬¬ä¸€äººç¨± (æˆ‘)ï¼šI <span class="font-bold text-indigo-700">am</span></li>
                        <li>ç¬¬äºŒäººç¨± (ä½ /ä½ å€‘)ï¼šyou <span class="font-bold text-indigo-700">are</span></li>
                        <li>ç¬¬ä¸‰äººç¨±å–®æ•¸ (ä»–/å¥¹/å®ƒ)ï¼šhe / she / it <span class="font-bold text-indigo-700">is</span></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-2">2. ç›´è¿°å¥ (Statements)</h4>
                    <div class="border-l-4 border-indigo-500 bg-indigo-50 p-4 rounded-r-lg mb-3">
                        <p><strong>è‚¯å®šå¥ï¼š</strong>ä¸»è© + beå‹•è© + a/an + å–®æ•¸åè©ã€‚</p>
                        <p class="mt-1 italic">My uncle is a doctor. (æˆ‘å”å”æ˜¯ä¸€ä½é†«ç”Ÿã€‚)</p>
                    </div>
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg">
                        <p><strong>å¦å®šå¥ï¼š</strong>ä¸»è© + beå‹•è© + not + a/an + å–®æ•¸åè©ã€‚</p>
                        <p class="mt-1 italic">My brother is not a junior high school student. (æˆ‘å“¥å“¥ä¸æ˜¯ä¸€ä½åœ‹ä¸­ç”Ÿã€‚)</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-2">3. Yes/No å•ç­”å¥ (Yes/No Questions)</h4>
                    <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded-r-lg">
                        <p><strong>å•å¥ï¼š</strong>Beå‹•è© + ä¸»è© + a/an + åè©?</p>
                        <p class="mt-2 italic">Q: Is Vicky a nurse? (Vickyæ˜¯ä¸€ä½è­·ç†å¸«å—ï¼Ÿ)</p>
                        <p class="italic">A: Yes, she is. (æ˜¯çš„ï¼Œå¥¹æ˜¯ã€‚)</p>
                        <p class="mt-2 italic">Q: Are you a cook? (ä½ æ˜¯ä¸€ä½å»šå¸«å—ï¼Ÿ)</p>
                        <p class="italic">A: No, I'm not a cook. (ä¸æ˜¯ï¼Œæˆ‘ä¸æ˜¯ä¸€ä½å»šå¸«ã€‚)</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-2">4. Who å•ç­”å¥ (Who Questions)</h4>
                    <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded-r-lg">
                        <p><strong>å•å¥ï¼š</strong>Who + beå‹•è© + ä¸»è©?</p>
                        <p class="mt-2 italic">Q: Who's that young man? (é‚£ä½å¹´è¼•çš„ç”·å­æ˜¯èª°ï¼Ÿ)</p>
                        <p class="italic">A: He's our new PE teacher. (ä»–æ˜¯æˆ‘å€‘çš„æ–°é«”è‚²è€å¸«ã€‚)</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dialogue Section -->
        <section id="dialogue" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md mb-8">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">å¯¦ç”¨å°è©± (Dialogue Practice)</h2>
            <div class="space-y-4">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p>A: Nice to meet you. (å¾ˆé«˜èˆˆèªè­˜ä½ ã€‚)</p>
                    <p>B: Nice to meet you, too. (æˆ‘ä¹Ÿå¾ˆé«˜èˆˆèªè­˜ä½ ã€‚)</p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p>A: Hey, Rita. Good news. Bella is our English teacher! (å˜¿ï¼ŒRitaã€‚å¥½æ¶ˆæ¯ï¼ŒBella æ˜¯æˆ‘å€‘çš„è‹±æ–‡è€å¸«ï¼)</p>
                    <p>B: Oh, no. That's not good. (å“¦ï¼Œä¸ã€‚é€™ä¸æ˜¯å¥½æ¶ˆæ¯ã€‚)</p>
                    <p>A: What's the problem? She's a great teacher. (æ€éº¼äº†ï¼Ÿå¥¹æ˜¯ä¸€ä½å¾ˆæ£’çš„è€å¸«ã€‚)</p>
                    <p>B: Well... she's a strict teacher, too. (å—¯...å¥¹ä¹Ÿæ˜¯ä¸€ä½åš´æ ¼çš„è€å¸«ã€‚)</p>
                </div>
            </div>
        </section>
        
        <!-- Quiz Section -->
        <section id="quiz" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">å°è©¦èº«æ‰‹ (Quick Quiz)</h2>
            <p class="text-gray-600 mb-6">è©¦è‘—å¡«å…¥æ­£ç¢ºçš„å–®å­— (am / is / are / Who's)ï¼</p>
            <div class="space-y-4">
                <div class="quiz-item">
                    <p>1. A: ____ that girl? B: She is my sister, May.</p>
                    <div class="answer mt-2 text-green-600 font-bold hidden">ç­”æ¡ˆï¼šWho's</div>
                </div>
                <div class="quiz-item">
                    <p>2. He ____ a handsome doctor.</p>
                    <div class="answer mt-2 text-green-600 font-bold hidden">ç­”æ¡ˆï¼šis</div>
                </div>
                <div class="quiz-item">
                    <p>3. A: ____ you a teacher? B: No, I ____ not. I'm a student.</p>
                    <div class="answer mt-2 text-green-600 font-bold hidden">ç­”æ¡ˆï¼šAre, am</div>
                </div>
            </div>
            <button id="show-answers" class="mt-6 inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">é¡¯ç¤ºç­”æ¡ˆ</button>
        </section>
    </main>

    <footer class="text-center py-10 mt-8">
        <p class="text-gray-500">åšå¾—å¾ˆå¥½ï¼ç¬¬ä¸€èª²çš„åŸºç¤éå¸¸é‡è¦ï¼Œå¸¸å¸¸å›ä¾†è¤‡ç¿’å–”ï¼</p>
    </footer>

    <script>
        // Script to show answers for the quiz
        document.getElementById('show-answers').addEventListener('click', function() {
            var answers = document.querySelectorAll('.answer');
            answers.forEach(function(answer) {
                answer.classList.remove('hidden');
            });
            this.classList.add('hidden'); // Hide button after clicking
        });
    </script></div>
</body></html>

=== FILE: docs\materials\ray\math\2025-08-10_lesson.html ===
<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title></title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=ray&date=2025-08-10">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1></h1><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æ•¸å­¸æ•™æï¼šè² æ•¸èˆ‡æ•¸ç·š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutrals -->
    <!-- Application Structure Plan: A single-page application with four interactive/informational modules ("1. æ¢ç´¢æ­£è² æ•¸", "2. ç©è½‰æ•¸ç·š", "3. è§€å¿µé‡æ¸…", "4. è§£å¯†çµ•å°å€¼") navigated by a sticky top bar. This thematic, hands-on structure is chosen over a linear text format to enhance engagement and clarify abstract concepts through direct manipulation and immediate visual feedback, which is more effective for foundational math learning. The goal is to transform passive reading into active exploration. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Relative quantities & benchmarks -> Goal: Inform -> Viz/Presentation: Interactive Slider with a dynamic thermometer visual (HTML/CSS/JS) -> Interaction: User drags slider to see value and visual change -> Justification: Makes the abstract concept of a benchmark tangible and connects it to a familiar real-world example.
        - Report Info: Number line and number comparison -> Goal: Organize/Compare -> Viz/Presentation: Large, interactive number line where users can place points (HTML/CSS/JS) -> Interaction: User clicks to add a point, and its value is displayed -> Justification: Promotes active learning and spatial understanding of number placement and order over passive observation.
        - Report Info: Confusing concepts (Opposite Numbers, Value vs. Absolute Value) -> Goal: Clarify/Differentiate -> Viz/Presentation: A dedicated text-based section with clear headings and highlighted keywords -> Interaction: Reading and comprehension -> Justification: Directly addresses common student misconceptions before they interact with the final module, improving learning outcomes.
        - Report Info: Value vs. Absolute Value -> Goal: Compare/Differentiate -> Viz/Presentation: A dual-bar chart (Chart.js) with a restructured data model. Color now consistently represents the entity (Number A or Number B), while the x-axis categorizes the concept (Value vs. Absolute Value). -> Interaction: User inputs two numbers, and the chart and number line immediately update -> Justification: This revised structure provides a powerful, direct visual comparison that highlights the core difference between a number's value and its absolute value without any color ambiguity.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
        }
        html {
            scroll-padding-top: 5rem; /* Offset for sticky header */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-link {
            transition: color 0.3s, border-color 0.3s;
        }
        .interactive-number-line {
            position: relative;
            height: 50px;
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 8px;
            cursor: crosshair;
        }
        .interactive-number-line .line {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background-color: #475569; /* slate-600 */
        }
        .interactive-number-line .tick {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 10px;
            background-color: #475569; /* slate-600 */
        }
        .interactive-number-line .tick-label {
            position: absolute;
            top: 28px;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #334155; /* slate-700 */
        }
        .interactive-number-line .point {
            position: absolute;
            top: 50%;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.2s;
        }
        .interactive-number-line .point-label {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl md:text-2xl font-bold text-sky-700">åœ‹ä¸­æ•¸å­¸éŠœæ¥æ•™æ</h1>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#module1" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">1. æ¢ç´¢æ­£è² æ•¸</a>
                    <a href="#module2" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">2. ç©è½‰æ•¸ç·š</a>
                    <a href="#concepts" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">3. è§€å¿µé‡æ¸…</a>
                    <a href="#module3" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">4. è§£å¯†çµ•å°å€¼</a>
                </div>
                <div class="md:hidden">
                    <select id="mobile-nav" class="bg-slate-100 border border-slate-300 rounded-md p-2 text-slate-700">
                        <option value="#module1">1. æ¢ç´¢æ­£è² æ•¸</option>
                        <option value="#module2">2. ç©è½‰æ•¸ç·š</option>
                        <option value="#concepts">3. è§€å¿µé‡æ¸…</option>
                        <option value="#module3">4. è§£å¯†çµ•å°å€¼</option>
                    </select>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="text-center mb-12">
            <h2 class="text-4xl font-bold text-slate-800 mb-2">1-1 è² æ•¸èˆ‡æ•¸ç·š</h2>
            <p class="text-lg text-slate-600">é€éäº’å‹•æ“ä½œï¼Œå»ºç«‹ç©©å›ºçš„æ•¸å­¸åŸºç¤è§€å¿µã€‚</p>
        </div>

        <!-- Module 1: Positive & Negative Numbers -->
        <section id="module1" class="mb-16 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-1 text-sky-800">1. æ¢ç´¢æ­£è² æ•¸</h3>
            <p class="text-slate-600 mb-6">ç”Ÿæ´»ä¸­å……æ»¿äº†ç›¸å°çš„é‡ã€‚æˆ‘å€‘ç”¨ä¸€å€‹ã€ŒåŸºæº–é» (0)ã€ä¾†å€åˆ†å®ƒå€‘ã€‚è©¦è‘—æ‹–å‹•ä¸‹æ–¹çš„æ»‘æ¡¿ï¼Œè§€å¯Ÿæº«åº¦è¨ˆå’Œæµ·æ‹”é«˜åº¦å¦‚ä½•ç”¨æ­£è² æ•¸è¡¨ç¤ºã€‚</p>
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="flex flex-col items-center">
                    <div class="w-full max-w-xs">
                         <label for="value-slider" class="block text-center text-slate-700 mb-2">æ‹–å‹•æ»‘æ¡¿æ”¹è®Šæ•¸å€¼</label>
                        <input id="value-slider" type="range" min="-50" max="50" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-slate-500 px-1 mt-1">
                            <span>-50</span>
                            <span>0</span>
                            <span>+50</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-around items-end h-64">
                    <!-- Thermometer -->
                    <div class="text-center">
                        <p class="font-semibold mb-2">æº«åº¦è¨ˆ</p>
                        <div class="w-12 h-56 bg-slate-200 rounded-full flex justify-center items-end p-1.5 relative">
                            <div id="mercury" class="w-full bg-red-500 rounded-b-full transition-all duration-200" style="height: 70%;"></div>
                             <div class="absolute top-1/2 left-full ml-2 w-px h-px">
                                <span class="absolute -translate-y-1/2 text-xs text-slate-500 whitespace-nowrap">0Â°C</span>
                            </div>
                        </div>
                        <p id="temp-display" class="mt-2 text-lg font-bold text-red-600">+20Â°C</p>
                    </div>
                    <!-- Altitude -->
                    <div class="text-center">
                        <p class="font-semibold mb-2">æµ·æ‹”é«˜åº¦</p>
                        <div class="w-24 h-56 bg-sky-100 relative overflow-hidden rounded-md">
                            <div class="absolute bottom-0 w-full h-1/2 bg-cyan-600"></div>
                            <div id="altitude-marker" class="absolute left-1/2 w-8 h-8 -translate-x-1/2 transition-all duration-200" style="bottom: 70%;">
                                <span class="text-3xl">â›°ï¸</span>
                            </div>
                            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-sky-800/50">
                                <span class="absolute top-0 left-full ml-2 text-xs text-slate-500 whitespace-nowrap">æµ·å¹³é¢ 0m</span>
                            </div>
                        </div>
                        <p id="altitude-display" class="mt-2 text-lg font-bold text-sky-700">+2000m</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Module 2: Number Line -->
        <section id="module2" class="mb-16 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-1 text-sky-800">2. ç©è½‰æ•¸ç·š</h3>
            <p class="text-slate-600 mb-6">æ•¸ç·šæ˜¯æ•¸å­—çš„å®¶ã€‚åœ¨ä¸‹é¢çš„æ•¸ç·šä¸Šé»æ“Šï¼Œæ¨™ç¤ºå‡ºä»»æ„æ•¸å­—çš„ä½ç½®ã€‚æ„ˆå³é‚Šçš„é»ï¼Œä»£è¡¨çš„æ•¸æ„ˆå¤§ã€‚</p>
            <div id="interactive-line-1" class="interactive-number-line mb-4"></div>
            <div class="text-center">
                <button id="clear-points-btn" class="mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">æ¸…é™¤æ‰€æœ‰æ¨™ç¤ºé»</button>
            </div>
        </section>
        
        <!-- NEW Module: Key Concepts -->
        <section id="concepts" class="mb-16 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-sky-800">3. è§€å¿µé‡æ¸…ï¼šåˆ¥å†ææ··äº†ï¼</h3>
            <div class="space-y-6 text-base">
                <div>
                    <h4 class="font-bold text-lg text-amber-700"># ç›¸åæ•¸æ˜¯ä»€éº¼ï¼Ÿ</h4>
                    <p class="text-slate-700 mt-2 leading-relaxed">
                        åœ¨æ•¸ç·šä¸Šï¼Œç«™åœ¨åŸé»(0)çš„å…©å´ï¼Œè€Œä¸”å’ŒåŸé»<strong class="text-orange-600">ã€Œè·é›¢ç›¸ç­‰ã€</strong>çš„å…©å€‹æ•¸ï¼Œå°±äº’ç‚ºç›¸åæ•¸ã€‚
                        <br>ä¾‹å¦‚ï¼š<code class="bg-slate-200 px-1 rounded">-5</code> çš„ç›¸åæ•¸æ˜¯ <code class="bg-slate-200 px-1 rounded">5</code>ã€‚å®ƒå€‘åˆ°0çš„è·é›¢éƒ½æ˜¯5ã€‚
                        <br><strong>é—œéµç‰¹æ€§ï¼š</strong> äº’ç‚ºç›¸åæ•¸çš„å…©å€‹æ•¸ï¼Œçµ•å°å€¼ç›¸ç­‰ã€‚
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-amber-700"># æ•¸å€¼ vs. çµ•å°å€¼ï¼šå“ªè£¡ä¸ä¸€æ¨£ï¼Ÿ</h4>
                    <p class="text-slate-700 mt-2 leading-relaxed">
                        é€™æ˜¯æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼è¨˜å¾—å®ƒå€‘å›ç­”çš„å•é¡Œä¸åŒï¼š
                        <br>â€¢ <strong>æ•¸å€¼</strong>ï¼šä»£è¡¨åœ¨æ•¸ç·šä¸Šçš„<strong class="text-blue-600">ã€Œä½ç½®ã€</strong>ã€‚å®ƒæœ‰æ–¹å‘æ€§ï¼ˆæ­£æˆ–è² ï¼‰ã€‚å•çš„æ˜¯ï¼šã€Œå®ƒåœ¨å“ªè£¡ï¼Ÿã€
                        <br>â€¢ <strong>çµ•å°å€¼</strong>ï¼šä»£è¡¨èˆ‡åŸé»0çš„<strong class="text-orange-600">ã€Œè·é›¢ã€</strong>ã€‚å®ƒæ°¸é æ˜¯æ­£æ•¸æˆ–0ã€‚å•çš„æ˜¯ï¼šã€Œå®ƒé›¢èµ·é»å¤šé ï¼Ÿã€
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-amber-700"># è² æ•¸æ¯”å¤§å°çš„é™·é˜±</h4>
                    <p class="text-slate-700 mt-2 leading-relaxed">
                        å¾ˆå¤šäººæœƒè¦ºå¾— -10 æ¯” -2 å¤§ï¼Œå› ç‚º 10 æ¯” 2 å¤§ã€‚é€™æ˜¯éŒ¯çš„ï¼
                        <br><strong>å”¯ä¸€æº–å‰‡ï¼š</strong> åœ¨æ•¸ç·šä¸Šï¼Œ<strong class="text-red-600">æ„ˆå³é‚Šçš„æ•¸æ„ˆå¤§</strong>ã€‚
                        <br>å› ç‚º -2 åœ¨ -10 çš„å³é‚Šï¼Œæ‰€ä»¥ <code class="bg-slate-200 px-1 rounded">-2 > -10</code>ã€‚å¯ä»¥æƒ³åƒæˆï¼šæ°£æº«é›¶ä¸‹2åº¦æ¯”é›¶ä¸‹10åº¦è¦æº«æš–ä¸€äº›ï¼
                    </p>
                </div>
            </div>
        </section>

        <!-- Module 3: Absolute Value -->
        <section id="module3" class="p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-1 text-sky-800">4. è§£å¯†çµ•å°å€¼</h3>
            <p class="text-slate-600 mb-4">çµ•å°å€¼çš„æ ¸å¿ƒæ„ç¾©æ˜¯ã€Œèˆ‡åŸé» (0) çš„è·é›¢ã€ï¼Œæ‰€ä»¥çµ•å°å€¼æ°¸é ä¸æœƒæ˜¯è² æ•¸ã€‚è¼¸å…¥å…©å€‹æ•¸å­—ï¼Œè§€å¯Ÿå®ƒå€‘çš„ã€Œæ•¸å€¼ã€å’Œã€Œçµ•å°å€¼ã€æœ‰ä½•ä¸åŒã€‚</p>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="numA" class="block text-sm font-medium text-slate-700">æ•¸å­— A</label>
                    <input type="number" id="numA" value="-5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="numB" class="block text-sm font-medium text-slate-700">æ•¸å­— B</label>
                    <input type="number" id="numB" value="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2">
                </div>
            </div>
            <div id="interactive-line-2" class="interactive-number-line mb-8"></div>
            <p class="text-slate-600 mb-4 text-center">ä¸‹æ–¹çš„åœ–è¡¨æ¸…æ¥šåœ°æ¯”è¼ƒäº†å…©æ•¸çš„ã€Œæ•¸å€¼å¤§å°ã€èˆ‡ã€Œçµ•å°å€¼å¤§å°ï¼ˆèˆ‡0çš„è·é›¢ï¼‰ã€ã€‚</p>
            <div class="chart-container">
                <canvas id="abs-chart"></canvas>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Navigation ---
            const setupNavigation = () => {
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const targetElement = document.querySelector(this.getAttribute('href'));
                        if(targetElement) {
                            targetElement.scrollIntoView({
                                behavior: 'smooth'
                            });
                        }
                    });
                });
                const mobileNav = document.getElementById('mobile-nav');
                mobileNav.addEventListener('change', (e) => {
                    const targetElement = document.querySelector(e.target.value);
                    if(targetElement) {
                        targetElement.scrollIntoView({
                           behavior: 'smooth'
                       });
                    }
                });
            };

            // --- Module 1: Positive/Negative Numbers ---
            const setupModule1 = () => {
                const slider = document.getElementById('value-slider');
                const mercury = document.getElementById('mercury');
                const tempDisplay = document.getElementById('temp-display');
                const altitudeMarker = document.getElementById('altitude-marker');
                const altitudeDisplay = document.getElementById('altitude-display');

                const updateVisuals = (value) => {
                    const percentage = (parseInt(value) + 50);
                    
                    mercury.style.height = `${percentage}%`;
                    tempDisplay.textContent = `${value >= 0 ? '+' : ''}${value}Â°C`;
                    mercury.style.backgroundColor = value >= 0 ? '#ef4444' : '#3b82f6';
                    tempDisplay.style.color = value >= 0 ? '#dc2626' : '#2563eb';

                    altitudeMarker.style.bottom = `${percentage}%`;
                    const altitude = value * 100;
                    altitudeDisplay.textContent = `${altitude >= 0 ? '+' : ''}${altitude}m`;
                    altitudeDisplay.style.color = altitude >= 0 ? '#0369a1' : '#0891b2';
                };

                slider.addEventListener('input', (e) => updateVisuals(e.target.value));
                updateVisuals(slider.value);
            };

            // --- Interactive Number Line Factory ---
            const createInteractiveNumberLine = (containerId, range = 10) => {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '<div class="line"></div>';
                const ticks = range * 2;
                for (let i = 0; i <= ticks; i++) {
                    const value = i - range;
                    const tickEl = document.createElement('div');
                    tickEl.className = 'tick';
                    const leftPos = (i / ticks) * 100;
                    tickEl.style.left = `${leftPos}%`;
                    
                    if (value % 5 === 0 || range <= 5) {
                        tickEl.style.height = '20px';
                        const labelEl = document.createElement('div');
                        labelEl.className = 'tick-label';
                        labelEl.textContent = value;
                        labelEl.style.left = `${leftPos}%`;
                        container.appendChild(labelEl);
                    }
                    container.appendChild(tickEl);
                }

                const addPoint = (value, label, color = 'bg-sky-500', id = '') => {
                    if (value < -range || value > range) return;
                    
                    const existingPoint = id ? document.getElementById(id) : null;
                    if(existingPoint) existingPoint.remove();

                    const pointEl = document.createElement('div');
                    pointEl.className = `point ${color}`;
                    if(id) pointEl.id = id;
                    
                    const leftPos = ((value + range) / (range * 2)) * 100;
                    pointEl.style.left = `${leftPos}%`;

                    const labelEl = document.createElement('div');
                    labelEl.className = `point-label text-white ${color}`;
                    labelEl.textContent = label;
                    pointEl.appendChild(labelEl);
                    
                    container.appendChild(pointEl);
                };

                const addDistanceLine = (value, color = 'bg-orange-500/50', id = '') => {
                     if (value < -range || value > range) return;

                    const existingLine = id ? document.getElementById(id) : null;
                    if(existingLine) existingLine.remove();

                    const distLine = document.createElement('div');
                    if(id) distLine.id = id;
                    distLine.style.position = 'absolute';
                    distLine.style.top = '10px';
                    distLine.style.height = '5px';
                    distLine.style.backgroundColor = color;
                    distLine.className = 'rounded-full';

                    const absValue = Math.abs(value);
                    const width = (absValue / (range * 2)) * 100;
                    distLine.style.width = `${width}%`;

                    if (value > 0) {
                        distLine.style.left = '50%';
                    } else {
                        const leftPos = ((value + range) / (range * 2)) * 100;
                        distLine.style.left = `${leftPos}%`;
                    }
                    container.appendChild(distLine);
                };
                
                const clearPoints = () => {
                    container.querySelectorAll('.point').forEach(p => p.remove());
                    container.querySelectorAll('[id^="dist-"]').forEach(d => d.remove());
                };

                return { container, addPoint, addDistanceLine, clearPoints, range };
            };

            // --- Module 2: Number Line ---
            const setupModule2 = () => {
                const lineInstance = createInteractiveNumberLine('interactive-line-1', 10);
                lineInstance.container.addEventListener('click', (e) => {
                    const rect = e.target.closest('.interactive-number-line').getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percentage = clickX / rect.width;
                    const value = (percentage * (lineInstance.range * 2)) - lineInstance.range;
                    const roundedValue = Math.round(value * 10) / 10;
                    lineInstance.addPoint(roundedValue, roundedValue.toString(), 'bg-teal-500');
                });
                document.getElementById('clear-points-btn').addEventListener('click', lineInstance.clearPoints);
            };

            // --- Module 3: Absolute Value ---
            const setupModule3 = () => {
                const numAInput = document.getElementById('numA');
                const numBInput = document.getElementById('numB');
                const lineInstance = createInteractiveNumberLine('interactive-line-2', 10);

                const ctx = document.getElementById('abs-chart').getContext('2d');
                // UPDATED CHART CONFIGURATION
                const absChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['æ•¸å€¼', 'çµ•å°å€¼'], // X-axis now represents the concept
                        datasets: [
                            {
                                label: 'æ•¸å­— A', // Series 1 is for Number A
                                data: [0, 0],
                                backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue for A
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'æ•¸å­— B', // Series 2 is for Number B
                                data: [0, 0],
                                backgroundColor: 'rgba(249, 115, 22, 0.6)', // Orange for B
                                borderColor: 'rgba(249, 115, 22, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'å¤§å°' }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                const updateAbsModule = () => {
                    const valA = parseFloat(numAInput.value) || 0;
                    const valB = parseFloat(numBInput.value) || 0;

                    // Number line colors remain consistent: Blue for A, Orange for B
                    lineInstance.clearPoints();
                    lineInstance.addPoint(valA, `A: ${valA}`, 'bg-blue-500', 'point-a');
                    lineInstance.addPoint(valB, `B: ${valB}`, 'bg-orange-500', 'point-b');
                    lineInstance.addDistanceLine(valA, '#3b82f680', 'dist-a'); // Light Blue for A's distance
                    lineInstance.addDistanceLine(valB, '#f9731680', 'dist-b'); // Light Orange for B's distance

                    // UPDATED CHART DATA MAPPING
                    // Dataset 0 (Number A) gets [value, absolute_value]
                    absChart.data.datasets[0].data = [valA, Math.abs(valA)];
                    // Dataset 1 (Number B) gets [value, absolute_value]
                    absChart.data.datasets[1].data = [valB, Math.abs(valB)];
                    absChart.update();
                };

                numAInput.addEventListener('input', updateAbsModule);
                numBInput.addEventListener('input', updateAbsModule);
                updateAbsModule();
            };

            // Initialize all modules
            setupNavigation();
            setupModule1();
            setupModule2();
            setupModule3();
        });
    </script>
</body>
</html></div>
</body></html>


=== FILE: docs\admin.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</title>
<script>
(function(){
  const isLocal = ['127.0.0.1','localhost'].includes(location.hostname);
  if(!isLocal){
    document.write('<div style="font-family:system-ui,\\'Noto Sans TC\\',Arial,sans-serif;padding:40px;text-align:center">æ­¤é åƒ…é™æœ¬æ©Ÿä½¿ç”¨ã€‚è«‹åœ¨æœ¬æ©ŸåŸ·è¡Œ <code>python server.py</code> å¾Œä»¥ <b>http://127.0.0.1:5000/admin.html</b> é–‹å•Ÿã€‚</div>');
    document.close(); throw new Error('admin locked on public host');
  }
})();
</script>
<link rel="stylesheet" href="data:text/css,">
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1100px;margin:36px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:22px 24px;}
  h1{margin:0 0 16px;display:flex;gap:10px;align-items:center;justify-content:space-between;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0;}
  input[type="text"], input[type="date"], select, textarea{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;font-size:15px;}
  textarea{width:100%;min-height:200px;}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
  .btn.gray{background:#6b7280}.btn.green{background:#059669}.btn.red{background:#dc2626}.btn.soft{background:#e5e7eb;color:#111827}
  .msg{padding:10px 12px;border-radius:8px;margin:8px 0;display:none}
  .msg.ok{display:block;background:#e6f9ed;color:#065f46}.msg.err{display:block;background:#fde2e0;color:#9b1c1c}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:12px;}
  .box{background:#f8fafc;border-radius:10px;padding:12px;}
  .list .item{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;margin:6px 0;display:flex;justify-content:space-between;align-items:center;}
  .muted{opacity:.65}
  .links a{color:#2563eb;text-decoration:none;margin-left:8px}
</style>
</head>
<body>
<div class="app">
  <h1>
    <span>å¾Œå°ç®¡ç†ä»‹é¢ï¼ˆé›™å‘ç·¨è¼¯ï¼‰</span>
    <div class="links">
      <a href="/teacher.html">è€å¸«ä¸»é </a>
      <a href="/index.html">å­¸ç”Ÿæ—¥æ›†</a>
    </div>
  </h1>

  <div id="msg" class="msg"></div>

  <div class="row">
    <label>å­¸ç”Ÿï¼š</label>
    <select id="studentSel"></select>
    <button class="btn" id="btnReload">è¼‰å…¥</button>
    <span style="flex:1"></span>
    <input type="text" id="newId" placeholder="æ–°å­¸ç”Ÿ idï¼ˆå°å¯«/ç„¡ç©ºç™½ï¼‰"/>
    <input type="text" id="newName" placeholder="æ–°å­¸ç”Ÿå§“åï¼ˆé¡¯ç¤ºç”¨ï¼Œå¯ç©ºï¼‰"/>
    <button class="btn green" id="btnAddStudent">æ–°å¢å­¸ç”Ÿ</button>
  </div>

  <div class="grid">
    <div class="box">
      <h3>å»ºç«‹ / ç·¨è¼¯ï¼ˆå–®éµå„²å­˜ï¼‰</h3>
      <div class="row">
        <input type="date" id="date"/>
        <select id="course"></select>
        <select id="type"></select>
      </div>
      <div class="row">
        <input style="flex:1" type="text" id="title" placeholder="æ¨™é¡Œ"/>
        <input style="flex:1" type="text" id="filename" placeholder="æª”åï¼ˆå¯ç•™ç©ºï¼Œæœƒç”¨ æ—¥æœŸ_æ¨™é¡Œ.htmlï¼‰"/>
      </div>
      <textarea id="html" placeholder="æ•™æ HTMLï¼ˆå¯ç•™ç©ºï¼šåªè¨˜éŒ„è·¯å¾‘ï¼›æŒ‰ã€å„²å­˜ã€æœƒç›´æ¥å¯«å…¥/è¦†è“‹ï¼‰"></textarea>
      <div class="row">
        <button class="btn green" id="btnSave">å„²å­˜</button>
        <label><input type="checkbox" id="keepForm"/> å„²å­˜å¾Œä¿ç•™è¡¨å–®å€¼ï¼ˆè¤‡è£½ä¸‹ä¸€ç­†ï¼‰</label>
        <button class="btn soft" id="btnClear">æ¸…ç©ºè¡¨å–®</button>
        <button class="btn soft" id="btnReloadHtml">é‡è¼‰ç›®å‰æ•™æ</button>
        <span class="muted">å„²å­˜æœƒï¼šå¯« HTMLï¼ˆè‹¥æœ‰å…§å®¹ï¼‰â†’ æ›´æ–°/æ–°å¢æ¢ç›® â†’ å¯«å…¥ manifest.json</span>
      </div>
    </div>

    <div class="box">
      <h3>ç¾æœ‰æ¢ç›®</h3>
      <div class="row">
        <label>ç¯©é¸æ—¥æœŸï¼š</label>
        <input type="date" id="filterDate"/>
        <span class="muted">åˆªé™¤æœƒ**åŒæ™‚**åˆªé™¤ HTML æª”</span>
      </div>
      <div class="list" id="list"></div>
    </div>
  </div>
</div>

<script src="admin.js"></script>
</body>
</html>


=== FILE: docs\admin.js ===
// ------- helpers -------
const q=(s,e=document)=>e.querySelector(s);
const msg=q('#msg');
const base=(p)=>p.split('/').pop();
const ymd=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const isLocal=()=>['127.0.0.1','localhost'].includes(location.hostname);

function toast(ok, text){
  msg.className='msg ' + (ok?'ok':'err');
  msg.textContent=text; msg.style.display='block';
  clearTimeout(window.__t); window.__t=setTimeout(()=>msg.style.display='none',3000);
}
async function getJSON(path){
  if(isLocal()){
    try{ const r=await fetch(`api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'}); if(!r2.ok) throw new Error('HTTP '+r2.status); return await r2.json();
}
async function getText(path){
  if(isLocal()){
    try{ const r=await fetch(`api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.text(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'}); if(!r2.ok) throw new Error('HTTP '+r2.status); return await r2.text();
}
async function apiSave(path, content){
  if(!isLocal()) throw new Error('save only available on localhost');
  const r=await fetch('api/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,content})});
  const j=await r.json(); if(!r.ok||j.status!=='success') throw new Error(j.message||('HTTP '+r.status)); return j;
}
async function apiDelete(path){
  if(!isLocal()) throw new Error('delete only available on localhost');
  const r=await fetch('api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path})});
  const j=await r.json(); if(!r.ok||j.status!=='success') throw new Error(j.message||('HTTP '+r.status)); return j;
}

// ------- state -------
let roster={students:[]}, manifest=null, stu=null;

// ------- manifest helpers -------
function ensureBase(){
  if(!manifest.version) manifest.version=3;
  manifest.courses=manifest.courses||{english:{label:'è‹±æ–‡'}, math:{label:'æ•¸å­¸'}};
  manifest.types  =manifest.types  ||{material:'æ•™æ', homework:'ä½œæ¥­'};
  manifest.days   =manifest.days   ||{};
}
function ensureArr(date,course,type){
  manifest.days[date]=manifest.days[date]||{};
  manifest.days[date][course]=manifest.days[date][course]||{};
  manifest.days[date][course][type]=manifest.days[date][course][type]||[];
  return manifest.days[date][course][type];
}
function removeEmpty(date,course,type){
  const d=manifest.days[date]||{};
  const c=d[course]||{};
  if((c[type]||[]).length===0) delete c[type];
  if(Object.keys(c).length===0) delete d[course];
  if(Object.keys(d).length===0) delete manifest.days[date];
}

// ------- UI render -------
function renderStu(){
  const sel=q('#studentSel'); sel.innerHTML='';
  (roster.students||[]).forEach(s=>{const o=document.createElement('option'); o.value=s.id; o.textContent=s.name||s.id; sel.appendChild(o);});
  if(!stu) stu=roster.students?.[0]?.id||null;
  if(stu) sel.value=stu;
  sel.onchange=async()=>{stu=sel.value; await loadManifest();}
}
function renderCourseType(){
  const c=q('#course'), t=q('#type'); c.innerHTML=''; t.innerHTML='';
  Object.entries(manifest.courses).forEach(([k,v])=>{const o=document.createElement('option'); o.value=k; o.textContent=v.label||k; c.appendChild(o);});
  Object.entries(manifest.types).forEach(([k,v])=>{const o=document.createElement('option'); o.value=k; o.textContent=v||k; t.appendChild(o);});
}

// é è¨­å¸¶å…¥ï¼šæœ€æ–°æ—¥æœŸï¼ˆ>=ä»Šå¤©å‰‡ç”¨æœ€æ–°ï¼›è‹¥æœ€æ–°åœ¨ä»Šå¤©ä»¥å‰ï¼Œå°±ç”¨ä»Šå¤©ï¼‰
function setDefaultDateFocus(){
  const today=ymd(new Date());
  const dates=Object.keys(manifest.days||{}).sort();
  const latest = dates.length ? dates[dates.length-1] : null;
  const pick = (!latest || latest < today) ? today : latest;
  q('#filterDate').value = pick;
  q('#date').value = pick;
}

function renderList(){
  const wrap=q('#list'); wrap.innerHTML='';
  const fd=q('#filterDate').value || null;
  const days=manifest.days||{};
  const dates=Object.keys(days).sort().filter(d=>!fd||d===fd);
  if(!dates.length){ wrap.innerHTML='<div class="item" style="opacity:.7">ç›®å‰æ²’æœ‰æ¢ç›®</div>'; return; }

  dates.forEach(d=>{
    const perDate=days[d];
    Object.keys(perDate).forEach(course=>{
      Object.keys(perDate[course]).forEach(type=>{
        perDate[course][type].forEach((it,idx)=>{
          const row=document.createElement('div'); row.className='item';
          row.innerHTML=`
            <div>${d}ï½œ${manifest.courses[course]?.label||course}ï½œ${manifest.types[type]||type} â†’ <strong>${it.title||base(it.path)}</strong></div>
            <div style="display:flex;gap:8px">
              <button class="btn gray">ç·¨è¼¯</button>
              <button class="btn red">åˆªé™¤</button>
            </div>`;
          // ç·¨è¼¯ï¼šå¸¶å…¥è¡¨å–® + è¼‰å› HTML ç‰‡æ®µ
          row.children[1].children[0].onclick=async()=>{
            q('#date').value=d; q('#course').value=course; q('#type').value=type;
            q('#title').value=it.title||''; q('#filename').value=base(it.path||'');
            try{
              const raw = await getText(it.path);
              let bodySnippet = '';
              try{
                const doc = new DOMParser().parseFromString(raw, 'text/html');
                const cont = doc.querySelector('.container');
                if(cont){
                  const clone = cont.cloneNode(true);
                  const h1 = clone.querySelector('h1'); if(h1) h1.remove();
                  bodySnippet = clone.innerHTML.trim();
                }else{
                  bodySnippet = (doc.querySelector('body')?.innerHTML||'').trim();
                }
              }catch(_){}
              q('#html').value = bodySnippet;
            }catch(e){
              q('#html').value='';
              toast(false,'è®€å–æ—¢æœ‰ HTML å¤±æ•—ï¼Œåƒ…å¸¶å…¥æ¨™é¡Œ/æª”å');
            }
            toast(true,'å·²å¸¶å…¥è¡¨å–®ï¼Œå¯ç›´æ¥ä¿®æ”¹å¾ŒæŒ‰ã€Œå„²å­˜ã€');
          };
          // åˆªé™¤ï¼šä¸€å¾‹åŒæ­¥åˆª HTML
          row.children[1].children[1].onclick=async()=>{
            const arr=manifest.days[d][course][type];
            const [removed]=arr.splice(idx,1);
            removeEmpty(d,course,type);
            if(removed?.path){
              try{ await apiDelete(removed.path); }catch(e){ toast(false,'åˆªæª”å¤±æ•—ï¼š'+(e.message||e)); }
            }
            await apiSave(`students/${stu}/manifest.json`, manifest);
            renderList(); toast(true,'å·²åˆªé™¤ï¼ˆå« HTML æª”ï¼‰');
          };
          wrap.appendChild(row);
        });
      });
    });
  });
}

// ------- actions -------
async function loadRoster(){
  roster=await getJSON('roster.json'); renderStu();
}
async function loadManifest(){
  manifest=await getJSON(`students/${stu}/manifest.json`); ensureBase();
  renderCourseType(); setDefaultDateFocus(); renderList();
}
function buildFilename(date,title){
  const safe=(title||'lesson').trim().replace(/\s+/g,'_').toLowerCase();
  return `${date}_${safe}.html`;
}
async function doSave(){
  if(!isLocal()) return toast(false,'å„²å­˜/åˆªé™¤åƒ…é™æœ¬æ©Ÿä½¿ç”¨');
  if(!stu) return toast(false,'è«‹å…ˆå»ºç«‹å­¸ç”Ÿ');
  const date=q('#date').value||''; if(!date) return toast(false,'è«‹é¸æ—¥æœŸ');
  const course=q('#course').value; const type=q('#type').value;
  const title=(q('#title').value||'').trim();
  let filename=(q('#filename').value||'').trim(); if(!filename) filename = buildFilename(date,title);
  const rel=`materials/${stu}/${course}/${filename}`;
  const html=(q('#html').value||'').trim();

  if(html){
    const wrap=`<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${title||''}</title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=${encodeURIComponent(stu)}&date=${encodeURIComponent(date)}">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1>${title||''}</h1>${html}</div>
</body></html>`;
    await apiSave(rel, wrap);
  }

  const arr=ensureArr(date,course,type);
  const exists=arr.find(x=>x.path===rel);
  if(exists){ exists.title=title; } else { arr.push({title, path: rel}); }

  await apiSave(`students/${stu}/manifest.json`, manifest);

  if(!q('#keepForm').checked){
    q('#title').value=''; q('#filename').value=''; q('#html').value='';
  }
  setDefaultDateFocus(); renderList();
  toast(true,'å·²å„²å­˜');
}

function clearForm(){ q('#title').value=''; q('#filename').value=''; q('#html').value=''; }
async function reloadCurrentHtml(){
  const file=q('#filename').value; if(!file) return toast(false,'ç›®å‰æ²’æœ‰æª”åå¯é‡è¼‰');
  const rel=`materials/${stu}/${q('#course').value}/${file}`;
  try{
    const raw=await getText(rel);
    const doc=new DOMParser().parseFromString(raw,'text/html');
    const cont=doc.querySelector('.container'); let body='';
    if(cont){ const c=cont.cloneNode(true); const h=c.querySelector('h1'); if(h) h.remove(); body=c.innerHTML.trim(); }
    else{ body=(doc.querySelector('body')?.innerHTML||'').trim(); }
    q('#html').value=body; toast(true,'å·²é‡è¼‰ç›®å‰æ•™æ');
  }catch(e){ toast(false,'é‡è¼‰å¤±æ•—ï¼š'+(e.message||e)); }
}

// ------- boot -------
async function init(){
  await loadRoster(); await loadManifest();
  q('#btnReload').onclick=loadManifest;
  q('#btnSave').onclick=doSave;
  q('#btnClear').onclick=clearForm;
  q('#btnReloadHtml').onclick=reloadCurrentHtml;
  q('#filterDate').oninput=renderList;

  // æ–°å¢å­¸ç”Ÿ
  q('#btnAddStudent').onclick=async()=>{
    if(!isLocal()) return toast(false,'æ–°å¢åƒ…é™æœ¬æ©Ÿä½¿ç”¨');
    const id=(q('#newId').value||'').trim(); const name=(q('#newName').value||'').trim();
    if(!/^[a-z0-9_-]+$/.test(id)) return toast(false,'id éœ€ç‚ºå°å¯«è‹±æ•¸èˆ‡ _-');
    roster.students.push({id, name: name||id});
    await apiSave('roster.json', roster);
    q('#newId').value=''; q('#newName').value='';
    await loadRoster(); stu=id; await loadManifest(); toast(true,'å·²æ–°å¢å­¸ç”Ÿ');
  };
}
init();


=== FILE: docs\index.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èª²ç¨‹æ—¥æ›†</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1024px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px 28px;position:relative;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .nav{display:flex;gap:10px;align-items:center}
  button.navbtn{border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .links a{margin-left:8px;color:#2563eb;text-decoration:none}
  .msg{padding:12px 14px;border-radius:8px;margin:8px 0;display:none}
  .msg.err{background:#fde2e0;color:#9b1c1c}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px;}
  .dow{font-weight:700;color:#5b6770;text-align:center;}
  .cell{background:#f7fafc;min-height:74px;border-radius:10px;padding:8px;position:relative}
  .cell .day{font-weight:700;color:#3a4a5b;}
  .cell.has .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;background:#34c759;border-radius:50%;}
  .cell.today{outline:2px solid #2f80ed;background:#eef6ff;}
  .popover{position:absolute;z-index:50;min-width:280px;max-width:360px;background:#fff;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.15);padding:12px;display:none}
  .popover .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .card{background:#f7fafc;border-radius:10px;padding:10px 12px;margin:8px 0;}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="nav">
      <button class="navbtn" id="btnPrev">â—€</button>
      <div id="monthLabel" style="font-weight:700"></div>
      <button class="navbtn" id="btnNext">â–¶</button>
    </div>
    <div class="links">
      <span id="studentName" style="font-weight:700;margin-right:8px"></span>
      <a href="teacher.html">è€å¸«ä¸»é </a>
      <span id="adminLink"></span>
    </div>
  </div>

  <div id="err" class="msg err"></div>
  <div id="calendar"></div>

  <div id="popover" class="popover">
    <div class="row">
      <label>èª²ç¨‹ï¼š</label><select id="pCourse"></select>
      <label>é¡å‹ï¼š</label><select id="pType"></select>
    </div>
    <div id="pList"></div>
  </div>
</div>

<script>
const q=(s,e=document)=>e.querySelector(s);
const params=new URLSearchParams(location.search);
let currentStudent=params.get('student')||null;
let currentDate=params.get('date')||null;
let currentCourse=params.get('course')||null;
let currentType=params.get('type')||null;

const isLocal=()=>['127.0.0.1','localhost'].includes(location.hostname);
async function getJSON(path){
  if(isLocal()){
    try{ const r=await fetch(`api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r2.ok) throw new Error('HTTP '+r2.status);
  return await r2.json();
}

let roster={students:[]}, manifest=null;
let view = (()=>{
  const d = currentDate ? new Date(currentDate) : new Date();
  return {y: d.getFullYear(), m: d.getMonth()};
})();
const fmtYMD=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const base=(p)=>p.split('/').pop();
function niceTitle(item){
  if(item.title && item.title.trim()) return item.title.trim();
  let name=base(item.path||'').replace(/\.[^.]+$/,'').replace(/^\d{4}-\d{2}-\d{2}_?/, '');
  return name || 'æ•™æ';
}
function setErr(m){const el=q('#err'); if(m){el.textContent=m; el.style.display='block';} else el.style.display='none';}

function dateHasAny(dayObj){
  if(!dayObj) return false;
  return Object.values(dayObj).some(courseObj=>{
    if(!courseObj) return false;
    return Object.values(courseObj).some(arr=>Array.isArray(arr)&&arr.length>0);
  });
}

function renderCalendar(){
  const container=q('#calendar'); container.innerHTML='';
  const y=view.y, m=view.m;
  q('#monthLabel').textContent = `${y} / ${String(m+1).padStart(2,'0')}`;

  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0), days=last.getDate();
  const grid=document.createElement('div'); grid.className='calendar';

  ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; grid.appendChild(el);
  });
  for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));

  const daysMap=manifest?.days||{};
  for(let day=1; day<=days; day++){
    const d=new Date(y,m,day), k=fmtYMD(d), cell=document.createElement('div'); cell.className='cell';
    const has = dateHasAny(daysMap[k]);
    if(has){
      cell.classList.add('has');
      const dot=document.createElement('span'); dot.className='dot'; cell.appendChild(dot);
      cell.style.cursor='pointer';
      cell.onclick=()=>openPopover(k, cell);
    }
    const todayStr=fmtYMD(new Date());
    if(k===todayStr) cell.classList.add('today');

    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.textContent=day; cell.appendChild(dayEl);
    grid.appendChild(cell);
  }
  container.appendChild(grid);

  if(currentDate){
    const d=new Date(currentDate);
    if(d.getFullYear()===y && d.getMonth()===m){
      const cell = container.querySelectorAll('.cell')[d.getDate()+start] || null;
      if(cell) openPopover(currentDate, cell);
    }
  }
}

function combosFor(dateKey){
  const day=manifest?.days?.[dateKey]||{};
  const combos=[];
  Object.keys(day).forEach(c=>{
    Object.keys(day[c]||{}).forEach(t=>{
      const items=(day[c][t]||[]);
      if(items.length) combos.push({course:c,type:t,items});
    });
  });
  return combos;
}
function renderPopoverList(dateKey, courseKey, typeKey){
  const wrap=q('#pList'); wrap.innerHTML='';
  const arr=(((manifest.days?.[dateKey]||{})[courseKey]||{})[typeKey])||[];
  if(!arr.length){ wrap.innerHTML='<div class="card">é€™å€‹çµ„åˆç›®å‰æ²’æœ‰å…§å®¹</div>'; return; }
  arr.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const a=document.createElement('a'); a.href=it.path;  /* ç›¸å°è·¯å¾‘ï¼Œé¿å… / é€ æˆ 404 */
    a.textContent=niceTitle(it);
    card.appendChild(a); wrap.appendChild(card);
  });
}
function openPopover(dateKey, anchorCell){
  currentDate=dateKey;
  const u=new URL(location.href); u.searchParams.set('date',dateKey); history.replaceState({},'',u);

  const combos=combosFor(dateKey);
  if(!combos.length) return;

  const pop=q('#popover'); const app=q('#app');
  const csel=q('#pCourse'), tsel=q('#pType');
  csel.innerHTML=''; tsel.innerHTML='';
  const courses=[...new Set(combos.map(x=>x.course))];
  const types=[...new Set(combos.map(x=>x.type))];
  courses.forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=manifest.courses?.[c]?.label||c; csel.appendChild(o);});
  types.forEach(t=>{const o=document.createElement('option'); o.value=t; o.textContent=manifest.types?.[t]||t; tsel.appendChild(o);});
  const ck = (currentCourse && courses.includes(currentCourse)) ? currentCourse : courses[0];
  const tk = (currentType && types.includes(currentType)) ? currentType : types[0];
  csel.value=ck; tsel.value=tk;
  renderPopoverList(dateKey, ck, tk);
  csel.onchange=()=>{ currentCourse=csel.value; renderPopoverList(dateKey, csel.value, tsel.value); syncURL(); };
  tsel.onchange=()=>{ currentType=tsel.value; renderPopoverList(dateKey, csel.value, tsel.value); syncURL(); };

  const ar=anchorCell.getBoundingClientRect();
  const pr=app.getBoundingClientRect();
  pop.style.display='block';
  pop.style.left = (ar.right - pr.left + 10) + 'px';
  pop.style.top  = (ar.top - pr.top + window.scrollY - 6) + 'px';
  const popRect=pop.getBoundingClientRect();
  if(popRect.right > window.innerWidth - 12){
    pop.style.left = (ar.left - pr.left - popRect.width - 10) + 'px';
  }
  document.addEventListener('click', onDocClick);
  function onDocClick(e){ if(pop.contains(e.target)||anchorCell.contains(e.target)) return; pop.style.display='none'; document.removeEventListener('click', onDocClick); }
  function syncURL(){
    const u=new URL(location.href);
    u.searchParams.set('date', dateKey);
    u.searchParams.set('course', csel.value);
    u.searchParams.set('type',   tsel.value);
    history.replaceState({},'',u);
  }
}

async function loadAll(){
  try{
    roster=await getJSON('roster.json');
    if(!currentStudent) currentStudent = roster.students?.[0]?.id || null;
    const stu = (roster.students||[]).find(s=>s.id===currentStudent);
    q('#studentName').textContent = stu?.name ? `å­¸ç”Ÿï¼š${stu.name}` : `å­¸ç”Ÿï¼š${currentStudent||''}`;
    if(isLocal()) q('#adminLink').innerHTML = '<a href="admin.html">å¾Œå°</a>';
    manifest=await getJSON(`students/${currentStudent}/manifest.json`);
    renderCalendar();
  }catch(e){
    console.error(e);
    setErr('è®€å–è³‡æ–™å¤±æ•—ï¼šè«‹æª¢æŸ¥ docs/roster.json èˆ‡ docs/students/<id>/manifest.json è·¯å¾‘/æ ¼å¼ã€‚');
  }
}
q('#btnPrev').onclick=()=>{ if(--view.m<0){view.m=11; view.y--;} renderCalendar(); };
q('#btnNext').onclick=()=>{ if(++view.m>11){view.m=0; view.y++;} renderCalendar(); };
loadAll();
</script>
</body>
</html>


=== FILE: docs\roster.json ===
{
  "students": [
    { "id": "åº­å¦¤", "name": "åº­å¦¤" },
    { "id": "ray",   "name": "Ray" }
  ]
}


=== FILE: docs\teacher.html ===
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è€å¸«ä¸»é </title>
<style>
  body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;background:#f3f5f7;margin:0;}
  .app{max-width:1024px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px 28px;}
  .header{display:flex;justify-content:space-between;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:14px;}
  .card{background:#f7fafc;border-radius:12px;padding:14px;border:1px solid #e5e7eb}
  .card h3{margin:0 0 6px}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>è€å¸«ä¸»é </h1>
    <div id="adminLink"></div>
  </div>
  <div id="list" class="grid"></div>
</div>
<script>
const q=(s,e=document)=>e.querySelector(s);
const isLocal=()=>['127.0.0.1','localhost'].includes(location.hostname);
async function getJSON(path){
  if(isLocal()){
    try{ const r=await fetch(`api/data/${path}?ts=${Date.now()}`,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
  }
  const r2=await fetch(`${path}?ts=${Date.now()}`,{cache:'no-store'});
  if(!r2.ok) throw new Error('HTTP '+r2.status);
  return await r2.json();
}
async function init(){
  if(isLocal()) q('#adminLink').innerHTML = '<a class="btn" href="admin.html">é€²å¾Œå°</a>';
  const roster=await getJSON('roster.json');
  const wrap=q('#list'); wrap.innerHTML='';
  (roster.students||[]).forEach(s=>{
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<h3>${s.name||s.id}</h3>
      <div style="opacity:.7">idï¼š${s.id}</div>
      <div style="margin-top:8px"><a class="btn" href="index.html?student=${encodeURIComponent(s.id)}">æ‰“é–‹æ—¥æ›†</a></div>`;
    wrap.appendChild(el);
  });
}
init();
</script>
</body>
</html>


=== FILE: docs\students\ray\manifest.json ===
{
  "version": 2,
  "student": "ray",
  "displayName": "Ray Chen",
  "courses": {
    "english": { "label": "è‹±æ–‡", "color": "#1d4ed8" },
    "math": { "label": "æ•¸å­¸", "color": "#059669" }
  },
  "days": {}
}

=== FILE: docs\students\sally\manifest.json ===
{
  "version": 3,
  "student": "sally",
  "displayName": "sally",
  "courses": {
    "english": {
      "label": "è‹±æ–‡"
    },
    "math": {
      "label": "æ•¸å­¸"
    }
  },
  "types": {
    "material": "æ•™æ",
    "homework": "ä½œæ¥­"
  },
  "days": {
    "2025-08-09": {
      "english": {
        "material": [
          {
            "title": "ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)",
            "path": "materials/sally/english/2025-08-09_ä¸»é¡Œï¼šåª’é«”ç´ é¤Š_(media_literacy).html"
          }
        ]
      }
    }
  }
}

=== FILE: docs\materials\sally\english\2025-08-09_ä¸»é¡Œï¼šåª’é«”ç´ é¤Š_(media_literacy).html ===
<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)</title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=sally&date=2025-08-09">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1>ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)</h1><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- è®“éºµåŒ…å±‘èƒ½æ­£ç¢ºè§£ææ—¥æœŸ -->
    <meta name="lesson-date" content="2025-08-10">
    <title>é«˜ä¸‰å­¸æ¸¬è‹±æ–‡ - ä¸»é¡Œæ¢è¨ï¼šåª’é«”ç´ é¤Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        summary {
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary::before {
            content: 'â–¶';
            margin-right: 8px;
            font-size: 0.8em;
            display: inline-block;
            transition: transform 0.2s ease-in-out;
        }
        details[open] summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <!-- è‡ªå‹•ç”¢ç”Ÿè¿”å›ä¸»é çš„éºµåŒ…å±‘ -->
    <div id="breadcrumb" class="max-w-4xl mx-auto mb-4"></div>
    <script>
    (function () {
      // 1) å…ˆç”¨ <meta name="lesson-date">ï¼›è‹¥æ²’æœ‰ï¼Œå†å˜—è©¦å¾æª”åæ¨ YYMMDD
      const metaDate = document.querySelector('meta[name="lesson-date"]')?.content?.trim();
      let dateStr = metaDate && !isNaN(Date.parse(metaDate)) ? metaDate : null;
      if (!dateStr) {
        const m = location.pathname.match(/(\d{2})(\d{2})(\d{2})\.html$/);
        if (m) dateStr = `20${m[1]}-${m[2]}-${m[3]}`;
      }
      const backUrl = dateStr ? `../index.html?date=${dateStr}#calendar-widget` : `../index.html#calendar-widget`;
      document.getElementById('breadcrumb').innerHTML = `
        <a href="${backUrl}" class="text-blue-600 hover:text-blue-800 hover:underline">&larr; è¿”å›èª²ç¨‹æ—¥æ›†</a>
      `;
    })();
    </script>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
        <header class="text-center mb-12">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mb-2">é«˜ä¸‰å­¸æ¸¬è‹±æ–‡ - ä¸»é¡Œæ¢è¨ ğŸŒ</h1>
            <p class="text-lg text-gray-600">ä¸»é¡Œï¼šåª’é«”ç´ é¤Š (Media Literacy)</p>
        </header>

        <main class="space-y-12">

            <!-- 1. é‡é»å–®å­— -->
            <section id="vocabulary">
                <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">1. é‡é»å–®å­— (Key Vocabulary)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">literacy (n.)</h3>
                        <p class="text-gray-700">ç´ é¤Šï¼›è®€å¯«èƒ½åŠ›</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., Financial <strong>literacy</strong> is essential for managing personal finances.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">critically (adv.)</h3>
                        <p class="text-gray-700">æ‰¹åˆ¤æ€§åœ°</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., We should think <strong>critically</strong> about the news we read online.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">evaluate (v.)</h3>
                        <p class="text-gray-700">è©•ä¼°ï¼›è©•åƒ¹</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., It's important to <strong>evaluate</strong> the credibility of a website before trusting its content.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">verify (v.)</h3>
                        <p class="text-gray-700">æŸ¥è­‰ï¼›æ ¸å¯¦</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., Always try to <strong>verify</strong> facts from multiple sources.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">mislead (v.)</h3>
                        <p class="text-gray-700">èª¤å° (ä¸‰æ…‹: mislead, misled, misled)</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., The advertisement was designed to <strong>mislead</strong> customers.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">cultivate (v.)</h3>
                        <p class="text-gray-700">åŸ¹é¤Š</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., Parents play a key role in <strong>cultivating</strong> good habits in their children.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">prevalence (n.)</h3>
                        <p class="text-gray-700">æ™®åŠï¼›ç››è¡Œ</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., The <strong>prevalence</strong> of smartphones has changed how we communicate.</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900">disseminator (n.)</h3>
                        <p class="text-gray-700">å‚³æ’­è€…</p>
                        <p class="text-sm text-gray-600 mt-1">e.g., With social media, anyone can be a content <strong>disseminator</strong>.</p>
                    </div>
                </div>
            </section>

            <!-- 2. æ ¸å¿ƒå¥å‹ -->
            <section id="patterns">
                <h2 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-6">2. æ ¸å¿ƒå¥å‹ (Core Sentence Patterns)</h2>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 1: <code class="text-pink-600">The term A refers to B, which/where...</code> (A ä¸€è©æŒ‡çš„æ˜¯ Bï¼Œè€Œ B...)</p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šç”¨ä¾†æä¾›ä¸€å€‹æ­£å¼çš„å®šç¾©ï¼Œä¸¦å¯æ¥çºŒä¸€å€‹é—œä¿‚å­å¥ä¾†è£œå……èªªæ˜ã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼šThe term "media literacy" <strong>refers to</strong> a set of skills, <strong>which</strong> empower individuals to critically analyze media messages.</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 2: <code class="text-pink-600">In an era flooded with..., it is important/vital/crucial to + Vr...</code></p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šå¼·èª¿åœ¨æŸå€‹ç‰¹å®šæ™‚ä»£èƒŒæ™¯ä¸‹ï¼ŒåšæŸä»¶äº‹çš„é‡è¦æ€§ã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼š<strong>In an era flooded with</strong> fake news, <strong>it is crucial to verify</strong> information sources.</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 3: <code class="text-pink-600">Cultivating... can help sb. (to) avoid being + p.p.</code> (åŸ¹é¤Š...èƒ½å¹«åŠ©æŸäººé¿å…è¢«...)</p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šè¡¨é”æ¡å–æŸè¡Œå‹•å¯ä»¥å¹«åŠ©é¿å…æŸç¨®è¢«å‹•çš„è² é¢çµæœã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼š<strong>Cultivating</strong> good media literacy <strong>can help us avoid being misled</strong> by false information.</p>
                    </div>
                     <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="font-semibold">å¥å‹ 4: <code class="text-pink-600">...come(s) with + N.</code> (...ä¼´éš¨è‘—...è€Œä¾†)</p>
                        <p class="mt-2 text-gray-700">èªªæ˜ï¼šè¡¨ç¤ºæŸäº‹ç‰©å‡ºç¾æ™‚ï¼Œæœƒé€£å¸¶ç”¢ç”Ÿå¦ä¸€ç¨®æƒ…æ³æˆ–è²¬ä»»ã€‚</p>
                        <p class="mt-1 text-gray-700">ä¾‹å¥ï¼šBecoming a content creator <strong>comes with</strong> great responsibility.</p>
                    </div>
                </div>
            </section>

            <!-- 3. å¯«ä½œæ”»ç•¥ -->
            <section id="writing-strategy">
                <h2 class="text-2xl font-bold text-purple-700 border-b-2 border-purple-200 pb-2 mb-6">3. å¯«ä½œæ”»ç•¥ (Writing Strategy)</h2>
                
                <div class="bg-purple-50 border-l-4 border-purple-400 p-6 rounded-r-lg space-y-6">
                    <div>
                        <h3 class="text-lg font-bold text-purple-900">ç¬¬ä¸€æ­¥ï¼šè¾¨åˆ¥æ–‡é«”</h3>
                        <p class="mt-1 text-gray-800">çœ‹åˆ°ã€Œæ¢è¨é‡è¦æ€§ã€ã€ã€Œåˆ†æå½±éŸ¿ã€é€™é¡é¡Œç›®ï¼Œå°±è¦çŸ¥é“é€™æ˜¯ä¸€ç¯‡<strong class="font-semibold">ã€Œè«–èªªæ–‡ã€(Argumentative/Expository Essay)</strong>ã€‚ä½ çš„ç›®æ¨™æ˜¯æå‡ºæ¸…æ™°çš„è«–é»ï¼Œä¸¦ç”¨ç†ç”±å’Œä¾‹å­ä¾†æ”¯æŒå®ƒã€‚</p>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-purple-900">ç¬¬äºŒæ­¥ï¼šè¦åŠƒæ–‡ç« æ¶æ§‹ (Structure)</h3>
                        <p class="mt-1 text-gray-800 mb-4">ä¸€ç¯‡å¥½çš„è«–èªªæ–‡ï¼Œå°±åƒè“‹æˆ¿å­ï¼Œéœ€è¦ç©©å›ºçš„æ¶æ§‹ã€‚ä½ å¯ä»¥éµå¾ªã€Œç¸½-åˆ†-ç¸½ã€çš„åŸå‰‡ï¼š</p>
                        
                        <div class="space-y-3">
                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p><strong>A. ä¸»æ—¨æ®µ (Introduction): é»å‡ºæ ¸å¿ƒè«–é»</strong></p>
                                <ul class="list-disc list-inside mt-2 text-gray-700 text-sm space-y-1">
                                    <li><strong>é–‹é ­ (Hook):</strong> ç”¨ä¸€å€‹å•é¡Œæˆ–ä¸€å¥è©±å¸å¼•è®€è€…æ³¨æ„ã€‚ (e.g., "In a world saturated with information, how can we tell truth from fiction?")</li>
                                    <li><strong>å®šç¾©èˆ‡èƒŒæ™¯:</strong> ç°¡å–®è§£é‡‹ã€Œåª’é«”ç´ é¤Šã€æ˜¯ä»€éº¼ï¼Œä»¥åŠç‚ºä»€éº¼åœ¨ã€Œæ•¸ä½æ™‚ä»£ã€å¾ˆé‡è¦ã€‚</li>
                                    <li><strong>ä¸»æ—¨å¥ (Thesis Statement):</strong> ä¸€å¥è©±æ¸…æ¥šè¡¨æ˜ä½ çš„æ ¸å¿ƒè«–é»ã€‚ (e.g., "Therefore, developing media literacy is a critical skill for navigating the modern world and fostering a responsible digital citizenship.")</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p><strong>B. æ”¯æ’æ®µ (Body Paragraph): æå‡ºç†ç”±èˆ‡è­‰æ“š</strong></p>
                                <ul class="list-disc list-inside mt-2 text-gray-700 text-sm space-y-1">
                                    <li><strong>ä¸»é¡Œå¥ (Topic Sentence):</strong> æ¯æ®µé–‹é ­ç”¨ä¸€å¥è©±é»å‡ºè©²æ®µçš„é‡é»ã€‚ä¾‹å¦‚ï¼Œå…ˆè«‡ã€Œç¼ºä¹åª’é«”ç´ é¤Šçš„å£è™•ã€ã€‚</li>
                                    <li><strong>è§£é‡‹èˆ‡èˆ‰ä¾‹ (Explanation & Example):</strong> é—¡è¿°ä¸»é¡Œå¥ï¼Œä¸¦èˆ‰å‡ºå…·é«”ä¾‹å­ï¼Œå¦‚å‡æ–°è (fake news)ã€ç¶²è·¯éœ¸å‡Œ (cyberbullying) ç­‰ã€‚</li>
                                    <li><strong>ç™¼å±•è«–é»:</strong> æ¥è‘—å¯ä»¥å¯«ä¸‹ä¸€æ®µï¼Œä¸»é¡Œå¥æ˜¯ã€Œå¦‚ä½•åŸ¹é¤Šåª’é«”ç´ é¤Šã€ï¼Œä¸¦æå‡ºå…·é«”æ–¹æ³•ï¼Œå¦‚æŸ¥è­‰ä¾†æº (verifying sources)ã€æ‰¹åˆ¤æ€§æ€è€ƒ (thinking critically) ç­‰ã€‚</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border border-purple-200">
                                <p><strong>C. çµè«–æ®µ (Conclusion): ç¸½çµä¸¦æ˜‡è¯</strong></p>
                                <ul class="list-disc list-inside mt-2 text-gray-700 text-sm space-y-1">
                                    <li><strong>é‡ç”³ä¸»æ—¨:</strong> ç”¨ä¸åŒçš„è©±å†æ¬¡å¼·èª¿ä½ çš„æ ¸å¿ƒè«–é»ã€‚</li>
                                    <li><strong>ç¸½çµè¦é»:</strong> å¿«é€Ÿç¸½çµä½ åœ¨æ”¯æ’æ®µæå‡ºçš„ä¸»è¦ç†ç”±ã€‚</li>
                                    <li><strong>æå‡ºå±•æœ› (Concluding thought):</strong> çµ¦å‡ºä¸€å€‹æœ‰åŠ›çš„çµå°¾ï¼Œä¾‹å¦‚å°æœªä¾†çš„æœŸè¨±æˆ–çµ¦è®€è€…çš„å»ºè­°ã€‚ (e.g., "Ultimately, being media literate is not just about personal protection; it is about contributing to a more informed and democratic society.")</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
        
        <footer class="text-center mt-16 pt-8 border-t border-gray-200">
            <p class="text-gray-500">æ¯å¤©é€²æ­¥ä¸€é»é»ï¼Œç´¯ç©èµ·ä¾†å°±æ˜¯å·¨å¤§çš„é£›èºï¼ğŸš€</p>
            <p class="text-sm text-gray-400 mt-2">æ¸…å¤§æ–‡ç†è£œç¿’ç­ãƒ»Jeff</p>
        </footer>
    </div>

</body>
</html></div>
</body></html>

=== FILE: docs\materials\ray\english\2025-08-10_lesson.html ===
<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç‘ç‘ç¬¬ä¸€èª²</title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=ray&date=2025-08-10">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1>ç‘ç‘ç¬¬ä¸€èª²</h1><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸€è‹±æ–‡ Lesson 1 å­¸ç¿’é‡é» - For ç‘ç‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;family=Noto+Sans+TC:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .hero-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>



    <header class="hero-bg text-white py-12 sm:py-20 px-4 text-center rounded-b-3xl shadow-lg">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4">æ­¡è¿ä¾†åˆ°åœ‹ä¸€è‹±æ–‡ç¬¬ä¸€èª²ï¼</h1>
            <p class="text-lg sm:text-xl opacity-90">é€™æ˜¯ä¸€å€‹å°ˆç‚ºç‘ç‘è¨­è¨ˆçš„å­¸ç¿’é é¢ï¼ŒæŠŠç¬¬ä¸€èª²çš„é‡é»ä¸€ç¶²æ‰“ç›¡ï¼</p>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 max-w-5xl">
        
        <!-- Vocabulary Section -->
        <section id="vocabulary" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md mb-8">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">æ ¸å¿ƒå–®å­— (Core Vocabulary)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <div class="bg-indigo-50 p-5 rounded-xl">
                    <h3 class="text-xl font-semibold text-indigo-800 mb-3">å®¶åº­èˆ‡ç¨±è¬‚ (Family &amp; Titles)</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>family: å®¶äººï¼›å®¶åº­</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>father (dad): çˆ¶è¦ª</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>mother (mom): æ¯è¦ª</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>brother: å…„å¼Ÿ</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>sister: å§å¦¹</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>son: å…’å­</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>daughter: å¥³å…’</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>uncle: å”(ä¼¯)çˆ¶ï¼›å§‘(å§¨)ä¸ˆï¼›èˆ…èˆ…</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>aunt: å¬¸å¬¸ï¼›ä¼¯æ¯ï¼›å§‘(å§¨)åª½ï¼›èˆ…åª½</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>cousin: å ‚(è¡¨)å…„å¼Ÿå§å¦¹</li>
                    </ul>
                </div>
                
                <div class="bg-purple-50 p-5 rounded-xl">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3">è·æ¥­ (Occupation)</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>student: å­¸ç”Ÿ</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>teacher: è€å¸«</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>doctor: é†«ç”Ÿ</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>nurse: è­·ç†å¸«ï¼›è­·å£«</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>farmer: è¾²å¤«</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-400 rounded-full mr-3"></span>cook: å»šå¸«</li>
                    </ul>
                </div>
                
                <div class="bg-pink-50 p-5 rounded-xl">
                    <h3 class="text-xl font-semibold text-pink-800 mb-3">å½¢å®¹è© (Adjectives)</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>young: å¹´è¼•çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>old: å¹´è€çš„ï¼›èˆŠçš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>tall: é«˜çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>handsome: è‹±ä¿Šçš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>beautiful: æ¼‚äº®çš„ï¼›ç¾éº—çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>cute: å¯æ„›çš„</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-pink-400 rounded-full mr-3"></span>strict: åš´æ ¼çš„</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Grammar Section -->
        <section id="grammar" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md mb-8">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">é‡é»æ–‡æ³•èˆ‡å¥å‹ (Key Grammar &amp; Patterns)</h2>
            
            <div class="space-y-6">
                <div>
                    <h4 class="text-xl font-semibold mb-2">1. be å‹•è©ï¼šam, is, are (æ˜¯)</h4>
                    <p class="text-gray-600 mb-3">be å‹•è©ç”¨ä¾†è¡¨ç¤ºç‹€æ…‹æˆ–èº«ä»½ï¼Œæœƒæ ¹æ“šä¸»è©äººç¨±åšè®ŠåŒ–ã€‚</p>
                    <ul class="list-disc list-inside bg-gray-100 p-4 rounded-lg">
                        <li>ç¬¬ä¸€äººç¨± (æˆ‘)ï¼šI <span class="font-bold text-indigo-700">am</span></li>
                        <li>ç¬¬äºŒäººç¨± (ä½ /ä½ å€‘)ï¼šyou <span class="font-bold text-indigo-700">are</span></li>
                        <li>ç¬¬ä¸‰äººç¨±å–®æ•¸ (ä»–/å¥¹/å®ƒ)ï¼šhe / she / it <span class="font-bold text-indigo-700">is</span></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-2">2. ç›´è¿°å¥ (Statements)</h4>
                    <div class="border-l-4 border-indigo-500 bg-indigo-50 p-4 rounded-r-lg mb-3">
                        <p><strong>è‚¯å®šå¥ï¼š</strong>ä¸»è© + beå‹•è© + a/an + å–®æ•¸åè©ã€‚</p>
                        <p class="mt-1 italic">My uncle is a doctor. (æˆ‘å”å”æ˜¯ä¸€ä½é†«ç”Ÿã€‚)</p>
                    </div>
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg">
                        <p><strong>å¦å®šå¥ï¼š</strong>ä¸»è© + beå‹•è© + not + a/an + å–®æ•¸åè©ã€‚</p>
                        <p class="mt-1 italic">My brother is not a junior high school student. (æˆ‘å“¥å“¥ä¸æ˜¯ä¸€ä½åœ‹ä¸­ç”Ÿã€‚)</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-2">3. Yes/No å•ç­”å¥ (Yes/No Questions)</h4>
                    <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded-r-lg">
                        <p><strong>å•å¥ï¼š</strong>Beå‹•è© + ä¸»è© + a/an + åè©?</p>
                        <p class="mt-2 italic">Q: Is Vicky a nurse? (Vickyæ˜¯ä¸€ä½è­·ç†å¸«å—ï¼Ÿ)</p>
                        <p class="italic">A: Yes, she is. (æ˜¯çš„ï¼Œå¥¹æ˜¯ã€‚)</p>
                        <p class="mt-2 italic">Q: Are you a cook? (ä½ æ˜¯ä¸€ä½å»šå¸«å—ï¼Ÿ)</p>
                        <p class="italic">A: No, I'm not a cook. (ä¸æ˜¯ï¼Œæˆ‘ä¸æ˜¯ä¸€ä½å»šå¸«ã€‚)</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-2">4. Who å•ç­”å¥ (Who Questions)</h4>
                    <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded-r-lg">
                        <p><strong>å•å¥ï¼š</strong>Who + beå‹•è© + ä¸»è©?</p>
                        <p class="mt-2 italic">Q: Who's that young man? (é‚£ä½å¹´è¼•çš„ç”·å­æ˜¯èª°ï¼Ÿ)</p>
                        <p class="italic">A: He's our new PE teacher. (ä»–æ˜¯æˆ‘å€‘çš„æ–°é«”è‚²è€å¸«ã€‚)</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dialogue Section -->
        <section id="dialogue" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md mb-8">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">å¯¦ç”¨å°è©± (Dialogue Practice)</h2>
            <div class="space-y-4">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p>A: Nice to meet you. (å¾ˆé«˜èˆˆèªè­˜ä½ ã€‚)</p>
                    <p>B: Nice to meet you, too. (æˆ‘ä¹Ÿå¾ˆé«˜èˆˆèªè­˜ä½ ã€‚)</p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p>A: Hey, Rita. Good news. Bella is our English teacher! (å˜¿ï¼ŒRitaã€‚å¥½æ¶ˆæ¯ï¼ŒBella æ˜¯æˆ‘å€‘çš„è‹±æ–‡è€å¸«ï¼)</p>
                    <p>B: Oh, no. That's not good. (å“¦ï¼Œä¸ã€‚é€™ä¸æ˜¯å¥½æ¶ˆæ¯ã€‚)</p>
                    <p>A: What's the problem? She's a great teacher. (æ€éº¼äº†ï¼Ÿå¥¹æ˜¯ä¸€ä½å¾ˆæ£’çš„è€å¸«ã€‚)</p>
                    <p>B: Well... she's a strict teacher, too. (å—¯...å¥¹ä¹Ÿæ˜¯ä¸€ä½åš´æ ¼çš„è€å¸«ã€‚)</p>
                </div>
            </div>
        </section>
        
        <!-- Quiz Section -->
        <section id="quiz" class="bg-white p-6 sm:p-8 rounded-2xl shadow-md">
            <h2 class="text-3xl font-bold text-indigo-600 border-b-4 border-indigo-200 pb-3 mb-6">å°è©¦èº«æ‰‹ (Quick Quiz)</h2>
            <p class="text-gray-600 mb-6">è©¦è‘—å¡«å…¥æ­£ç¢ºçš„å–®å­— (am / is / are / Who's)ï¼</p>
            <div class="space-y-4">
                <div class="quiz-item">
                    <p>1. A: ____ that girl? B: She is my sister, May.</p>
                    <div class="answer mt-2 text-green-600 font-bold hidden">ç­”æ¡ˆï¼šWho's</div>
                </div>
                <div class="quiz-item">
                    <p>2. He ____ a handsome doctor.</p>
                    <div class="answer mt-2 text-green-600 font-bold hidden">ç­”æ¡ˆï¼šis</div>
                </div>
                <div class="quiz-item">
                    <p>3. A: ____ you a teacher? B: No, I ____ not. I'm a student.</p>
                    <div class="answer mt-2 text-green-600 font-bold hidden">ç­”æ¡ˆï¼šAre, am</div>
                </div>
            </div>
            <button id="show-answers" class="mt-6 inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">é¡¯ç¤ºç­”æ¡ˆ</button>
        </section>
    </main>

    <footer class="text-center py-10 mt-8">
        <p class="text-gray-500">åšå¾—å¾ˆå¥½ï¼ç¬¬ä¸€èª²çš„åŸºç¤éå¸¸é‡è¦ï¼Œå¸¸å¸¸å›ä¾†è¤‡ç¿’å–”ï¼</p>
    </footer>

    <script>
        // Script to show answers for the quiz
        document.getElementById('show-answers').addEventListener('click', function() {
            var answers = document.querySelectorAll('.answer');
            answers.forEach(function(answer) {
                answer.classList.remove('hidden');
            });
            this.classList.add('hidden'); // Hide button after clicking
        });
    </script></div>
</body></html>

=== FILE: docs\materials\ray\math\2025-08-10_lesson.html ===
<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title></title>
<style>body{font-family:system-ui,"Noto Sans TC",Arial,sans-serif;margin:0;background:#f6f7fb;}
.header{background:#111827;color:#fff;padding:10px 14px;}
.header a{color:#a7f3d0;text-decoration:none}
.container{max-width:900px;margin:18px auto;background:#fff;border-radius:12px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.06)}</style>
</head><body>
<div class="header">â† <a href="../../../index.html?student=ray&date=2025-08-10">è¿”å›æ—¥æ›†</a></div>
<div class="container"><h1></h1><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æ•¸å­¸æ•™æï¼šè² æ•¸èˆ‡æ•¸ç·š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutrals -->
    <!-- Application Structure Plan: A single-page application with four interactive/informational modules ("1. æ¢ç´¢æ­£è² æ•¸", "2. ç©è½‰æ•¸ç·š", "3. è§€å¿µé‡æ¸…", "4. è§£å¯†çµ•å°å€¼") navigated by a sticky top bar. This thematic, hands-on structure is chosen over a linear text format to enhance engagement and clarify abstract concepts through direct manipulation and immediate visual feedback, which is more effective for foundational math learning. The goal is to transform passive reading into active exploration. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Relative quantities & benchmarks -> Goal: Inform -> Viz/Presentation: Interactive Slider with a dynamic thermometer visual (HTML/CSS/JS) -> Interaction: User drags slider to see value and visual change -> Justification: Makes the abstract concept of a benchmark tangible and connects it to a familiar real-world example.
        - Report Info: Number line and number comparison -> Goal: Organize/Compare -> Viz/Presentation: Large, interactive number line where users can place points (HTML/CSS/JS) -> Interaction: User clicks to add a point, and its value is displayed -> Justification: Promotes active learning and spatial understanding of number placement and order over passive observation.
        - Report Info: Confusing concepts (Opposite Numbers, Value vs. Absolute Value) -> Goal: Clarify/Differentiate -> Viz/Presentation: A dedicated text-based section with clear headings and highlighted keywords -> Interaction: Reading and comprehension -> Justification: Directly addresses common student misconceptions before they interact with the final module, improving learning outcomes.
        - Report Info: Value vs. Absolute Value -> Goal: Compare/Differentiate -> Viz/Presentation: A dual-bar chart (Chart.js) with a restructured data model. Color now consistently represents the entity (Number A or Number B), while the x-axis categorizes the concept (Value vs. Absolute Value). -> Interaction: User inputs two numbers, and the chart and number line immediately update -> Justification: This revised structure provides a powerful, direct visual comparison that highlights the core difference between a number's value and its absolute value without any color ambiguity.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
        }
        html {
            scroll-padding-top: 5rem; /* Offset for sticky header */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-link {
            transition: color 0.3s, border-color 0.3s;
        }
        .interactive-number-line {
            position: relative;
            height: 50px;
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 8px;
            cursor: crosshair;
        }
        .interactive-number-line .line {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background-color: #475569; /* slate-600 */
        }
        .interactive-number-line .tick {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 10px;
            background-color: #475569; /* slate-600 */
        }
        .interactive-number-line .tick-label {
            position: absolute;
            top: 28px;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #334155; /* slate-700 */
        }
        .interactive-number-line .point {
            position: absolute;
            top: 50%;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.2s;
        }
        .interactive-number-line .point-label {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl md:text-2xl font-bold text-sky-700">åœ‹ä¸­æ•¸å­¸éŠœæ¥æ•™æ</h1>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#module1" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">1. æ¢ç´¢æ­£è² æ•¸</a>
                    <a href="#module2" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">2. ç©è½‰æ•¸ç·š</a>
                    <a href="#concepts" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">3. è§€å¿µé‡æ¸…</a>
                    <a href="#module3" class="nav-link text-slate-600 hover:text-sky-600 border-b-2 border-transparent hover:border-sky-600 pb-1">4. è§£å¯†çµ•å°å€¼</a>
                </div>
                <div class="md:hidden">
                    <select id="mobile-nav" class="bg-slate-100 border border-slate-300 rounded-md p-2 text-slate-700">
                        <option value="#module1">1. æ¢ç´¢æ­£è² æ•¸</option>
                        <option value="#module2">2. ç©è½‰æ•¸ç·š</option>
                        <option value="#concepts">3. è§€å¿µé‡æ¸…</option>
                        <option value="#module3">4. è§£å¯†çµ•å°å€¼</option>
                    </select>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="text-center mb-12">
            <h2 class="text-4xl font-bold text-slate-800 mb-2">1-1 è² æ•¸èˆ‡æ•¸ç·š</h2>
            <p class="text-lg text-slate-600">é€éäº’å‹•æ“ä½œï¼Œå»ºç«‹ç©©å›ºçš„æ•¸å­¸åŸºç¤è§€å¿µã€‚</p>
        </div>

        <!-- Module 1: Positive & Negative Numbers -->
        <section id="module1" class="mb-16 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-1 text-sky-800">1. æ¢ç´¢æ­£è² æ•¸</h3>
            <p class="text-slate-600 mb-6">ç”Ÿæ´»ä¸­å……æ»¿äº†ç›¸å°çš„é‡ã€‚æˆ‘å€‘ç”¨ä¸€å€‹ã€ŒåŸºæº–é» (0)ã€ä¾†å€åˆ†å®ƒå€‘ã€‚è©¦è‘—æ‹–å‹•ä¸‹æ–¹çš„æ»‘æ¡¿ï¼Œè§€å¯Ÿæº«åº¦è¨ˆå’Œæµ·æ‹”é«˜åº¦å¦‚ä½•ç”¨æ­£è² æ•¸è¡¨ç¤ºã€‚</p>
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="flex flex-col items-center">
                    <div class="w-full max-w-xs">
                         <label for="value-slider" class="block text-center text-slate-700 mb-2">æ‹–å‹•æ»‘æ¡¿æ”¹è®Šæ•¸å€¼</label>
                        <input id="value-slider" type="range" min="-50" max="50" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-slate-500 px-1 mt-1">
                            <span>-50</span>
                            <span>0</span>
                            <span>+50</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-around items-end h-64">
                    <!-- Thermometer -->
                    <div class="text-center">
                        <p class="font-semibold mb-2">æº«åº¦è¨ˆ</p>
                        <div class="w-12 h-56 bg-slate-200 rounded-full flex justify-center items-end p-1.5 relative">
                            <div id="mercury" class="w-full bg-red-500 rounded-b-full transition-all duration-200" style="height: 70%;"></div>
                             <div class="absolute top-1/2 left-full ml-2 w-px h-px">
                                <span class="absolute -translate-y-1/2 text-xs text-slate-500 whitespace-nowrap">0Â°C</span>
                            </div>
                        </div>
                        <p id="temp-display" class="mt-2 text-lg font-bold text-red-600">+20Â°C</p>
                    </div>
                    <!-- Altitude -->
                    <div class="text-center">
                        <p class="font-semibold mb-2">æµ·æ‹”é«˜åº¦</p>
                        <div class="w-24 h-56 bg-sky-100 relative overflow-hidden rounded-md">
                            <div class="absolute bottom-0 w-full h-1/2 bg-cyan-600"></div>
                            <div id="altitude-marker" class="absolute left-1/2 w-8 h-8 -translate-x-1/2 transition-all duration-200" style="bottom: 70%;">
                                <span class="text-3xl">â›°ï¸</span>
                            </div>
                            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-sky-800/50">
                                <span class="absolute top-0 left-full ml-2 text-xs text-slate-500 whitespace-nowrap">æµ·å¹³é¢ 0m</span>
                            </div>
                        </div>
                        <p id="altitude-display" class="mt-2 text-lg font-bold text-sky-700">+2000m</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Module 2: Number Line -->
        <section id="module2" class="mb-16 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-1 text-sky-800">2. ç©è½‰æ•¸ç·š</h3>
            <p class="text-slate-600 mb-6">æ•¸ç·šæ˜¯æ•¸å­—çš„å®¶ã€‚åœ¨ä¸‹é¢çš„æ•¸ç·šä¸Šé»æ“Šï¼Œæ¨™ç¤ºå‡ºä»»æ„æ•¸å­—çš„ä½ç½®ã€‚æ„ˆå³é‚Šçš„é»ï¼Œä»£è¡¨çš„æ•¸æ„ˆå¤§ã€‚</p>
            <div id="interactive-line-1" class="interactive-number-line mb-4"></div>
            <div class="text-center">
                <button id="clear-points-btn" class="mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">æ¸…é™¤æ‰€æœ‰æ¨™ç¤ºé»</button>
            </div>
        </section>
        
        <!-- NEW Module: Key Concepts -->
        <section id="concepts" class="mb-16 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-sky-800">3. è§€å¿µé‡æ¸…ï¼šåˆ¥å†ææ··äº†ï¼</h3>
            <div class="space-y-6 text-base">
                <div>
                    <h4 class="font-bold text-lg text-amber-700"># ç›¸åæ•¸æ˜¯ä»€éº¼ï¼Ÿ</h4>
                    <p class="text-slate-700 mt-2 leading-relaxed">
                        åœ¨æ•¸ç·šä¸Šï¼Œç«™åœ¨åŸé»(0)çš„å…©å´ï¼Œè€Œä¸”å’ŒåŸé»<strong class="text-orange-600">ã€Œè·é›¢ç›¸ç­‰ã€</strong>çš„å…©å€‹æ•¸ï¼Œå°±äº’ç‚ºç›¸åæ•¸ã€‚
                        <br>ä¾‹å¦‚ï¼š<code class="bg-slate-200 px-1 rounded">-5</code> çš„ç›¸åæ•¸æ˜¯ <code class="bg-slate-200 px-1 rounded">5</code>ã€‚å®ƒå€‘åˆ°0çš„è·é›¢éƒ½æ˜¯5ã€‚
                        <br><strong>é—œéµç‰¹æ€§ï¼š</strong> äº’ç‚ºç›¸åæ•¸çš„å…©å€‹æ•¸ï¼Œçµ•å°å€¼ç›¸ç­‰ã€‚
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-amber-700"># æ•¸å€¼ vs. çµ•å°å€¼ï¼šå“ªè£¡ä¸ä¸€æ¨£ï¼Ÿ</h4>
                    <p class="text-slate-700 mt-2 leading-relaxed">
                        é€™æ˜¯æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼è¨˜å¾—å®ƒå€‘å›ç­”çš„å•é¡Œä¸åŒï¼š
                        <br>â€¢ <strong>æ•¸å€¼</strong>ï¼šä»£è¡¨åœ¨æ•¸ç·šä¸Šçš„<strong class="text-blue-600">ã€Œä½ç½®ã€</strong>ã€‚å®ƒæœ‰æ–¹å‘æ€§ï¼ˆæ­£æˆ–è² ï¼‰ã€‚å•çš„æ˜¯ï¼šã€Œå®ƒåœ¨å“ªè£¡ï¼Ÿã€
                        <br>â€¢ <strong>çµ•å°å€¼</strong>ï¼šä»£è¡¨èˆ‡åŸé»0çš„<strong class="text-orange-600">ã€Œè·é›¢ã€</strong>ã€‚å®ƒæ°¸é æ˜¯æ­£æ•¸æˆ–0ã€‚å•çš„æ˜¯ï¼šã€Œå®ƒé›¢èµ·é»å¤šé ï¼Ÿã€
                    </p>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-amber-700"># è² æ•¸æ¯”å¤§å°çš„é™·é˜±</h4>
                    <p class="text-slate-700 mt-2 leading-relaxed">
                        å¾ˆå¤šäººæœƒè¦ºå¾— -10 æ¯” -2 å¤§ï¼Œå› ç‚º 10 æ¯” 2 å¤§ã€‚é€™æ˜¯éŒ¯çš„ï¼
                        <br><strong>å”¯ä¸€æº–å‰‡ï¼š</strong> åœ¨æ•¸ç·šä¸Šï¼Œ<strong class="text-red-600">æ„ˆå³é‚Šçš„æ•¸æ„ˆå¤§</strong>ã€‚
                        <br>å› ç‚º -2 åœ¨ -10 çš„å³é‚Šï¼Œæ‰€ä»¥ <code class="bg-slate-200 px-1 rounded">-2 > -10</code>ã€‚å¯ä»¥æƒ³åƒæˆï¼šæ°£æº«é›¶ä¸‹2åº¦æ¯”é›¶ä¸‹10åº¦è¦æº«æš–ä¸€äº›ï¼
                    </p>
                </div>
            </div>
        </section>

        <!-- Module 3: Absolute Value -->
        <section id="module3" class="p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-1 text-sky-800">4. è§£å¯†çµ•å°å€¼</h3>
            <p class="text-slate-600 mb-4">çµ•å°å€¼çš„æ ¸å¿ƒæ„ç¾©æ˜¯ã€Œèˆ‡åŸé» (0) çš„è·é›¢ã€ï¼Œæ‰€ä»¥çµ•å°å€¼æ°¸é ä¸æœƒæ˜¯è² æ•¸ã€‚è¼¸å…¥å…©å€‹æ•¸å­—ï¼Œè§€å¯Ÿå®ƒå€‘çš„ã€Œæ•¸å€¼ã€å’Œã€Œçµ•å°å€¼ã€æœ‰ä½•ä¸åŒã€‚</p>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="numA" class="block text-sm font-medium text-slate-700">æ•¸å­— A</label>
                    <input type="number" id="numA" value="-5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="numB" class="block text-sm font-medium text-slate-700">æ•¸å­— B</label>
                    <input type="number" id="numB" value="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-2">
                </div>
            </div>
            <div id="interactive-line-2" class="interactive-number-line mb-8"></div>
            <p class="text-slate-600 mb-4 text-center">ä¸‹æ–¹çš„åœ–è¡¨æ¸…æ¥šåœ°æ¯”è¼ƒäº†å…©æ•¸çš„ã€Œæ•¸å€¼å¤§å°ã€èˆ‡ã€Œçµ•å°å€¼å¤§å°ï¼ˆèˆ‡0çš„è·é›¢ï¼‰ã€ã€‚</p>
            <div class="chart-container">
                <canvas id="abs-chart"></canvas>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Navigation ---
            const setupNavigation = () => {
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        const targetElement = document.querySelector(this.getAttribute('href'));
                        if(targetElement) {
                            targetElement.scrollIntoView({
                                behavior: 'smooth'
                            });
                        }
                    });
                });
                const mobileNav = document.getElementById('mobile-nav');
                mobileNav.addEventListener('change', (e) => {
                    const targetElement = document.querySelector(e.target.value);
                    if(targetElement) {
                        targetElement.scrollIntoView({
                           behavior: 'smooth'
                       });
                    }
                });
            };

            // --- Module 1: Positive/Negative Numbers ---
            const setupModule1 = () => {
                const slider = document.getElementById('value-slider');
                const mercury = document.getElementById('mercury');
                const tempDisplay = document.getElementById('temp-display');
                const altitudeMarker = document.getElementById('altitude-marker');
                const altitudeDisplay = document.getElementById('altitude-display');

                const updateVisuals = (value) => {
                    const percentage = (parseInt(value) + 50);
                    
                    mercury.style.height = `${percentage}%`;
                    tempDisplay.textContent = `${value >= 0 ? '+' : ''}${value}Â°C`;
                    mercury.style.backgroundColor = value >= 0 ? '#ef4444' : '#3b82f6';
                    tempDisplay.style.color = value >= 0 ? '#dc2626' : '#2563eb';

                    altitudeMarker.style.bottom = `${percentage}%`;
                    const altitude = value * 100;
                    altitudeDisplay.textContent = `${altitude >= 0 ? '+' : ''}${altitude}m`;
                    altitudeDisplay.style.color = altitude >= 0 ? '#0369a1' : '#0891b2';
                };

                slider.addEventListener('input', (e) => updateVisuals(e.target.value));
                updateVisuals(slider.value);
            };

            // --- Interactive Number Line Factory ---
            const createInteractiveNumberLine = (containerId, range = 10) => {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '<div class="line"></div>';
                const ticks = range * 2;
                for (let i = 0; i <= ticks; i++) {
                    const value = i - range;
                    const tickEl = document.createElement('div');
                    tickEl.className = 'tick';
                    const leftPos = (i / ticks) * 100;
                    tickEl.style.left = `${leftPos}%`;
                    
                    if (value % 5 === 0 || range <= 5) {
                        tickEl.style.height = '20px';
                        const labelEl = document.createElement('div');
                        labelEl.className = 'tick-label';
                        labelEl.textContent = value;
                        labelEl.style.left = `${leftPos}%`;
                        container.appendChild(labelEl);
                    }
                    container.appendChild(tickEl);
                }

                const addPoint = (value, label, color = 'bg-sky-500', id = '') => {
                    if (value < -range || value > range) return;
                    
                    const existingPoint = id ? document.getElementById(id) : null;
                    if(existingPoint) existingPoint.remove();

                    const pointEl = document.createElement('div');
                    pointEl.className = `point ${color}`;
                    if(id) pointEl.id = id;
                    
                    const leftPos = ((value + range) / (range * 2)) * 100;
                    pointEl.style.left = `${leftPos}%`;

                    const labelEl = document.createElement('div');
                    labelEl.className = `point-label text-white ${color}`;
                    labelEl.textContent = label;
                    pointEl.appendChild(labelEl);
                    
                    container.appendChild(pointEl);
                };

                const addDistanceLine = (value, color = 'bg-orange-500/50', id = '') => {
                     if (value < -range || value > range) return;

                    const existingLine = id ? document.getElementById(id) : null;
                    if(existingLine) existingLine.remove();

                    const distLine = document.createElement('div');
                    if(id) distLine.id = id;
                    distLine.style.position = 'absolute';
                    distLine.style.top = '10px';
                    distLine.style.height = '5px';
                    distLine.style.backgroundColor = color;
                    distLine.className = 'rounded-full';

                    const absValue = Math.abs(value);
                    const width = (absValue / (range * 2)) * 100;
                    distLine.style.width = `${width}%`;

                    if (value > 0) {
                        distLine.style.left = '50%';
                    } else {
                        const leftPos = ((value + range) / (range * 2)) * 100;
                        distLine.style.left = `${leftPos}%`;
                    }
                    container.appendChild(distLine);
                };
                
                const clearPoints = () => {
                    container.querySelectorAll('.point').forEach(p => p.remove());
                    container.querySelectorAll('[id^="dist-"]').forEach(d => d.remove());
                };

                return { container, addPoint, addDistanceLine, clearPoints, range };
            };

            // --- Module 2: Number Line ---
            const setupModule2 = () => {
                const lineInstance = createInteractiveNumberLine('interactive-line-1', 10);
                lineInstance.container.addEventListener('click', (e) => {
                    const rect = e.target.closest('.interactive-number-line').getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percentage = clickX / rect.width;
                    const value = (percentage * (lineInstance.range * 2)) - lineInstance.range;
                    const roundedValue = Math.round(value * 10) / 10;
                    lineInstance.addPoint(roundedValue, roundedValue.toString(), 'bg-teal-500');
                });
                document.getElementById('clear-points-btn').addEventListener('click', lineInstance.clearPoints);
            };

            // --- Module 3: Absolute Value ---
            const setupModule3 = () => {
                const numAInput = document.getElementById('numA');
                const numBInput = document.getElementById('numB');
                const lineInstance = createInteractiveNumberLine('interactive-line-2', 10);

                const ctx = document.getElementById('abs-chart').getContext('2d');
                // UPDATED CHART CONFIGURATION
                const absChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['æ•¸å€¼', 'çµ•å°å€¼'], // X-axis now represents the concept
                        datasets: [
                            {
                                label: 'æ•¸å­— A', // Series 1 is for Number A
                                data: [0, 0],
                                backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue for A
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'æ•¸å­— B', // Series 2 is for Number B
                                data: [0, 0],
                                backgroundColor: 'rgba(249, 115, 22, 0.6)', // Orange for B
                                borderColor: 'rgba(249, 115, 22, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'å¤§å°' }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                const updateAbsModule = () => {
                    const valA = parseFloat(numAInput.value) || 0;
                    const valB = parseFloat(numBInput.value) || 0;

                    // Number line colors remain consistent: Blue for A, Orange for B
                    lineInstance.clearPoints();
                    lineInstance.addPoint(valA, `A: ${valA}`, 'bg-blue-500', 'point-a');
                    lineInstance.addPoint(valB, `B: ${valB}`, 'bg-orange-500', 'point-b');
                    lineInstance.addDistanceLine(valA, '#3b82f680', 'dist-a'); // Light Blue for A's distance
                    lineInstance.addDistanceLine(valB, '#f9731680', 'dist-b'); // Light Orange for B's distance

                    // UPDATED CHART DATA MAPPING
                    // Dataset 0 (Number A) gets [value, absolute_value]
                    absChart.data.datasets[0].data = [valA, Math.abs(valA)];
                    // Dataset 1 (Number B) gets [value, absolute_value]
                    absChart.data.datasets[1].data = [valB, Math.abs(valB)];
                    absChart.update();
                };

                numAInput.addEventListener('input', updateAbsModule);
                numBInput.addEventListener('input', updateAbsModule);
                updateAbsModule();
            };

            // Initialize all modules
            setupNavigation();
            setupModule1();
            setupModule2();
            setupModule3();
        });
    </script>
</body>
</html></div>
</body></html>
